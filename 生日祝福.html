<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ëá¥Ê†óÂ≠êüå∞ - 581Â§©ÁöÑÁæéÂ•ΩÁõ∏ÈÅá</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #FF6B9D 0%, #C66FBC 25%, #7C4DFF 50%, #536DFE 75%, #66B3F9 100%);
            --secondary-gradient: linear-gradient(135deg, #FFA726 0%, #FF7043 50%, #F06292 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* Á≤íÂ≠êËÉåÊôØ */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            pointer-events: none;
            animation: float-particle 15s infinite linear;
        }

        @keyframes float-particle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ‰∏ªÂÆπÂô® */
        .main-container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ËøõÂ∫¶Êù° */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-gradient);
            width: 0%;
            transition: width 0.8s ease;
        }

        /* Âú∫ÊôØÂÆπÂô® */
        .scene {
            display: none;
            animation: sceneIn 0.8s ease-out;
        }

        .scene.active {
            display: block;
        }

        @keyframes sceneIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ÁéªÁíÉÂç°Áâá */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 40px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: white;
        }

        /* Ê†áÈ¢òÊ†∑Âºè */
        h1 {
            font-size: 3em;
            background: linear-gradient(45deg, #FFD700, #FF69B4, #00CED1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        h2 {
            color: #FFFFFF;
            font-size: 2em;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* Ê†óÂ≠êÂä®Áîª */
        .chestnut-icon {
            font-size: 4em;
            display: inline-block;
            animation: chestnut-bounce 2s ease-in-out infinite;
            margin: 20px 0;
        }

        @keyframes chestnut-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(-10deg); }
            75% { transform: translateY(-20px) rotate(10deg); }
        }

        /* ÊåâÈíÆÊ†∑Âºè */
        .btn {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        /* Ê∏∏ÊàèÂ±ïÁ§∫Âå∫ */
        .games-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px; 
            margin: 40px 0;
            padding: 0 10px; 
        }

        .game-item {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px; 
            text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden; 
            height: auto; 
            min-height: 250px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-item:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .game-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .game-item:hover::before {
            opacity: 1;
        }

        .game-item:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .game-icon {
            width: 100px; 
            height: 100px;
            margin: 0 auto 15px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0; 
        }

        .game-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .game-item:hover .game-icon img {
            transform: scale(1.1);
        }

        /* ËÆ°Êï∞Âô® */
        .counter-display {
            font-size: 5em;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
        }

        /* ËÆ∏ÊÑøÊ±†Ê†∑Âºè */
        .wish-pool {
            background: linear-gradient(135deg, rgba(124, 77, 255, 0.2), rgba(83, 109, 254, 0.2));
            border: 2px solid rgba(124, 77, 255, 0.5);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            backdrop-filter: blur(10px);
        }

        .wish-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(124, 77, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1em;
            font-family: 'Noto Sans SC', sans-serif;
            resize: vertical;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .wish-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .wish-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Á•ùÁ¶èÂ¢ô */
        .wishes-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .wish-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            transform: rotate(var(--rotation, 0deg));
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .wish-card:hover {
            transform: rotate(0deg) scale(1.1);
            z-index: 10;
        }

        /* ÊµÆÂä®ÂÖÉÁ¥† */
        .floating-element {
            position: fixed;
            pointer-events: none;
            animation: float-up 6s ease-out forwards;
            z-index: 1000;
            font-size: 1.1em;
            left: 50% !important;
            transform: translateX(-50%);
        }

        @keyframes float-up {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(50px) scale(0.8);
            }
            15% {
                opacity: 1;
                transform: translateX(-50%) translateY(0px) scale(1);
            }
            85% {
                opacity: 1;
                transform: translateX(-50%) translateY(-20px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-100px) scale(0.8);
            }
        }
        
        /* ÁÉüËä±ÊïàÊûú */
        .firework {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .firework-particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
            z-index: 9999;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        /* ÂØπËØùÊ°Ü */
.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    z-index: 999;
    backdrop-filter: blur(5px);
}

.dialog-box {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 40px;
    max-width: 600px;
    max-height: 80vh;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 1000;
    animation: dialogIn 0.4s ease-out;
    overflow-y: auto;
    color: white; 
}

@keyframes dialogIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

        /* Èü≥‰πêÊí≠ÊîæÂô®Ê†∑Âºè */
        .music-player {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2001;
            transition: all 0.3s ease;
        }

        .music-player:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .music-player.playing {
            animation: musicPulse 2s infinite;
        }

        @keyframes musicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ==================================== */
        /* Ê∏∏ÊàèÊ®°ÂùóÂü∫Á°ÄÊ†∑Âºè */
        /* ==================================== */
        .game-module-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black; /* ÈªòËÆ§ÈªëËâ≤ËÉåÊôØ */
            display: none; /* ÈªòËÆ§ÈöêËóè */
            z-index: 20000; /* Á°Æ‰øùË¶ÜÁõñÂú®ÂÖ∂‰ªñÂÜÖÂÆπ‰πã‰∏ä */
            overflow: hidden; /* Èò≤Ê≠¢ÂÜÖÂÆπÊ∫¢Âá∫ */
            user-select: none; /* Èò≤Ê≠¢ÊñáÊú¨Ë¢´ÈÄâ‰∏≠ */
            cursor: pointer; /* ÊèêÁ§∫Áî®Êà∑ÂèØ‰ª•ÁÇπÂáªÊé®Ëøõ */
            transition: opacity 0.5s ease-out; /* Ê∑°ÂÖ•Ê∑°Âá∫Âä®Áîª */
        }

        .game-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover; /* Á°Æ‰øùËÉåÊôØË¶ÜÁõñÊï¥‰∏™Âå∫Âüü */
            background-position: center;
            transition: background-image 0.8s ease-in-out; /* ËÉåÊôØÂàáÊç¢Âä®Áîª */
        }

        /* ÈªòËÆ§Ê®™Â±èËÉåÊôØ (ÁîµËÑë) */
        .game-background.landscape {
            background-image: url('https://vacuopolis.netlify.app/image/bg_landscape_scene1.png');
        }
        /* Á´ñÂ±èËÉåÊôØ (ÊâãÊú∫) */
        .game-background.portrait {
            background-image: url('https://vacuopolis.netlify.app/image/bg_portrait_scene1.png');
        }

        .game-character {
            position: absolute;
            bottom: 0; /* Ë¥¥ÂêàÂ∫ïÈÉ® */
            left: 50%;
            transform: translateX(-50%); /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
            max-height: 80vh; /* ÊúÄÂ§ßÈ´òÂ∫¶‰∏∫ËßÜÂè£È´òÂ∫¶ÁöÑ80% */
            width: auto; /* ‰øùÊåÅÂõæÁâáÊØî‰æã */
            max-width: 90vw; /* ÊúÄÂ§ßÂÆΩÂ∫¶‰∏∫ËßÜÂè£ÂÆΩÂ∫¶ÁöÑ90% */
            object-fit: contain; /* Á°Æ‰øùÂõæÁâáÂÆåÊï¥ÊòæÁ§∫ */
            transition: opacity 0.5s ease-in-out; /* ÊòæÈöêÂä®Áîª */
            pointer-events: none; /* ‰∏ç‰ºöÈòªÊå°ÁÇπÂáª‰∫ã‰ª∂ */
        }

        .game-menu-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-image: url('https://vacuopolis.netlify.app/image/game_menu_icon.png'); /* ËèúÂçïÂõæÊ†á */
            background-size: cover;
            border-radius: 50%; /* Â¶ÇÊûúÊòØÂúÜÂΩ¢ÊåâÈíÆ */
            cursor: pointer;
            z-index: 2010; /* Á°Æ‰øùÂú®ÂÖ∂‰ªñÂÖÉÁ¥†‰πã‰∏ä */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }
        .game-menu-button:hover {
            transform: scale(1.05);
        }

        .game-dialogue-box {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px); /* ÊâãÊú∫Á´ØÁïôËæπË∑ù */
            max-width: 1100px; /* PCÁ´ØÊúÄÂ§ßÂÆΩÂ∫¶ */
            height: 170px;
            background-image: url('https://vacuopolis.netlify.app/image/dialogbox.png'); /* ÂØπËØùÊ°ÜÂõæÁâá */
            background-size: 100% 100%; /* Á°Æ‰øùÂõæÁâáÊãâ‰º∏Â°´ÂÖÖ */
            background-repeat: no-repeat;
            padding: 30px 40px; /* Ê†πÊçÆÂØπËØùÊ°ÜÂõæÁâáÈ¢ÑÁïôÂÜÖÂÆπÂå∫Âüü */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* ÂÜÖÂÆπÈù†‰∏ãÂØπÈΩê */
            color: white;
            font-size: 1.2em;
            line-height: 1.6;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
            z-index: 2005; /* Âú®‰∫∫Áâ©ÂíåËÉåÊôØ‰πã‰∏ä */
            pointer-events: auto; /* ÂèØÁÇπÂáª */
            bottom: 20px; /* ÈªòËÆ§Â∫ïÈÉ®ÂÅèÁßª */
            /* Âä®ÁîªÊïàÊûúÔºåÂèØÈÄâ */
            animation: fadeInSlideUp 0.6s ease-out;
        }        
        
.game-dialogue-box .dialogue-text {
    margin-top: 20px; /* ÊñáÊú¨ÂíåÂêçÂ≠óÁöÑÈó¥Ë∑ù */
    overflow-y: auto;
    white-space: pre-wrap; /* ‰øùÁïôÊñáÊú¨‰∏≠ÁöÑÊç¢Ë°åÁ¨¶ */
    max-height: 80px;
    padding-right: 10px; 

    /* ‰∏∫‰∏çÂêåÊµèËßàÂô®ÈöêËóèÊªöÂä®Êù° */
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* ÈöêËóèWebkitÊµèËßàÂô®ÔºàÂ¶ÇChrome, SafariÔºâÁöÑÊªöÂä®Êù° */
.game-dialogue-box .dialogue-text::-webkit-scrollbar {
    display: none;
}
        
        /* ËØ¥ËØù‰∫∫ÂêçÂ≠óÊ°ÜÊ†∑Âºè */
.speaker-name-box {
    position: absolute;
    /* Áõ∏ÂØπ‰∫éÁà∂ÂÖÉÁ¥† .game-dialogue-box ÂÆö‰Ωç */
    /* Âêë‰∏äÊñπÁßªÂä®Ôºå‰ΩøÂÖ∂ÊòæÁ§∫Âú®ÂØπËØùÊ°ÜÂ§ñÈÉ® */
    top: -60px; /* Ê†πÊçÆ speaker_name.png ÁöÑÈ´òÂ∫¶Âíå‰∏éÂØπËØùÊ°ÜÁöÑÈó¥Ë∑ùË∞ÉÊï¥ */
    /* ÂêëÂ∑¶‰æßÁßªÂä®Ôºå‰ΩøÂÖ∂ÊòæÁ§∫Âú®ÂØπËØùÊ°ÜÂ§ñÈÉ®Â∑¶‰∏äÊñπ */
    left: 40px; /* Ê†πÊçÆ dialogbox.png ÁöÑËÆæËÆ°ÔºåË∞ÉÊï¥ÂêçÂ≠óÊ°Ü‰∏éÂØπËØùÊ°ÜÂ∑¶ËæπÁºòÁöÑÂØπÈΩê */
    width: 240px; /* ÂêçÂ≠óÊ°ÜÂõæÁâáÁöÑÂÆΩÂ∫¶ÔºåÊ†πÊçÆ speaker_name.png ÂÆûÈôÖÂ∞∫ÂØ∏Ë∞ÉÊï¥ */
    height: 60px; /* ÂêçÂ≠óÊ°ÜÂõæÁâáÁöÑÈ´òÂ∫¶ÔºåÊ†πÊçÆ speaker_name.png ÂÆûÈôÖÂ∞∫ÂØ∏Ë∞ÉÊï¥ */
    background-image: url('https://vacuopolis.netlify.app/image/speaker_name.png'); /* ÂêçÂ≠óÊ°ÜËÉåÊôØÂõæÁâá */
    background-size: 100% 100%; /* Á°Æ‰øùÂõæÁâáÂÆåÂÖ®Ë¶ÜÁõñ */
    background-repeat: no-repeat;
    display: flex; /* ‰ΩøÁî® Flexbox ËøõË°åÂÜÖÂÆπÂ±Ö‰∏≠ */
    align-items: center; /* ÂûÇÁõ¥Â±Ö‰∏≠ */
    justify-content: center; /* Ê∞¥Âπ≥Â±Ö‰∏≠ */
    z-index: 2006; /* Á°Æ‰øùÂú®ÂØπËØùÊ°Ü‰πã‰∏ä */
    pointer-events: none; /* ‰∏çÈòªÁ¢çÈº†Ê†á‰∫ã‰ª∂ */
    opacity: 0; /* ÈªòËÆ§ÈöêËóè */
    transition: opacity 0.3s ease, transform 0.3s ease; 
    transform: translateY(10px); /* ÂàùÂßãÁä∂ÊÄÅÁï•ÂæÆÂêë‰∏ãÔºåÁî®‰∫éÊ∑°ÂÖ•‰∏äÊµÆÊïàÊûú */
}

/* ÂêçÂ≠óÊ°ÜÊòæÁ§∫Êó∂ÁöÑÊ†∑Âºè */
.speaker-name-box.visible {
    opacity: 1;
    transform: translateY(0); /* ÊòæÁ§∫Êó∂ÂõûÂà∞Ê≠£Â∏∏‰ΩçÁΩÆ */
}

/* ÂêçÂ≠óÊ°ÜÂÜÖÁöÑÊñáÊú¨Ê†∑Âºè */
.speaker-name-box .speaker-name-text {
    font-size: 1.1em;
    font-weight: bold;
    color: #FFFFFF; /* ÂêçÂ≠óÈ¢úËâ≤ÔºåÊé®ËçêÁôΩËâ≤‰ª•Âú®ÂêçÂ≠óÊ°ÜÂõæÁâá‰∏ä‰øùÊåÅÊ∏ÖÊô∞ */
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.7); 
    white-space: nowrap; /* Èò≤Ê≠¢ÂêçÂ≠óËøáÈïøÊç¢Ë°å */
    overflow: hidden; /* ÈöêËóèË∂ÖÂá∫ÈÉ®ÂàÜ */
    text-overflow: ellipsis; /* Ë∂ÖÂá∫ÈÉ®ÂàÜÊòæÁ§∫ÁúÅÁï•Âè∑ */
    max-width: 90%; /* ÈôêÂà∂ÊñáÊú¨ÊúÄÂ§ßÂÆΩÂ∫¶ÔºåÈò≤Ê≠¢Ë∂ÖÂá∫ÂêçÂ≠óÊ°Ü */
}

/* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
@media (max-width: 768px) {
    .speaker-name-box {
        width: 180px; /* ÊâãÊú∫Á´ØÂêçÂ≠óÊ°ÜÂÆΩÂ∫¶ */
        height: 45px; /* ÊâãÊú∫Á´ØÂêçÂ≠óÊ°ÜÈ´òÂ∫¶ */
        top: -45px; /* ÊâãÊú∫Á´ØÂêë‰∏äÁßªÂä®ÁöÑÈ´òÂ∫¶ */
        left: 20px; /* ÊâãÊú∫Á´ØÂêëÂ∑¶ÁßªÂä®ÁöÑË∑ùÁ¶ª */
    }
    .speaker-name-box .speaker-name-text {
        font-size: 1em; /* ÊâãÊú∫Á´ØÂ≠ó‰ΩìÂ§ßÂ∞è */
    }
}

        /* ÈÄâÈ°πÂÆπÂô® */
        .choice-container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 872px; /* ÈÄâÈ°πÊ°ÜÂõæÁâáÁöÑÊúÄÂ§ßÂÆΩÂ∫¶ */
            display: flex;
            flex-direction: column; /* ÂûÇÁõ¥ÊéíÂàó */
            gap: 15px; /* ÈÄâÈ°πÈó¥Ë∑ù */
            z-index: 2005;
            bottom: calc(20px + 170px + 30px); /* Âú®ÂØπËØùÊ°Ü‰πã‰∏äÔºåÁïôÂá∫ÈÄÇÂΩìÈó¥Ë∑ù */
            animation: fadeIn 0.5s ease-out;
        }

        .choice-button {
            width: 100%;
            height: 64px; /* ÈÄâÈ°πÊ°ÜÂõæÁâáÈ´òÂ∫¶ */
            background-size: 100% 100%;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1em;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .choice-button:hover {
            transform: translateY(-5px) scale(1.02);
            filter: brightness(1.1);
        }

        /* Âçï‰∫∫Áâ©ÂØπËØùÊ®°ÂùóÊ†∑Âºè */
        .single-char-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7); /* ÂçäÈÄèÊòéÈªëËâ≤ËÉåÊôØ */
            backdrop-filter: blur(8px); /* ËÉåÊôØËôöÂåñ */
            -webkit-backdrop-filter: blur(8px);
            display: none; /* ÈªòËÆ§ÈöêËóè */
            z-index: 20000;
            justify-content: center;
            align-items: center;
            cursor: pointer; /* ÊèêÁ§∫ÂèØÁÇπÂáªÂÖ≥Èó≠ */
            transition: opacity 0.5s ease-out; /* Ê∑°ÂÖ•Ê∑°Âá∫Âä®Áîª */
        }

        .single-char-popup-content {
            background: var(--glass-bg); /* ‰ΩøÁî®Áé∞ÊúâÁéªÁíÉÊïàÊûúËÉåÊôØ */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 80vw; /* ÊúÄÂ§ßÂÆΩÂ∫¶ */
            width: 500px; /* PCÁ´ØÂõ∫ÂÆöÂÆΩÂ∫¶ */
            max-height: 90vh; /* ÊúÄÂ§ßÈ´òÂ∫¶ */
            position: relative;
            animation: dialogIn 0.4s ease-out; /* ‰ΩøÁî®ÂéüÊúâÂØπËØùÊ°ÜÂä®Áîª */
        }

        .popup-char-image {
            max-width: 80%; /* ÂõæÁâáÊúÄÂ§ßÂÆΩÂ∫¶ */
            height: auto;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            object-fit: contain;
        }

        .popup-dialogue-card {
            background: rgba(255, 255, 255, 0.1); /* Áã¨Á´ãÂØπËØùÊ°ÜÊ†∑Âºè */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-size: 1.1em;
            line-height: 1.6;
            text-align: center;
            width: 100%;
            max-height: 150px; /* ÈôêÂà∂È´òÂ∫¶ÔºåÂèØÊªöÂä® */
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .popup-dialogue-card::-webkit-scrollbar { /* Chrome, Safari, Opera */
            display: none;
        }

        .single-char-popup-content .close-popup-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .single-char-popup-content .close-popup-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }
        
/* ÂÖ®Â±èÂä†ËΩΩÁïåÈù¢Ê†∑Âºè */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(29, 29, 31, 0.9); /* ‰ΩøÁî®Ê∑±Ëâ≤ÂçäÈÄèÊòéËÉåÊôØÔºåÊõ¥ÂÖ∑Ê≤âÊµ∏ÊÑü */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999; /* Á°Æ‰øùÂú®ÊúÄÈ°∂Â±Ç */
    transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
    opacity: 1;
    visibility: visible;
}

#loadingOverlay.hidden {
    opacity: 0;
    visibility: hidden; /* ÈöêËóèÂêé‰∏çÂèØ‰∫§‰∫í */
}

/* Âä†ËΩΩÂä®ÁîªÔºàÊóãËΩ¨ÂúÜÂúàÔºâ */
.loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.2);
    border-top-color: #FFD700; /* ‰ΩøÁî®‰∏ªÈ¢òÈáëËâ≤‰Ωú‰∏∫È´ò‰∫Æ */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* Âä†ËΩΩÊñáÂ≠óÊ†∑Âºè */
.loading-text {
    color: white;
    margin-top: 25px;
    font-size: 1.1em;
    font-weight: 500;
    letter-spacing: 1px;
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
}

/* === ÂõæÁâáÊü•ÁúãÂô®Ê†∑Âºè === */
.photo-viewer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: none; /* ÈªòËÆ§ÈöêËóè */
    justify-content: center;
    align-items: center;
    z-index: 30000; /* ËÆæÁΩÆ‰∏Ä‰∏™ËæÉÈ´òÁöÑÂ±ÇÁ∫ß */
    cursor: zoom-out;
}

.photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    font-size: 3em;
    color: white;
    font-weight: 300;
    cursor: pointer;
    z-index: 30002;
    transition: transform 0.2s ease, color 0.2s ease;
    user-select: none;
}

.photo-viewer-close-btn:hover {
    transform: scale(1.2);
    color: #FF6B9D;
}

.photo-viewer-content {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* ÈöêËóèÊ∫¢Âá∫ÁöÑÂõæÁâáÈÉ®ÂàÜ */
}

.photo-viewer-img {
    max-width: 95vw;
    max-height: 95vh;
    object-fit: contain;
    transition: transform 0.2s ease-out; /* Âπ≥ÊªëÁº©ÊîæËøáÊ∏° */
    cursor: grab;
    transform-origin: center center;
    user-select: none;
}

.photo-viewer-img.panning {
    cursor: grabbing;
}

/* === Âä†ËΩΩÈÅÆÁΩ©ËøõÂ∫¶Êù° === */
.loading-progress{
    width: min(66vw, 420px);
    height: 8px;
    margin-top: 18px;
    border-radius: 9999px;
    background: rgba(255,255,255,0.18);
    overflow: hidden;
}
#loadingProgressFill{
    width: 0%;
    height: 100%;
    background: var(--secondary-gradient);
    transition: width .3s ease;
    border-radius: 9999px;
}
.loading-percent{
    margin-top: 10px;
    color: #fff;
    font-size: .95em;
    opacity: .9;
    letter-spacing: 1px;
}

/* === LJH ÂÖ®Â±èÂ™í‰ΩìÊí≠ÊîæÂô®ÔºàË¶ÜÁõñÂçï‰∫∫Áâ©ÂºπÁ™óÈªòËÆ§Âç°ÁâáÂ∏ÉÂ±ÄÔºâ === */
.single-char-popup-content.fullscreen{
    width: 100vw;
    height: 100vh;
    max-width: none;
    max-height: none;
    padding: 0;
    border-radius: 0;
    border: none;
    background: #000;
    display: grid;
    place-items: center;
}
.ljh-media{
    width: 100vw;
    height: 100vh;
    object-fit: contain; /* ‰øùÊåÅ 9:16 ÊØî‰æãÔºåÈªëÂ∫ï‰ø°ÁÆ±ÈÄÇÈÖçÊ°åÈù¢ */
    transition: opacity .4s ease;
    opacity: 1;
}
.ljh-hidden{ opacity: 0; pointer-events: none; }

/* Emoji ‰º¥ÈöèÊïàÊûúÊ†∑Âºè */
.cursor-chestnut, .trail-emoji {
    position: fixed;
    pointer-events: none; /* Á°Æ‰øù‰∏çÈòªÊå°Â∫ïÂ±ÇÂÖÉÁ¥†ÁöÑÁÇπÂáª */
    z-index: 99999; /* Á°Æ‰øùÂßãÁªàÂú®ÊúÄ‰∏äÂ±Ç */
    transform: translate(-50%, -50%); /* Â∞Ü emoji Ëá™Ë∫´‰∏≠ÂøÉÁÇπ‰∏éÈº†Ê†á/Ëß¶Êë∏ÁÇπÂØπÈΩê */
    white-space: nowrap; /* Èò≤Ê≠¢ emoji Êç¢Ë°å */
    user-select: none; /* Èò≤Ê≠¢ emoji Ë¢´ÈÄâ‰∏≠ */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.cursor-chestnut {
    font-size: 2.2em; /* Ê†óÂ≠êemojiÂ§ßÂ∞è */
    opacity: 0; /* Ê°åÈù¢Á´ØÂàùÂßãÈöêËóèÔºåÈº†Ê†áËøõÂÖ•Êó∂ÊòæÁ§∫ */
    transition: opacity 0.1s ease-out; /* Ê∑°ÂÖ•Ê∑°Âá∫Âä®Áîª */
}

.cursor-chestnut.visible {
    opacity: 1;
}

/* Â∞æÈöèÂøÉÂΩ¢ emoji Âä®Áîª */
.trail-emoji {
    font-size: 1.5em; /* ÂøÉÂΩ¢ emoji Âü∫Á°ÄÂ§ßÂ∞è */
    animation: emoji-pop-fade 1.2s ease-out forwards; /* Âä®ÁîªÊåÅÁª≠Êó∂Èó¥ */
}

@keyframes emoji-pop-fade {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
    }
    50% {
        opacity: 1;
        /* ‰ΩøÁî® CSS ÂèòÈáèÂÆûÁé∞ÈöèÊú∫ÂÅèÁßªÂíåÊóãËΩ¨ */
        transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(1.2) rotate(var(--rotate, 0deg));
    }
    100% {
        opacity: 0;
        /* Âêë‰∏äÊºÇÊµÆÂπ∂Áº©Â∞èÊ∑°Âá∫ */
        transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px) - 30px)) scale(1) rotate(var(--rotate, 0deg));
    }
}

.ljh-gif-container {
    position: relative;
    width: 100%;
    height: 80vh; /* Âç†ÊçÆËßÜÂè£È´òÂ∫¶ÁöÑ80% */
    max-width: 1080px; /* ÊúÄÂ§ßÂÆΩÂ∫¶ÈôêÂà∂ */
    max-height: 1920px; /* ÊúÄÂ§ßÈ´òÂ∫¶ÈôêÂà∂ */
    margin: 0 auto 20px auto;
    display: none;
    justify-content: center;
    align-items: center;
}

.ljh-gif {
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain; /* ‰øùÊåÅÂéüÂßãÊØî‰æãÔºåÂÆåÊï¥ÊòæÁ§∫ */
}

.popup-char-image.hidden {
    display: none;
}

.ljh-gif-container.visible {
    display: flex;
}

        /* ÂìçÂ∫îÂºèË∞ÉÊï¥ */
        @media (max-width: 768px) {
            .game-dialogue-box {
                height: 150px; 
                font-size: 0.95em;
                padding: 15px 25px;
                bottom: 10px;
            }
            .game-dialogue-box .speaker-name {
                top: 10px;
                left: 30px;
                font-size: 1em;
            }
            .game-character {
                max-height: 70vh; /* ÊâãÊú∫Á´Ø‰∫∫Áâ©ÈÄÇÂΩìÁº©Â∞è */
            }
            .choice-container {
                bottom: calc(10px + 150px + 20px); /* ÊâãÊú∫Á´ØÈÄâÈ°π‰ΩçÁΩÆ */
                gap: 10px;
            }
            .choice-button {
                height: 50px; /* ÊâãÊú∫Á´ØÈÄâÈ°πÈ´òÂ∫¶ */
                font-size: 0.9em;
            }
            .game-menu-button {
                width: 60px;
                height: 60px;
                top: 10px;
                right: 10px;
            }

            .single-char-popup-content {
                padding: 20px;
                width: 95%; /* ÊâãÊú∫Á´ØÊõ¥ÂÆΩ */
            }
            .popup-char-image {
                max-width: 90%; /* ÊâãÊú∫Á´Ø‰∫∫Áâ©ÂõæÊõ¥ÂÆΩ */
            }
            .popup-dialogue-card {
                font-size: 0.95em;
                padding: 15px;
                max-height: 120px;
            }
            .single-char-popup-content .close-popup-btn {
                width: 25px;
                height: 25px;
                font-size: 1em;
            }

            /* Ë∞ÉÊï¥ÂéüÊúâÂºπÁ™ó‰ª•ÈÄÇÈÖçÊâãÊú∫ */
            .dialog-box {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
                top: 50%;
                border-radius: 16px;
                color: #333;
            }
            
            .dialog-box h2 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            
            .dialog-box p {
                font-size: 1em;
                line-height: 1.6;
                margin-bottom: 15px;
            }
            
            .dialog-box strong {
                font-size: 1.1em;
            }
        }
        /* Âä®ÁîªÊïàÊûú */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translate(-50%, 50px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- Á≤íÂ≠êËÉåÊôØ -->
    <div class="particles" id="particles"></div>

    <!-- ËøõÂ∫¶Êù° -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- Èü≥‰πêÊí≠ÊîæÂô® -->
    <div class="music-player" id="musicPlayer" onclick="toggleMusic()" title="ÁÇπÂáªÊí≠Êîæ/ÊöÇÂÅúÈü≥‰πê">
        <span style="font-size: 1.5em;">üéµ</span>
    </div>
    
    <!-- ÂØπËØùÊ°Ü -->
    <div class="dialog-overlay" id="dialogOverlay" onclick="closeDialog()"></div>
    <div class="dialog-box" id="dialogBox">
        <div id="dialogContent"></div>
        <button class="btn" onclick="closeDialog()" style="margin-top: 20px; position: sticky; bottom: 0;">ÂÖ≥Èó≠</button>
    </div>

    <!-- Ê∏∏ÊàèÊ®°ÂùóÂÆπÂô® -->
    <div id="gameModule" class="game-module-overlay">
        <!-- ËÉåÊôØÈü≥‰πê -->
        <audio id="gameBGM" loop>
            <source src="https://vacuopolis.netlify.app/audio/srkl_hunyuan.mp3" type="audio/mp3">
            ÊµèËßàÂô®‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ...
        </audio>

        <!-- ËÉåÊôØÂõæÁâá (Âä®ÊÄÅÂä†ËΩΩÔºåÊ†πÊçÆÊ®™Á´ñÂ±èÂàáÊç¢) -->
        <div id="gameBackground" class="game-background"></div>

        <!-- ËèúÂçïÊåâÈíÆ -->
        <div id="gameMenu" class="game-menu-button"></div>

        <!-- ‰∫∫Áâ©ÂõæÁâá (Âä®ÊÄÅÂä†ËΩΩ/ÊòæÁ§∫/ÈöêËóè) -->
        <img id="gameCharacter" class="game-character" src="" alt="ËßíËâ≤ÂõæÁâá">

        <!-- ÂØπËØùÊ°Ü -->
        <div id="gameDialogueBox" class="game-dialogue-box" onclick="advanceDialogue()">
            <span id="speakerName" class="speaker-name"></span>
            <p id="dialogueText" class="dialogue-text"></p>
        </div>

        <!-- ÈÄâÈ°πÂÆπÂô® (Âä®ÊÄÅÂä†ËΩΩ/ÊòæÁ§∫/ÈöêËóè) -->
        <div id="choiceContainer" class="choice-container">
            <!-- ÈÄâÈ°πÊåâÈíÆÂ∞ÜÂú®Ê≠§Â§ÑÂä®ÊÄÅÁîüÊàê -->
        </div>
    </div>
    
<!-- ÂÖ®Â±èÂä†ËΩΩÁïåÈù¢ -->
<div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">üéÅ Ê≠£Âú®ÊÇÑÊÇÑ‰∏∫Ê†óÂ≠êÂáÜÂ§áÁ§ºÁâ©...</p>
    <!-- Âä†ËΩΩËøõÂ∫¶Êù°‰∏éÁôæÂàÜÊØî -->
<div class="loading-progress"><div id="loadingProgressFill"></div></div>
<div id="loadingPercent" class="loading-percent">0%</div>
</div>

    <!-- Âçï‰∫∫Áâ©ÂØπËØùÊ®°ÂùóÂÆπÂô® -->
<div id="singleCharacterPopup" class="single-char-popup-overlay" onclick="closeSingleCharacterPopup()">
    <div class="single-char-popup-content" onclick="event.stopPropagation()">
        <!-- GIFÂÆπÂô® -->
        <div id="ljhGifContainer" class="ljh-gif-container">
            <img id="ljhGif" class="ljh-gif" src="https://image.lolimi.cn/2025/08/24/68ab3378200ca.gif" alt="ÈôÜÊôØÂíåGIF">
        </div>
        
        <!-- ‰∫∫Áâ©ÂõæÁâá -->
        <img id="popupCharImage" class="popup-char-image hidden" src="https://vacuopolis.netlify.app/image/ljh_Liftcake.png" alt="ÈôÜÊôØÂíå">
        
        <!-- ÂØπËØùÂÜÖÂÆπ -->
        <div class="popup-dialogue-card">
            <p id="popupCharText"></p>
            <audio id="popupCharVoice" src="https://vacuopolis.netlify.app/audio/Â∞èÈôÜÁöÑÁîüÊó•Á•ùÁ¶è.mp3"></audio>
        </div>
        
        <!-- ÂÖ≥Èó≠ÊåâÈíÆ -->
        <button class="close-popup-btn" onclick="closeSingleCharacterPopup()">X</button>
    </div>
</div>

    <!-- Èü≥È¢ëÂÖÉÁ¥† -->
    <audio id="backgroundMusic" loop>
        <source src="https://vacuopolis.netlify.app/audio/srkl_hunyuan.mp3" type="audio/mp3">
        ÊµèËßàÂô®ÂèØËÉΩ‰∏çÊîØÊåÅÈü≥È¢ëÊí≠Êîæ...
    </audio>
    
    <!-- ÂõæÁâáÊü•ÁúãÂô® -->
<div id="photoViewerOverlay" class="photo-viewer-overlay" onclick="closePhotoViewer()">
    <span class="photo-viewer-close-btn" onclick="closePhotoViewer(event)">&times;</span>
    <div id="photoViewerContent" class="photo-viewer-content">
        <img id="photoViewerImg" src="" alt="Êü•ÁúãÁÖßÁâá" class="photo-viewer-img">
    </div>
</div>

    <!-- ‰∏ªÂÆπÂô® -->
    <div class="main-container">
        <!-- Âú∫ÊôØ1ÔºöÂºÄÂú∫ -->
        <div class="scene active" id="scene1">
            <div class="glass-card">
                <div class="chestnut-icon">üå∞</div>
                <h1>HeyÔºÅÊ†óÂ≠êÂêåÂ≠¶</h1>
                <p style="font-size: 1.3em; margin: 30px 0;">
                    Â∞èÁ©∫ÂüéÂú®ËøôÈáåÁ≠â‰Ω†Âæà‰πÖÂï¶ÔΩû<br>
                    ‰ªäÂ§©ÊòØ‰∏™ÁâπÂà´ÁöÑÊó•Â≠êÂë¢ÔºÅ
                </p>
                <p>ÂáÜÂ§áÂ•ΩÂºÄÂêØËøôÊÆµÂ•áÂ¶ôÁöÑÊóÖÁ®ã‰∫ÜÂêóÔºü</p>
                <button class="btn" onclick="nextScene()">ÂêØÁ®ãÔºÅ‚ú®</button>
            </div>
        </div>

        <!-- Âú∫ÊôØ2ÔºöÊó∂ÂÖâÂõûÂøÜ -->
        <div class="scene" id="scene2">
            <div class="glass-card">
                <h2>‚è∞ Êó∂ÂÖâÂç∞ËÆ∞</h2>
                <p>‰ªéÁõ∏ÈÅáÂà∞Áé∞Âú®ÔºåÂ∑≤ÁªèËøáÂéª‰∫Ü</p>
                <div class="counter-display" id="daysCounter">0</div>
                <p style="font-size: 1.3em;">Â§©</p>
                <p style="margin-top: 30px;">
                    581‰∏™Êó•Â§úÁöÑÈô™‰º¥<br>
                    ÊØè‰∏ÄÂ§©ÈÉΩÊòØÁã¨ÁâπÁöÑËÆ∞ÂøÜ<br>
                    ‰ªéÈôåÁîü‰∫∫Âà∞‰∫í‰∏∫ÊúãÂèã....
                </p>
                <button class="btn" onclick="nextScene()">ÁªßÁª≠ÊóÖÁ®ã ‚Üí</button>
            </div>
        </div>

        <!-- Âú∫ÊôØ3ÔºöÊ∏∏Êàè‰∏ñÁïå -->
        <div class="scene" id="scene3">
            <div class="glass-card">
                <h2>üéÆ Áé∞Âú®ÊòØÊ∏∏ÊàèÁ•ùÁ¶èÊó∂Èó¥~</h2>
                <p style="color: #FFD700; font-size: 1.1em; margin-bottom: 20px;">
                    üí° ËΩªËß¶Ê∏∏ÊàèÂõæÊ†áÂèØ‰ª•Ëé∑Âæó‰∏ìÂ±ûÁ•ùÁ¶è~
                </p>
                <div class="games-showcase">
                    <div class="game-item" onclick="gameWish('ÂéüÁ•û', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/genshin.png" alt="ÂéüÁ•û" />
                        </div>
                        <h3>ÂéüÁ•û</h3>
                        <p>ÊèêÁì¶ÁâπÂ§ßÈôÜÁöÑÂÜíÈô©</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">ÊÑø‰Ω†ÊäΩÂç°ÊÄªÊòØ‰∏çÊ≠™ÔºÅ</p>
                    </div>
                    <div class="game-item" onclick="gameWish('Â¥©ÈìÅ', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/starrail.png" alt="Â¥©ÂùèÔºöÊòüÁ©πÈìÅÈÅì" />
                        </div>
                        <h3>Â¥©ÂùèÔºöÊòüÁ©πÈìÅÈÅì</h3>
                        <p>ÊòüÁ©πÂàóËΩ¶ÁöÑÊóÖÈÄî</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">ÊÑø‰Ω†ÈÅóÂô®ÊÄªÊúâÂèåÊö¥ÔºÅ</p>
                    </div>
                    <div class="game-item" onclick="gameWish('ÁªùÂå∫Èõ∂', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/zzz.png" alt="ÁªùÂå∫Èõ∂" />
                        </div>
                        <h3>ÁªùÂå∫Èõ∂</h3>
                        <p>Á©∫Ê¥ûÊé¢Á¥¢ËÄÖ</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">ÊÑø‰Ω†Èü≥ÊìéÊÄªËÉΩÊ¨ßÁöáÔºÅ</p>
                    </div>
                    <div class="game-item" onclick="gameWish('‰∫åÊ¨°ÂÖÉ', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/bilibili.png" alt="ÂìîÂì©ÂìîÂì©" />
                        </div>
                        <h3>‰∫åÊ¨°ÂÖÉ‰∏ñÁïå</h3>
                        <p>ACGÁöÑÊó†ÈôêÂèØËÉΩ</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">ÊÑø‰Ω†Ê∞∏Ëøú‰∏≠‰∫å‰∏îÂø´‰πêÔºÅ</p>
                    </div>
                </div>
                <div style="margin-top: 30px; align-items: center; justify-content: center; display: flex; flex-wrap: wrap; gap: 15px;">
    <p style="margin: 0;">Ê†óÂ≠êËøòËÆ∞ÂæóÂéªÂπ¥‰∫îÊúà‰ªΩ‰∏≠Êó¨Â∏¶ÊàëÂéªÁà±ÂøÉÂ≤õÊó∂ÁöÑÂú∫ÊôØÂêó<br>ÂïäÂìàÂìà</p>
    <button class="btn" style="padding: 8px 24px; font-size: 0.9em;" onclick="openPhotoViewer('https://image.lolimi.cn/2025/08/20/68a56a294a3d5.png')">üì∑ Êü•ÁúãÁÖßÁâá</button>
</div>
                <p style="color: #FFD700; font-size: 1em; margin-top: 10px;">
                    üéØ ËØïËØïÊåâ‰ΩèÂ±èÂπïÊªëÂä®Ôºå‰ºöÊúâÁ•ûÁßòemojiË∑üÈöè~
                </p>
                <button class="btn" onclick="nextScene()">‰∏ã‰∏ÄÁ´ô üöÄ</button>
            </div>
        </div>

        <!-- Âú∫ÊôØ4ÔºöËÆ∏ÊÑøÊó∂Âàª -->
        <div class="scene" id="scene4">
            <div class="glass-card">
                <h2>üå† Áé∞Âú®ÊòØËÆ∏ÊÑøÊó∂ÂàªÔºÅ</h2>
                <div class="chestnut-icon">‚≠ê</div>
                <p style="font-size: 1.2em; margin-bottom: 30px;">
                    Âú®Ëøô‰∏™ÁâπÂà´ÁöÑÊó•Â≠êÈáå<br>
                    ËÆ©Êàë‰ª¨‰∏ÄËµ∑ÂêëÊòüÁ©∫ËÆ∏‰∏ãÁæéÂ•ΩÁöÑÊÑøÊúõÂêßÔºÅ
                </p>
                
                <div class="wish-pool">
                    <h3 style="margin-bottom: 20px; color: #FFD700;">‚ú® Ê†óÂ≠êÁöÑËÆ∏ÊÑøÊ±† ‚ú®</h3>
                    <textarea 
                        id="wishInput" 
                        class="wish-input"
                        placeholder="ÂèØ‰ª•Âú®ËøôÈáåÂÜô‰∏ãÁîüÊó•ÊÑøÊúõ...&#10;ÊØè‰∏™ÁúüËØöÁöÑÊÑøÊúõÈÉΩ‰ºöË¢´‰ªñ‰ª¨Êé•Êî∂ üíñ"
                    ></textarea>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="submitWish()">üåü ÊäïÂÖ•ËÆ∏ÊÑøÊ±†</button>
                        <button class="btn" onclick="showWishTips()">üí° ËÆ∏ÊÑøÂ∞èË¥¥Â£´</button>
                    </div>
                </div>
                
                <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 20px;">
                    Â∞èÁ©∫ÂüéÁõ∏‰ø°ÔºåÊØè‰∏Ä‰∏™ËÆ§ÁúüËÆ∏‰∏ãÁöÑÊÑøÊúõÈÉΩ‰ºöÂÆûÁé∞Âë¢ÔºÅ
                </p>
                
                <button class="btn" onclick="nextScene()" id="continueBtn" style="display: none;">ÁªßÁª≠ÂâçÂæÄÁîüÊó•Â∫ÜÂÖ∏ üéâ</button>
            </div>
        </div>

        <!-- Âú∫ÊôØ5ÔºöÁîüÊó•Á•ùÁ¶è -->
        <div class="scene" id="scene5">
            <div class="glass-card">
                <h1>üéâ Ê†óÂ≠êÁîüÊó•Âø´‰πêÔºÅüéâ</h1>
                <div class="chestnut-icon">üéÇüå∞</div>
                <h2 style="color: #FFD700;">8Êúà25Êó• - ÊòØ‰Ω†ÁöÑ‰∏ìÂ±ûËäÇÊó•</h2>
                
                <div class="wishes-wall">
                    <div class="wish-card" style="--rotation: -3deg;">
                        <p>ÊÑø‰Ω†Â≠¶‰∏öÈ°∫Âà©<br>ËÄÉËØïÂÖ®ËøáÔºÅüíØ</p>
                    </div>
                    <div class="wish-card" style="--rotation: 2deg;">
                        <p>ÊÑø‰Ω†ÊäΩÂç°ÂøÖ‰∏≠<br>Ê∞∏‰∏çÊ≠™Ê±†ÔºÅ‚≠ê</p>
                    </div>
                    <div class="wish-card" style="--rotation: -2deg;">
                        <p>ÊÑø‰Ω†Âø´‰πêÂä†ÂÄç<br>ÁÉ¶ÊÅºÊ∏ÖÈõ∂ÔºÅüòä</p>
                    </div>
                    <div class="wish-card" style="--rotation: 3deg;">
                        <p>ÊÑø‰Ω†Ë∫´‰ΩìÂÅ•Â∫∑<br>Ê¥ªÂäõÊª°Êª°ÔºÅüí™</p>
                    </div>
                    <div class="wish-card" style="--rotation: -1deg;">
                        <p>ÊÑø‰Ω†Ê¢¶ÊÉ≥ÊàêÁúü<br>ÂâçÁ®ã‰ººÈî¶ÔºÅüåü</p>
                    </div>
                    <div class="wish-card" style="--rotation: 1deg;">
                        <p>ÊÑø‰Ω†Ê∞∏ËøúÂèØÁà±<br>Á¨ëÂÆπÂ∏∏Âú®ÔºÅüåà</p>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn" onclick="launchFireworks()">üéÜ ÊîæÁÉüËä±</button>
                    <button class="btn" onclick="showSecretMessage()">üíå ÁßòÂØÜ‰ø°‰ª∂</button>
                    <button class="btn" onclick="nextScene()">üíï Êü•ÁúãÊúÄÂêéÁöÑËØù</button>
                </div>
            </div>
        </div>

        <!-- Âú∫ÊôØ6ÔºöÊúÄÁªàÁïôË®Ä -->
        <div class="scene" id="scene6">
            <div class="glass-card">
                <h2>üíï Ëá¥ÊúÄÁâπÂà´ÁöÑÊ†óÂ≠ê</h2>
                <div class="chestnut-icon">üå∞‚ú®</div>
                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                    <p style="font-size: 1.1em; line-height: 2;">
                        ‰∫≤Áà±ÁöÑÊ†óÂ≠êÔºö<br><br>
                        
                        581Â§©ÂâçÁöÑÁõ∏ÈÅáÔºåÊòØÂëΩËøêÊúÄÁæéÂ•ΩÁöÑÂÆâÊéí„ÄÇ<br><br>
                        
                        ‰Ω†ÊòØÈÇ£‰∏™Âú®Ê∏∏ÊàèÈáå‰ºöÂõ†‰∏∫ÊäΩÂà∞ÂêÑÁßçÈáëÁîöËá≥ÊèêÂâçËøõËÄåÂÖ¥Â•ãÂ∞ñÂè´ÁöÑÂ•≥Â≠©Ôºõ<br>
                        ‰Ω†ÊòØÈÇ£‰∏™Ê∑±Â§úËøòÂú®ËÉåËØµÂåªÂ≠¶ÊúØËØ≠Âç¥‰æùÁÑ∂ÂÖÉÊ∞îÊª°Êª°ÁöÑÂ≠¶Èú∏Ôºõ<br>
                        ‰Ω†ÊòØÈÇ£‰∏™‰ºöÂíåÊàë‰∏ÄËµ∑Áé©Ê¢óÊï¥Ê¥ªÂÑø‰ªé‰∏çÂ´åÂπºÁ®öÁöÑÊúãÂèãÔºõ<br>
                        ‰Ω†ÊòØÈÇ£‰∏™ÊúâÁùÄÂåªËÄÖÊ¢¶ÊÉ≥Âèà‰øùÊåÅÁùÄÂ∞ëÂ•≥ÂøÉÁöÑÁâπÂà´Â≠òÂú®„ÄÇ<br><br>
                        
                        ÊÑüË∞¢‰Ω†ÁöÑÈô™‰º¥ÔºåËÆ©Ëøô581Â§©ÁöÑÊØè‰∏ÄÂ§©ÈÉΩÂÖÖÊª°Ê¨¢Á¨ë„ÄÇ<br>
                        Êú™Êù•ÁöÑË∑ØËøòÂæàÈïøÔºåÂ∏åÊúõÊàë‰ª¨ËÉΩÁªßÁª≠Ôºö<br>
                        ‰∏ÄËµ∑Ê∏∏ÊàèÔºå‰∏ÄËµ∑ÂêêÊßΩÂâßÊÉÖÔºõ<br>
                        ‰∏ÄËµ∑ÊäΩÂç°Ôºå‰∏ÄËµ∑ÂàÜ‰∫´Ê¨ßÊ∞îÔºõ<br>
                        ‰∏ÄËµ∑ÊàêÈïøÔºå‰∏ÄËµ∑ËßÅËØÅÂΩºÊ≠§ÁöÑÁ≤æÂΩ©„ÄÇ<br><br>
                        
                        <strong style="font-size: 1.3em; color: #FFD700;">
                            ÁîüÊó•Âø´‰πêÔºåÊàëÁöÑÊúãÂèãÔºÅ<br>
                            ÊÑø‰Ω†Ê∞∏ËøúÊòØÈÇ£‰∏™Áã¨‰∏ÄÊó†‰∫åÁöÑÊ†óÂ≠êÔºÅ
                        </strong><br><br>
                        
                        ‚Äî‚Äî Â∞èÁ©∫Âüé<br>
                        2025.8.25
                    </p>
                </div>
                <button class="btn" onclick="restart()">üîÑ ÂÜçÁúã‰∏ÄÈÅç</button>
            </div>
        </div>
    </div>

    <script>
// ËµÑÊ∫êÊ∏ÖÂçï
const assetManifest = {
    images: [
        // Ê∏∏ÊàèÂõæÊ†á
        'https://vacuopolis.netlify.app/image/genshin.png',
        'https://vacuopolis.netlify.app/image/starrail.png',
        'https://vacuopolis.netlify.app/image/zzz.png',
        'https://vacuopolis.netlify.app/image/bilibili.png',
        // Ê∏∏ÊàèÊ®°ÂùóËÉåÊôØ
        'https://vacuopolis.netlify.app/image/bg_landscape_scene1.png',
        'https://vacuopolis.netlify.app/image/bg_portrait_scene1.png',
        // Ê∏∏ÊàèÊ®°ÂùóUI
        'https://vacuopolis.netlify.app/image/game_menu_icon.png',
        'https://vacuopolis.netlify.app/image/dialogbox.png',
        'https://vacuopolis.netlify.app/image/speaker_name.png',
        'https://vacuopolis.netlify.app/image/choicebox1.png',
        'https://vacuopolis.netlify.app/image/choicebox2.png',
        'https://vacuopolis.netlify.app/image/choicebox3.png',
        // Ê∏∏ÊàèÊ®°Âùó‰∫∫Áâ©Á´ãÁªò
        'https://vacuopolis.netlify.app/image/qinwu_yelloweyes.png',
        'https://vacuopolis.netlify.app/image/qinwu_laugh1.png',
        'https://vacuopolis.netlify.app/image/qinwu_laugh2.png',
        'https://vacuopolis.netlify.app/image/qinwu_laugh3.png',
        'https://vacuopolis.netlify.app/image/qinwu_embarrass.png',
        // Âçï‰∫∫ÂºπÁ™óÊ®°Âùó
        'https://vacuopolis.netlify.app/image/ljh_Liftcake.png',
        'https://image.lolimi.cn/2025/08/24/68ab3378200ca.gif',
        // ÁÖßÁâáÊü•ÁúãÂô®ÂõæÁâá
        'https://image.lolimi.cn/2025/08/20/68a56a294a3d5.png'
    ],
    audio: [
        'https://vacuopolis.netlify.app/audio/srkl_hunyuan.mp3',
        'https://vacuopolis.netlify.app/audio/qinwubgm.mp3',
        'https://vacuopolis.netlify.app/audio/toprincess.ogg',
        'https://vacuopolis.netlify.app/audio/Â∞èÈôÜÁöÑÁîüÊó•Á•ùÁ¶è.mp3'
    ]
};

function preloadAssets(onComplete) {
    const loadingFill = document.getElementById('loadingProgressFill');
    const loadingPercent = document.getElementById('loadingPercent');

    const imgCount = assetManifest.images?.length || 0;
    const audioCount = assetManifest.audio?.length || 0;
    // const videoCount = assetManifest.videos?.length || 0; 

    const totalAssets = imgCount + audioCount; // + videoCount;
    let loadedAssets = 0;

    const updateLoadingUI = () => {
        const progress = totalAssets === 0 ? 100 : Math.round((loadedAssets / totalAssets) * 100);
        if (loadingFill) loadingFill.style.width = progress + '%';
        if (loadingPercent) loadingPercent.textContent = progress + '%';
        console.log(`ËµÑÊ∫êÂä†ËΩΩ‰∏≠... ${progress}%`);
        if (loadedAssets >= totalAssets) { // Êù°‰ª∂ËææÊàêÂç≥Ë∞ÉÁî®onComplete
            console.log('ÊâÄÊúâËµÑÊ∫êÂ∑≤Âä†ËΩΩÂÆåÊØïÔºÅ');
            // Âª∂Ëøü‰∏ÄÁÇπÊó∂Èó¥ÔºåÁ°Æ‰øùUIÂä®ÁîªÂÆåÊàê
            setTimeout(() => {
                if (onComplete) onComplete();
            }, 300); 
        }
    };

    const assetLoaded = () => {
        loadedAssets++;
        updateLoadingUI();
    };

    // È¢ÑÂä†ËΩΩÂõæÁâá
    (assetManifest.images || []).forEach(src => {
        const img = new Image();
        img.onload = assetLoaded;
        img.onerror = () => { console.error(`ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•: ${src}`); assetLoaded(); };
        img.src = src;
    });

    // È¢ÑÂä†ËΩΩÈü≥È¢ë
    (assetManifest.audio || []).forEach(src => {
        const audio = new Audio();
        const done = () => {
            audio.removeEventListener('canplaythrough', done);
            audio.removeEventListener('loadeddata', done);
            assetLoaded();
        };
        // canplaythrough Êõ¥ËÉΩ‰øùËØÅËµÑÊ∫êÂ∑≤ÂÆåÂÖ®Âä†ËΩΩÂπ∂ÂèØÊí≠Êîæ
        audio.addEventListener('canplaythrough', done, { once: true });
        // Â¶ÇÊûú canplaythrough ‰∏çËß¶ÂèëÔºåloadeddata ‰πü‰ºöÊ†áËÆ∞‰∏∫Âä†ËΩΩ
        audio.addEventListener('loadeddata', done, { once: true });
        audio.onerror = () => { console.error(`Èü≥È¢ëÂä†ËΩΩÂ§±Ë¥•: ${src}`); assetLoaded(); };
        audio.preload = 'auto'; // Á°Æ‰øùÊµèËßàÂô®‰ºöÂ∞ùËØïÈ¢ÑÂä†ËΩΩ
        audio.src = src;
        audio.load(); // Âº∫Âà∂ÊµèËßàÂô®Âä†ËΩΩÈü≥È¢ë
    });

    // Â¶ÇÊûúÊ≤°Êúâ‰ªª‰ΩïËµÑÊ∫êÈúÄË¶ÅÂä†ËΩΩÔºåÁ´ãÂç≥Ëß¶ÂèëÂÆåÊàêÂõûË∞É
    if (totalAssets === 0) {
        updateLoadingUI();
    }
}
    
    let currentScene = 1;
    const totalScenes = 6;
    let musicPlaying = false;
    let audioInitialized = false;
    // === ÂΩ©ËõãÂÖ®Â±ÄÂèòÈáèÈÄªËæë ===
    let musicToggleCount = 0; // Èü≥‰πêÊí≠ÊîæÂô®ÂΩ©ËõãËÆ°Êï∞
    let easterEggActivated = false; // Konami code ÊòØÂê¶ÊøÄÊ¥ª
    let originalCursorChestnutEmoji = 'üå∞'; // Â≠òÂÇ®Èº†Ê†áË∑üÈöèÊ†óÂ≠êÂéüÂõæÊ†á
    // Èº†Ê†áÂ∞æÈöèÂøÉÂΩ¢emojiÔºåÁî®‰∫éKonami code‰∏¥Êó∂ÊõøÊç¢
    let specialEmojis = ['ü©∫', 'üåü', 'üíñ', '‚ú®', 'ü©π', 'üíâ']; // Ê†óÂ≠ê‰Ωú‰∏∫ÂåªÂ≠¶ÁîüÁöÑÁâπÊÆäemoji

    // ÂàõÂª∫Á≤íÂ≠êÊïàÊûú
    function createParticles() {
        const container = document.getElementById('particles');
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (15 + Math.random() * 10) + 's';
            container.appendChild(particle);
        }
    }

    // Âú∫ÊôØÂàáÊç¢
function nextScene() {
    // È¶ñÊ¨°ÁÇπÂáª"ÂêØÁ®ã"Êó∂ÔºåÂ∞ùËØïÊí≠ÊîæÈü≥‰πê
    if (currentScene === 1) {
        const audio = document.getElementById('backgroundMusic');
        const player = document.getElementById('musicPlayer');
        
        // Âè™ÊúâÂú®Èü≥‰πêÂ∞öÊú™Êí≠ÊîæÊó∂ÊâçÂ∞ùËØïÊí≠Êîæ‰∏îÈü≥È¢ëÂ∑≤ÂáÜÂ§áÂ•Ω
        if (!musicPlaying && audio.paused && audioInitialized) {
            audio.play().then(() => {
                musicPlaying = true;
                player.classList.add('playing');
                player.innerHTML = '<span style="font-size: 1.5em;">üéµ</span>';
                createEnhancedFloatingText('üéµ Èü≥‰πêÂ∑≤Ëá™Âä®Êí≠ÊîæÔΩû', window.innerWidth / 2, 150);
                createMusicNotes(player); // ‰ªÖÂú®ÊàêÂäüÊí≠ÊîæÂêéÂàõÂª∫Èü≥Á¨¶Âä®Áîª
            }).catch(error => {
                console.log('Ëá™Âä®Êí≠ÊîæÂ§±Ë¥•ÔºåÈúÄË¶ÅÁî®Êà∑ÂêéÁª≠ÊâãÂä®ÁÇπÂáª:', error);
                // Âç≥‰ΩøÊí≠ÊîæÂ§±Ë¥•Ôºå‰πüÊèêÁ§∫Áî®Êà∑ÂèØ‰ª•ÊâãÂä®ÁÇπÂáª
                createEnhancedFloatingText('üîä ÁÇπÂáªÂè≥‰∏ãËßíÈü≥Á¨¶ÂèØÊí≠ÊîæÈü≥‰πê', window.innerWidth / 2, 150);
            });
        }
    }

    if (currentScene < totalScenes) {
        document.getElementById(`scene${currentScene}`).classList.remove('active');
        currentScene++;
        setTimeout(() => {
            document.getElementById(`scene${currentScene}`).classList.add('active');
            updateProgress();
            
            // ÁâπÊÆäÂú∫ÊôØÊïàÊûú
            if (currentScene === 2) {
                animateCounter();
            } else if (currentScene === 5) {
                createConfetti();
            }
            // === Âú∫ÊôØÂàáÊç¢Êó∂ÔºåÊ∑ªÂä†ÂØπÂ∫îÂú∫ÊôØÁöÑÂΩ©ËõãÁÇπÂáªÁõëÂê¨Âô® ===
            addSceneSpecificClickListeners(currentScene);
        }, 300);
    }
}

    // Êõ¥Êñ∞ËøõÂ∫¶Êù°
    function updateProgress() {
        const progress = (currentScene / totalScenes) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }

    // Â§©Êï∞ËÆ°Êï∞Âä®Áîª
    function animateCounter() {
        const counter = document.getElementById('daysCounter');
        let count = 0;
        const target = 581;
        const duration = 2000;
        const increment = target / (duration / 16);
        
        const timer = setInterval(() => {
            count += increment;
            if (count >= target) {
                counter.textContent = target;
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(count);
            }
        }, 16);
    }

    // Ê∏∏ÊàèÁ•ùÁ¶è
    function gameWish(game, event) {
        // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°
        event.stopPropagation();
        
        const wishes = {
            'ÂéüÁ•û': '‚ú® ÊÑøÈ£éÁ•ûÂøΩÊÇ†ÔºåÂ≤©Á•ûÊä§‰ΩëÔºåÊØèÊ¨°ÂçÅËøûÂøÖÂá∫ÈáëÔºÅüåü',
            'Â¥©ÈìÅ': 'üöÇ ÊÑø‰Ω†ÊòüËΩ®Ê∞∏Ëøú‰∏çÊ≠™ÔºåÈÅóÂô®ÂâØËØçÊù°ÂÖ®Êö¥ÂáªÔºÅ‚≠ê',
            'ÁªùÂå∫Èõ∂': 'üéµ ÊÑø‰Ω†Èü≥ÊìéË∞ÉÈ¢ë‰∏ÄÂèëÂÖ•È≠ÇÔºå‰ª£ÁêÜ‰∫∫ÂÖ®ÂëòÊª°ÂëΩÔºÅüéÆ',
            '‰∫åÊ¨°ÂÖÉ': 'üåà ÊÑø‰Ω†Ê∞∏Ëøú‰øùÊåÅ‰∏≠‰∫åÁöÑÁÅµÈ≠ÇÔºåÂú®‰∫åÊ¨°ÂÖÉ‰∏ñÁïåÂø´‰πêÈÅ®Ê∏∏ÔºÅüí´'
        };
        
        // ‰ΩøÁî®Â±èÂπï‰∏≠ÂøÉ‰ΩçÁΩÆÔºåÈÅøÂÖçÂÆö‰ΩçÂÅèÁßª
        const centerX = window.innerWidth / 2;
        const topY = window.innerHeight * 0.3; // Âú®Â±èÂπï‰∏äÊñπ30%‰ΩçÁΩÆÊòæÁ§∫
        
        createEnhancedFloatingText(wishes[game], centerX, topY);
        createClickFeedback(event.currentTarget);
    }

    // ÊµÆÂä®ÊñáÂ≠óÂáΩÊï∞
    function createEnhancedFloatingText(text, x, y) {
        const element = document.createElement('div');
        element.className = 'floating-element';
        element.style.top = y + 'px';
        element.innerHTML = `
            <div style="
                background: linear-gradient(135deg, #FF6B9D, #C66FBC, #7C4DFF); 
                padding: 15px 20px; 
                border-radius: 25px; 
                color: white; 
                font-weight: bold; 
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                border: 2px solid rgba(255,255,255,0.3);
                text-align: center;
                max-width: 90vw;
                width: fit-content;
                margin: 0 auto;
                font-size: 1em;
                line-height: 1.4;
            ">${text}</div>
        `;
        document.body.appendChild(element);
        
        setTimeout(() => element.remove(), 6000);
        
        return element;
    }

    // ÁÇπÂáªÂèçÈ¶àÂáΩÊï∞
    function createClickFeedback(target) {
        target.style.transform = 'scale(0.95)';
        setTimeout(() => {
            target.style.transform = 'scale(1.05)';
            setTimeout(() => {
                target.style.transform = '';
            }, 150);
        }, 100);
    }

    // ËÆ∏ÊÑøÂäüËÉΩ
    function submitWish() {
        const wish = document.getElementById('wishInput').value.trim();
        if (wish) {
            createEnhancedFloatingText('üåü ÊÑøÊúõÂ∑≤ÊäïÂÖ•ËÆ∏ÊÑøÊ±†ÔºÅÊòüÊòü‰ª¨ÈÉΩÂê¨Âà∞‰∫ÜÔΩû', window.innerWidth / 2, window.innerHeight / 3);
            
            // ÂàõÂª∫ËÆ∏ÊÑøÁâπÊïà
            createWishEffect();
            
            // ÊòæÁ§∫ÁªßÁª≠ÊåâÈíÆ
            document.getElementById('continueBtn').style.display = 'inline-block';
            
            // Ê∏ÖÁ©∫ËæìÂÖ•Ê°Ü
            document.getElementById('wishInput').value = '';
            
            // ‰∏Ä‰∫õÂ∞èÊòüÊòüÁâπÊïà
            for (let i = 0; i < 15; i++) {
                setTimeout(() => createStar(), i * 100);
            }

            // --- NEW: Randomly choose game type ---
            const gameType = Math.random() < 0.5 ? 'textAdventure' : 'singleCharacter'; // 50/50 Ê¶ÇÁéá

            if (gameType === 'textAdventure') {
                startTextAdventure();
            } else {
                showSingleCharacterPopup();
            }

        } else {
            createEnhancedFloatingText('üí´ ËØ∑ÂÖàÂÜô‰∏ã‰Ω†ÁöÑÊÑøÊúõÂì¶ÔΩû', window.innerWidth / 2, window.innerHeight / 3);
        }
    }

    // ËÆ∏ÊÑøÁâπÊïà
    function createWishEffect() {
        const colors = ['#FFD700', '#FF69B4', '#00CED1', '#7C4DFF', '#FF6B9D'];
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        
        for (let i = 0; i < 20; i++) {
            const star = document.createElement('div');
            star.innerHTML = '‚ú®';
            star.style.position = 'fixed';
            star.style.left = centerX + 'px';
            star.style.top = centerY + 'px';
            star.style.fontSize = '1.5em';
            star.style.color = colors[Math.floor(Math.random() * colors.length)];
            star.style.pointerEvents = 'none';
            star.style.zIndex = '2000';
            document.body.appendChild(star);
            
            const endX = centerX + (Math.random() - 0.5) * 300;
            const endY = centerY + (Math.random() - 0.5) * 300;

            star.animate([
                { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                { transform: `translate(${endX - centerX}px, ${endY - centerY}px) scale(1)`, opacity: 1 },
                { transform: `translate(${endX - centerX}px, ${endY - centerY}px) scale(0)`, opacity: 0 }
            ], {
                duration: 2000,
                easing: 'ease-out'
            }).onfinish = () => star.remove();
        }
    }

    // ÂàõÂª∫Â∞èÊòüÊòü
    function createStar() {
        const star = document.createElement('div');
        star.innerHTML = ['‚≠ê', '‚ú®', 'üåü'][Math.floor(Math.random() * 3)];
        star.style.position = 'fixed';
        star.style.left = Math.random() * window.innerWidth + 'px';
        star.style.top = '-20px';
        star.style.fontSize = '1.2em';
        star.style.pointerEvents = 'none';
        star.style.zIndex = '1500';
        document.body.appendChild(star);
        
        star.animate([
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 50}px) rotate(360deg)`, opacity: 0 }
        ], {
            duration: 3000 + Math.random() * 2000,
            easing: 'linear'
        }).onfinish = () => star.remove();
    }

        // ËÆ∏ÊÑøÂ∞èË¥¥Â£´
    function showWishTips() {
        const content = `
            <h2 style="color: #4F2FBF;">üí° ËÆ∏ÊÑøÂ∞èË¥¥Â£´</h2> 
            <div style="text-align: left; line-height: 1.8;">                
                <p style="color: #b8860b; font-size: 0.9em; margin-top: 20px;"> 
                    ‚ú® ÂΩìÊäïÂÖ•ËÆ∏ÊÑøÊ±†Êó∂ÔºåÂ∞Ü‰ºöÊúâ‰∏§‰ΩçÁ•ûÁßòÁöÑËßíËâ≤ÈöèÊú∫Âá∫Áé∞Âì¶ÔºÅü•≥
                </p>
            </div>
        `;
        showDialog(content);
    }

    // ÊîæÁÉüËä±
    function launchFireworks() {
        for (let i = 0; i < 10; i++) {
            setTimeout(() => createFirework(), i * 300);
        }
    }

    function createFirework() {
        const colors = ['#FF6B9D', '#C66FBC', '#7C4DFF', '#536DFE', '#66B3F9', '#FFD700'];
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight * 0.5;
        
        const firework = document.createElement('div');
        firework.className = 'firework';
        firework.style.left = x + 'px';
        firework.style.top = y + 'px';
        document.body.appendChild(firework);
        
        // ÂàõÂª∫ÁàÜÁÇ∏Á≤íÂ≠ê
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'firework-particle';
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            const angle = (Math.PI * 2 * i) / 20;
            const velocity = 50 + Math.random() * 50;
            const vx = Math.cos(angle) * velocity;
            const vy = Math.sin(angle) * velocity;
            
            particle.style.transform = `translate(${vx}px, ${vy}px)`;
            firework.appendChild(particle);
        }
        
        setTimeout(() => firework.remove(), 1000);
    }

    // ÂàõÂª∫ÂΩ©Â∏¶
    function createConfetti() {
        const colors = ['#FF6B9D', '#C66FBC', '#7C4DFF', '#FFD700', '#66B3F9'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.zIndex = '1000';
                confetti.style.pointerEvents = 'none';
                document.body.appendChild(confetti);
                
                confetti.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], {
                    duration: 3000 + Math.random() * 2000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).onfinish = () => confetti.remove();
            }, i * 50);
        }
    }

        // ÊòæÁ§∫ÁßòÂØÜÊ∂àÊÅØ
function showSecretMessage() {
    const content = `
        <h2 style="color: #FFD700;">üéÅ ‰∏ìÂ±û‰∫éÊàëÁªôÊ†óÂ≠êÁöÑÁßòÂØÜ</h2> 
        <p style="margin: 20px 0; line-height: 1.8;">
            ÂÖ∂ÂÆûÊàëÂÅ∑ÂÅ∑ÂáÜÂ§á‰∫ÜËøô‰∏™Á•ùÁ¶èÈ°µÈù¢Âæà‰πÖ‰∫ÜÂë¢ÔΩû<br>
            Â§ßÊ¶ÇÂú®ÂÖ´ÊúàÂàùÈÇ£Êó∂ÂÄôÂ∞±Âú®ÂáÜÂ§á‰∫ÜÂêßÂïäÂìàÂìà<br><br>
            ËôΩÁÑ∂ËØ¥‰∏≠ÈÄîÊàëÂ∞±Êúâ‰∫õÊ≤°Âøç‰ΩèÂíåÊ†óÂ≠êÊèêËøá‰∫ÜÂòøÂòø<br>
            Âú®Ê≠§...ÊØè‰∏Ä‰∏™Âä®Áîª„ÄÅÊØè‰∏ÄÂè•Á•ùÁ¶è<br>
            ÈÉΩÊòØÊÉ≥ÂëäËØâ‰Ω†Ôºö<br><br>
            <strong style="font-size: 1.3em; color: #FFD700;"> 
                ‰Ω†ÂØπÊàëÊù•ËØ¥ÁªùÂØπÊòØ‰∏Ä‰∏™ÂæàÁâπÂà´ÁöÑÂ≠òÂú®ÔºÅ
            </strong><br><br>
            ÊàñËÆ∏‰∏Ä‰∫õÈïøÁ∫¶ÂÆöÁ°ÆÂÆûÊòØÊó†Ê≥ïÂÆûÁé∞<br>
                ‰ΩÜÊàë‰∏ÄÂÆö‰ºöÂä™ÂäõÊúùÁùÄÂÆûÁé∞ÁöÑË∑Ø‰∏äËµ∞‰∏ãÂéªÁöÑ<br>
                ÊàëË¢´‰Ω†ÊîπÂèò‰∫ÜÂæàÂ§ö<br>
                ÊàñËÆ∏ÊúâÂ§Ñ‰∫ãÊñπÂºèÔºåÂØπ‰∏ñÁïåÁöÑËÆ§Áü•Â∫¶Á≠âÁ≠âÂêß<br>
                ‰Ω†ËôΩÁÑ∂ËØ¥ËøáËá™Â∑±ÂæàÈöæÂõ†Âà´‰∫∫ÊîπÂèò<br>
                ‰ΩÜÊòØ‰πü‰∏çÂ¶®Á¢çÊàëÁªô‰Ω†Â∏¶Êù•Âø´‰πêÂëÄÂòøÂòø<br>
            ÊàëÂ∏åÊúõÊú™Êù•ÁöÑÊØè‰∏ÄÂπ¥<br>
            ÈÉΩËÉΩ‰∏∫‰Ω†ÈÄÅ‰∏äÁîüÊó•Á•ùÁ¶èÔºÅ<br><br>            
            PSÔºöÊÑüË∞¢Ê∑∑ÂÖÉËÄÅÂ∏àÂú®2020Âπ¥Êèê‰æõÁöÑÈü≥È¢ëÂìàÂìàÂìà<br>ÊàñËÆ∏Ê†óÂ≠êÊÉ≥Âà∞‰∫ÜÂì¶ÔºåÊ≠§Èü≥‰πêÂ∞±ÊòØÈÇ£‰ΩçÂñúÊ¨¢Âú®coserËÉåÂêéÁî®Âî¢ÂëêÂêπÂØπÂ∫îËßíËâ≤Èü≥‰πêÁöÑÁâàÊú¨ÔºÅÔºàÂèØËÉΩÂõ†‰∏∫ÊàëÂà∑Âà∞ÁöÑËßÜÈ¢ëÈÉΩÊòØËøôÁ±ªÁöÑÂêßÂìàÂìàÔºâ
            <br>Âç≥‰ΩøËä±‰∫ÜÊàëËøëÂçä‰∏™Â§öÊúàÁöÑÊó∂Èó¥ÔºåËØ•ÁΩëÈ°µËøòÊòØÊúâÂæàÂ§ö‰∏çË∂≥Ôºå‰∏çËøá...Â≠¶‰π†Â∞±ÊòØË¶ÅÂæ™Â∫èÊ∏êËøõÂòõÔºå‰ª•Âêé‰∏ÄÂÆö‰ºöË∂äÊù•Ë∂äÂÆåÁæéÁöÑÔºÅ
            <br><br>‰Ω†ËÆ∞ÂæóË¶Å‰∏ÄÁõ¥‰øùÊåÅÈÇ£‰ªΩÂèØÁà±ÁöÑ"ÊäΩË±°"Âë¢ÔºÅÔºàÂ∞èÂ£∞Ôºâ<br><br> 
            <div class="secret-tip-box">
                <strong>ÊúâÈöêËóèÂ∞èÂΩ©ËõãÂì¶Ôºö</strong><br>
                ‚Ä¢ ÁîµËÑë‰∏äËøôÊ†∑ÊåâÈîÆÁõòÁúãÁúãÔºö‚Üë‚Üë‚Üì‚Üì‚Üê‚Üí‚Üê‚ÜíBA<br>
                ‚Ä¢ Èü≥‰πêÊí≠ÊîæÂô®ÊúâÂ∞èÊÉäÂñúÔºåÂ§öÁÇπÂá†Ê¨°ËØïËØïÁúãÔºü<br>
                ‚Ä¢ <strong>Âú®Á¨¨1„ÄÅ2„ÄÅ4Âú∫ÊôØ‰∏≠ÔºåÁÇπÂáªÂç°Áâá‰∏äÁöÑüå∞ÊàñËÄÖÊï∞Â≠óÔºå‰ºöÊúâ‰∏ìÂ±ûÁ•ùÁ¶èÂì¶ÔºÅ</strong><br>
                ‚Ä¢ <strong>Á¨¨5Âú∫ÊôØÁöÑÁîüÊó•Á•ùÁ¶èÂ¢ô‰∏äÔºåÊØè‰∏™Á•ùÁ¶èÂç°ÁâáÈÉΩËÉΩË¢´ÁÇπ‰∫ÆÔºåÂø´ÂéªËØïËØïÔºÅ</strong><br>
                ‚Ä¢ <strong>Âú®Á¨¨6Âú∫ÊôØÁöÑÊúÄÂêéÁïôË®ÄÈáåÔºåÁÇπÁÇπÂç°ÁâáÁöÑÁ©∫ÁôΩËÉåÊôØÔºå‰ºöÊúâÂ∞èÁ©∫ÂüéÁöÑÊÇÑÊÇÑËØùÔºÅ</strong><br>
                ‚Ä¢ ÊØè‰∏™Âú∫ÊôØÈÉΩÂèØ‰ª•Âà∞Â§ÑÁÇπÁÇπÁúã<br>
                ‚Ä¢ ËØïËØïÊåâ‰ΩèÂ±èÂπïÊªëÂä®Ôºå‰ºöÊúâÁ•ûÁßòemojiË∑üÈöè~
            </div>
        </p>
    `;
    showDialog(content);
}

    // ÂØπËØùÊ°ÜÊéßÂà∂
    function showDialog(content) {
        const dialogContent = document.getElementById('dialogContent');
        const dialogOverlay = document.getElementById('dialogOverlay');
        const dialogBox = document.getElementById('dialogBox');
        
        dialogContent.innerHTML = content;
        dialogOverlay.style.display = 'block';
        dialogBox.style.display = 'block';
        
        // Á°Æ‰øùÂØπËØùÊ°ÜÊ≠£Á°ÆÂÆö‰Ωç
        setTimeout(() => {
            dialogBox.scrollTop = 0; // ÈáçÁΩÆÊªöÂä®‰ΩçÁΩÆÂà∞È°∂ÈÉ®
        }, 100);
        
        // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
        document.body.style.overflow = 'hidden';
    }

    function closeDialog() {
        document.getElementById('dialogOverlay').style.display = 'none';
        document.getElementById('dialogBox').style.display = 'none';
        
        // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
        document.body.style.overflow = '';
    }

        function addTouchOptimization() {
        const dialogBox = document.getElementById('dialogBox');
        const photoViewerContent = document.getElementById('photoViewerContent');
        
        // Èò≤Ê≠¢ÂØπËØùÊ°ÜÂÜÖÂÆπÊªöÂä®Êó∂Ëß¶ÂèëËÉåÊôØÊªöÂä®
        dialogBox.addEventListener('touchstart', function(e) {
            e.stopPropagation();
        }, { passive: true }); // ‰ΩøÁî® passive:true ÊèêÂçáÊªöÂä®ÊÄßËÉΩ
        
        dialogBox.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        }, { passive: true });
        
        // ÁÇπÂáªÂØπËØùÊ°ÜÂÜÖÂÆπÂå∫Âüü‰∏çÂÖ≥Èó≠ÂØπËØùÊ°ÜÔºàÈùûÊåâÈíÆÂå∫ÂüüÔºâ
        dialogBox.addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') { // Â¶ÇÊûú‰∏çÊòØÊåâÈíÆÔºåÂàôÈòªÊ≠¢‰∫ã‰ª∂‰º†Êí≠
                e.stopPropagation();
            }
        });

        // Èò≤Ê≠¢ÂõæÁâáÊü•ÁúãÂô®ÂÜÖÂÆπÊªöÂä®Êó∂Ëß¶ÂèëËÉåÊôØÊªöÂä®ÊàñÂÖ≥Èó≠
        if (photoViewerContent) {
            photoViewerContent.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            }, { passive: true });
            photoViewerContent.addEventListener('touchmove', function(e) {
                e.stopPropagation();
            }, { passive: true });
            photoViewerContent.addEventListener('click', function(e) {
                e.stopPropagation(); // ÁÇπÂáªÂõæÁâáÊü•ÁúãÂô®ÂÜÖÂÆπ‰∏çÂÖ≥Èó≠
            });
        }
    }

    // ÈáçÊñ∞ÂºÄÂßã
    function restart() {
        currentScene = 1;
        updateProgress();
        document.querySelectorAll('.scene').forEach(scene => {
            scene.classList.remove('active');
        });
        document.getElementById('scene1').classList.add('active');
        // ÈöêËóèËÆ∏ÊÑøÊàêÂäüÂêéÁöÑÁªßÁª≠ÊåâÈíÆ
        document.getElementById('continueBtn').style.display = 'none';
    }
    
    // === Âú∫ÊôØ‰∏ìÂ±ûÂΩ©ËõãËß¶ÂèëÂáΩÊï∞ ===

    // Âú∫ÊôØ1ÔºöÊ†óÂ≠êÂõæÊ†áÁ•ùÁ¶è
    function triggerChestnutBlessing(event) {
        event.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†ÔºåÈò≤Ê≠¢Ëß¶ÂèëÂÖ∂‰ªñÁÇπÂáªÊïàÊûú
        createEnhancedFloatingText('ÊÑøÊ†óÂ≠êüå∞Ê∞∏ËøúÂèØÁà±ÔºåÂÖÉÊ∞îÊª°Êª°ÔºåÂ≠¶‰∏öÈ°∫ÈÅÇÔºåÂâçÁ®ã‰ººÈî¶ÔºÅ', event.clientX, event.clientY);
    }

    // Âú∫ÊôØ2ÔºöÂ§©Êï∞ËÆ°Êï∞Á•ùÁ¶è
    function triggerDaysCounterBlessing(event) {
        event.stopPropagation();
        createEnhancedFloatingText('581Â§©ÁöÑÁßØÁ¥ØÔºåÊÑøÊ†óÂ≠êÂ≠¶Âåª‰πãË∑ØÊ≠•Ê≠•‰∏∫Ëê•ÔºåÂäüÂæ∑ÂúÜÊª°ÔºÅ', event.clientX, event.clientY);
    }

    // Âú∫ÊôØ4ÔºöËÆ∏ÊÑøÊòüÁ•ùÁ¶è
    function triggerWishStarBlessing(event) {
        event.stopPropagation();
        createEnhancedFloatingText('ÊÑøÊ†óÂ≠êÊâÄÊ±ÇÁöÜÂ¶ÇÊÑøÔºåÊòüÂÖâ‰∏∫‰Ω†ÊåáÂºïÊñπÂêëÔºÅ', event.clientX, event.clientY);
    }

    // Âú∫ÊôØ5ÔºöÁ•ùÁ¶èÂç°ÁâáÁÇπÂáªÊïàÊûú‰∏éÁ•ùÁ¶è
    function triggerWishCardBlessing(event) {
        event.stopPropagation();
        createEnhancedFloatingText('‚ú®Ëøô‰ªΩÁ•ùÁ¶èÂ∑≤Á≠æÊî∂ÔºåÊ†óÂ≠êÁöÑÊú™Êù•ÂÖÖÊª°ÂÖâÂΩ©ÔºÅ', event.clientX, event.clientY);
        // ‰∏Ä‰∏™‰∏¥Êó∂ÁöÑËßÜËßâÂèçÈ¶àÂà∞Âç°ÁâáÊú¨Ë∫´
        event.currentTarget.style.transition = 'none'; // Á¶ÅÁî®ËøáÊ∏°ÊïàÊûúÔºåÂÆûÁé∞Âç≥Êó∂ÂèçÈ¶à
        event.currentTarget.style.filter = 'brightness(1.5) saturate(1.5)'; // Êèê‰∫ÆÂç°Áâá
        setTimeout(() => {
            event.currentTarget.style.transition = 'all 0.3s ease'; // ÈáçÊñ∞ÂêØÁî®ËøáÊ∏°ÊïàÊûú
            event.currentTarget.style.filter = ''; // ÊÅ¢Â§çÂéüÂßã‰∫ÆÂ∫¶
        }, 300);
    }

    // Âú∫ÊôØ6ÔºöÊúÄÂêéÁïôË®ÄÂç°ÁâáËÉåÊôØÁ•ùÁ¶è
    function triggerFinalCardBlessing(event) {
        // Á°Æ‰øùÁÇπÂáªÁõÆÊ†áÊòØÁéªÁíÉÂç°ÁâáÊú¨Ë∫´ÔºåËÄå‰∏çÊòØÈáåÈù¢ÁöÑÊåâÈíÆÊàñÊñáÊú¨ÔºàÈÅøÂÖçÂÜ≤Á™ÅÔºâ
        const target = event.target;
        if (target.classList.contains('glass-card') || 
            (target.parentElement && target.parentElement.classList.contains('glass-card') && !target.closest('.btn'))) {
            
            event.stopPropagation();
            createEnhancedFloatingText('Â∞èÁ©∫Âüé‰ºö‰∏ÄÁõ¥Èô™‰º¥Ê†óÂ≠êÁöÑÔºåÊÑø‰Ω†ÊØèÂ§©ÈÉΩÁ¨ëÂÆπÁªΩÊîæÔºÅ', event.clientX, event.clientY);
        }
    }

    // Ê†πÊçÆÂú∫ÊôØÂè∑Ê∑ªÂä†ÂØπÂ∫îÁöÑÁÇπÂáªÁõëÂê¨Âô®
    function addSceneSpecificClickListeners(sceneNumber) {
        // ÂÖàÁßªÈô§ÊâÄÊúâÊóßÁöÑÁõëÂê¨Âô®ÔºåÈò≤Ê≠¢ÈáçÂ§çÁªëÂÆö
        removeSceneSpecificClickListeners(); 

        if (sceneNumber === 1) {
            const chestnutIcon = document.querySelector('#scene1 .chestnut-icon');
            if (chestnutIcon) chestnutIcon.addEventListener('click', triggerChestnutBlessing);
        } else if (sceneNumber === 2) {
            const daysCounter = document.getElementById('daysCounter');
            if (daysCounter) daysCounter.addEventListener('click', triggerDaysCounterBlessing);
        } else if (sceneNumber === 4) {
            const wishStar = document.querySelector('#scene4 .chestnut-icon');
            if (wishStar) wishStar.addEventListener('click', triggerWishStarBlessing);
        } else if (sceneNumber === 5) {
            const wishCards = document.querySelectorAll('.wish-card');
            wishCards.forEach(card => card.addEventListener('click', triggerWishCardBlessing));
        } else if (sceneNumber === 6) {
            const finalCard = document.querySelector('#scene6 .glass-card');
            if (finalCard) finalCard.addEventListener('click', triggerFinalCardBlessing);
        }
    }

    // ÁßªÈô§ÊâÄÊúâÂú∫ÊôØÁâπÂÆöÁöÑÁÇπÂáªÁõëÂê¨Âô®
    function removeSceneSpecificClickListeners() {
        // Âú∫ÊôØ1
        const chestnutIcon1 = document.querySelector('#scene1 .chestnut-icon');
        if (chestnutIcon1) chestnutIcon1.removeEventListener('click', triggerChestnutBlessing);

        // Âú∫ÊôØ2
        const daysCounter = document.getElementById('daysCounter');
        if (daysCounter) daysCounter.removeEventListener('click', triggerDaysCounterBlessing);

        // Âú∫ÊôØ4
        const wishStar4 = document.querySelector('#scene4 .chestnut-icon');
        if (wishStar4) wishStar4.removeEventListener('click', triggerWishStarBlessing);

        // Âú∫ÊôØ5
        const wishCards = document.querySelectorAll('.wish-card');
        wishCards.forEach(card => card.removeEventListener('click', triggerWishCardBlessing));
        
        // Âú∫ÊôØ6
        const finalCard = document.querySelector('#scene6 .glass-card');
        if (finalCard) finalCard.removeEventListener('click', triggerFinalCardBlessing);
    }


    // Èü≥‰πêÊí≠Êîæ
function toggleMusic() {
    const player = document.getElementById('musicPlayer');
    const audio = document.getElementById('backgroundMusic');

    // Ê£ÄÊü•Èü≥È¢ëÊòØÂê¶Â∑≤ÂáÜÂ§áÂ•ΩÔºåÈò≤Ê≠¢Áî®Êà∑Âú®Èü≥È¢ëÂä†ËΩΩÂÆåÊàêÂâçÁÇπÂáª
    if (!audioInitialized) {
        createEnhancedFloatingText('‚ùå Èü≥‰πêÊ≠£Âú®Âä†ËΩΩÔºåËØ∑Á®çÂÄô...', window.innerWidth / 2, 200);
        return;
    }
    
    // === Èü≥‰πêÊí≠ÊîæÂô®ÂΩ©ËõãËÆ°Êï∞ ===
    musicToggleCount++;
    if (musicToggleCount === 5) {
        // Ëß¶ÂèëÈü≥‰πêÊí≠ÊîæÂô®ÂΩ©Ëõã
        createEnhancedFloatingText('üíñ ÊÅ≠ÂñúÂèëÁé∞Èü≥‰πêÂΩ©ËõãÔºÅÊÑø‰Ω†ÁöÑÁîüÊ¥ªÂÖÖÊª°ÁæéÂ¶ôÊóãÂæãÔºÅ', window.innerWidth / 2, 100);
        createMusicFireflies(player); // Âè¨Âî§Èü≥Á¨¶Ëê§ÁÅ´Ëô´
        // ÂèØÈÄâÔºöÊí≠ÊîæÁâπÊÆäÈü≥Êïà
        const specialSound = new Audio(SOUND_BASE_PATH + 'toprincess.ogg'); // ÂÅáËÆæ‰Ω†Êúâ‰∏Ä‰∏™ÁâπÊÆäÈü≥Êïà
        specialSound.volume = 0.5;
        specialSound.play().catch(e => console.warn("Special sound play error:", e));
        musicToggleCount = 0; // ÈáçÁΩÆËÆ°Êï∞Âô®ÔºåÂèØÂÜçÊ¨°Ëß¶ÂèëÊàñËÆæÁΩÆ‰∏∫-1Á¶ÅÁî®
    }

    if (musicPlaying) {
        // --- ÊöÇÂÅúÈü≥‰πê ---
        audio.pause();
        musicPlaying = false;
        player.classList.remove('playing');
        player.innerHTML = '<span style="font-size: 1.5em;">üîá</span>';
        createEnhancedFloatingText('üîá Èü≥‰πêÂ∑≤ÊöÇÂÅú', window.innerWidth / 2, 200);
    } else {
        // --- Êí≠ÊîæÈü≥‰πê ---
        audio.play().then(() => {
            musicPlaying = true;
            player.classList.add('playing');
            player.innerHTML = '<span style="font-size: 1.5em;">üéµ</span>';
            createEnhancedFloatingText('üéµ Èü≥‰πêÂ∑≤ÂºÄÂßãÊí≠Êîæ', window.innerWidth / 2, 200);
            createMusicNotes(player);
        }).catch(error => {
            // Â¶ÇÊûúÊí≠ÊîæÂ§±Ë¥•Ôºà‰æãÂ¶ÇÂú®Êüê‰∫õ‰∏•Ê†ºÁöÑÊµèËßàÂô®Á≠ñÁï•‰∏ãÔºâ
            console.error('Èü≥‰πêÊí≠ÊîæÂ§±Ë¥•:', error);
            createEnhancedFloatingText('‚ùå Êí≠ÊîæÂ§±Ë¥•ÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÊàñÊ£ÄÊü•ÊµèËßàÂô®ËÆæÁΩÆ', window.innerWidth / 2, 200);
        });
    }
}

    // ÈîÆÁõòÂΩ©Ëõã
    function addKeyboardEasterEgg() {
        let sequence = [];
        const code = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
        
        document.addEventListener('keydown', (e) => {
            sequence.push(e.key);
            sequence = sequence.slice(-10);
            
            if (sequence.join(',') === code.join(',')) {
                activateEasterEgg();
            }
        });
    }

    function activateEasterEgg() {
    if (easterEggActivated) return; // ÈÅøÂÖçÈáçÂ§çÊøÄÊ¥ª

    document.body.style.animation = 'rainbow 2s linear infinite';
    createEnhancedFloatingText('üéÆ ÊÅ≠ÂñúÂèëÁé∞ÂΩ©ËõãÔºÅ‰Ω†ÁúüÁöÑÂæàÁªÜÂøÉÂë¢ÔºåÊ†óÂ≠êÔºÅ', window.innerWidth / 2, 100);
    easterEggActivated = true; // Ê†áËÆ∞ÂΩ©ËõãÂ∑≤ÊøÄÊ¥ª

    // ÂΩ©ËôπÂä®Áîª
    if (!document.querySelector('#rainbowStyle')) {
        const style = document.createElement('style');
        style.id = 'rainbowStyle';
        style.textContent = `
            @keyframes rainbow {
                0% { filter: hue-rotate(0deg); }
                100% { filter: hue-rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }

    if (cursorChestnut) {
        originalCursorChestnutEmoji = cursorChestnut.textContent; // ‰øùÂ≠òÂéüÂßãÊ†óÂ≠ê
        cursorChestnut.textContent = 'ü©∫'; // ÊõøÊç¢‰∏∫Âê¨ËØäÂô®emoji
        createEnhancedFloatingText('üë©‚Äç‚öïÔ∏è ÊÑø‰Ω†Â≠¶‰∏öÊúâÊàêÔºåÊàê‰∏∫‰∏ÄÂêç‰ºòÁßÄÁöÑÂåªÁîüÔºÅ', window.innerWidth / 2, 250);
        // ‰πüÂèØ‰ª•ËÆ©Â∞æÈöèÁöÑÂøÉÂΩ¢ÂèòÊàêÁâπÊÆäemoji
        hearts.splice(0, hearts.length, ...specialEmojis); // ÊõøÊç¢heartsÊï∞ÁªÑÂÜÖÂÆπ
    }

    // ÊåÅÁª≠5ÁßíÂêéÊÅ¢Â§ç
    setTimeout(() => {
        document.body.style.animation = '';
        easterEggActivated = false; // ÂÖÅËÆ∏ÂÜçÊ¨°Ëß¶Âèë
        // ÊÅ¢Â§çÂéüÂßãÊ†óÂ≠êÂõæÊ†á
        if (cursorChestnut) {
            cursorChestnut.textContent = originalCursorChestnutEmoji;
        }
        // ÊÅ¢Â§çÂéüÂßãÂøÉÂΩ¢emoji
        hearts.splice(0, hearts.length, '‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üíñ', 'üíò', 'üíï');
    }, 8000); // Âª∂ÈïøÊåÅÁª≠Êó∂Èó¥Âà∞8Áßí
}

// ÂΩìÈ°µÈù¢ÊâÄÊúâËµÑÊ∫êÂä†ËΩΩÂÆåÊàêÂêéÊâßË°å
window.addEventListener('load', () => {
    // È¶ñÂÖàÂàõÂª∫Èº†Ê†áË∑üÈöèÁöÑÊ†óÂ≠êÂÖÉÁ¥†ÔºåÁ°Æ‰øùÂÆÉÂú®ÂÖ∂‰ªñ‰∫ã‰ª∂ÁõëÂê¨ÂâçÂ∞±Â≠òÂú®
    cursorChestnut = createEmojiElement(chestnutEmoji, 0, 0, true);
    currentChestnutX = 0; 
    currentChestnutY = 0;
    document.body.style.cursor = 'none';

    createParticles();
    updateProgress();
    addKeyboardEasterEgg();
    addTouchOptimization();

    // Ëé∑ÂèñÂä†ËΩΩÁïåÈù¢ÁöÑDOMÂÖÉÁ¥†
    const loadingOverlay = document.getElementById('loadingOverlay');

    // ÂºÄÂßãÈ¢ÑÂä†ËΩΩÊâÄÊúâÊ†∏ÂøÉËµÑÊ∫êÔºåÂÆåÊàêÂêéÊâßË°åÂõûË∞ÉÂáΩÊï∞
    preloadAssets(() => {
        // ËµÑÊ∫êÂä†ËΩΩÂÆåÊàêÂêéÔºå‰∏∫Âä†ËΩΩÁïåÈù¢Ê∑ªÂä† 'hidden' Á±ª‰ΩøÂÖ∂Ê∑°Âá∫
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
            // Âú®Âä†ËΩΩÂä®ÁîªÁªìÊùüÂêéÂÜçÁßªÈô§DOMÂÖÉÁ¥†ÔºåÈò≤Ê≠¢Èó™ÁÉÅ
            loadingOverlay.addEventListener('transitionend', () => {
                loadingOverlay.remove();
            }, { once: true });
        }
        
        // ÂàùÂßãÂåñÈü≥È¢ë
        initializeAudio();
        
        // Âª∂ËøüÊòæÁ§∫Êìç‰ΩúÊèêÁ§∫
        setTimeout(() => {
            if (currentScene === 1) {
                createEnhancedFloatingText('üí° Â∞èÊèêÁ§∫ÔºöÈ°µÈù¢ÈöêËóè‰∫ÜËÆ∏Â§öÂΩ©ËõãÔºåÂèØ‰ª•Âà∞Â§ÑÁÇπÁÇπÁúãÂì¶ÔºÅ', window.innerWidth / 2, 100);
            }
        }, 1200); // Á®çÂæÆÂ¢ûÂä†Âª∂ËøüÔºåÁ≠âÂæÖÂä†ËΩΩÁïåÈù¢ÂÆåÂÖ®Ê∂àÂ§±

        addGlobalSceneClickListeners();
        addSceneSpecificClickListeners(currentScene);
    });
});

        // Èü≥È¢ëÂàùÂßãÂåñ
    function initializeAudio() {
        const audio = document.getElementById('backgroundMusic');
        audio.volume = 0.3; // ËÆæÁΩÆ‰∏Ä‰∏™ÂêàÈÄÇÁöÑÈªòËÆ§Èü≥Èáè
        
        // ÁõëÂê¨Èü≥È¢ëÊòØÂê¶ÂèØ‰ª•Êí≠Êîæ
        audio.addEventListener('canplay', () => {
            console.log('Èü≥È¢ëÂ∑≤ÂáÜÂ§áÂ∞±Áª™ÔºåÂèØ‰ª•Êí≠Êîæ„ÄÇ');
            audioInitialized = true; // ËÆæÁΩÆÊ†áÂøó‰Ωç
        });
        
        audio.addEventListener('error', (e) => {
            console.error('Èü≥È¢ëÂä†ËΩΩÈîôËØØ:', e);
            // Âú®È°µÈù¢‰∏äÁªôÁî®Êà∑‰∏Ä‰∏™Ê∏ÖÊô∞ÁöÑÊèêÁ§∫
            createEnhancedFloatingText('ÂæàÊä±Ê≠âÔºåËÉåÊôØÈü≥‰πêÂä†ËΩΩÂ§±Ë¥•‰∫ÜÔºÅ', window.innerWidth / 2, 100);
        });
        
        // ÊâãÂä®Ëß¶ÂèëÂä†ËΩΩ
        audio.load();
    }

    // === Èü≥‰πêÊí≠ÊîæÂô®ÁâπÊÆäÈü≥Á¨¶Ëê§ÁÅ´Ëô´ÊïàÊûú ===
    function createMusicFireflies(player) {
        const colors = ['#FFD700', '#FF69B4', '#00CED1', '#7C4DFF', '#FF6B9D'];
        for (let i = 0; i < 15; i++) {
            setTimeout(() => {
                const firefly = document.createElement('div');
                firefly.textContent = '‚ú®'; // ‰ΩøÁî®ÊòüÊòüÊõø‰ª£Èü≥Á¨¶ÔºåÊõ¥ÂÉèËê§ÁÅ´Ëô´
                firefly.style.position = 'fixed';
                firefly.style.left = (player.offsetLeft + player.offsetWidth / 2 + (Math.random() - 0.5) * 80) + 'px';
                firefly.style.top = (player.offsetTop + player.offsetHeight / 2 + (Math.random() - 0.5) * 80) + 'px';
                firefly.style.fontSize = `${1 + Math.random()}em`;
                firefly.style.color = colors[Math.floor(Math.random() * colors.length)];
                firefly.style.zIndex = '1001';
                firefly.style.pointerEvents = 'none';
                firefly.style.opacity = '0'; // ÂàùÂßãÈÄèÊòé
                document.body.appendChild(firefly);
                
                // Â§çÊùÇÂä®ÁîªÔºåÊ®°ÊãüËê§ÁÅ´Ëô´È£ûËàû
                const startX = parseFloat(firefly.style.left);
                const startY = parseFloat(firefly.style.top);
                const endX = startX + (Math.random() - 0.5) * 200;
                const endY = startY - 150 - Math.random() * 100;

                firefly.animate([
                    { opacity: 0, transform: `translate(0px, 0px) scale(0.5)` },
                    { opacity: 1, transform: `translate(${endX - startX}px, ${endY - startY}px) scale(1.2)` },
                    { opacity: 0, transform: `translate(${endX - startX + (Math.random() - 0.5) * 50}px, ${endY - startY - 50}px) scale(0.8)` }
                ], {
                    duration: 4000 + Math.random() * 1000,
                    easing: 'ease-in-out',
                    iterations: 1
                }).onfinish = () => firefly.remove();
            }, i * 150);
        }
    }


    // Èü≥Á¨¶Âä®ÁîªÂáΩÊï∞
    function createMusicNotes(player) {
        const notes = ['üéµ', 'üé∂', '‚ô™', '‚ô´'];
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                const note = document.createElement('div');
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                note.style.position = 'fixed';
                note.style.left = (player.offsetLeft + Math.random() * 60) + 'px';
                note.style.top = (player.offsetTop + Math.random() * 60) + 'px';
                note.style.fontSize = '1.5em';
                note.style.color = '#FFD700';
                note.style.zIndex = '1001';
                note.style.pointerEvents = 'none';
                document.body.appendChild(note);
                
                note.animate([
                    { transform: 'translateY(0) scale(1)', opacity: 1 },
                    { transform: 'translateY(-100px) scale(0.5)', opacity: 0 }
                ], {
                    duration: 2000,
                    easing: 'ease-out'
                }).onfinish = () => note.remove();
            }, i * 300);
        }
    }

    // === Âú∫ÊôØÈÄöÁî®ÁÇπÂáªÂΩ©ËõãÁõëÂê¨Âô® ===
    function addGlobalSceneClickListeners() {
        document.querySelectorAll('.scene').forEach(scene => {
            scene.addEventListener('click', (e) => {
                // Âè™ÊúâÂΩìÁÇπÂáªÁõÆÊ†á‰∏çÊòØÊåâÈíÆÊàñÈìæÊé•Ôºå‰∏î‰∏çÊòØÁâπÂÆöÁöÑÂΩ©ËõãÂÖÉÁ¥†Êó∂ÊâçËß¶ÂèëÈÄöÁî®ÂΩ©Ëõã
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('.game-item') || e.target.closest('.chestnut-icon') || e.target.closest('.music-player')) {
                    return;
                }
                const randomMessages = [
                    'üåü ÊÑø‰Ω†ÊØèÂ§©ÈÉΩÊúâÂ∞èÁ°ÆÂπ∏ÔºÅ',
                    '‚ú® Â•ΩËøêÂ∏∏‰º¥ÔºåÂøÉÊÉ≥‰∫ãÊàêÔºÅ',
                    'üíñ Ê†óÂ≠êÊúÄÊ£íÔºåÊú™Êù•ÂèØÊúüÔºÅ',
                    'üòä ÊÑø‰Ω†Á¨ëÂÆπÂ∏∏Âú®ÔºåÂø´‰πêÊó†ËæπÔºÅ',
                    'üåà ÂÖÖÊª°Â∏åÊúõÔºåÂãáÊï¢ÂâçË°åÔºÅ'
                ];
                const message = randomMessages[Math.floor(Math.random() * randomMessages.length)];
                createEnhancedFloatingText(message, e.clientX, e.clientY - 30);
                createFireworkSparkle(e.clientX, e.clientY); // Â∞èÈó™ÁÉÅÊïàÊûú
            });
        });
    }

    // === Âú∫ÊôØÁâπÂÆöÁÇπÂáªÂΩ©ËõãÁõëÂê¨Âô® ===
    function addSceneSpecificClickListeners(sceneNumber) {
        // ÂΩ©Ëõã1: Âú∫ÊôØ3ÁöÑüå∞ÂõæÊ†áÁÇπÂáªÂΩ©Ëõã
        if (sceneNumber === 3) {
            const chestnutIcon = document.querySelector('#scene3 .chestnut-icon');
            if (chestnutIcon && !chestnutIcon.dataset.listenerAdded) {
                chestnutIcon.style.cursor = 'pointer'; // ÊèêÁ§∫ÂèØÁÇπÂáª
                chestnutIcon.addEventListener('click', (e) => {
                    e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Âú∫ÊôØÈÄöÁî®ÁÇπÂáª
                    createEnhancedFloatingText('üå∞ Ê†óÂ≠êÊú¨Ê†óÔºåÁã¨‰∏ÄÊó†‰∫åÔºÅ‰Ω†ÊòØÊúÄÂèØÁà±ÁöÑÔºÅ', e.clientX, e.clientY - 30);
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => createFloatingChestnut(e.clientX, e.clientY), i * 50);
                    }
                });
                chestnutIcon.dataset.listenerAdded = 'true'; // Ê†áËÆ∞Â∑≤Ê∑ªÂä†ÁõëÂê¨Âô®
            }
        }
    }

    // === ÂàõÂª∫Â∞èÈó™ÁÉÅÊïàÊûúÔºàÁî®‰∫éÈÄöÁî®Âú∫ÊôØÁÇπÂáªÔºâ===
    function createFireworkSparkle(x, y) {
        const colors = ['#FFD700', '#FFA500', '#FF6B9D', '#C66FBC'];
        for (let i = 0; i < 5; i++) {
            const sparkle = document.createElement('div');
            sparkle.style.position = 'fixed';
            sparkle.style.left = x + (Math.random() - 0.5) * 20 + 'px';
            sparkle.style.top = y + (Math.random() - 0.5) * 20 + 'px';
            sparkle.style.width = '5px';
            sparkle.style.height = '5px';
            sparkle.style.borderRadius = '50%';
            sparkle.style.background = colors[Math.floor(Math.random() * colors.length)];
            sparkle.style.zIndex = '2000';
            sparkle.style.pointerEvents = 'none';
            document.body.appendChild(sparkle);

            sparkle.animate([
                { transform: 'scale(0)', opacity: 1 },
                { transform: `scale(1.5) translate(${(Math.random() - 0.5) * 30}px, ${(Math.random() - 0.5) * 30}px)`, opacity: 0 }
            ], {
                duration: 500 + Math.random() * 300,
                easing: 'ease-out'
            }).onfinish = () => sparkle.remove();
        }
    }

    // === Ê†óÂ≠êÂõæÊ†áÁÇπÂáªÂêéÊºÇÊµÆÁöÑÂ∞èÊ†óÂ≠ê ===
    function createFloatingChestnut(x, y) {
        const chestnut = document.createElement('div');
        chestnut.textContent = 'üå∞';
        chestnut.style.position = 'fixed';
        chestnut.style.left = x + 'px';
        chestnut.style.top = y + 'px';
        chestnut.style.fontSize = `${2 + Math.random()}em`;
        chestnut.style.zIndex = '2000';
        chestnut.style.pointerEvents = 'none';
        chestnut.style.transform = 'translate(-50%, -50%)'; // ‰∏≠ÂøÉÂØπÈΩê
        document.body.appendChild(chestnut);

        const endX = x + (Math.random() - 0.5) * 150;
        const endY = y - 100 - Math.random() * 100;

        chestnut.animate([
            { transform: 'translate(-50%, -50%) scale(0.8) rotate(0deg)', opacity: 1 },
            { transform: `translate(${endX - x - 50}px, ${endY - y - 50}px) scale(1.2) rotate(${Math.random() * 360}deg)`, opacity: 1 },
            { transform: `translate(${endX - x}px, ${endY - y - 150}px) scale(0.5) rotate(${Math.random() * 360}deg)`, opacity: 0 }
        ], {
            duration: 2500 + Math.random() * 1000,
            easing: 'ease-out'
        }).onfinish = () => chestnut.remove();
    }

    // Èü≥Á¨¶Âä®ÁîªÂáΩÊï∞
function createMusicNotes(player) {
    const notes = ['üéµ', 'üé∂', '‚ô™', '‚ô´'];
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            const note = document.createElement('div');
            note.textContent = notes[Math.floor(Math.random() * notes.length)];
            note.style.position = 'fixed';
            note.style.left = (player.getBoundingClientRect().left + Math.random() * 60) + 'px';
            note.style.top = (player.getBoundingClientRect().top + Math.random() * 60) + 'px';
            note.style.fontSize = '1.5em';
            note.style.color = '#FFD700';
            note.style.zIndex = '1001';
            note.style.pointerEvents = 'none';
            document.body.appendChild(note);
            
            note.animate([
                { transform: 'translateY(0) translateX(0) scale(1)', opacity: 1 },
                // Âêë‰∏äÊºÇÊµÆÊõ¥ËøúÔºåÂπ∂ÊúâÈöèÊú∫ÁöÑÊ∞¥Âπ≥ÂÅèÁßª
                { transform: `translateY(${-100 - Math.random() * 50}px) translateX(${(Math.random() - 0.5) * 80}px) scale(0.5)`, opacity: 0 }
            ], {
                duration: 2000 + Math.random() * 500,
                easing: 'ease-out'
            }).onfinish = () => note.remove();
        }, i * 300);
    }
}
    
    /* ==================================== */
    /* Emoji ‰º¥ÈöèÊïàÊûúÈÄªËæë */
    /* ==================================== */

    let cursorChestnut = null;
    let touchChestnut = null;
    let hearts = ['‚ù§Ô∏è', 'üß°', 'üíõ', 'üíö', 'üíô', 'üíú', 'üíñ', 'üíò', 'üíï']; 
    const chestnutEmoji = 'üå∞';
    let lastEmojiTime = 0;
    const emojiInterval = 80;

    let targetMouseX = 0;
    let targetMouseY = 0;
    let targetTouchX = 0;
    let targetTouchY = 0;

    let currentChestnutX = 0;
    let currentChestnutY = 0;
    let currentTouchChestnutX = 0;
    let currentTouchChestnutY = 0;

    const animationDecay = 0.2;
    let animationFrameId = null;

        function createEmojiElement(emoji, x, y, isChestnut = false) {
        const el = document.createElement('div');
        el.textContent = emoji;
        el.style.position = 'fixed';
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        el.style.pointerEvents = 'none';
        el.style.zIndex = '99999';
        el.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(el);

        if (isChestnut) {
            el.className = 'cursor-chestnut';
            el.style.fontSize = '2.2em';
            if (!isTouchDevice) { // Â¶ÇÊûú‰∏çÊòØËß¶Â±èËÆæÂ§áÔºåÂàôÂàùÂßãÂèØËßÅ
                el.style.opacity = '1'; 
            } else { // Ëß¶Â±èËÆæÂ§áÂàùÂßãÈöêËóè
                el.style.opacity = '0';
            }
            return el;
        } else {
            el.className = 'trail-emoji';
            el.style.fontSize = `${1.2 + Math.random() * 0.6}em`;
            
            const offsetX = (Math.random() - 0.5) * 60;
            const offsetY = (Math.random() - 0.5) * 60;
            const rotation = (Math.random() - 0.5) * 90;
            el.style.setProperty('--dx', `${offsetX}px`);
            el.style.setProperty('--dy', `${offsetY}px`);
            el.style.setProperty('--rotate', `${rotation}deg`);
            
            el.addEventListener('animationend', () => el.remove());
            return el;
        }
    }

    function generateTrailEmoji(x, y) {
        const currentTime = Date.now();
        if (currentTime - lastEmojiTime > emojiInterval) {
            const offsetX = (Math.random() - 0.5) * 20;
            const offsetY = (Math.random() - 0.5) * 20;
            createEmojiElement(hearts[Math.floor(Math.random() * hearts.length)], x + offsetX, y + offsetY);
            lastEmojiTime = currentTime;
        }
    }

    function animateChestnut() {
        let activeChestnuts = 0;

        if (cursorChestnut && parseFloat(cursorChestnut.style.opacity) > 0) {
            const deltaMouseX = targetMouseX - currentChestnutX;
            const deltaMouseY = targetMouseY - currentChestnutY;
            currentChestnutX += deltaMouseX * animationDecay;
            currentChestnutY += deltaMouseY * animationDecay;
            cursorChestnut.style.left = `${currentChestnutX}px`;
            cursorChestnut.style.top = `${currentChestnutY}px`;
            activeChestnuts++;
        }

        if (touchChestnut && parseFloat(touchChestnut.style.opacity) > 0) {
            const deltaTouchX = targetTouchX - currentTouchChestnutX;
            const deltaTouchY = targetTouchY - currentTouchChestnutY;
            currentTouchChestnutX += deltaTouchX * animationDecay;
            currentTouchChestnutY += deltaTouchY * animationDecay;
            touchChestnut.style.left = `${currentTouchChestnutX}px`;
            touchChestnut.style.top = `${currentTouchChestnutY}px`;
            activeChestnuts++;
        }

        if (activeChestnuts > 0) {
            animationFrameId = requestAnimationFrame(animateChestnut);
        } else {
            stopAnimationLoop();
        }
    }

    function startAnimationLoop() {
        if (animationFrameId === null) {
            animationFrameId = requestAnimationFrame(animateChestnut);
        }
    }

    function stopAnimationLoop() {
        if (animationFrameId !== null) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

        // === „Äê‰øÆÂ§ç/‰ºòÂåñ„ÄëÈº†Ê†áË∑üÈöèÊ†óÂ≠êÊòæÁ§∫ÈÄªËæë ===
    // Èº†Ê†áÊ†óÂ≠êÂàùÂßãÂåñÂú® window.load ‰∏≠ÊâßË°åÔºå‰ª•Á°Æ‰øùDOMÂ∑≤ÂáÜÂ§áÂ•Ω

    document.body.style.cursor = 'none'; // ÈöêËóèÈªòËÆ§Èº†Ê†á

    document.addEventListener('mousemove', (e) => {
        targetMouseX = e.clientX;
        targetMouseY = e.clientY;
        // Âè™ÊúâÂΩìÈº†Ê†áÊ†óÂ≠êÂèØËßÅÊó∂ÊâçÁîüÊàêÂ∞æÈöèemoji
        if (cursorChestnut && parseFloat(cursorChestnut.style.opacity) > 0) {
            generateTrailEmoji(e.clientX, e.clientY);
        }
        startAnimationLoop();
    });

    document.addEventListener('mouseleave', () => {
        // ÂΩìÈº†Ê†áÁ¶ªÂºÄbodyÊó∂ÔºåÈöêËóèÊ†óÂ≠ê
        if (cursorChestnut) {
           cursorChestnut.style.opacity = '0';
        }
    });

    document.addEventListener('mouseenter', (e) => {
        // ÂΩìÈº†Ê†áÈáçÊñ∞ËøõÂÖ•bodyÊó∂ÔºåÊòæÁ§∫Ê†óÂ≠êÂπ∂Êõ¥Êñ∞‰ΩçÁΩÆ
        if (cursorChestnut) {
           cursorChestnut.style.opacity = '1';
           currentChestnutX = e.clientX; // Á´ãÂç≥Â∞ÜÊ†óÂ≠ê‰ΩçÁΩÆËÆæÁΩÆÂà∞Èº†Ê†á‰ΩçÁΩÆ
           currentChestnutY = e.clientY;
           cursorChestnut.style.left = `${currentChestnutX}px`;
           cursorChestnut.style.top = `${currentChestnutY}px`;
        }
        startAnimationLoop();
    });

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
    if (isTouchDevice) {
        // ÁßªÂä®Á´ØÈöêËóèÈªòËÆ§Èº†Ê†á
        document.body.style.cursor = 'auto'; // ÁßªÂä®Á´ØÈÄöÂ∏∏‰∏çÈúÄË¶ÅÈöêËóèÂÖâÊ†á

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                
                if (!touchChestnut) { // ÊáíÂä†ËΩΩÔºåÈ¶ñÊ¨°Ëß¶Êë∏Êó∂ÂàõÂª∫
                    touchChestnut = createEmojiElement(chestnutEmoji, targetTouchX, targetTouchY, true);
                    // Á°Æ‰øùÁßªÂä®Á´ØtouchChestnutÂàùÂßãÂèØËßÅ
                    touchChestnut.style.opacity = '1';
                }
                
                touchChestnut.style.opacity = '1'; // Á°Æ‰øùÂèØËßÅ
                currentTouchChestnutX = targetTouchX; // Á´ãÂç≥ËÆæÁΩÆ‰ΩçÁΩÆ
                currentTouchChestnutY = targetTouchY;
                touchChestnut.style.left = `${currentTouchChestnutX}px`;
                touchChestnut.style.top = `${currentTouchChestnutY}px`;

                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0 && touchChestnut && parseFloat(touchChestnut.style.opacity) > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            // Â¶ÇÊûúÊâÄÊúâËß¶Êë∏ÈÉΩÂ∑≤ÁªìÊùüÔºåÂàôÈöêËóèÊ†óÂ≠ê
            if (touchChestnut && e.touches.length === 0) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });

        document.addEventListener('touchcancel', () => {
            if (touchChestnut) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });
    } else {
        // Ê°åÈù¢Á´Ø‰∏ìÂ±ûÔºåÁ°Æ‰øùcursorChestnut‰∏ÄÂºÄÂßãÂ∞±ÊòØÂèØËßÅÁöÑ
        if (cursorChestnut) {
            cursorChestnut.style.opacity = '1';
        }
    }
    if (isTouchDevice) {
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                
                if (!touchChestnut) {
                    touchChestnut = createEmojiElement(chestnutEmoji, targetTouchX, targetTouchY, true);
                }
                
                touchChestnut.style.opacity = '1';
                currentTouchChestnutX = targetTouchX;
                currentTouchChestnutY = targetTouchY;
                touchChestnut.style.left = `${currentTouchChestnutX}px`;
                touchChestnut.style.top = `${currentTouchChestnutY}px`;

                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0 && touchChestnut && parseFloat(touchChestnut.style.opacity) > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (touchChestnut && e.touches.length === 0) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });

        document.addEventListener('touchcancel', () => {
            if (touchChestnut) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });
    }

    function enableAutoPlay() {
        const audio = document.getElementById('backgroundMusic');
        const player = document.getElementById('musicPlayer');
        // Âè™ÊúâÂΩìÈü≥‰πêÂ∞öÊú™Êí≠Êîæ„ÄÅÂ∑≤ÊöÇÂÅú‰∏îÈü≥È¢ëÂ∑≤ÂáÜÂ§áÂ•ΩÊó∂ÊâçÂ∞ùËØïÊí≠Êîæ
        if (!musicPlaying && audio.paused && audioInitialized) {
            audio.play().then(() => {
                musicPlaying = true;
                player.classList.add('playing');
                player.innerHTML = '<span style="font-size: 1.5em;">üéµ</span>';
                createEnhancedFloatingText('üéµ Èü≥‰πêÂ∑≤Êí≠Êîæ', window.innerWidth / 2, 150);
                createMusicNotes(player);
            }).catch(error => {
                console.log('Èü≥‰πêËá™Âä®Êí≠ÊîæÂ§±Ë¥•:', error);
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', enableAutoPlay, { once: true });
    });

    // ÁÇπÂáªÊ∂üÊº™ÊïàÊûú
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') return;
        // ÊéíÈô§Ê∏∏ÊàèÊ®°ÂùóÂÜÖÁöÑÁÇπÂáªÔºåÈò≤Ê≠¢Âπ≤Êâ∞
        if (e.target.closest('#gameModule') || e.target.closest('#singleCharacterPopup')) return;
        
        const ripple = document.createElement('div');
        ripple.style.position = 'fixed';
        ripple.style.left = e.clientX + 'px';
        ripple.style.top = e.clientY + 'px';
        ripple.style.width = '10px';
        ripple.style.height = '10px';
        ripple.style.background = 'radial-gradient(circle, rgba(255, 255, 255, 0.8), transparent)';
        ripple.style.borderRadius = '50%';
        ripple.style.pointerEvents = 'none';
        ripple.style.zIndex = '10000';
        document.body.appendChild(ripple);
        
        ripple.animate([
            { transform: 'scale(0)', opacity: 1 },
            { transform: 'scale(10)', opacity: 0 }
        ], {
            duration: 600,
            easing: 'ease-out'
        }).onfinish = () => ripple.remove();
    });

    /* ==================================== */
    /* ÊñáÂ≠óÂÜíÈô©Ê∏∏ÊàèÊ®°ÂùóÈÄªËæë */
    /* ==================================== */

    // ÂÆö‰πâ‰∫∫Áâ©ÂõæÁâáÂíåËÉåÊôØÂõæÁâáÁöÑÂü∫Á°ÄË∑ØÂæÑ
    const IMAGE_BASE_PATH = 'https://vacuopolis.netlify.app/image/';
    const SOUND_BASE_PATH = 'https://vacuopolis.netlify.app/audio/';

        // ÂØπËØùÊï∞ÊçÆ
    const textAdventureData = [
        {
            id: 'intro_action',
            type: 'action',
            speaker: '',
            text: 'ÔºàÂú®‰Ω†ÂøÉ‰∏≠ÈªòÂøµÊÑøÊúõÁöÑÁû¨Èó¥...Ë∫´ËæπÁöÑÁ©∫Ê∞îÁ™ÅÁÑ∂ÂæÆÊºæÔºåÁß¶Ê¢ßÂ¶ÇÂêåÈ¨ºÈ≠Ö...ÊàñËÄÖËØ¥ÔºåÊõ¥ÂÉèÂè™Ë≠¶ËßâÁöÑÁãêÁã∏ÔºåÁû¨Èó¥Ë¥¥ËøëËá≥‰∏é‰Ω†ÂëºÂê∏Áõ∏ÈóªÁöÑË∑ùÁ¶ª„ÄÇ‰ªñÈÇ£ÂèåÈéèÈáëÁúºÁû≥ÁÖßÂ∞ÑÂá∫ÂæÆÂÖâÔºåÂ•Ω‰ººÂàöÈÄöËøáÁ•ûÁßòÁöÑÊñπÂºèÁé∞Ë∫´‰∏éÊ≠§Ôºâ', 
            charImg: 'qinwu_yelloweyes.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue0'
        },
        {
            id: 'dialogue0',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'Âì¶ÔºüÊÑüÂ∫îÂà∞‰∏™ÊúâË∂£ÁöÑÂøÉÊÑø‰ø°Âè∑ÔΩûÔºàÂøΩÁÑ∂Âéã‰ΩéÂ£∞Èü≥ÔºåÂ∏¶ÁùÄÁã°Èª†ÁöÑÁ¨ëÊÑèÔºâÂà´Á¥ßÂº†ÂïäÔºå‰Ω†ÁöÑÂ∞èÈπøÈÉΩÊíûÂà∞ÊàëÂøÉÂè£‰∫Ü...(Á®ç‰ΩúÂÅúÈ°øÔºåÊÑüÊÖ®Áä∂)', 
            charImg: 'qinwu_laugh1.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue1'
        },
        {
            id: 'dialogue1',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ÂîâÔºåÂ§©ÁîüÂä≥Á¢åÂëΩÂíØÔºåÊó¢ÁÑ∂Áâ©ÁêÜÁæéÂ≠¶Â§©ÊâçÊÑüÂ∫îÂà∞‰∫Ü‚Äî‚Äî', 
            charImg: 'qinwu_laugh2.png', // Â∑≤Á°ÆËÆ§ËØ•ÂõæÁâáÂ≠òÂú®Âπ∂Ë°•ÂÖÖÂà∞manifest
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action1'
        },
        {
            id: 'action1',
            type: 'action',
            speaker: '',
            text: 'ÔºàÈáëÁ∫¢Ëâ≤ÁöÑÂÖâÁÇπÂ¶ÇË∞ÉÁöÆÂ∞èËô´ÔºåÂøΩÁÑ∂‰ªé‰ªñÊåáÂ∞ñËπ¶Âá∫ÔºåÊ¨¢Âø´Âú∞Âú®‰Ω†ÁöÑË°£Ë•ü‰∏äÁªï‰∫Ü‰∏™ÊµÅÂÖâÂúàÔºåÈöèÂç≥ÈíªÂÖ•Á∫ΩÊâ£Èó¥Ôºâ',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue2'
        },
        {
            id: 'dialogue2',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: '‰∏ÄÊÑøÔºöÁªä‰Ω†ÁöÑÁßçÁßç‰∏çÈ°∫ÂøÉÔºåÁªüÁªüÂåñÊàêÁé∞ÂÆûÂàÜÊûêÈ¢òÔºÅÔºàÈ£üÊåáÁÇπÁÇπÁ©∫Ê∞îÔºâ‰øùËØÅÊØîËØÅÊòé‰∏§Áâ©Á≠âÈ´òÁÆÄÂçïÔºÅÔºàÂøΩÁÑ∂‰øÉÁã≠Áú®ÁúºÔºâÈôÑÂä†ÁâπÊïàÊòØËß£ÂÆåÈ¢òËá™Âä®Ê∂àÂ§±~', 
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action2'
        },
        {
            id: 'action2',
            type: 'action',
            speaker: '',
            text: '(‰ªø‰Ωõ‰∏çÁªèÊÑèÂú∞ÊäΩËµ∞‰Ω†È¨ìËæπ‰∏ÄÁºïÂèë‰∏ùÔºåÊåáÂ∞ñÈ£ûÂø´Âú∞Êâì‰∫Ü‰∏™Á≤æÂ∑ßÁöÑÁªìÔºâ',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue3'
        },
        {
            id: 'dialogue3',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: '‰∫åÊÑøÔºö‰∏∫‰Ω†ÊíëÊää‰ºûÔºÅÔºàËØ≠Ê∞îËé´ÂêçÂèòÂæóËÆ§ÁúüÔºâ‰∏çÊòØÊåáÊ∑ãÈõ®Ê∑ãÈõ™ÊôíÂ§™ÂÜ∑ÊôíÂ§™Èò≥ÈÇ£Áßç...ÔºàÂ£∞Èü≥ÂøΩÂ∞èÔºâ', 
            charImg: 'qinwu_laugh2.png', // Â∑≤Á°ÆËÆ§ËØ•ÂõæÁâáÂ≠òÂú®Âπ∂Ë°•ÂÖÖÂà∞manifest
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue3.5'
        },
        {
            id: 'dialogue3.5',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ÊòØËØ¥...ÂóØ...‰∏á‰∏ÄÊúâÁúã‰∏çÊÉØÁöÑÂÆ∂‰ºôÊÉπ‰Ω†‰∏çÁàΩÈ∫ªÁÉ¶...ÁúãÊàëÁî®ÂÖ¨ÂºèÊèç‰∫∫ÔºÅÔºàËØ≠Ê∞îËΩ¨Âø´ÔºâÂΩìÁÑ∂‰ºòÂÖàÂ∫îÁî®Áâ©ÁêÜÂäùÈÄÄÊ≥ïÔºÅ', 
            charImg: 'qinwu_embarrass.png', 
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action3'
        },
        {
            id: 'action3',
            type: 'action',
            speaker: '',
            text: 'ÔºàÊçªÁùÄÂèë‰∏ùÁº†ÊàêÁöÑÂ∞èÁªìÔºåÂä®‰ΩúËΩªÂø´Âú∞Â∞ÜÂÖ∂ÊåâÂêë‰Ω†ÁöÑÊéåÂøÉÔºâ',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue4a'
        },
        {
            id: 'dialogue4a',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ÊúÄÂêéËøôÊÑøÂòõ...ÔºàÊïÖ‰ΩúÈ´òÊ∑±Áä∂ÔºâÊöÇÂ≠òËøôÈ¢ó‚ÄòÁß¶ÂºèÁâπ‰æõÈÄöËÆØÁè†‚ÄôÈáåÂï¶ÔºÅ',
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue4b'
        },
        {
            id: 'dialogue4b', 
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'Ë¶ÅÊòØ„ÄÅË¶ÅÊòØÊÉ≥ËÆ®ËÆ∫Áâ©ÁêÜÈ¢ò...ÊàñËÄÖ...Âí≥...‚ÄòÂ∞è‰∏ª‰ΩÜÂèØÊéêÁ¢éÊ≠§Áè†ÔºåËá™ÊúâÂ•¥Â©¢Á´≠ËØö‰∏∫ÊÇ®ÊúçÂä°...‚Äô',
            charImg: 'qinwu_embarrass.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'systemPrompt1'
        },
        {
            id: 'systemPrompt1',
            type: 'action',
            speaker: '',
            text: '„ÄêÁ≥ªÁªüÊèêÁ§∫„ÄëËé∑ÂæóË¢´Âä®ÊäÄËÉΩ<Áß¶Ê¢ß„ÅÆÊïëÊè¥>ÔºöÈÅáÈô©Êó∂Âº∫Âà∂ÈÄöÁü•Áß¶Ê¢ßÔºàÊ∏©È¶®ÊèêÁ§∫ÔºöÊàñËÆ∏Âè¨Âî§ÊúâÊ¶ÇÁéá‰ºöÂá∫Áé∞Á©øÁùÄËçâËéìÂõæÊ°àÁù°Ë°£ÁâàÔΩûÔºâ', 
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'choices1'
        },
        {
            id: 'choices1',
            type: 'choices',
            text: 'ÔºûÈÄâÈ°πÊµÆÁé∞Ôºú',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            options: [
                { text: '„Äê‰º∏ÊâãÊé¢Âêë‰ªñÊåáÂ∞ñ„Äë‚ÄúÈÄöËÆØÁè†ÔºüÁªìÊûÑËÉΩÊèèËø∞‰∏Ä‰∏ãÂêóÁß¶ËÄÅÂ∏àÔºü‚Äù', next: 'branchA', img: 'choicebox1.png' }, 
                { text: '„ÄêËΩªÊôÉÊéåÂøÉÁöÑÁªì„Äë‚ÄúËøôÂâ©‰∏ãÁöÑ‰∏ÄÊÑø...ÁúüÁöÑ‰∏çÊòØÂÖçË¥£Â£∞ÊòéÔºü‚Äù', next: 'branchB', img: 'choicebox2.png' }, 
                { text: '„ÄêÁõØÁùÄ‰ªñÂæÆÁ∫¢ÁöÑËÄ≥Êúµ„Äë‚ÄúÁß¶ËÄÅÂ∏àÔºåÂÆ´ÊñóÂâßÊå∫‰∏äÂ§¥ÂëÄÔºü‚Äù', next: 'branchC', img: 'choicebox3.png' }  
            ]
        },
        {
            id: 'branchA',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ËØ∂ÔºüÂÖ∂ÂÆûÊ†∏ÂøÉÊòØ...(ÁúºÁùõÈô°ÁÑ∂‰∫ÆËµ∑ÔºåÂáëËøëËÆ≤Ëß£ÔºåÊåáÂ∞ñ‰∫ÆËµ∑ÂæÆÂÖâÂãæÂãíÁªìÊûÑÂõæÔºâËøêÁî®‰∫ÜÊüî*Êõ≤ÁéáÁ∫¶ÊùüÂíå...‰∏çÂØπÔºåËøô‰πàËÆ≤ÂèØËÉΩÊúâ‰∫õÂê¨‰∏çÊáÇ...ÔºàÊÄùÁ¥¢ingÔºâ', 
            charImg: 'qinwu_laugh1.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'mergePoint'
        },
        {
            id: 'branchB',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ÂòøÔºÅÊÄÄÁñë‰∏ì‰∏öÁ¥†ÂÖªÔºüÔºàÂøΩÁÑ∂Êäì‰Ωè‰Ω†ÊâãËÖïÔºâ‰Ω†ÁúãÁ≠æÁ´†ÈÉΩÁõñËøôÂÑø‰∫ÜÔºÅÁ´•ÂèüÊó†Ê¨∫ÔºÅÔºàÊùæÂºÄÊâãÔºå‰ΩØÊÄíÔºâ‰∏çËøáÁúüË¶ÅÊî∂Âà©ÊÅØ...ÔºàÁúºÁ•ûÈ£òÂêëËøúÂ§ÑÁÅ´ÈîÖÊãõÁâåÔºâÂèØÂê¶ËÄÉËôëËøΩÂä†‰∏Ä‰ªΩÁàÜËæ£ÁæéÈ£üÔºü', 
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'mergePoint'
        },
        {
            id: 'branchC',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ËøôËøôËøô...Ë°•ÂÖÖÁ≤æÁ•ûÈ£üÁ≤ÆÁΩ¢‰∫ÜÔºÅÈÅøÂÖçÁâ©ÁêÜÂ§ßËÑëÂÉµÂåñÔºÅ.....Âí≥ÔºåÊØîËµ∑Ëøô‰∏™ÔºåË¶Å‰∏çËÆ®ËÆ∫ËÆ®ËÆ∫Á¨¨‰∏âÊÑøÁöÑ‰∫ãÔºü‚Äù (ÊúÄÂêéÂ∞èÂ£∞ËΩ¨ÁßªËØùÈ¢ò)',
            charImg: 'qinwu_embarrass.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'mergePoint'
        },
        {
            id: 'mergePoint',
            type: 'action',
            speaker: '',
            text: 'ÔºàÁ™ÅÁÑ∂Èó¥ÔºåÈÇ£‰∫õÈáëËâ≤ÁöÑÂÖâÁÇπÂ¶ÇÂêåÂΩíÂ∑¢ËúÇÁæ§ÔºåÈ£ûÈÄüÂÄíÊ∂åÂõû‰ªñÁöÑË¢ñÂè£ÔºåÂ∏¶Ëµ∑‰∏ÄÈòµËΩªÈ£éÔºåË£πÁùÄÊ∑°Ê∑°ÁöÑ...Èõ™ÊùæÈ¶ôÂë≥ÁöÑÊ∞îÊÅØËç°ÂºÄÔºâ', 
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue5'
        },
        {
            id: 'dialogue5',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: 'ÈÇ£‰∏™...Ë¶Å‰∏çË¶ÅËÄÉËôëÊää‰∏âÊÑøÂàÜÊúü‰ªòÔºüÔºàÊå†‰∫ÜÊå†ËÑ∏È¢äÔºâÊàëÊòØËØ¥...ÊØîÂ¶Ç...ÊäΩÂá†ÁõòÂΩìÊïôÂ≠¶Á´ûËµõÂ•ñÂìÅÊù•ÂÖëÁé∞ÔºüÂèàÊàñËÄÖÊòØÂÖ∂‰ªñ‰ªÄ‰πàÁöÑÔºü', 
            charImg: 'qinwu_laugh1.png', 
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue6'
        },
        {
            id: 'dialogue6',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: '(Áúã‰Ω†ÊÑ£Á•ûÔºåÂøΩÁÑ∂‰º∏ÊâãËΩªÊà≥‰∫Ü‰∏Ä‰∏ã‰Ω†È¢ùÂ§¥)‚ÄúÂ•ΩÂï¶ÔºÅÔºà‰ªñÂÉèÊòØÁ´ô‰∏ç‰Ωè‰ººÁöÑËΩªÂø´Ë∑≥ÂºÄ‰∏§Ê≠•Ôºå‰ªø‰Ωõ‰∏∫Á¶ªÂºÄÈ¢ÑÁÉ≠ÔºâÂÜç‰π±ÊåâËÆ∏ÊÑøÊåâÈíÆ...(Á©∫‰∏≠ÂøΩÈó™ÂæÆËäí)Â∞èÂøÉÊàëÊù•ËøôÂ§öÁúã‰Ω†Âá†ÁúºÂì¶ÔºÅ‚ÄùÔºàËøôËØù‰∏ÄÂá∫Â£∞Èü≥ÂêåÊó∂Â∞è‰∫Ü‰∏ãÂéªÔºåÈ¢áÊúâ‰∫õÊ¨≤ÁõñÂº•ÂΩ∞Âú∞Âç≥Â∞ÜÊ∂àÂ§±‰∏∫ÂÖâÁóïÔºâ', 
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action_end'
        },
        {
            id: 'action_end',
            type: 'action',
            speaker: '',
            text: 'ÔºàÈ£òÊï£ÁöÑÂÖâÊ≤´ÂæÆÂæÆÈúáÂä®Ôºå‰ªø‰ΩõË£πÊåüÁùÄ‰∏ÄÂè•ÈöèÈ£éÊ∂àÈÄùÁöÑ‰ΩéËØ≠...Ôºâ',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue_final'
        },
        {
            id: 'dialogue_final',
            type: 'dialogue',
            speaker: 'Áß¶Ê¢ß',
            text: '....Á•àÊÑøÂ¶ÇÊûúÊòØËØïÂç∑Ê±ÇÂä©ÁöÑËØù...ÊåëÁÇπÈöæÁöÑ‰πüÂ•Ω..ËøôÊ†∑Â∞±ÂèØ‰ª•Â§öËä±Êó∂Èó¥Èô™Âú®‰Ω†Ë∫´Ëæπ‰∫Ü..',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'end'
        },
        {
            id: 'end',
            type: 'end',
            music: 'qinwubgm.mp3',
            text: 'ÊÑøÊúõÁ≠æÊî∂ÂÆåÊØïÔºåÊó∂Á©∫ÂõûÂΩíÂØªÂ∏∏„ÄÇ'
        }
    ];

    let currentDialogueIndex = 0;
    let isDialogueInProgress = false; // Èò≤Ê≠¢Âø´ÈÄüÁÇπÂáª
    let isGameActive = false; // Ê∏∏ÊàèÊòØÂê¶Â§Ñ‰∫éÊøÄÊ¥ªÁä∂ÊÄÅ

    // Â≠òÂÇ®ÂØπËØùIDÂà∞Á¥¢ÂºïÁöÑÊò†Â∞ÑÔºåÊñπ‰æøÈÄöËøáIDË∑≥ËΩ¨
    const dialogueMap = new Map();
    textAdventureData.forEach((item, index) => {
        if (item.id) {
            dialogueMap.set(item.id, index);
        }
    });

    // Ëé∑ÂèñDOMÂÖÉÁ¥†
    const gameModule = document.getElementById('gameModule');
    const gameBGM = document.getElementById('gameBGM');
    const gameBackground = document.getElementById('gameBackground');
    const gameCharacter = document.getElementById('gameCharacter');
    const gameDialogueBox = document.getElementById('gameDialogueBox');
    const speakerNameElem = document.getElementById('speakerName');
    const dialogueTextElem = document.getElementById('dialogueText');
    const choiceContainer = document.getElementById('choiceContainer');
    const gameMenuButton = document.getElementById('gameMenu');

    // ÁõëÂê¨Â±èÂπïÊñπÂêëÂèòÂåñ
    window.addEventListener('orientationchange', updateGameBackgroundOrientation);
    window.addEventListener('resize', updateGameBackgroundOrientation); // Á™óÂè£Â§ßÂ∞èÊîπÂèò‰πüÂèØËÉΩÂΩ±ÂìçÂà§Êñ≠

    function updateGameBackgroundOrientation() {
        // Âú®Ê∏∏ÊàèÊú™ÊøÄÊ¥ªÊó∂ÊàñËÄÖÂØπËØùÊï∞ÊçÆ‰∏çÂ≠òÂú®Êó∂Ôºå‰∏çÊõ¥Êñ∞ËÉåÊôØ
        if (!isGameActive || currentDialogueIndex >= textAdventureData.length) {
            return;
        }
        
        const currentSceneData = textAdventureData[currentDialogueIndex];
        if (!currentSceneData) {
            return;
        }

        const isPortrait = window.innerHeight > window.innerWidth;

        // ÁßªÈô§ÊâÄÊúâËÉåÊôØÊñπÂêëÁ±ª
        gameBackground.classList.remove('landscape', 'portrait');

        // Ê†πÊçÆÂΩìÂâçÊñπÂêëËÆæÁΩÆËÉåÊôØÁ±ªÂíåÂõæÁâá
        if (isPortrait) {
            gameBackground.classList.add('portrait');
            if (currentSceneData.bgPortrait) {
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgPortrait}')`;
            } else if (currentSceneData.bgLandscape) {
                // Â¶ÇÊûúÊ≤°Êúâ‰∏ìÈó®ÁöÑÁ´ñÂ±èËÉåÊôØÔºåÂèØ‰ª•Â∞ùËØï‰ΩøÁî®Ê®™Â±èËÉåÊôØ
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgLandscape}')`;
            } else {
                // Â¶ÇÊûúÈÉΩÊ≤°ÊúâÔºåËÆæÁΩÆ‰∏Ä‰∏™ÈªòËÆ§ËÉåÊôØÊàñËÄÖÊ∏ÖÈô§
                gameBackground.style.backgroundImage = 'none';
            }
        } else { // Ê®™Â±è
            gameBackground.classList.add('landscape');
            if (currentSceneData.bgLandscape) {
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgLandscape}')`;
            } else if (currentSceneData.bgPortrait) {
                // Â¶ÇÊûúÊ≤°Êúâ‰∏ìÈó®ÁöÑÊ®™Â±èËÉåÊôØÔºåÂèØ‰ª•Â∞ùËØï‰ΩøÁî®Á´ñÂ±èËÉåÊôØ
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgPortrait}')`;
            } else {
                gameBackground.style.backgroundImage = 'none';
            }
        }
    }

    // Ê†∏ÂøÉÂáΩÊï∞ - Êé®ËøõÂØπËØù
    function advanceDialogue() {
        if (!isGameActive || isDialogueInProgress) return; // Ê∏∏ÊàèÊú™ÊøÄÊ¥ªÊàñÂØπËØùÊ≠£Âú®ËøõË°å‰∏≠ÔºåÈòªÊ≠¢Êé®Ëøõ

        const currentSceneData = textAdventureData[currentDialogueIndex];

        if (!currentSceneData) {
            console.warn('Dialogue data not found for index:', currentDialogueIndex);
            endTextAdventure();
            return;
        }

        if (currentSceneData.type === 'choices') {
            // Â¶ÇÊûúÂΩìÂâçÊòØÈÄâÈ°πÔºåÂàôÁÇπÂáªÂ±èÂπï‰∏çÊé®ËøõÔºåÂøÖÈ°ªÈÄâÊã©ÈÄâÈ°π
            return;
        } else if (currentSceneData.type === 'end') {
            endTextAdventure();
            return;
        }

        currentDialogueIndex++;
        displayCurrentScene();
    }

    // ÊòæÁ§∫ÂΩìÂâçÂú∫ÊôØ
    function displayCurrentScene() {
        isDialogueInProgress = true; // ËÆæÁΩÆÊ†áÂøóÔºåÈò≤Ê≠¢Âú®ÊñáÊú¨ÊòæÁ§∫ËøáÁ®ã‰∏≠Â§öÊ¨°ÁÇπÂáª

        const data = textAdventureData[currentDialogueIndex];
        if (!data) {
            endTextAdventure();
            return;
        }

        // ÂàáÊç¢ËÉåÊôØÈü≥‰πê (Â¶ÇÊûúÂú∫ÊôØÊúâÊåáÂÆöÈü≥‰πê)
        if (data.music) {
            const newMusicSrc = SOUND_BASE_PATH + data.music;
            if (gameBGM.src !== newMusicSrc) { // ÈÅøÂÖçÈáçÂ§çËÆæÁΩÆÂíåÂä†ËΩΩ
                gameBGM.src = newMusicSrc;
                gameBGM.play().catch(e => console.error("Game BGM play error:", e));
            } else if (gameBGM.paused) { // Â¶ÇÊûúÈü≥‰πêÁõ∏Âêå‰ΩÜÂ∑≤ÊöÇÂÅúÔºåÂàôÁªßÁª≠Êí≠Êîæ
                gameBGM.play().catch(e => console.error("Game BGM resume error:", e));
            }
        } else {
            // Â¶ÇÊûúÂΩìÂâçÂú∫ÊôØÊ≤°ÊúâÊåáÂÆöÈü≥‰πêÔºåÂπ∂‰∏îÈü≥‰πêÊ≠£Âú®Êí≠ÊîæÔºåÂàôÊöÇÂÅú
            if (!gameBGM.paused) {
                gameBGM.pause();
            }
        }

        // Êõ¥Êñ∞ËÉåÊôØÂõæÁâá
        updateGameBackgroundOrientation(); // Ê†πÊçÆÂΩìÂâçÂú∫ÊôØÁöÑÊï∞ÊçÆÂíåÂ±èÂπïÊñπÂêëÊõ¥Êñ∞ËÉåÊôØ

        // ÈöêËóè‰∫∫Áâ©ÂíåÈÄâÊã©ÔºåÊòæÁ§∫ÂØπËØùÊ°Ü
        gameCharacter.style.opacity = '0'; // ÂÖàÈöêËóè
        choiceContainer.innerHTML = ''; // Ê∏ÖÁ©∫ÈÄâÈ°π
        choiceContainer.style.display = 'none';
        gameDialogueBox.style.display = 'flex'; // ÈáçÊñ∞ÊòæÁ§∫ÂØπËØùÊ°Ü

        // ÊòæÁ§∫‰∫∫Áâ©ÂõæÁâá
        if (data.charImg) { // Ê≥®ÊÑèÔºöÁé∞Âú® charImg ‰∏∫Á©∫Â≠óÁ¨¶‰∏≤Êó∂‰ºöÊ≠£Á°ÆËøõÂÖ• else
            gameCharacter.src = IMAGE_BASE_PATH + data.charImg;
            gameCharacter.style.opacity = '1'; // ÈÄêÊ∏êÊòæÁ§∫
        } else {
            gameCharacter.src = ''; // Ê∏ÖÁ©∫srcÔºåÈò≤Ê≠¢ÊòæÁ§∫ÊóßÂõæ
            gameCharacter.style.opacity = '0'; // Á°Æ‰øùÈöêËóè
        }

        // Êõ¥Êñ∞ËØ¥ËØùËÄÖÂêçÂ≠óÂíåÂØπËØùÊñáÊú¨
        speakerNameElem.textContent = data.speaker || ''; // Â¶ÇÊûúspeaker‰∏∫Á©∫ÔºåÂàô‰∏çÊòæÁ§∫
        dialogueTextElem.textContent = ''; // ÂÖàÊ∏ÖÁ©∫ÊñáÊú¨ÔºåÂáÜÂ§áÊâìÂ≠óÊïàÊûú

        // ÂÆûÁé∞ÊâìÂ≠óÊïàÊûú
        let textIndex = 0;
        const typingSpeed = 50; // ÊØèÂ≠óÁ¨¶50ÊØ´Áßí

        const typeText = () => {
            if (textIndex < data.text.length) {
                dialogueTextElem.textContent += data.text.charAt(textIndex);
                textIndex++;
                setTimeout(typeText, typingSpeed);
            } else {
                isDialogueInProgress = false; // ÊâìÂ≠óÂÆåÊàêÔºåÂÖÅËÆ∏Êé®Ëøõ
                // Â¶ÇÊûúÊòØÈÄâÈ°πÁ±ªÂûãÔºåÊòæÁ§∫ÈÄâÈ°π
                if (data.type === 'choices') {
                    displayChoices(data.options);
                }
            }
        };
        typeText();
    }

    // ÊòæÁ§∫ÈÄâÈ°π
    function displayChoices(options) {
        gameDialogueBox.style.display = 'none'; // ÈöêËóèÂØπËØùÊ°Ü
        gameCharacter.style.opacity = '0'; // ÈÄâÈ°πÊó∂‰∫∫Áâ©‰πüÈöêËóè
        choiceContainer.style.display = 'flex'; // ÊòæÁ§∫ÈÄâÈ°πÂÆπÂô®
        choiceContainer.innerHTML = ''; // Ê∏ÖÁ©∫Áé∞ÊúâÈÄâÈ°π

        options.forEach((option, index) => {
            const choiceBtn = document.createElement('div');
            choiceBtn.className = 'choice-button';
            choiceBtn.textContent = option.text;
            choiceBtn.style.backgroundImage = `url('${IMAGE_BASE_PATH}${option.img}')`; // ÈÄâÈ°πËÉåÊôØÂõæ
            choiceBtn.onclick = (e) => {
                e.stopPropagation(); // ÈòªÊ≠¢ÁÇπÂáª‰∫ã‰ª∂ÂÜíÊ≥°Âà∞ gameModule
                handleChoice(option.next);
            };
            choiceContainer.appendChild(choiceBtn);
        });

        isDialogueInProgress = false; // ÈÄâÈ°πÊòæÁ§∫ÂÆåÊØïÔºåÂèØ‰ª•ËøõË°åÈÄâÊã©‰∫Ü
    }

    // Â§ÑÁêÜÈÄâÈ°πÈÄâÊã©
    function handleChoice(nextId) {
        const nextIndex = dialogueMap.get(nextId);
        if (nextIndex !== undefined) {
            currentDialogueIndex = nextIndex;
            displayCurrentScene();
        } else {
            console.error('Invalid nextId for choice:', nextId);
            endTextAdventure(); // ÈîôËØØÂ§ÑÁêÜÔºåÁªìÊùüÊ∏∏Êàè
        }
    }

    // ÂêØÂä®ÊñáÂ≠óÂÜíÈô©Ê∏∏Êàè
    function startTextAdventure() {
        // ÊöÇÂÅú‰∏ªÈ°µËÉåÊôØÈü≥‰πê
        document.getElementById('backgroundMusic').pause();
        musicPlaying = false; // Êõ¥Êñ∞‰∏ªÈ°µÈü≥‰πêÁä∂ÊÄÅ
        document.getElementById('musicPlayer').classList.remove('playing');
        document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">üîá</span>';


        gameModule.style.display = 'block'; // ÊòæÁ§∫Ê∏∏ÊàèÊ®°Âùó
        gameModule.style.opacity = '0'; // ‰ªéÈÄèÊòéÂºÄÂßã
        setTimeout(() => {
            gameModule.style.opacity = '1'; // Ê∑°ÂÖ•
        }, 50); // Â∞èÂª∂ËøüÁ°Æ‰øùdisplayÁîüÊïàÂêéÂºÄÂßãÂä®Áîª

        isGameActive = true;
        currentDialogueIndex = dialogueMap.get('intro_action'); // ‰ªéËÆæÂÆöÁöÑÁ¨¨‰∏ÄÈ°πÂºÄÂßã
        displayCurrentScene(); // ÊòæÁ§∫Á¨¨‰∏ÄÂú∫ÊôØ

        // ÁªëÂÆöÁÇπÂáª‰∫ã‰ª∂ÔºåÁî®‰∫éÊé®ËøõÂØπËØù
        gameModule.onclick = advanceDialogue;

        // ËèúÂçïÊåâÈíÆ‰∫ã‰ª∂ (Á§∫‰æãÔºöÈÄÄÂá∫Ê∏∏Êàè)
        gameMenuButton.onclick = (e) => {
            e.stopPropagation(); // ÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Ê∏∏ÊàèÊ®°ÂùóÔºåÈÅøÂÖçËß¶Âèë advanceDialogue
            if (confirm('Á°ÆÂÆöË¶ÅÈÄÄÂá∫Ê∏∏ÊàèÂêóÔºü')) {
                endTextAdventure();
            }
        };

        // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
        document.body.style.overflow = 'hidden';
    }

    // ÁªìÊùüÊñáÂ≠óÂÜíÈô©Ê∏∏Êàè
    function endTextAdventure() {
        isGameActive = false;
        gameModule.style.opacity = '0'; // Ê∑°Âá∫Âä®Áîª
        setTimeout(() => {
            gameModule.style.display = 'none';
            // ÊÅ¢Â§ç‰∏ªÈ°µËÉåÊôØÈü≥‰πê (Â¶ÇÊûú‰πãÂâçÂú®Êí≠Êîæ)
            if (document.getElementById('backgroundMusic').paused) { // ÈÅøÂÖçÈáçÂ§çÊí≠Êîæ
                 document.getElementById('backgroundMusic').play().then(() => {
                    musicPlaying = true;
                    document.getElementById('musicPlayer').classList.add('playing');
                    document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">üéµ</span>';
                }).catch(e => console.warn("Main BGM resume error:", e));
            }
            document.body.style.overflow = ''; // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
        }, 500); // Á≠âÂæÖÊ∑°Âá∫Âä®ÁîªÂÆåÊàê
        gameBGM.pause(); // ÊöÇÂÅúÊ∏∏ÊàèÈü≥‰πê
        gameBGM.currentTime = 0; // ÈáçÁΩÆÊ∏∏ÊàèÈü≥‰πêÊí≠ÊîæËøõÂ∫¶

        gameModule.onclick = null; // Ëß£Áªë‰∫ã‰ª∂
        gameMenuButton.onclick = null; // Ëß£ÁªëËèúÂçï‰∫ã‰ª∂
    }

    /* ==================================== */
    /* Âçï‰∫∫Áâ©ÂØπËØùÊ®°ÂùóÈÄªËæë */
    /* ==================================== */
    const singleCharacterPopup = document.getElementById('singleCharacterPopup');
    const popupCharImage = document.getElementById('popupCharImage');
    const popupCharText = document.getElementById('popupCharText');
    const popupCharVoice = document.getElementById('popupCharVoice');

    function showSingleCharacterPopup() {
    // ÊöÇÂÅú‰∏ªÈ°µËÉåÊôØÈü≥‰πê
    document.getElementById('backgroundMusic').pause();
    musicPlaying = false;
    document.getElementById('musicPlayer').classList.remove('playing');
    document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">üîá</span>';

    // Ëé∑ÂèñDOMÂÖÉÁ¥†
    const gifContainer = document.getElementById('ljhGifContainer');
    const gif = document.getElementById('ljhGif');
    const charImage = document.getElementById('popupCharImage');
    
    // ÈáçÁΩÆÁä∂ÊÄÅ
    gifContainer.classList.add('visible');
    charImage.classList.add('hidden');
    
    // ËÆæÁΩÆÊñáÊú¨ÂíåËØ≠Èü≥
    const charText = '‚ÄúÁ•ùÂÖ®‰∏ñÁïåÊúÄÊúÄÂèØÁà±ÁöÑ‰Ω†ÔºåÁîüÊó•Âø´‰πê!~ ÂßêÂßêÁöÑÊÑøÊúõÂïä‚Ä¶‚Ä¶Êó©Â∞±Ë¢´ÊàëÁöÑÁîªÁ¨îÂÅ∑ÂÅ∑ËóèËøõÊòüÁ©∫Èáå‰∫ÜÂï¶ÔºÅÊÑø‰Ω†ÁöÑÊØè‰∏™ÊúüÂæÖÈÉΩÂÉèÊú™Âπ≤ÁöÑÊ≤πÁîªÔºåË¢´Êó∂ÂÖâÈïÄ‰∏äÊõ¥ÁªöÁÉÇÁöÑÈáâÂΩ©‚Äî‚ÄîËÄåÊàëÔºåÊ∞∏Ëøú‰ºöÊòØÊâò‰Ωè‰Ω†ÊâÄÊúâÊòüËæ∞ÁöÑÈÇ£ÁâáÂ§úÂπï„ÄÇËøôÊ†∑Ë¥™ÂøÉÁöÑÂÆàÊä§ÔºåÂßêÂßêÂèØ‰∏çÂáÜÊãíÁªùÂë¢ÔΩû‚Äù';
    document.getElementById('popupCharText').textContent = charText;
    
    const charVoice = document.getElementById('popupCharVoice');
    charVoice.src = 'https://vacuopolis.netlify.app/audio/Â∞èÈôÜÁöÑÁîüÊó•Á•ùÁ¶è.mp3';

    // ÊòæÁ§∫ÂºπÁ™ó
    singleCharacterPopup.style.display = 'flex';
    singleCharacterPopup.style.opacity = '0';
    setTimeout(() => {
        singleCharacterPopup.style.opacity = '1';
    }, 50);

    // GIFÊí≠ÊîæÂÆåÊàêÂêéÂàáÊç¢Âà∞ÈùôÊÄÅÂõæÁâá
    setTimeout(() => {
        gifContainer.classList.remove('visible');
        charImage.classList.remove('hidden');
        
        // Êí≠ÊîæËØ≠Èü≥
        charVoice.play().catch(e => console.error("Popup voice play error:", e));
    }, 4000); 

    // ÈòªÊ≠¢ËÉåÊôØÊªöÂä®
    document.body.style.overflow = 'hidden';
}

    function closeSingleCharacterPopup() {
    // ÈáçÁΩÆGIFÂíåÂõæÁâáÁä∂ÊÄÅ
    document.getElementById('ljhGifContainer').classList.remove('visible');
    document.getElementById('popupCharImage').classList.add('hidden');
    
    // ÂÖ∂‰ΩôÂÖ≥Èó≠ÈÄªËæë
    singleCharacterPopup.style.opacity = '0';
    setTimeout(() => {
        singleCharacterPopup.style.display = 'none';
    }, 500);

    document.getElementById('popupCharVoice').pause();
    document.getElementById('popupCharVoice').currentTime = 0;

    // ÊÅ¢Â§ç‰∏ªÈ°µËÉåÊôØÈü≥‰πê
    if (document.getElementById('backgroundMusic').paused) {
        document.getElementById('backgroundMusic').play().then(() => {
            musicPlaying = true;
            document.getElementById('musicPlayer').classList.add('playing');
            document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">üéµ</span>';
        }).catch(e => console.warn("‰∏ªBGMÊÅ¢Â§çÈîôËØØ:", e));
    }
    
    document.body.style.overflow = '';
}
    
    /* ÂõæÁâáÊü•ÁúãÂô®Ê®°ÂùóÈÄªËæë */
/* ==================================== */
const photoViewerOverlay = document.getElementById('photoViewerOverlay');
const photoViewerImg = document.getElementById('photoViewerImg');
const photoViewerContent = document.getElementById('photoViewerContent');

let scale = 1,
    panning = false,
    pointX = 0,
    pointY = 0,
    start = { x: 0, y: 0 };

function setTransform() {
    // ÊîæÂ§ßÂêéÈôêÂà∂ÂõæÁâáÊãñÂä®ËåÉÂõ¥ÔºåÈò≤Ê≠¢ÊãñÂá∫ËßÜÂè£Â§™Ëøú
    if (scale > 1) {
        const imgRect = photoViewerImg.getBoundingClientRect();
        const contentRect = photoViewerContent.getBoundingClientRect();
        const max_x = Math.abs(imgRect.width - contentRect.width) / 2;
        const max_y = Math.abs(imgRect.height - contentRect.height) / 2;
        pointX = Math.max(-max_x, Math.min(max_x, pointX));
        pointY = Math.max(-max_y, Math.min(max_y, pointY));
    } else {
        // Áº©Â∞èÊó∂‰∏çÂÖÅËÆ∏ÊãñÂä®Ôºå‰ΩçÁΩÆÂΩíÈõ∂
        pointX = 0;
        pointY = 0;
    }
    photoViewerImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
}

function openPhotoViewer(imageUrl) {
    photoViewerImg.src = imageUrl;
    photoViewerOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Á¶ÅÊ≠¢ËÉåÊôØÊªöÂä®

    resetPhotoViewer();

    // Âª∂ËøüÊ∑ªÂä†‰∫ã‰ª∂ÁõëÂê¨Âô®ÔºåÁ°Æ‰øùÂÖÉÁ¥†Â∑≤Ê∏≤Êüì
    setTimeout(() => {
        photoViewerContent.addEventListener('mousedown', onPointerDown);
        photoViewerContent.addEventListener('mouseup', onPointerUp);
        photoViewerContent.addEventListener('mouseleave', onPointerUp);
        photoViewerContent.addEventListener('mousemove', onPointerMove);
        photoViewerContent.addEventListener('wheel', onWheel);
        photoViewerContent.addEventListener('dblclick', onDoubleClick);
    }, 0);
}

function closePhotoViewer(event) {
    // Â¶ÇÊûúÁÇπÂáª‰∫ÜÂÖ≥Èó≠ÊåâÈíÆ(ÊàñÂÖ∂‰ªñÂ≠êÂÖÉÁ¥†)ÔºåÈòªÊ≠¢‰∫ã‰ª∂ÂÜíÊ≥°Âà∞Áà∂ÂÖÉÁ¥†overlay
    if (event) {
        event.stopPropagation();
    }
    
    photoViewerOverlay.style.display = 'none';
    document.body.style.overflow = ''; // ÊÅ¢Â§çËÉåÊôØÊªöÂä®
    photoViewerImg.src = ''; // Ê∏ÖÁ©∫ÂõæÁâáÔºåÈáäÊîæÂÜÖÂ≠ò

    // ÁßªÈô§‰∫ã‰ª∂ÁõëÂê¨Âô®
    photoViewerContent.removeEventListener('mousedown', onPointerDown);
    photoViewerContent.removeEventListener('mouseup', onPointerUp);
    photoViewerContent.removeEventListener('mouseleave', onPointerUp);
    photoViewerContent.removeEventListener('mousemove', onPointerMove);
    photoViewerContent.removeEventListener('wheel', onWheel);
    photoViewerContent.removeEventListener('dblclick', onDoubleClick);
}

function resetPhotoViewer() {
    scale = 1;
    panning = false;
    pointX = 0;
    pointY = 0;
    start = { x: 0, y: 0 };
    photoViewerImg.style.transition = 'transform 0.2s ease-out'; // ÊÅ¢Â§çÂπ≥ÊªëËøáÊ∏°
    setTransform();
}

function onPointerDown(e) {
    e.preventDefault();
    if (scale <= 1) return; // Âè™ÊúâÊîæÂ§ßÊó∂ÊâçËÉΩÊãñÂä®
    start.x = e.clientX - pointX;
    start.y = e.clientY - pointY;
    panning = true;
    photoViewerImg.classList.add('panning');
    photoViewerImg.style.transition = 'none'; // ÊãñÂä®Êó∂ÁßªÈô§ËøáÊ∏°ÊïàÊûú‰ª•Ëé∑ÂæóÊõ¥ÊµÅÁïÖÁöÑ‰ΩìÈ™å
}

function onPointerUp(e) {
    panning = false;
    photoViewerImg.classList.remove('panning');
    photoViewerImg.style.transition = 'transform 0.2s ease-out';
}

function onPointerMove(e) {
    e.preventDefault();
    if (!panning) return;
    pointX = e.clientX - start.x;
    pointY = e.clientY - start.y;
    setTransform();
}

function onWheel(e) {
    e.preventDefault();
    const rect = photoViewerContent.getBoundingClientRect();
    const xs = (e.clientX - rect.left - pointX) / scale;
    const ys = (e.clientY - rect.top - pointY) / scale;
    const delta = -e.deltaY;

    const zoomFactor = 1.2;
    if (delta > 0) {
        scale *= zoomFactor;
    } else {
        scale /= zoomFactor;
    }
    
    // ÈôêÂà∂ÊúÄÂ∞èÁº©Êîæ‰∏∫1ÂÄçÔºàÂéüÂßãÂ§ßÂ∞èÔºâÔºåÊúÄÂ§ß‰∏∫10ÂÄç
    scale = Math.max(1, Math.min(scale, 10));

    pointX = e.clientX - rect.left - xs * scale;
    pointY = e.clientY - rect.top - ys * scale;
    setTransform();
}

function onDoubleClick(e) {
    e.preventDefault();
    if (scale > 1) {
        // Â¶ÇÊûúÂ∑≤ÊîæÂ§ßÔºåÂàôÊÅ¢Â§ç
        resetPhotoViewer();
    } else {
        // Â¶ÇÊûúÊòØÂéüÂ§ßÂ∞èÔºåÂàôÊîæÂ§ßÂà∞2.5ÂÄç
        const rect = photoViewerContent.getBoundingClientRect();
        scale = 2.5;
        // ÊîæÂ§ßÂà∞Èº†Ê†áÂèåÂáªÁöÑ‰ΩçÁΩÆ
        pointX = -(e.clientX - rect.left - rect.width / 2) * (scale - 1);
        pointY = -(e.clientY - rect.top - rect.height / 2) * (scale - 1);
        setTransform();
    }
}

    </script>
</body>
</html>