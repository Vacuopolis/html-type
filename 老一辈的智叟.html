<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è€ä¸€è¾ˆçš„æ™ºåŸ</title>
<style>
    body {
        margin: 0;
        padding: 0;
        font-family: 'Minecraft', Arial, sans-serif;
        background-color: #111;
        color: #fff;
        display: flex;
        flex-direction: column;
        height: 100vh;
        overflow: hidden;
    }
    .scene-container {
        position: relative;
        flex-grow: 1;
        overflow: hidden;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    .background-image {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        z-index: 1;
    }
    .villager-image {
        position: absolute;
        width: 100%;
        height: 100%;
        object-fit: cover;
        opacity: 0;
        transition: opacity 0.8s ease-out;
        z-index: 2;
    }
    @keyframes confettiAnimation {
        0% { opacity: 0; transform: translateY(0); }
        10% { opacity: 1; }
        100% { opacity: 0; transform: translateY(-100px) rotate(360deg); }
    }
    .confetti-container {
        position: absolute;
        left: 5%;
        bottom: 0%;
        width: 40%;
        height: 50%;
        z-index: 3;
        pointer-events: none;
    }
    .confetti {
        position: absolute;
        width: 8px;
        height: 16px;
        background-color: white;
        opacity: 0;
        animation: confettiAnimation 1.5s forwards;
    }
    .chat-container {
        background-color: rgba(0, 0, 0, 0.7);
        padding: 10px;
        border-top: 2px solid #555;
        height: 200px;
        display: flex;
        flex-direction: column;
        z-index: 10;
    }
    .chat-messages {
        flex-grow: 1;
        overflow-y: auto;
        margin-bottom: 10px;
        padding: 5px;
        scrollbar-width: thin;
        scrollbar-color: #555 rgba(0,0,0,0.3);
    }
    .chat-messages::-webkit-scrollbar {
        width: 8px;
    }
    .chat-messages::-webkit-scrollbar-track {
        background: rgba(0,0,0,0.3);
    }
    .chat-messages::-webkit-scrollbar-thumb {
        background-color: #555;
        border-radius: 4px;
    }
    .message {
        margin-bottom: 8px;
        word-wrap: break-word;
    }
    .player-message {
        color: #AAFFAA;
    }
    .villager-message {
        color: #FFAA55;
    }
    .chat-input {
        display: flex;
    }
    input {
        flex-grow: 1;
        padding: 8px;
        border: 2px solid #555;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        border-radius: 4px;
    }
    button {
        padding: 8px 15px;
        margin-left: 10px;
        background-color: #5D7;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    button:hover {
        background-color: #4C6;
    }
    .nametag {
        position: absolute;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 14px;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.5s;
        top: 33%;
        left: 22%;
        z-index: 4;
    }
    .speech-bubble {
    position: absolute;
    background-color: white;
    color: black;
    padding: 10px 15px;
    border-radius: 10px;
    max-width: 70%; /* å¢åŠ æœ€å¤§å®½åº¦ */
    max-height: 50vh; /* é™åˆ¶æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„50% */
    overflow-y: auto; /* æ·»åŠ å‚ç›´æ»šåŠ¨æ¡ */
    top: 28%;
    left: 35%;
    transform: translate(-50%, -100%);
    opacity: 0;
    transition: opacity 0.8s;
    z-index: 4;
    line-height: 1.4; /* å¢åŠ è¡Œé—´è· */
    font-size: 0.95em; /* ç¨å¾®å‡å°å­—ä½“å¤§å° */
}
/* æ·»åŠ æ»šåŠ¨æ¡æ ·å¼ */
.speech-bubble::-webkit-scrollbar {
    width: 6px;
}
.speech-bubble::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1);
    border-radius: 3px;
}
.speech-bubble::-webkit-scrollbar-thumb {
    background-color: rgba(0,0,0,0.3);
    border-radius: 3px;
}
/* è°ƒæ•´æ°”æ³¡å°¾éƒ¨ç®­å¤´ä½ç½®ï¼Œç¡®ä¿åœ¨æ»šåŠ¨æ—¶ä»ç„¶å¯è§ */
.speech-bubble:after {
    content: '';
    position: absolute;
    bottom: -15px;
    left: 20%;
    margin-left: -15px;
    border-width: 15px 15px 0;
    border-style: solid;
    border-color: white transparent;
}
    .reset-button {
        position: absolute;
        top: 10px;
        right: 10px;
        padding: 5px 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        border: 1px solid #555;
        border-radius: 4px;
        cursor: pointer;
        z-index: 10;
        transition: background-color 0.2s;
    }
    .reset-button:hover {
        background-color: rgba(50, 50, 50, 0.7);
    }
    .joker-image {
        position: absolute;
        width: 120px;
        height: 120px;
        top: 40%;
        left: 24%;
        transform: translateX(-50%);
        opacity: 0;
        transition: opacity 0.8s;
        z-index: 3;
        border-radius: 10px;
        display: none;
    }
    .audio-notification {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background-color: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        z-index: 100;
        display: none;
        text-align: center;
        max-width: 80%;
    }
    .notification-button {
        margin-top: 10px;
        padding: 8px 15px;
        background-color: #5D7;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
    }
    @media (max-width: 768px) {
    .speech-bubble {
        max-width: 85%; /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šå æ®æ›´å¤šç©ºé—´ */
        font-size: 0.9em; /* æ›´å°çš„å­—ä½“ */
        max-height: 40vh; /* åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé™åˆ¶é«˜åº¦ */
    }
    /* ä¿ç•™å…¶ä»–åŸæœ‰çš„åª’ä½“æŸ¥è¯¢æ ·å¼ */
    .chat-container {
        height: 150px;
    }
    .nametag {
        font-size: 12px;
    }
    .joker-image {
        width: 100px;
        height: 100px;
    }
}
    #loadingStatus {
        position: absolute;
        bottom: 5px;
        right: 5px;
        font-size: 12px;
        color: #aaa;
        z-index: 100;
    }
</style>
</head>
<body>
<div class="scene-container">
    <img src="https://stellar-cat-4909aa.netlify.app/image/EmptyBackground.png" alt="Minecraft Scene" class="background-image">
    <img src="https://stellar-cat-4909aa.netlify.app/image/VillagerAppear.png" alt="Villager Scene" class="villager-image">
    <div class="confetti-container" id="confettiContainer"></div>
    <div class="nametag">è€ä¸€è¾ˆçš„'æ™ºåŸ'</div>
    <div class="speech-bubble" aria-live="polite"></div>
    <img src="https://stellar-cat-4909aa.netlify.app/image/joker.jpeg" alt="Joker" class="joker-image" id="jokerImage">
    <audio id="villagerSound" preload="auto"></audio>
    <audio id="jokerSound" preload="auto"></audio>
    <audio id="easterEggSound" preload="auto"></audio>
    <div id="loadingStatus"></div>
    <div class="audio-notification" id="audioNotification">
        <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¯ç”¨éŸ³æ•ˆ</p>
        <button class="notification-button" id="enableAudioBtn">å¯ç”¨éŸ³æ•ˆ</button>
    </div>
</div>
<div class="chat-container">
    <div class="chat-messages" id="chatMessages">
        <div class="message">å½“ä½ å‡æœŸæ¥åˆ°è€å®¶ä¸€äººæˆ·åšå®¢æ—¶ä½ éšå£è¯´åˆ°....</div>
    </div>
    <div class="chat-input">
        <input type="text" id="messageInput" placeholder="è¾“å…¥èŠå¤©å†…å®¹..." aria-label="èŠå¤©è¾“å…¥æ¡†">
        <button id="sendButton">å‘é€</button>
    </div>
</div>
<script>
    // å…¨å±€å˜é‡
    let chatMessages;
    let messageInput;
    let villagerImage;
    let confettiContainer;
    let nametag;
    let speechBubble;
    let villagerSound;
    let jokerSound;
    let easterEggSound;
    let loadingStatus;
    let audioNotification;
    let enableAudioBtn;
    let jokerImage;
    let sendButton;
    let villagerSummoned = false;
    let jokerTimeout = null; // ç”¨äºå­˜å‚¨jokeræ˜¾ç¤ºçš„timeout
    let audioInitialized = false;
    let jokerReady = false; // è·Ÿè¸ªJokeræ˜¯å¦å‡†å¤‡å¥½æ˜¾ç¤º
    let pendingJokerDisplay = false; // æ ‡è®°æ˜¯å¦æœ‰å¾…æ˜¾ç¤ºçš„Joker
    let isEasterEggTriggered = false; // æ ‡è®°æ˜¯å¦è§¦å‘äº†å½©è›‹

    // ç¡®ä¿æ‰€æœ‰å‡½æ•°å®šä¹‰ä¸ºå…¨å±€
    window.setupAudio = function() {
        villagerSound.src = "https://stellar-cat-4909aa.netlify.app/audio/lybdzs.mp3";
        jokerSound.src = "https://stellar-cat-4909aa.netlify.app/audio/joker.mp3";
        easterEggSound.src = "https://stellar-cat-4909aa.netlify.app/audio/EasterEgg.m4a";
        // é¢„åŠ è½½éŸ³é¢‘
        villagerSound.load();
        jokerSound.load();
        easterEggSound.load();
    };

    // åˆå§‹åŒ–éŸ³é¢‘
    window.initializeAudio = function() {
        if (audioInitialized) return Promise.resolve();
        return new Promise((resolve, reject) => {
            // æ’­æ”¾ä¸€ä¸ªé™éŸ³çš„éŸ³é¢‘æ¥åˆå§‹åŒ–éŸ³é¢‘ä¸Šä¸‹æ–‡
            const silentPlay = villagerSound.play();
            if (silentPlay !== undefined) {
                silentPlay.then(() => {
                    villagerSound.pause();
                    villagerSound.currentTime = 0;
                    return jokerSound.play();
                })
                .then(() => {
                    jokerSound.pause();
                    jokerSound.currentTime = 0;
                    return easterEggSound.play();
                })
                .then(() => {
                    easterEggSound.pause();
                    easterEggSound.currentTime = 0;
                    audioInitialized = true;
                    console.log("éŸ³é¢‘åˆå§‹åŒ–æˆåŠŸ");
                    // å¦‚æœæœ‰å¾…æ˜¾ç¤ºçš„Jokerï¼Œç°åœ¨æ˜¾ç¤º
                    if (pendingJokerDisplay && jokerReady && !isEasterEggTriggered) {
                        displayJoker();
                    }
                    resolve();
                })
                .catch(error => {
                    console.warn("éŸ³é¢‘åˆå§‹åŒ–å¤±è´¥:", error);
                    showAudioNotification();
                    reject(error);
                });
            } else {
                reject(new Error("æ— æ³•åˆå§‹åŒ–éŸ³é¢‘"));
            }
        });
    };

    // æ˜¾ç¤ºéŸ³é¢‘é€šçŸ¥
    window.showAudioNotification = function() {
        audioNotification.style.display = 'block';
    };

    // éšè—éŸ³é¢‘é€šçŸ¥
    window.hideAudioNotification = function() {
        audioNotification.style.display = 'none';
    };

    // å‘é€æ¶ˆæ¯å‡½æ•°
    window.sendMessage = function() {
        const message = messageInput.value.trim();
        if (message === '') return;
        
        // å°è¯•åˆå§‹åŒ–éŸ³é¢‘
        initializeAudio().catch(() => console.log("é€šè¿‡æ¶ˆæ¯å‘é€åˆå§‹åŒ–éŸ³é¢‘å¤±è´¥"));
        
        // æ·»åŠ ä½ çš„æ¶ˆæ¯
        const playerMessageDiv = document.createElement('div');
        playerMessageDiv.className = 'message player-message';
        playerMessageDiv.textContent = `ä½ : ${message}`;
        chatMessages.appendChild(playerMessageDiv);
        
        // æ£€æŸ¥æ˜¯å¦è§¦å‘å½©è›‹
        if (message === "ğŸŒ°") {
            isEasterEggTriggered = true;
            if (jokerTimeout) {
                clearTimeout(jokerTimeout);
                jokerTimeout = null;
            }
            summonVillagerWithEasterEgg();
        }
        // æ£€æŸ¥æ˜¯å¦åŒ…å«"è¡¨å§"
        else if (message.includes('è¡¨å§') && !villagerSummoned) {
            summonVillager();
        }
        
        // æ¸…ç©ºè¾“å…¥æ¡†å¹¶æ»šåŠ¨åˆ°åº•éƒ¨
        messageInput.value = '';
        chatMessages.scrollTop = chatMessages.scrollHeight;
    };

    // æ ¹æ®è®¾å¤‡æ€§èƒ½ç¡®å®šç²’å­æ•°é‡
    window.getConfettiCount = function() {
        // æ£€æµ‹æ˜¯å¦æ˜¯æ€§èƒ½è¾ƒä½çš„è®¾å¤‡
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        return isMobile ? 100 : 200; // ç§»åŠ¨è®¾å¤‡å‡å°‘ç²’å­æ•°é‡
    };

    window.createConfetti = function() {
        // æ¸…ç©ºç°æœ‰çº¸å±‘
        confettiContainer.innerHTML = '';
        // åˆ›å»ºå¤šä¸ªçº¸å±‘å…ƒç´ 
        const confettiCount = getConfettiCount();
        for (let i = 0; i < confettiCount; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti';
            // éšæœºä½ç½®
            confetti.style.left = Math.random() * 100 + '%';
            confetti.style.top = Math.random() * 100 + '%';
            // éšæœºå»¶è¿Ÿ
            confetti.style.animationDelay = Math.random() * 0.8 + 's';
            // éšæœºæ—‹è½¬
            confetti.style.transform = `rotate(${Math.random() * 360}deg)`;
            // éšæœºé¢œè‰²
            const colors = ['#ffffff', '#dedede', '#f0f0f0', '#ffffff'];
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            // éšæœºå¤§å°
            const size = Math.random() * 6 + 3;
            confetti.style.width = `${size}px`;
            confetti.style.height = `${size * 1.5}px`;
            confettiContainer.appendChild(confetti);
        }
    };

    // æ‰“å­—æœºæ•ˆæœå‡½æ•°
    window.typewriterEffect = function(element, text, speed = 40, callback) {
        element.textContent = ''; // æ¸…ç©ºå†…å®¹
        let i = 0;
        function typeNextChar() {
            if (i < text.length) {
                element.textContent += text.charAt(i);
                i++;
                setTimeout(typeNextChar, speed);
            } else if (callback) {
                callback(); // æ‰“å­—æ•ˆæœå®Œæˆåæ‰§è¡Œå›è°ƒ
            }
        }
        typeNextChar();
    };

    window.summonVillager = function() {
        villagerSummoned = true;
        // åˆ›å»ºçº¸å±‘æ•ˆæœå¹¶å¼€å§‹æ¸æ˜¾å›¾ç‰‡
        createConfetti();
        villagerImage.style.opacity = '1';
        // æ˜¾ç¤ºæ‘æ°‘åç§°æ ‡ç­¾
        setTimeout(() => {
            nametag.style.opacity = 1;
            // æ˜¾ç¤ºæ‘æ°‘å¯¹è¯
            setTimeout(() => {
                speechBubble.style.opacity = 1;
                // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºæ–‡æœ¬
                const villagerText = "ä½ åˆšåˆšè¯´äº†è¡¨å§æ˜¯å§ï¼Œé¦–å…ˆæˆ‘è®¤ä¸ºå¥¹å°±æ˜¯å¾ˆå¤±è´¥çš„ï¼Œå› ä¸ºå¥¹æ²¡æœ‰æ‰¾ç”·äººç»“å©šå¥¹å­¦å†é«˜æœ‰å•¥ç”¨ï¼Œä¸è¿˜æ˜¯æ²¡ç”·äººè¦å—ï¼Ÿ";
                typewriterEffect(speechBubble, villagerText, 40, showJokerAfterDelay);
                // æ’­æ”¾éŸ³é¢‘
                playVillagerSound();
                // æ·»åŠ æ‘æ°‘æ¶ˆæ¯åˆ°èŠå¤©åŒº
                const villagerMessageDiv = document.createElement('div');
                villagerMessageDiv.className = 'message villager-message';
                villagerMessageDiv.textContent = `è€ä¸€è¾ˆçš„'æ™ºåŸ': ${villagerText}`;
                chatMessages.appendChild(villagerMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }, 500);
        }, 800);
    };

    // å½©è›‹è§¦å‘æ—¶çš„æ‘æ°‘å¬å”¤å‡½æ•°
    window.summonVillagerWithEasterEgg = function() {
        villagerSummoned = true;
        // åˆ›å»ºçº¸å±‘æ•ˆæœå¹¶å¼€å§‹æ¸æ˜¾å›¾ç‰‡
        createConfetti();
        villagerImage.style.opacity = '1';
        // æ˜¾ç¤ºæ‘æ°‘åç§°æ ‡ç­¾
        setTimeout(() => {
            nametag.style.opacity = 1;
            // æ˜¾ç¤ºæ‘æ°‘å¯¹è¯
            setTimeout(() => {
                speechBubble.style.opacity = 1;
                // ä½¿ç”¨æ‰“å­—æœºæ•ˆæœæ˜¾ç¤ºå½©è›‹æ–‡æœ¬ï¼ŒåŠ å¿«é€Ÿåº¦
                const easterEggText = "æˆ‘è®¤ä¸ºæ —å­æ˜¯æ²‰é™ä¸­å¸¦ç€çµåŠ¨çš„ï¼Œæ¸©æš–è€Œä¸å¤±åšéŸ§çš„ï¼Œå¯é ä¸”å–„è§£äººæ„çš„ï¼Œä½è°ƒè°¦é€Šå´å¯Œæœ‰å¥½å¥‡å¿ƒçš„ï¼Œå…¼å…·å†·é™ç†æ€§ä¸æ•é”åŒç†å¿ƒçš„ï¼Œæ€ç»´ç¼œå¯†åˆå¯Œæœ‰åˆ›é€ åŠ›çš„ï¼Œå‹¤å¥‹åŠ¡å®è€Œæ‰§ç€åšå®šçš„ï¼Œä¹è§‚å‘ä¸Šä¸”å¿ƒæ€€çƒ­å¿±çš„ï¼Œå¹½é»˜é£è¶£å´çœŸè¯šå¦ç‡çš„ï¼Œè„šè¸å®åœ°è€Œè¿½æ±‚å“è¶Šçš„ï¼Œç‹¬ç«‹è‡ªä¸»ä¸”å¯Œæœ‰ä¸»è§çš„ï¼Œè‡ªå¾‹å…‹å·±åˆè™šæ€€è‹¥è°·çš„ï¼ŒçŸ¥è¡Œåˆä¸€å´é»˜é»˜è€•è€˜çš„ï¼Œå¿ƒæ€ç»†è…»è€Œè¡ŒåŠ¨æœå†³çš„ï¼Œå–„äºè§‚å¯Ÿä¸”é”æ„åˆ›æ–°çš„ï¼Œå¤–æŸ”å†…åˆšåˆå†…å¿ƒä¸°ç›ˆçš„ä¸€ä½åŒ»å­¦ç”Ÿã€‚";
                // æé«˜æ‰“å­—é€Ÿåº¦åˆ°20ï¼Œè®©é•¿æ–‡æœ¬æ›´å¿«æ˜¾ç¤º
                typewriterEffect(speechBubble, easterEggText, 20);
                // æ’­æ”¾å½©è›‹éŸ³é¢‘
                playEasterEggSound();
                // æ·»åŠ å½©è›‹æ¶ˆæ¯åˆ°èŠå¤©åŒº
                const villagerMessageDiv = document.createElement('div');
                villagerMessageDiv.className = 'message villager-message';
                villagerMessageDiv.textContent = `è€ä¸€è¾ˆçš„'æ™ºåŸ': ${easterEggText}`;
                chatMessages.appendChild(villagerMessageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
                // ç¡®ä¿speech-bubbleæ–‡æœ¬å®Œæˆåæ»šåŠ¨åˆ°é¡¶éƒ¨
                setTimeout(() => {
                    speechBubble.scrollTop = 0;
                }, easterEggText.length * 20 + 100); // æ ¹æ®æ‰“å­—é€Ÿåº¦å’Œæ–‡æœ¬é•¿åº¦ä¼°ç®—å®Œæˆæ—¶é—´
            }, 500);
        }, 800);
    };

    window.showJokerAfterDelay = function() {
        // å¦‚æœè§¦å‘äº†å½©è›‹ï¼Œä¸æ˜¾ç¤ºJoker
        if (isEasterEggTriggered) return;
        // åœ¨æ§åˆ¶å°æ˜¾ç¤ºç­‰å¾…å¼€å§‹ä¿¡æ¯
        console.log("ç­‰å¾…6ç§’åæ˜¾ç¤ºJoker...");
        // å°è¯æ‰“å®Œåç­‰å¾…6ç§’æ˜¾ç¤ºJoker
        jokerTimeout = setTimeout(() => {
            console.log("Jokerå‡†å¤‡æ˜¾ç¤º");
            jokerReady = true;
            // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ’­æ”¾éŸ³é¢‘
            if (audioInitialized) {
                displayJoker();
            } else {
                pendingJokerDisplay = true;
                showAudioNotification();
            }
        }, 6000); // 6ç§’å»¶è¿Ÿï¼Œå¯ä»¥è°ƒæ•´
    };

    window.displayJoker = function() {
        // å¦‚æœè§¦å‘äº†å½©è›‹ï¼Œä¸æ˜¾ç¤ºJoker
        if (isEasterEggTriggered) return;
        console.log("æ˜¾ç¤ºJoker");
        pendingJokerDisplay = false;
        jokerImage.style.display = 'block';
        setTimeout(() => {
            jokerImage.style.opacity = 1;
            playJokerSound();
        }, 50);
    };

    // æ’­æ”¾éŸ³é¢‘çš„å‡½æ•°
    window.playVillagerSound = function() {
        if (!audioInitialized) {
            initializeAudio().catch(() => console.log("æ’­æ”¾æ‘æ°‘å£°éŸ³æ—¶åˆå§‹åŒ–éŸ³é¢‘å¤±è´¥"));
            return;
        }
        // é‡ç½®éŸ³é¢‘åˆ°å¼€å§‹ä½ç½®ï¼ˆå¦‚æœå·²ç»æ’­æ”¾è¿‡ï¼‰
        villagerSound.currentTime = 0;
        // æ’­æ”¾éŸ³é¢‘å¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯
        const playPromise = villagerSound.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("æ’­æ”¾æ‘æ°‘éŸ³é¢‘å¤±è´¥:", error);
            });
        }
    };

    window.playJokerSound = function() {
        if (!audioInitialized) {
            console.log("éŸ³é¢‘æœªåˆå§‹åŒ–ï¼Œä¸èƒ½æ’­æ”¾JokeréŸ³æ•ˆ");
            return;
        }
        console.log("æ’­æ”¾JokeréŸ³æ•ˆ");
        jokerSound.currentTime = 0;
        const playPromise = jokerSound.play();
        if (playPromise !== undefined) {
            playPromise.then(() => {
                console.log("JokeréŸ³æ•ˆæ’­æ”¾æˆåŠŸ");
            }).catch(error => {
                console.error("æ’­æ”¾JokeréŸ³æ•ˆå¤±è´¥:", error);
                showAudioNotification();
            });
        }
    };

    // æ’­æ”¾å½©è›‹éŸ³é¢‘
    window.playEasterEggSound = function() {
        if (!audioInitialized) {
            initializeAudio().catch(() => console.log("æ’­æ”¾å½©è›‹éŸ³é¢‘æ—¶åˆå§‹åŒ–éŸ³é¢‘å¤±è´¥"));
            return;
        }
        // é‡ç½®éŸ³é¢‘åˆ°å¼€å§‹ä½ç½®
        easterEggSound.currentTime = 0;
        // æ’­æ”¾éŸ³é¢‘å¹¶å¤„ç†å¯èƒ½çš„é”™è¯¯
        const playPromise = easterEggSound.play();
        if (playPromise !== undefined) {
            playPromise.catch(error => {
                console.error("æ’­æ”¾å½©è›‹éŸ³é¢‘å¤±è´¥:", error);
                showAudioNotification();
            });
        }
    };

    // é‡ç½®åœºæ™¯çš„åŠŸèƒ½
    window.resetScene = function() {
        // å¦‚æœå½©è›‹å·²ç»è§¦å‘ä¸”æ­£åœ¨æ˜¾ç¤ºï¼Œåˆ™é˜»æ­¢é‡ç½®
        if (isEasterEggTriggered) {
            // ç”¨æˆ·å°è¯•é‡ç½®å½©è›‹æ—¶å¯ä»¥æ˜¾ç¤ºä¸€ä¸ªå°æç¤º
            showEasterEggResetMessage();
            return; // ç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œé‡ç½®æ“ä½œ
        }
        villagerImage.style.opacity = '0';
        nametag.style.opacity = 0;
        speechBubble.style.opacity = 0;
        speechBubble.textContent = '';
        villagerSummoned = false;
        confettiContainer.innerHTML = '';
        // æ¸…é™¤joker timeout
        if (jokerTimeout) {
            clearTimeout(jokerTimeout);
            jokerTimeout = null;
        }
        // éšè—Jokerå›¾ç‰‡
        jokerImage.style.opacity = 0;
        setTimeout(() => {
            jokerImage.style.display = 'none';
        }, 800);
        // é‡ç½®JokerçŠ¶æ€
        jokerReady = false;
        pendingJokerDisplay = false;
        // åœæ­¢æ‰€æœ‰éŸ³é¢‘
        villagerSound.pause();
        villagerSound.currentTime = 0;
        jokerSound.pause();
        jokerSound.currentTime = 0;
        easterEggSound.pause();
        easterEggSound.currentTime = 0;
        // éšè—éŸ³é¢‘é€šçŸ¥
        hideAudioNotification();
        loadingStatus.textContent = "";
    };

    // æç¤ºå½©è›‹ä¸èƒ½é‡ç½®çš„æ¶ˆæ¯
    window.showEasterEggResetMessage = function() {
        console.log("å½©è›‹å·²è§¦å‘ï¼Œæ— æ³•é‡ç½®");
        // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ ä¸€ä¸ªæç¤ºæ¶ˆæ¯çš„å®ç°
    };

    // DOMåŠ è½½å®Œæˆåæ‰§è¡Œåˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        // è·å–DOMå…ƒç´ 
        chatMessages = document.getElementById('chatMessages');
        messageInput = document.getElementById('messageInput');
        villagerImage = document.querySelector('.villager-image');
        confettiContainer = document.getElementById('confettiContainer');
        nametag = document.querySelector('.nametag');
        speechBubble = document.querySelector('.speech-bubble');
        villagerSound = document.getElementById('villagerSound');
        jokerSound = document.getElementById('jokerSound');
        easterEggSound = document.getElementById('easterEggSound');
        loadingStatus = document.getElementById('loadingStatus');
        audioNotification = document.getElementById('audioNotification');
        enableAudioBtn = document.getElementById('enableAudioBtn');
        jokerImage = document.getElementById('jokerImage');
        sendButton = document.getElementById('sendButton');

        // ç»‘å®šå‘é€æŒ‰é’®ç‚¹å‡»äº‹ä»¶
        if (sendButton) {
            sendButton.addEventListener('click', sendMessage);
        }
        
        // ç»‘å®šEnteré”®äº‹ä»¶
        if (messageInput) {
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        }
        
        // ç»‘å®šéŸ³é¢‘å¯ç”¨æŒ‰é’®äº‹ä»¶
        enableAudioBtn.addEventListener('click', function() {
            initializeAudio()
                .then(() => {
                    hideAudioNotification();
                    // å¦‚æœJokerå·²å‡†å¤‡å¥½æ˜¾ç¤ºä½†å°šæœªæ˜¾ç¤ºï¼Œæ˜¾ç¤ºå®ƒ
                    if (jokerReady && !jokerImage.style.opacity === '1' && !isEasterEggTriggered) {
                        displayJoker();
                    }
                })
                .catch(e => console.error("å¯ç”¨éŸ³é¢‘å¤±è´¥:", e));
        });

        // åŒå‡»èƒŒæ™¯é‡ç½®åœºæ™¯
        document.querySelector('.scene-container').addEventListener('dblclick', function(e) {
            // å¦‚æœå½©è›‹å·²ç»è§¦å‘ï¼Œåˆ™é˜»æ­¢äº‹ä»¶é»˜è®¤è¡Œä¸ºå’Œå†’æ³¡
            if (isEasterEggTriggered) {
                e.preventDefault();
                e.stopPropagation();
                showEasterEggResetMessage();
                return false;
            }
            resetScene();
        });

        // è§¦æ‘¸è®¾å¤‡æ”¯æŒ
        let lastTapTime = 0;
        document.querySelector('.scene-container').addEventListener('touchend', function(e) {
            const currentTime = new Date().getTime();
            const tapLength = currentTime - lastTapTime;
            if (tapLength < 500 && tapLength > 0) {
                // å¦‚æœå½©è›‹å·²ç»è§¦å‘ï¼Œåˆ™é˜»æ­¢å¿«é€ŸåŒå‡»é‡ç½®
                if (isEasterEggTriggered) {
                    e.preventDefault();
                    showEasterEggResetMessage();
                    return false;
                }
                resetScene();
                e.preventDefault();
            }
            lastTapTime = currentTime;
        });

        // è®¾ç½®éŸ³é¢‘
        setupAudio();
        
        // å°è¯•è·å–ç„¦ç‚¹å¹¶åˆå§‹åŒ–éŸ³é¢‘
        setTimeout(() => {
            messageInput.focus();
            // è½»å¾®å»¶è¿Ÿåå°è¯•åˆå§‹åŒ–éŸ³é¢‘
            setTimeout(() => {
                initializeAudio().catch(() => console.log("é¡µé¢åŠ è½½ååˆå§‹åŒ–éŸ³é¢‘å¤±è´¥"));
            }, 1000);
        }, 500);
    });

    // ç›‘å¬ç”¨æˆ·äº¤äº’ä»¥åˆå§‹åŒ–éŸ³é¢‘
    document.addEventListener('click', function() {
        initializeAudio().catch(() => console.log("é€šè¿‡ç‚¹å‡»åˆå§‹åŒ–éŸ³é¢‘å¤±è´¥"));
    });
</script>
</body>
</html>
