<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‡´æ —å­ğŸŒ° - 581å¤©çš„ç¾å¥½ç›¸é‡</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@300;400;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary-gradient: linear-gradient(135deg, #FF6B9D 0%, #C66FBC 25%, #7C4DFF 50%, #536DFE 75%, #66B3F9 100%);
            --secondary-gradient: linear-gradient(135deg, #FFA726 0%, #FF7043 50%, #F06292 100%);
            --glass-bg: rgba(255, 255, 255, 0.08);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background: var(--primary-gradient);
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }

        /* ç²’å­èƒŒæ™¯ */
        .particles {
            position: fixed;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: 1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            border-radius: 50%;
            pointer-events: none;
            animation: float-particle 15s infinite linear;
        }

        @keyframes float-particle {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateY(-100vh) rotate(720deg);
                opacity: 0;
            }
        }

        /* ä¸»å®¹å™¨ */
        .main-container {
            position: relative;
            z-index: 10;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* è¿›åº¦æ¡ */
        .progress-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.1);
            z-index: 100;
        }

        .progress-fill {
            height: 100%;
            background: var(--secondary-gradient);
            width: 0%;
            transition: width 0.8s ease;
        }

        /* åœºæ™¯å®¹å™¨ */
        .scene {
            display: none;
            animation: sceneIn 0.8s ease-out;
        }

        .scene.active {
            display: block;
        }

        @keyframes sceneIn {
            from {
                opacity: 0;
                transform: translateY(30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ç»ç’ƒå¡ç‰‡ */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 40px;
            margin: 20px auto;
            max-width: 800px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
            color: white;
        }

        /* æ ‡é¢˜æ ·å¼ */
        h1 {
            font-size: 3em;
            background: linear-gradient(45deg, #FFD700, #FF69B4, #00CED1);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 20px;
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0%, 100% { filter: brightness(1); }
            50% { filter: brightness(1.3); }
        }

        h2 {
            color: #FFFFFF;
            font-size: 2em;
            margin-bottom: 15px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        p {
            color: rgba(255, 255, 255, 0.9);
            font-size: 1.2em;
            line-height: 1.8;
            margin-bottom: 20px;
        }

        /* æ —å­åŠ¨ç”» */
        .chestnut-icon {
            font-size: 4em;
            display: inline-block;
            animation: chestnut-bounce 2s ease-in-out infinite;
            margin: 20px 0;
        }

        @keyframes chestnut-bounce {
            0%, 100% { transform: translateY(0) rotate(0deg); }
            25% { transform: translateY(-20px) rotate(-10deg); }
            75% { transform: translateY(-20px) rotate(10deg); }
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            background: var(--secondary-gradient);
            color: white;
            border: none;
            padding: 16px 40px;
            border-radius: 50px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 10px;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.3);
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(255, 107, 107, 0.4);
        }

        /* æ¸¸æˆå±•ç¤ºåŒº */
        .games-showcase {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px; 
            margin: 40px 0;
            padding: 0 10px; 
        }

        .game-item {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 20px; 
            text-align: center;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
            position: relative;
            overflow: hidden; 
            height: auto; 
            min-height: 250px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .game-item:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-5px);
        }

        .game-item::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1), transparent);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .game-item:hover::before {
            opacity: 1;
        }

        .game-item:hover {
            transform: translateY(-10px) scale(1.05);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .game-icon {
            width: 100px; 
            height: 100px;
            margin: 0 auto 15px auto;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            flex-shrink: 0; 
        }

        .game-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s ease;
        }

        .game-item:hover .game-icon img {
            transform: scale(1.1);
        }

        /* è®¡æ•°å™¨ */
        .counter-display {
            font-size: 5em;
            font-weight: bold;
            background: linear-gradient(45deg, #FFD700, #FFA500);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
            margin: 20px 0;
        }

        /* è®¸æ„¿æ± æ ·å¼ */
        .wish-pool {
            background: linear-gradient(135deg, rgba(124, 77, 255, 0.2), rgba(83, 109, 254, 0.2));
            border: 2px solid rgba(124, 77, 255, 0.5);
            border-radius: 20px;
            padding: 30px;
            margin: 30px 0;
            backdrop-filter: blur(10px);
        }

        .wish-input {
            width: 100%;
            height: 120px;
            padding: 15px;
            border-radius: 15px;
            border: 2px solid rgba(124, 77, 255, 0.6);
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 1.1em;
            font-family: 'Noto Sans SC', sans-serif;
            resize: vertical;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .wish-input:focus {
            outline: none;
            border-color: #FFD700;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .wish-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* ç¥ç¦å¢™ */
        .wishes-wall {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin: 30px 0;
        }

        .wish-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 20px;
            transform: rotate(var(--rotation, 0deg));
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .wish-card:hover {
            transform: rotate(0deg) scale(1.1);
            z-index: 10;
        }

        /* æµ®åŠ¨å…ƒç´  */
        .floating-element {
            position: fixed;
            pointer-events: none;
            animation: float-up 6s ease-out forwards;
            z-index: 1000;
            font-size: 1.1em;
            left: 50% !important;
            transform: translateX(-50%);
        }

        @keyframes float-up {
            0% {
                opacity: 0;
                transform: translateX(-50%) translateY(50px) scale(0.8);
            }
            15% {
                opacity: 1;
                transform: translateX(-50%) translateY(0px) scale(1);
            }
            85% {
                opacity: 1;
                transform: translateX(-50%) translateY(-20px) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateX(-50%) translateY(-100px) scale(0.8);
            }
        }
        
        /* çƒŸèŠ±æ•ˆæœ */
        .firework {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
        }

        .firework-particle {
            position: absolute;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            animation: explode 1s ease-out forwards;
            z-index: 9999;
        }

        @keyframes explode {
            0% {
                transform: translate(0, 0);
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        /* å¯¹è¯æ¡† */
.dialog-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.6);
    display: none;
    z-index: 999;
    backdrop-filter: blur(5px);
}

.dialog-box {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--glass-bg);
    backdrop-filter: blur(20px);
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 24px;
    padding: 40px;
    max-width: 600px;
    max-height: 80vh;
    width: 90%;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    display: none;
    z-index: 1000;
    animation: dialogIn 0.4s ease-out;
    overflow-y: auto;
    color: white; 
}

@keyframes dialogIn {
    from {
        opacity: 0;
        transform: translate(-50%, -50%) scale(0.8);
    }
    to {
        opacity: 1;
        transform: translate(-50%, -50%) scale(1);
    }
}

        /* éŸ³ä¹æ’­æ”¾å™¨æ ·å¼ */
        .music-player {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 2001;
            transition: all 0.3s ease;
        }

        .music-player:hover {
            transform: scale(1.1);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .music-player.playing {
            animation: musicPulse 2s infinite;
        }

        @keyframes musicPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* ==================================== */
        /* æ¸¸æˆæ¨¡å—åŸºç¡€æ ·å¼ */
        /* ==================================== */
        .game-module-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: black; /* é»˜è®¤é»‘è‰²èƒŒæ™¯ */
            display: none; /* é»˜è®¤éšè— */
            z-index: 20000; /* ç¡®ä¿è¦†ç›–åœ¨å…¶ä»–å†…å®¹ä¹‹ä¸Š */
            overflow: hidden; /* é˜²æ­¢å†…å®¹æº¢å‡º */
            user-select: none; /* é˜²æ­¢æ–‡æœ¬è¢«é€‰ä¸­ */
            cursor: pointer; /* æç¤ºç”¨æˆ·å¯ä»¥ç‚¹å‡»æ¨è¿› */
            transition: opacity 0.5s ease-out; /* æ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
        }

        .game-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-size: cover; /* ç¡®ä¿èƒŒæ™¯è¦†ç›–æ•´ä¸ªåŒºåŸŸ */
            background-position: center;
            transition: background-image 0.8s ease-in-out; /* èƒŒæ™¯åˆ‡æ¢åŠ¨ç”» */
        }

        /* é»˜è®¤æ¨ªå±èƒŒæ™¯ (ç”µè„‘) */
        .game-background.landscape {
            background-image: url('https://vacuopolis.netlify.app/image/bg_landscape_scene1.png');
        }
        /* ç«–å±èƒŒæ™¯ (æ‰‹æœº) */
        .game-background.portrait {
            background-image: url('https://vacuopolis.netlify.app/image/bg_portrait_scene1.png');
        }

        .game-character {
            position: absolute;
            bottom: 0; /* è´´åˆåº•éƒ¨ */
            left: 50%;
            transform: translateX(-50%); /* æ°´å¹³å±…ä¸­ */
            max-height: 80vh; /* æœ€å¤§é«˜åº¦ä¸ºè§†å£é«˜åº¦çš„80% */
            width: auto; /* ä¿æŒå›¾ç‰‡æ¯”ä¾‹ */
            max-width: 90vw; /* æœ€å¤§å®½åº¦ä¸ºè§†å£å®½åº¦çš„90% */
            object-fit: contain; /* ç¡®ä¿å›¾ç‰‡å®Œæ•´æ˜¾ç¤º */
            transition: opacity 0.5s ease-in-out; /* æ˜¾éšåŠ¨ç”» */
            pointer-events: none; /* ä¸ä¼šé˜»æŒ¡ç‚¹å‡»äº‹ä»¶ */
        }

        .game-menu-button {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 80px;
            height: 80px;
            background-image: url('https://vacuopolis.netlify.app/image/game_menu_icon.png'); /* èœå•å›¾æ ‡ */
            background-size: cover;
            border-radius: 50%; /* å¦‚æœæ˜¯åœ†å½¢æŒ‰é’® */
            cursor: pointer;
            z-index: 2010; /* ç¡®ä¿åœ¨å…¶ä»–å…ƒç´ ä¹‹ä¸Š */
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s ease;
        }
        .game-menu-button:hover {
            transform: scale(1.05);
        }

        .game-dialogue-box {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px); /* æ‰‹æœºç«¯ç•™è¾¹è· */
            max-width: 1100px; /* PCç«¯æœ€å¤§å®½åº¦ */
            height: 170px;
            background-image: url('https://vacuopolis.netlify.app/image/dialogbox.png'); /* å¯¹è¯æ¡†å›¾ç‰‡ */
            background-size: 100% 100%; /* ç¡®ä¿å›¾ç‰‡æ‹‰ä¼¸å¡«å…… */
            background-repeat: no-repeat;
            padding: 30px 40px; /* æ ¹æ®å¯¹è¯æ¡†å›¾ç‰‡é¢„ç•™å†…å®¹åŒºåŸŸ */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            justify-content: flex-end; /* å†…å®¹é ä¸‹å¯¹é½ */
            color: white;
            font-size: 1.2em;
            line-height: 1.6;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
            z-index: 2005; /* åœ¨äººç‰©å’ŒèƒŒæ™¯ä¹‹ä¸Š */
            pointer-events: auto; /* å¯ç‚¹å‡» */
            bottom: 20px; /* é»˜è®¤åº•éƒ¨åç§» */
            /* åŠ¨ç”»æ•ˆæœï¼Œå¯é€‰ */
            animation: fadeInSlideUp 0.6s ease-out;
        }        
        
.game-dialogue-box .dialogue-text {
    margin-top: 20px; /* æ–‡æœ¬å’Œåå­—çš„é—´è· */
    overflow-y: auto;
    white-space: pre-wrap; /* ä¿ç•™æ–‡æœ¬ä¸­çš„æ¢è¡Œç¬¦ */
    max-height: 80px;
    padding-right: 10px; 

    /* ä¸ºä¸åŒæµè§ˆå™¨éšè—æ»šåŠ¨æ¡ */
    -ms-overflow-style: none;  /* IE and Edge */
    scrollbar-width: none;  /* Firefox */
}

/* éšè—Webkitæµè§ˆå™¨ï¼ˆå¦‚Chrome, Safariï¼‰çš„æ»šåŠ¨æ¡ */
.game-dialogue-box .dialogue-text::-webkit-scrollbar {
    display: none;
}
        
        /* è¯´è¯äººåå­—æ¡†æ ·å¼ */
.speaker-name-box {
    position: absolute;
    /* ç›¸å¯¹äºçˆ¶å…ƒç´  .game-dialogue-box å®šä½ */
    /* å‘ä¸Šæ–¹ç§»åŠ¨ï¼Œä½¿å…¶æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†å¤–éƒ¨ */
    top: -60px; /* æ ¹æ® speaker_name.png çš„é«˜åº¦å’Œä¸å¯¹è¯æ¡†çš„é—´è·è°ƒæ•´ */
    /* å‘å·¦ä¾§ç§»åŠ¨ï¼Œä½¿å…¶æ˜¾ç¤ºåœ¨å¯¹è¯æ¡†å¤–éƒ¨å·¦ä¸Šæ–¹ */
    left: 40px; /* æ ¹æ® dialogbox.png çš„è®¾è®¡ï¼Œè°ƒæ•´åå­—æ¡†ä¸å¯¹è¯æ¡†å·¦è¾¹ç¼˜çš„å¯¹é½ */
    width: 240px; /* åå­—æ¡†å›¾ç‰‡çš„å®½åº¦ï¼Œæ ¹æ® speaker_name.png å®é™…å°ºå¯¸è°ƒæ•´ */
    height: 60px; /* åå­—æ¡†å›¾ç‰‡çš„é«˜åº¦ï¼Œæ ¹æ® speaker_name.png å®é™…å°ºå¯¸è°ƒæ•´ */
    background-image: url('https://vacuopolis.netlify.app/image/speaker_name.png'); /* åå­—æ¡†èƒŒæ™¯å›¾ç‰‡ */
    background-size: 100% 100%; /* ç¡®ä¿å›¾ç‰‡å®Œå…¨è¦†ç›– */
    background-repeat: no-repeat;
    display: flex; /* ä½¿ç”¨ Flexbox è¿›è¡Œå†…å®¹å±…ä¸­ */
    align-items: center; /* å‚ç›´å±…ä¸­ */
    justify-content: center; /* æ°´å¹³å±…ä¸­ */
    z-index: 2006; /* ç¡®ä¿åœ¨å¯¹è¯æ¡†ä¹‹ä¸Š */
    pointer-events: none; /* ä¸é˜»ç¢é¼ æ ‡äº‹ä»¶ */
    opacity: 0; /* é»˜è®¤éšè— */
    transition: opacity 0.3s ease, transform 0.3s ease; 
    transform: translateY(10px); /* åˆå§‹çŠ¶æ€ç•¥å¾®å‘ä¸‹ï¼Œç”¨äºæ·¡å…¥ä¸Šæµ®æ•ˆæœ */
}

/* åå­—æ¡†æ˜¾ç¤ºæ—¶çš„æ ·å¼ */
.speaker-name-box.visible {
    opacity: 1;
    transform: translateY(0); /* æ˜¾ç¤ºæ—¶å›åˆ°æ­£å¸¸ä½ç½® */
}

/* åå­—æ¡†å†…çš„æ–‡æœ¬æ ·å¼ */
.speaker-name-box .speaker-name-text {
    font-size: 1.1em;
    font-weight: bold;
    color: #FFFFFF; /* åå­—é¢œè‰²ï¼Œæ¨èç™½è‰²ä»¥åœ¨åå­—æ¡†å›¾ç‰‡ä¸Šä¿æŒæ¸…æ™° */
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.7); 
    white-space: nowrap; /* é˜²æ­¢åå­—è¿‡é•¿æ¢è¡Œ */
    overflow: hidden; /* éšè—è¶…å‡ºéƒ¨åˆ† */
    text-overflow: ellipsis; /* è¶…å‡ºéƒ¨åˆ†æ˜¾ç¤ºçœç•¥å· */
    max-width: 90%; /* é™åˆ¶æ–‡æœ¬æœ€å¤§å®½åº¦ï¼Œé˜²æ­¢è¶…å‡ºåå­—æ¡† */
}

/* å“åº”å¼è°ƒæ•´ */
@media (max-width: 768px) {
    .speaker-name-box {
        width: 180px; /* æ‰‹æœºç«¯åå­—æ¡†å®½åº¦ */
        height: 45px; /* æ‰‹æœºç«¯åå­—æ¡†é«˜åº¦ */
        top: -45px; /* æ‰‹æœºç«¯å‘ä¸Šç§»åŠ¨çš„é«˜åº¦ */
        left: 20px; /* æ‰‹æœºç«¯å‘å·¦ç§»åŠ¨çš„è·ç¦» */
    }
    .speaker-name-box .speaker-name-text {
        font-size: 1em; /* æ‰‹æœºç«¯å­—ä½“å¤§å° */
    }
}

        /* é€‰é¡¹å®¹å™¨ */
        .choice-container {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            width: calc(100% - 40px);
            max-width: 872px; /* é€‰é¡¹æ¡†å›¾ç‰‡çš„æœ€å¤§å®½åº¦ */
            display: flex;
            flex-direction: column; /* å‚ç›´æ’åˆ— */
            gap: 15px; /* é€‰é¡¹é—´è· */
            z-index: 2005;
            bottom: calc(20px + 170px + 30px); /* åœ¨å¯¹è¯æ¡†ä¹‹ä¸Šï¼Œç•™å‡ºé€‚å½“é—´è· */
            animation: fadeIn 0.5s ease-out;
        }

        .choice-button {
            width: 100%;
            height: 64px; /* é€‰é¡¹æ¡†å›¾ç‰‡é«˜åº¦ */
            background-size: 100% 100%;
            background-repeat: no-repeat;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.1em;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, filter 0.2s ease;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.7);
        }

        .choice-button:hover {
            transform: translateY(-5px) scale(1.02);
            filter: brightness(1.1);
        }

        /* å•äººç‰©å¯¹è¯æ¨¡å—æ ·å¼ */
        .single-char-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.7); /* åŠé€æ˜é»‘è‰²èƒŒæ™¯ */
            backdrop-filter: blur(8px); /* èƒŒæ™¯è™šåŒ– */
            -webkit-backdrop-filter: blur(8px);
            display: none; /* é»˜è®¤éšè— */
            z-index: 20000;
            justify-content: center;
            align-items: center;
            cursor: pointer; /* æç¤ºå¯ç‚¹å‡»å…³é—­ */
            transition: opacity 0.5s ease-out; /* æ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
        }

        .single-char-popup-content {
            background: var(--glass-bg); /* ä½¿ç”¨ç°æœ‰ç»ç’ƒæ•ˆæœèƒŒæ™¯ */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            max-width: 80vw; /* æœ€å¤§å®½åº¦ */
            width: 500px; /* PCç«¯å›ºå®šå®½åº¦ */
            max-height: 90vh; /* æœ€å¤§é«˜åº¦ */
            position: relative;
            animation: dialogIn 0.4s ease-out; /* ä½¿ç”¨åŸæœ‰å¯¹è¯æ¡†åŠ¨ç”» */
        }

        .popup-char-image {
            max-width: 80%; /* å›¾ç‰‡æœ€å¤§å®½åº¦ */
            height: auto;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            object-fit: contain;
        }

        .popup-dialogue-card {
            background: rgba(255, 255, 255, 0.1); /* ç‹¬ç«‹å¯¹è¯æ¡†æ ·å¼ */
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            padding: 20px;
            color: white;
            font-size: 1.1em;
            line-height: 1.6;
            text-align: center;
            width: 100%;
            max-height: 150px; /* é™åˆ¶é«˜åº¦ï¼Œå¯æ»šåŠ¨ */
            overflow-y: auto;
            -ms-overflow-style: none;  /* IE and Edge */
            scrollbar-width: none;  /* Firefox */
        }
        .popup-dialogue-card::-webkit-scrollbar { /* Chrome, Safari, Opera */
            display: none;
        }

        .single-char-popup-content .close-popup-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .single-char-popup-content .close-popup-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: rotate(90deg);
        }
        
/* å…¨å±åŠ è½½ç•Œé¢æ ·å¼ */
#loadingOverlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(29, 29, 31, 0.9); /* ä½¿ç”¨æ·±è‰²åŠé€æ˜èƒŒæ™¯ï¼Œæ›´å…·æ²‰æµ¸æ„Ÿ */
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 99999; /* ç¡®ä¿åœ¨æœ€é¡¶å±‚ */
    transition: opacity 0.8s ease-out, visibility 0.8s ease-out;
    opacity: 1;
    visibility: visible;
}

#loadingOverlay.hidden {
    opacity: 0;
    visibility: hidden; /* éšè—åä¸å¯äº¤äº’ */
}

/* åŠ è½½åŠ¨ç”»ï¼ˆæ—‹è½¬åœ†åœˆï¼‰ */
.loading-spinner {
    width: 60px;
    height: 60px;
    border: 5px solid rgba(255, 255, 255, 0.2);
    border-top-color: #FFD700; /* ä½¿ç”¨ä¸»é¢˜é‡‘è‰²ä½œä¸ºé«˜äº® */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from {
        transform: rotate(0deg);
    }
    to {
        transform: rotate(360deg);
    }
}

/* åŠ è½½æ–‡å­—æ ·å¼ */
.loading-text {
    color: white;
    margin-top: 25px;
    font-size: 1.1em;
    font-weight: 500;
    letter-spacing: 1px;
    text-shadow: 0 1px 5px rgba(0, 0, 0, 0.5);
}

/* === å›¾ç‰‡æŸ¥çœ‹å™¨æ ·å¼ === */
.photo-viewer-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background-color: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    display: none; /* é»˜è®¤éšè— */
    justify-content: center;
    align-items: center;
    z-index: 30000; /* è®¾ç½®ä¸€ä¸ªè¾ƒé«˜çš„å±‚çº§ */
    cursor: zoom-out;
}

.photo-viewer-close-btn {
    position: absolute;
    top: 20px;
    right: 30px;
    font-size: 3em;
    color: white;
    font-weight: 300;
    cursor: pointer;
    z-index: 30002;
    transition: transform 0.2s ease, color 0.2s ease;
    user-select: none;
}

.photo-viewer-close-btn:hover {
    transform: scale(1.2);
    color: #FF6B9D;
}

.photo-viewer-content {
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden; /* éšè—æº¢å‡ºçš„å›¾ç‰‡éƒ¨åˆ† */
}

.photo-viewer-img {
    max-width: 95vw;
    max-height: 95vh;
    object-fit: contain;
    transition: transform 0.2s ease-out; /* å¹³æ»‘ç¼©æ”¾è¿‡æ¸¡ */
    cursor: grab;
    transform-origin: center center;
    user-select: none;
}

.photo-viewer-img.panning {
    cursor: grabbing;
}

/* === åŠ è½½é®ç½©è¿›åº¦æ¡ === */
.loading-progress{
    width: min(66vw, 420px);
    height: 8px;
    margin-top: 18px;
    border-radius: 9999px;
    background: rgba(255,255,255,0.18);
    overflow: hidden;
}
#loadingProgressFill{
    width: 0%;
    height: 100%;
    background: var(--secondary-gradient);
    transition: width .3s ease;
    border-radius: 9999px;
}
.loading-percent{
    margin-top: 10px;
    color: #fff;
    font-size: .95em;
    opacity: .9;
    letter-spacing: 1px;
}

/* === LJH å…¨å±åª’ä½“æ’­æ”¾å™¨ï¼ˆè¦†ç›–å•äººç‰©å¼¹çª—é»˜è®¤å¡ç‰‡å¸ƒå±€ï¼‰ === */
.single-char-popup-content.fullscreen{
    width: 100vw;
    height: 100vh;
    max-width: none;
    max-height: none;
    padding: 0;
    border-radius: 0;
    border: none;
    background: #000;
    display: grid;
    place-items: center;
}
.ljh-media{
    width: 100vw;
    height: 100vh;
    object-fit: contain; /* ä¿æŒ 9:16 æ¯”ä¾‹ï¼Œé»‘åº•ä¿¡ç®±é€‚é…æ¡Œé¢ */
    transition: opacity .4s ease;
    opacity: 1;
}
.ljh-hidden{ opacity: 0; pointer-events: none; }

/* Emoji ä¼´éšæ•ˆæœæ ·å¼ */
.cursor-chestnut, .trail-emoji {
    position: fixed;
    pointer-events: none; /* ç¡®ä¿ä¸é˜»æŒ¡åº•å±‚å…ƒç´ çš„ç‚¹å‡» */
    z-index: 99999; /* ç¡®ä¿å§‹ç»ˆåœ¨æœ€ä¸Šå±‚ */
    transform: translate(-50%, -50%); /* å°† emoji è‡ªèº«ä¸­å¿ƒç‚¹ä¸é¼ æ ‡/è§¦æ‘¸ç‚¹å¯¹é½ */
    white-space: nowrap; /* é˜²æ­¢ emoji æ¢è¡Œ */
    user-select: none; /* é˜²æ­¢ emoji è¢«é€‰ä¸­ */
    -webkit-user-select: none;
    -moz-user-select: none;
    -ms-user-select: none;
}

.cursor-chestnut {
    font-size: 2.2em; /* æ —å­emojiå¤§å° */
    opacity: 0; /* æ¡Œé¢ç«¯åˆå§‹éšè—ï¼Œé¼ æ ‡è¿›å…¥æ—¶æ˜¾ç¤º */
    transition: opacity 0.1s ease-out; /* æ·¡å…¥æ·¡å‡ºåŠ¨ç”» */
}

.cursor-chestnut.visible {
    opacity: 1;
}

/* å°¾éšå¿ƒå½¢ emoji åŠ¨ç”» */
.trail-emoji {
    font-size: 1.5em; /* å¿ƒå½¢ emoji åŸºç¡€å¤§å° */
    animation: emoji-pop-fade 1.2s ease-out forwards; /* åŠ¨ç”»æŒç»­æ—¶é—´ */
}

@keyframes emoji-pop-fade {
    0% {
        opacity: 1;
        transform: translate(-50%, -50%) scale(0.5) rotate(0deg);
    }
    50% {
        opacity: 1;
        /* ä½¿ç”¨ CSS å˜é‡å®ç°éšæœºåç§»å’Œæ—‹è½¬ */
        transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px))) scale(1.2) rotate(var(--rotate, 0deg));
    }
    100% {
        opacity: 0;
        /* å‘ä¸Šæ¼‚æµ®å¹¶ç¼©å°æ·¡å‡º */
        transform: translate(calc(-50% + var(--dx, 0px)), calc(-50% + var(--dy, 0px) - 30px)) scale(1) rotate(var(--rotate, 0deg));
    }
}

.ljh-gif-container {
    position: relative;
    width: 100%;
    height: 80vh; /* å æ®è§†å£é«˜åº¦çš„80% */
    max-width: 1080px; /* æœ€å¤§å®½åº¦é™åˆ¶ */
    max-height: 1920px; /* æœ€å¤§é«˜åº¦é™åˆ¶ */
    margin: 0 auto 20px auto;
    display: none;
    justify-content: center;
    align-items: center;
}

.ljh-gif {
    width: auto;
    height: auto;
    max-width: 100%;
    max-height: 100%;
    object-fit: contain; /* ä¿æŒåŸå§‹æ¯”ä¾‹ï¼Œå®Œæ•´æ˜¾ç¤º */
}

.popup-char-image.hidden {
    display: none;
}

.ljh-gif-container.visible {
    display: flex;
}

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 768px) {
            .game-dialogue-box {
                height: 150px; 
                font-size: 0.95em;
                padding: 15px 25px;
                bottom: 10px;
            }
            .game-dialogue-box .speaker-name {
                top: 10px;
                left: 30px;
                font-size: 1em;
            }
            .game-character {
                max-height: 70vh; /* æ‰‹æœºç«¯äººç‰©é€‚å½“ç¼©å° */
            }
            .choice-container {
                bottom: calc(10px + 150px + 20px); /* æ‰‹æœºç«¯é€‰é¡¹ä½ç½® */
                gap: 10px;
            }
            .choice-button {
                height: 50px; /* æ‰‹æœºç«¯é€‰é¡¹é«˜åº¦ */
                font-size: 0.9em;
            }
            .game-menu-button {
                width: 60px;
                height: 60px;
                top: 10px;
                right: 10px;
            }

            .single-char-popup-content {
                padding: 20px;
                width: 95%; /* æ‰‹æœºç«¯æ›´å®½ */
            }
            .popup-char-image {
                max-width: 90%; /* æ‰‹æœºç«¯äººç‰©å›¾æ›´å®½ */
            }
            .popup-dialogue-card {
                font-size: 0.95em;
                padding: 15px;
                max-height: 120px;
            }
            .single-char-popup-content .close-popup-btn {
                width: 25px;
                height: 25px;
                font-size: 1em;
            }

            /* è°ƒæ•´åŸæœ‰å¼¹çª—ä»¥é€‚é…æ‰‹æœº */
            .dialog-box {
                width: 95%;
                padding: 20px;
                max-height: 85vh;
                top: 50%;
                border-radius: 16px;
                color: #333;
            }
            
            .dialog-box h2 {
                font-size: 1.5em;
                margin-bottom: 15px;
            }
            
            .dialog-box p {
                font-size: 1em;
                line-height: 1.6;
                margin-bottom: 15px;
            }
            
            .dialog-box strong {
                font-size: 1.1em;
            }
        }
        /* åŠ¨ç”»æ•ˆæœ */
        @keyframes fadeInSlideUp {
            from { opacity: 0; transform: translate(-50%, 50px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
    </style>
</head>
<body>
    <!-- ç²’å­èƒŒæ™¯ -->
    <div class="particles" id="particles"></div>

    <!-- è¿›åº¦æ¡ -->
    <div class="progress-bar">
        <div class="progress-fill" id="progressFill"></div>
    </div>

    <!-- éŸ³ä¹æ’­æ”¾å™¨ -->
    <div class="music-player" id="musicPlayer" onclick="toggleMusic()" title="ç‚¹å‡»æ’­æ”¾/æš‚åœéŸ³ä¹">
        <span style="font-size: 1.5em;">ğŸµ</span>
    </div>
    
    <!-- å¯¹è¯æ¡† -->
    <div class="dialog-overlay" id="dialogOverlay" onclick="closeDialog()"></div>
    <div class="dialog-box" id="dialogBox">
        <div id="dialogContent"></div>
        <button class="btn" onclick="closeDialog()" style="margin-top: 20px; position: sticky; bottom: 0;">å…³é—­</button>
    </div>

    <!-- æ¸¸æˆæ¨¡å—å®¹å™¨ -->
    <div id="gameModule" class="game-module-overlay">
        <!-- èƒŒæ™¯éŸ³ä¹ -->
        <audio id="gameBGM" loop>
            <source src="https://vacuopolis.netlify.app/audio/srkl_hunyuan.mp3" type="audio/mp3">
            æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾...
        </audio>

        <!-- èƒŒæ™¯å›¾ç‰‡ (åŠ¨æ€åŠ è½½ï¼Œæ ¹æ®æ¨ªç«–å±åˆ‡æ¢) -->
        <div id="gameBackground" class="game-background"></div>

        <!-- èœå•æŒ‰é’® -->
        <div id="gameMenu" class="game-menu-button"></div>

        <!-- äººç‰©å›¾ç‰‡ (åŠ¨æ€åŠ è½½/æ˜¾ç¤º/éšè—) -->
        <img id="gameCharacter" class="game-character" src="" alt="è§’è‰²å›¾ç‰‡">

        <!-- å¯¹è¯æ¡† -->
        <div id="gameDialogueBox" class="game-dialogue-box" onclick="advanceDialogue()">
            <span id="speakerName" class="speaker-name"></span>
            <p id="dialogueText" class="dialogue-text"></p>
        </div>

        <!-- é€‰é¡¹å®¹å™¨ (åŠ¨æ€åŠ è½½/æ˜¾ç¤º/éšè—) -->
        <div id="choiceContainer" class="choice-container">
            <!-- é€‰é¡¹æŒ‰é’®å°†åœ¨æ­¤å¤„åŠ¨æ€ç”Ÿæˆ -->
        </div>
    </div>
    
<!-- å…¨å±åŠ è½½ç•Œé¢ -->
<div id="loadingOverlay">
    <div class="loading-spinner"></div>
    <p class="loading-text">ğŸ æ­£åœ¨æ‚„æ‚„ä¸ºæ —å­å‡†å¤‡ç¤¼ç‰©...</p>
    <!-- åŠ è½½è¿›åº¦æ¡ä¸ç™¾åˆ†æ¯” -->
<div class="loading-progress"><div id="loadingProgressFill"></div></div>
<div id="loadingPercent" class="loading-percent">0%</div>
</div>

    <!-- å•äººç‰©å¯¹è¯æ¨¡å—å®¹å™¨ -->
<div id="singleCharacterPopup" class="single-char-popup-overlay" onclick="closeSingleCharacterPopup()">
    <div class="single-char-popup-content" onclick="event.stopPropagation()">
        <!-- GIFå®¹å™¨ -->
        <div id="ljhGifContainer" class="ljh-gif-container">
            <img id="ljhGif" class="ljh-gif" src="https://image.lolimi.cn/2025/08/24/68ab3378200ca.gif" alt="é™†æ™¯å’ŒGIF">
        </div>
        
        <!-- äººç‰©å›¾ç‰‡ -->
        <img id="popupCharImage" class="popup-char-image hidden" src="https://vacuopolis.netlify.app/image/ljh_Liftcake.png" alt="é™†æ™¯å’Œ">
        
        <!-- å¯¹è¯å†…å®¹ -->
        <div class="popup-dialogue-card">
            <p id="popupCharText"></p>
            <audio id="popupCharVoice" src="https://vacuopolis.netlify.app/audio/å°é™†çš„ç”Ÿæ—¥ç¥ç¦.mp3"></audio>
        </div>
        
        <!-- å…³é—­æŒ‰é’® -->
        <button class="close-popup-btn" onclick="closeSingleCharacterPopup()">X</button>
    </div>
</div>

    <!-- éŸ³é¢‘å…ƒç´  -->
    <audio id="backgroundMusic" loop>
        <source src="https://vacuopolis.netlify.app/audio/srkl_hunyuan.mp3" type="audio/mp3">
        æµè§ˆå™¨å¯èƒ½ä¸æ”¯æŒéŸ³é¢‘æ’­æ”¾...
    </audio>
    
    <!-- å›¾ç‰‡æŸ¥çœ‹å™¨ -->
<div id="photoViewerOverlay" class="photo-viewer-overlay" onclick="closePhotoViewer()">
    <span class="photo-viewer-close-btn" onclick="closePhotoViewer(event)">&times;</span>
    <div id="photoViewerContent" class="photo-viewer-content">
        <img id="photoViewerImg" src="" alt="æŸ¥çœ‹ç…§ç‰‡" class="photo-viewer-img">
    </div>
</div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="main-container">
        <!-- åœºæ™¯1ï¼šå¼€åœº -->
        <div class="scene active" id="scene1">
            <div class="glass-card">
                <div class="chestnut-icon">ğŸŒ°</div>
                <h1>Heyï¼æ —å­åŒå­¦</h1>
                <p style="font-size: 1.3em; margin: 30px 0;">
                    å°ç©ºåŸåœ¨è¿™é‡Œç­‰ä½ å¾ˆä¹…å•¦ï½<br>
                    ä»Šå¤©æ˜¯ä¸ªç‰¹åˆ«çš„æ—¥å­å‘¢ï¼
                </p>
                <p>å‡†å¤‡å¥½å¼€å¯è¿™æ®µå¥‡å¦™çš„æ—…ç¨‹äº†å—ï¼Ÿ</p>
                <button class="btn" onclick="nextScene()">å¯ç¨‹ï¼âœ¨</button>
            </div>
        </div>

        <!-- åœºæ™¯2ï¼šæ—¶å…‰å›å¿† -->
        <div class="scene" id="scene2">
            <div class="glass-card">
                <h2>â° æ—¶å…‰å°è®°</h2>
                <p>ä»ç›¸é‡åˆ°ç°åœ¨ï¼Œå·²ç»è¿‡å»äº†</p>
                <div class="counter-display" id="daysCounter">0</div>
                <p style="font-size: 1.3em;">å¤©</p>
                <p style="margin-top: 30px;">
                    581ä¸ªæ—¥å¤œçš„é™ªä¼´<br>
                    æ¯ä¸€å¤©éƒ½æ˜¯ç‹¬ç‰¹çš„è®°å¿†<br>
                    ä»é™Œç”Ÿäººåˆ°äº’ä¸ºæœ‹å‹....
                </p>
                <button class="btn" onclick="nextScene()">ç»§ç»­æ—…ç¨‹ â†’</button>
            </div>
        </div>

        <!-- åœºæ™¯3ï¼šæ¸¸æˆä¸–ç•Œ -->
        <div class="scene" id="scene3">
            <div class="glass-card">
                <h2>ğŸ® ç°åœ¨æ˜¯æ¸¸æˆç¥ç¦æ—¶é—´~</h2>
                <p style="color: #FFD700; font-size: 1.1em; margin-bottom: 20px;">
                    ğŸ’¡ è½»è§¦æ¸¸æˆå›¾æ ‡å¯ä»¥è·å¾—ä¸“å±ç¥ç¦~
                </p>
                <div class="games-showcase">
                    <div class="game-item" onclick="gameWish('åŸç¥', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/genshin.png" alt="åŸç¥" />
                        </div>
                        <h3>åŸç¥</h3>
                        <p>æç“¦ç‰¹å¤§é™†çš„å†’é™©</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">æ„¿ä½ æŠ½å¡æ€»æ˜¯ä¸æ­ªï¼</p>
                    </div>
                    <div class="game-item" onclick="gameWish('å´©é“', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/starrail.png" alt="å´©åï¼šæ˜Ÿç©¹é“é“" />
                        </div>
                        <h3>å´©åï¼šæ˜Ÿç©¹é“é“</h3>
                        <p>æ˜Ÿç©¹åˆ—è½¦çš„æ—…é€”</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">æ„¿ä½ é—å™¨æ€»æœ‰åŒæš´ï¼</p>
                    </div>
                    <div class="game-item" onclick="gameWish('ç»åŒºé›¶', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/zzz.png" alt="ç»åŒºé›¶" />
                        </div>
                        <h3>ç»åŒºé›¶</h3>
                        <p>ç©ºæ´æ¢ç´¢è€…</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">æ„¿ä½ éŸ³æ“æ€»èƒ½æ¬§çš‡ï¼</p>
                    </div>
                    <div class="game-item" onclick="gameWish('äºŒæ¬¡å…ƒ', event)">
                        <div class="game-icon">
                            <img src="https://vacuopolis.netlify.app/image/bilibili.png" alt="å“”å“©å“”å“©" />
                        </div>
                        <h3>äºŒæ¬¡å…ƒä¸–ç•Œ</h3>
                        <p>ACGçš„æ— é™å¯èƒ½</p>
                        <p style="font-size: 0.9em; opacity: 0.8;">æ„¿ä½ æ°¸è¿œä¸­äºŒä¸”å¿«ä¹ï¼</p>
                    </div>
                </div>
                <div style="margin-top: 30px; align-items: center; justify-content: center; display: flex; flex-wrap: wrap; gap: 15px;">
    <p style="margin: 0;">æ —å­è¿˜è®°å¾—å»å¹´äº”æœˆä»½ä¸­æ—¬å¸¦æˆ‘å»çˆ±å¿ƒå²›æ—¶çš„åœºæ™¯å—<br>å•Šå“ˆå“ˆ</p>
    <button class="btn" style="padding: 8px 24px; font-size: 0.9em;" onclick="openPhotoViewer('https://image.lolimi.cn/2025/08/20/68a56a294a3d5.png')">ğŸ“· æŸ¥çœ‹ç…§ç‰‡</button>
</div>
                <p style="color: #FFD700; font-size: 1em; margin-top: 10px;">
                    ğŸ¯ è¯•è¯•æŒ‰ä½å±å¹•æ»‘åŠ¨ï¼Œä¼šæœ‰ç¥ç§˜emojiè·Ÿéš~
                </p>
                <button class="btn" onclick="nextScene()">ä¸‹ä¸€ç«™ ğŸš€</button>
            </div>
        </div>

        <!-- åœºæ™¯4ï¼šè®¸æ„¿æ—¶åˆ» -->
        <div class="scene" id="scene4">
            <div class="glass-card">
                <h2>ğŸŒ  ç°åœ¨æ˜¯è®¸æ„¿æ—¶åˆ»ï¼</h2>
                <div class="chestnut-icon">â­</div>
                <p style="font-size: 1.2em; margin-bottom: 30px;">
                    åœ¨è¿™ä¸ªç‰¹åˆ«çš„æ—¥å­é‡Œ<br>
                    è®©æˆ‘ä»¬ä¸€èµ·å‘æ˜Ÿç©ºè®¸ä¸‹ç¾å¥½çš„æ„¿æœ›å§ï¼
                </p>
                
                <div class="wish-pool">
                    <h3 style="margin-bottom: 20px; color: #FFD700;">âœ¨ æ —å­çš„è®¸æ„¿æ±  âœ¨</h3>
                    <textarea 
                        id="wishInput" 
                        class="wish-input"
                        placeholder="å¯ä»¥åœ¨è¿™é‡Œå†™ä¸‹ç”Ÿæ—¥æ„¿æœ›...&#10;æ¯ä¸ªçœŸè¯šçš„æ„¿æœ›éƒ½ä¼šè¢«ä»–ä»¬æ¥æ”¶ ğŸ’–"
                    ></textarea>
                    <div style="margin-top: 20px;">
                        <button class="btn" onclick="submitWish()">ğŸŒŸ æŠ•å…¥è®¸æ„¿æ± </button>
                        <button class="btn" onclick="showWishTips()">ğŸ’¡ è®¸æ„¿å°è´´å£«</button>
                    </div>
                </div>
                
                <p style="color: rgba(255,255,255,0.8); font-size: 0.9em; margin-top: 20px;">
                    å°ç©ºåŸç›¸ä¿¡ï¼Œæ¯ä¸€ä¸ªè®¤çœŸè®¸ä¸‹çš„æ„¿æœ›éƒ½ä¼šå®ç°å‘¢ï¼
                </p>
                
                <button class="btn" onclick="nextScene()" id="continueBtn" style="display: none;">ç»§ç»­å‰å¾€ç”Ÿæ—¥åº†å…¸ ğŸ‰</button>
            </div>
        </div>

        <!-- åœºæ™¯5ï¼šç”Ÿæ—¥ç¥ç¦ -->
        <div class="scene" id="scene5">
            <div class="glass-card">
                <h1>ğŸ‰ æ —å­ç”Ÿæ—¥å¿«ä¹ï¼ğŸ‰</h1>
                <div class="chestnut-icon">ğŸ‚ğŸŒ°</div>
                <h2 style="color: #FFD700;">8æœˆ25æ—¥ - æ˜¯ä½ çš„ä¸“å±èŠ‚æ—¥</h2>
                
                <div class="wishes-wall">
                    <div class="wish-card" style="--rotation: -3deg;">
                        <p>æ„¿ä½ å­¦ä¸šé¡ºåˆ©<br>è€ƒè¯•å…¨è¿‡ï¼ğŸ’¯</p>
                    </div>
                    <div class="wish-card" style="--rotation: 2deg;">
                        <p>æ„¿ä½ æŠ½å¡å¿…ä¸­<br>æ°¸ä¸æ­ªæ± ï¼â­</p>
                    </div>
                    <div class="wish-card" style="--rotation: -2deg;">
                        <p>æ„¿ä½ å¿«ä¹åŠ å€<br>çƒ¦æ¼æ¸…é›¶ï¼ğŸ˜Š</p>
                    </div>
                    <div class="wish-card" style="--rotation: 3deg;">
                        <p>æ„¿ä½ èº«ä½“å¥åº·<br>æ´»åŠ›æ»¡æ»¡ï¼ğŸ’ª</p>
                    </div>
                    <div class="wish-card" style="--rotation: -1deg;">
                        <p>æ„¿ä½ æ¢¦æƒ³æˆçœŸ<br>å‰ç¨‹ä¼¼é”¦ï¼ğŸŒŸ</p>
                    </div>
                    <div class="wish-card" style="--rotation: 1deg;">
                        <p>æ„¿ä½ æ°¸è¿œå¯çˆ±<br>ç¬‘å®¹å¸¸åœ¨ï¼ğŸŒˆ</p>
                    </div>
                </div>

                <div style="margin-top: 30px;">
                    <button class="btn" onclick="launchFireworks()">ğŸ† æ”¾çƒŸèŠ±</button>
                    <button class="btn" onclick="showSecretMessage()">ğŸ’Œ ç§˜å¯†ä¿¡ä»¶</button>
                    <button class="btn" onclick="nextScene()">ğŸ’• æŸ¥çœ‹æœ€åçš„è¯</button>
                </div>
            </div>
        </div>

        <!-- åœºæ™¯6ï¼šæœ€ç»ˆç•™è¨€ -->
        <div class="scene" id="scene6">
            <div class="glass-card">
                <h2>ğŸ’• è‡´æœ€ç‰¹åˆ«çš„æ —å­</h2>
                <div class="chestnut-icon">ğŸŒ°âœ¨</div>
                <div style="text-align: left; max-width: 600px; margin: 0 auto;">
                    <p style="font-size: 1.1em; line-height: 2;">
                        äº²çˆ±çš„æ —å­ï¼š<br><br>
                        
                        581å¤©å‰çš„ç›¸é‡ï¼Œæ˜¯å‘½è¿æœ€ç¾å¥½çš„å®‰æ’ã€‚<br><br>
                        
                        ä½ æ˜¯é‚£ä¸ªåœ¨æ¸¸æˆé‡Œä¼šå› ä¸ºæŠ½åˆ°å„ç§é‡‘ç”šè‡³æå‰è¿›è€Œå…´å¥‹å°–å«çš„å¥³å­©ï¼›<br>
                        ä½ æ˜¯é‚£ä¸ªæ·±å¤œè¿˜åœ¨èƒŒè¯µåŒ»å­¦æœ¯è¯­å´ä¾ç„¶å…ƒæ°”æ»¡æ»¡çš„å­¦éœ¸ï¼›<br>
                        ä½ æ˜¯é‚£ä¸ªä¼šå’Œæˆ‘ä¸€èµ·ç©æ¢—æ•´æ´»å„¿ä»ä¸å«Œå¹¼ç¨šçš„æœ‹å‹ï¼›<br>
                        ä½ æ˜¯é‚£ä¸ªæœ‰ç€åŒ»è€…æ¢¦æƒ³åˆä¿æŒç€å°‘å¥³å¿ƒçš„ç‰¹åˆ«å­˜åœ¨ã€‚<br><br>
                        
                        æ„Ÿè°¢ä½ çš„é™ªä¼´ï¼Œè®©è¿™581å¤©çš„æ¯ä¸€å¤©éƒ½å……æ»¡æ¬¢ç¬‘ã€‚<br>
                        æœªæ¥çš„è·¯è¿˜å¾ˆé•¿ï¼Œå¸Œæœ›æˆ‘ä»¬èƒ½ç»§ç»­ï¼š<br>
                        ä¸€èµ·æ¸¸æˆï¼Œä¸€èµ·åæ§½å‰§æƒ…ï¼›<br>
                        ä¸€èµ·æŠ½å¡ï¼Œä¸€èµ·åˆ†äº«æ¬§æ°”ï¼›<br>
                        ä¸€èµ·æˆé•¿ï¼Œä¸€èµ·è§è¯å½¼æ­¤çš„ç²¾å½©ã€‚<br><br>
                        
                        <strong style="font-size: 1.3em; color: #FFD700;">
                            ç”Ÿæ—¥å¿«ä¹ï¼Œæˆ‘çš„æœ‹å‹ï¼<br>
                            æ„¿ä½ æ°¸è¿œæ˜¯é‚£ä¸ªç‹¬ä¸€æ— äºŒçš„æ —å­ï¼
                        </strong><br><br>
                        
                        â€”â€” å°ç©ºåŸ<br>
                        2025.8.25
                    </p>
                </div>
                <button class="btn" onclick="restart()">ğŸ”„ å†çœ‹ä¸€é</button>
            </div>
        </div>
    </div>

    <script>
// èµ„æºæ¸…å•
const assetManifest = {
    images: [
        // æ¸¸æˆå›¾æ ‡
        'https://vacuopolis.netlify.app/image/genshin.png',
        'https://vacuopolis.netlify.app/image/starrail.png',
        'https://vacuopolis.netlify.app/image/zzz.png',
        'https://vacuopolis.netlify.app/image/bilibili.png',
        // æ¸¸æˆæ¨¡å—èƒŒæ™¯
        'https://vacuopolis.netlify.app/image/bg_landscape_scene1.png',
        'https://vacuopolis.netlify.app/image/bg_portrait_scene1.png',
        // æ¸¸æˆæ¨¡å—UI
        'https://vacuopolis.netlify.app/image/game_menu_icon.png',
        'https://vacuopolis.netlify.app/image/dialogbox.png',
        'https://vacuopolis.netlify.app/image/speaker_name.png',
        'https://vacuopolis.netlify.app/image/choicebox1.png',
        'https://vacuopolis.netlify.app/image/choicebox2.png',
        'https://vacuopolis.netlify.app/image/choicebox3.png',
        // æ¸¸æˆæ¨¡å—äººç‰©ç«‹ç»˜
        'https://vacuopolis.netlify.app/image/qinwu_yelloweyes.png',
        'https://vacuopolis.netlify.app/image/qinwu_laugh1.png',
        'https://vacuopolis.netlify.app/image/qinwu_laugh2.png',
        'https://vacuopolis.netlify.app/image/qinwu_laugh3.png',
        'https://vacuopolis.netlify.app/image/qinwu_embarrass.png',
        // å•äººå¼¹çª—æ¨¡å—
        'https://vacuopolis.netlify.app/image/ljh_Liftcake.png',
        'https://image.lolimi.cn/2025/08/24/68ab3378200ca.gif',
        // ç…§ç‰‡æŸ¥çœ‹å™¨å›¾ç‰‡
        'https://image.lolimi.cn/2025/08/20/68a56a294a3d5.png'
    ],
    audio: [
        'https://vacuopolis.netlify.app/audio/srkl_hunyuan.mp3',
        'https://vacuopolis.netlify.app/audio/qinwubgm.mp3',
        'https://vacuopolis.netlify.app/audio/toprincess.ogg',
        'https://vacuopolis.netlify.app/audio/å°é™†çš„ç”Ÿæ—¥ç¥ç¦.mp3'
    ]
};

function preloadAssets(onComplete) {
    const loadingFill = document.getElementById('loadingProgressFill');
    const loadingPercent = document.getElementById('loadingPercent');

    const imgCount = assetManifest.images?.length || 0;
    const audioCount = assetManifest.audio?.length || 0;
    // const videoCount = assetManifest.videos?.length || 0; 

    const totalAssets = imgCount + audioCount; // + videoCount;
    let loadedAssets = 0;

    const updateLoadingUI = () => {
        const progress = totalAssets === 0 ? 100 : Math.round((loadedAssets / totalAssets) * 100);
        if (loadingFill) loadingFill.style.width = progress + '%';
        if (loadingPercent) loadingPercent.textContent = progress + '%';
        console.log(`èµ„æºåŠ è½½ä¸­... ${progress}%`);
        if (loadedAssets >= totalAssets) { // æ¡ä»¶è¾¾æˆå³è°ƒç”¨onComplete
            console.log('æ‰€æœ‰èµ„æºå·²åŠ è½½å®Œæ¯•ï¼');
            // å»¶è¿Ÿä¸€ç‚¹æ—¶é—´ï¼Œç¡®ä¿UIåŠ¨ç”»å®Œæˆ
            setTimeout(() => {
                if (onComplete) onComplete();
            }, 300); 
        }
    };

    const assetLoaded = () => {
        loadedAssets++;
        updateLoadingUI();
    };

    // é¢„åŠ è½½å›¾ç‰‡
    (assetManifest.images || []).forEach(src => {
        const img = new Image();
        img.onload = assetLoaded;
        img.onerror = () => { console.error(`å›¾ç‰‡åŠ è½½å¤±è´¥: ${src}`); assetLoaded(); };
        img.src = src;
    });

    // é¢„åŠ è½½éŸ³é¢‘
    (assetManifest.audio || []).forEach(src => {
        const audio = new Audio();
        const done = () => {
            audio.removeEventListener('canplaythrough', done);
            audio.removeEventListener('loadeddata', done);
            assetLoaded();
        };
        // canplaythrough æ›´èƒ½ä¿è¯èµ„æºå·²å®Œå…¨åŠ è½½å¹¶å¯æ’­æ”¾
        audio.addEventListener('canplaythrough', done, { once: true });
        // å¦‚æœ canplaythrough ä¸è§¦å‘ï¼Œloadeddata ä¹Ÿä¼šæ ‡è®°ä¸ºåŠ è½½
        audio.addEventListener('loadeddata', done, { once: true });
        audio.onerror = () => { console.error(`éŸ³é¢‘åŠ è½½å¤±è´¥: ${src}`); assetLoaded(); };
        audio.preload = 'auto'; // ç¡®ä¿æµè§ˆå™¨ä¼šå°è¯•é¢„åŠ è½½
        audio.src = src;
        audio.load(); // å¼ºåˆ¶æµè§ˆå™¨åŠ è½½éŸ³é¢‘
    });

    // å¦‚æœæ²¡æœ‰ä»»ä½•èµ„æºéœ€è¦åŠ è½½ï¼Œç«‹å³è§¦å‘å®Œæˆå›è°ƒ
    if (totalAssets === 0) {
        updateLoadingUI();
    }
}
    
    let currentScene = 1;
    const totalScenes = 6;
    let musicPlaying = false;
    let audioInitialized = false;
    // === å½©è›‹å…¨å±€å˜é‡é€»è¾‘ ===
    let musicToggleCount = 0; // éŸ³ä¹æ’­æ”¾å™¨å½©è›‹è®¡æ•°
    let easterEggActivated = false; // Konami code æ˜¯å¦æ¿€æ´»
    let originalCursorChestnutEmoji = 'ğŸŒ°'; // å­˜å‚¨é¼ æ ‡è·Ÿéšæ —å­åŸå›¾æ ‡
    // é¼ æ ‡å°¾éšå¿ƒå½¢emojiï¼Œç”¨äºKonami codeä¸´æ—¶æ›¿æ¢
    let specialEmojis = ['ğŸ©º', 'ğŸŒŸ', 'ğŸ’–', 'âœ¨', 'ğŸ©¹', 'ğŸ’‰']; // æ —å­ä½œä¸ºåŒ»å­¦ç”Ÿçš„ç‰¹æ®Šemoji

    // åˆ›å»ºç²’å­æ•ˆæœ
    function createParticles() {
        const container = document.getElementById('particles');
        for (let i = 0; i < 30; i++) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.style.left = Math.random() * 100 + '%';
            particle.style.animationDelay = Math.random() * 15 + 's';
            particle.style.animationDuration = (15 + Math.random() * 10) + 's';
            container.appendChild(particle);
        }
    }

    // åœºæ™¯åˆ‡æ¢
function nextScene() {
    // é¦–æ¬¡ç‚¹å‡»"å¯ç¨‹"æ—¶ï¼Œå°è¯•æ’­æ”¾éŸ³ä¹
    if (currentScene === 1) {
        const audio = document.getElementById('backgroundMusic');
        const player = document.getElementById('musicPlayer');
        
        // åªæœ‰åœ¨éŸ³ä¹å°šæœªæ’­æ”¾æ—¶æ‰å°è¯•æ’­æ”¾ä¸”éŸ³é¢‘å·²å‡†å¤‡å¥½
        if (!musicPlaying && audio.paused && audioInitialized) {
            audio.play().then(() => {
                musicPlaying = true;
                player.classList.add('playing');
                player.innerHTML = '<span style="font-size: 1.5em;">ğŸµ</span>';
                createEnhancedFloatingText('ğŸµ éŸ³ä¹å·²è‡ªåŠ¨æ’­æ”¾ï½', window.innerWidth / 2, 150);
                createMusicNotes(player); // ä»…åœ¨æˆåŠŸæ’­æ”¾ååˆ›å»ºéŸ³ç¬¦åŠ¨ç”»
            }).catch(error => {
                console.log('è‡ªåŠ¨æ’­æ”¾å¤±è´¥ï¼Œéœ€è¦ç”¨æˆ·åç»­æ‰‹åŠ¨ç‚¹å‡»:', error);
                // å³ä½¿æ’­æ”¾å¤±è´¥ï¼Œä¹Ÿæç¤ºç”¨æˆ·å¯ä»¥æ‰‹åŠ¨ç‚¹å‡»
                createEnhancedFloatingText('ğŸ”Š ç‚¹å‡»å³ä¸‹è§’éŸ³ç¬¦å¯æ’­æ”¾éŸ³ä¹', window.innerWidth / 2, 150);
            });
        }
    }

    if (currentScene < totalScenes) {
        document.getElementById(`scene${currentScene}`).classList.remove('active');
        currentScene++;
        setTimeout(() => {
            document.getElementById(`scene${currentScene}`).classList.add('active');
            updateProgress();
            
            // ç‰¹æ®Šåœºæ™¯æ•ˆæœ
            if (currentScene === 2) {
                animateCounter();
            } else if (currentScene === 5) {
                createConfetti();
            }
            // === åœºæ™¯åˆ‡æ¢æ—¶ï¼Œæ·»åŠ å¯¹åº”åœºæ™¯çš„å½©è›‹ç‚¹å‡»ç›‘å¬å™¨ ===
            addSceneSpecificClickListeners(currentScene);
        }, 300);
    }
}

    // æ›´æ–°è¿›åº¦æ¡
    function updateProgress() {
        const progress = (currentScene / totalScenes) * 100;
        document.getElementById('progressFill').style.width = progress + '%';
    }

    // å¤©æ•°è®¡æ•°åŠ¨ç”»
    function animateCounter() {
        const counter = document.getElementById('daysCounter');
        let count = 0;
        const target = 581;
        const duration = 2000;
        const increment = target / (duration / 16);
        
        const timer = setInterval(() => {
            count += increment;
            if (count >= target) {
                counter.textContent = target;
                clearInterval(timer);
            } else {
                counter.textContent = Math.floor(count);
            }
        }, 16);
    }

    // æ¸¸æˆç¥ç¦
    function gameWish(game, event) {
        // é˜»æ­¢äº‹ä»¶å†’æ³¡
        event.stopPropagation();
        
        const wishes = {
            'åŸç¥': 'âœ¨ æ„¿é£ç¥å¿½æ‚ ï¼Œå²©ç¥æŠ¤ä½‘ï¼Œæ¯æ¬¡åè¿å¿…å‡ºé‡‘ï¼ğŸŒŸ',
            'å´©é“': 'ğŸš‚ æ„¿ä½ æ˜Ÿè½¨æ°¸è¿œä¸æ­ªï¼Œé—å™¨å‰¯è¯æ¡å…¨æš´å‡»ï¼â­',
            'ç»åŒºé›¶': 'ğŸµ æ„¿ä½ éŸ³æ“è°ƒé¢‘ä¸€å‘å…¥é­‚ï¼Œä»£ç†äººå…¨å‘˜æ»¡å‘½ï¼ğŸ®',
            'äºŒæ¬¡å…ƒ': 'ğŸŒˆ æ„¿ä½ æ°¸è¿œä¿æŒä¸­äºŒçš„çµé­‚ï¼Œåœ¨äºŒæ¬¡å…ƒä¸–ç•Œå¿«ä¹é¨æ¸¸ï¼ğŸ’«'
        };
        
        // ä½¿ç”¨å±å¹•ä¸­å¿ƒä½ç½®ï¼Œé¿å…å®šä½åç§»
        const centerX = window.innerWidth / 2;
        const topY = window.innerHeight * 0.3; // åœ¨å±å¹•ä¸Šæ–¹30%ä½ç½®æ˜¾ç¤º
        
        createEnhancedFloatingText(wishes[game], centerX, topY);
        createClickFeedback(event.currentTarget);
    }

    // æµ®åŠ¨æ–‡å­—å‡½æ•°
    function createEnhancedFloatingText(text, x, y) {
        const element = document.createElement('div');
        element.className = 'floating-element';
        element.style.top = y + 'px';
        element.innerHTML = `
            <div style="
                background: linear-gradient(135deg, #FF6B9D, #C66FBC, #7C4DFF); 
                padding: 15px 20px; 
                border-radius: 25px; 
                color: white; 
                font-weight: bold; 
                box-shadow: 0 8px 25px rgba(0,0,0,0.3);
                border: 2px solid rgba(255,255,255,0.3);
                text-align: center;
                max-width: 90vw;
                width: fit-content;
                margin: 0 auto;
                font-size: 1em;
                line-height: 1.4;
            ">${text}</div>
        `;
        document.body.appendChild(element);
        
        setTimeout(() => element.remove(), 6000);
        
        return element;
    }

    // ç‚¹å‡»åé¦ˆå‡½æ•°
    function createClickFeedback(target) {
        target.style.transform = 'scale(0.95)';
        setTimeout(() => {
            target.style.transform = 'scale(1.05)';
            setTimeout(() => {
                target.style.transform = '';
            }, 150);
        }, 100);
    }

    // è®¸æ„¿åŠŸèƒ½
    function submitWish() {
        const wish = document.getElementById('wishInput').value.trim();
        if (wish) {
            createEnhancedFloatingText('ğŸŒŸ æ„¿æœ›å·²æŠ•å…¥è®¸æ„¿æ± ï¼æ˜Ÿæ˜Ÿä»¬éƒ½å¬åˆ°äº†ï½', window.innerWidth / 2, window.innerHeight / 3);
            
            // åˆ›å»ºè®¸æ„¿ç‰¹æ•ˆ
            createWishEffect();
            
            // æ˜¾ç¤ºç»§ç»­æŒ‰é’®
            document.getElementById('continueBtn').style.display = 'inline-block';
            
            // æ¸…ç©ºè¾“å…¥æ¡†
            document.getElementById('wishInput').value = '';
            
            // ä¸€äº›å°æ˜Ÿæ˜Ÿç‰¹æ•ˆ
            for (let i = 0; i < 15; i++) {
                setTimeout(() => createStar(), i * 100);
            }

            // --- NEW: Randomly choose game type ---
            const gameType = Math.random() < 0.5 ? 'textAdventure' : 'singleCharacter'; // 50/50 æ¦‚ç‡

            if (gameType === 'textAdventure') {
                startTextAdventure();
            } else {
                showSingleCharacterPopup();
            }

        } else {
            createEnhancedFloatingText('ğŸ’« è¯·å…ˆå†™ä¸‹ä½ çš„æ„¿æœ›å“¦ï½', window.innerWidth / 2, window.innerHeight / 3);
        }
    }

    // è®¸æ„¿ç‰¹æ•ˆ
    function createWishEffect() {
        const colors = ['#FFD700', '#FF69B4', '#00CED1', '#7C4DFF', '#FF6B9D'];
        const centerX = window.innerWidth / 2;
        const centerY = window.innerHeight / 2;
        
        for (let i = 0; i < 20; i++) {
            const star = document.createElement('div');
            star.innerHTML = 'âœ¨';
            star.style.position = 'fixed';
            star.style.left = centerX + 'px';
            star.style.top = centerY + 'px';
            star.style.fontSize = '1.5em';
            star.style.color = colors[Math.floor(Math.random() * colors.length)];
            star.style.pointerEvents = 'none';
            star.style.zIndex = '2000';
            document.body.appendChild(star);
            
            const endX = centerX + (Math.random() - 0.5) * 300;
            const endY = centerY + (Math.random() - 0.5) * 300;

            star.animate([
                { transform: 'translate(-50%, -50%) scale(0)', opacity: 1 },
                { transform: `translate(${endX - centerX}px, ${endY - centerY}px) scale(1)`, opacity: 1 },
                { transform: `translate(${endX - centerX}px, ${endY - centerY}px) scale(0)`, opacity: 0 }
            ], {
                duration: 2000,
                easing: 'ease-out'
            }).onfinish = () => star.remove();
        }
    }

    // åˆ›å»ºå°æ˜Ÿæ˜Ÿ
    function createStar() {
        const star = document.createElement('div');
        star.innerHTML = ['â­', 'âœ¨', 'ğŸŒŸ'][Math.floor(Math.random() * 3)];
        star.style.position = 'fixed';
        star.style.left = Math.random() * window.innerWidth + 'px';
        star.style.top = '-20px';
        star.style.fontSize = '1.2em';
        star.style.pointerEvents = 'none';
        star.style.zIndex = '1500';
        document.body.appendChild(star);
        
        star.animate([
            { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
            { transform: `translateY(${window.innerHeight + 50}px) rotate(360deg)`, opacity: 0 }
        ], {
            duration: 3000 + Math.random() * 2000,
            easing: 'linear'
        }).onfinish = () => star.remove();
    }

        // è®¸æ„¿å°è´´å£«
    function showWishTips() {
        const content = `
            <h2 style="color: #4F2FBF;">ğŸ’¡ è®¸æ„¿å°è´´å£«</h2> 
            <div style="text-align: left; line-height: 1.8;">                
                <p style="color: #b8860b; font-size: 0.9em; margin-top: 20px;"> 
                    âœ¨ å½“æŠ•å…¥è®¸æ„¿æ± æ—¶ï¼Œå°†ä¼šæœ‰ä¸¤ä½ç¥ç§˜çš„è§’è‰²éšæœºå‡ºç°å“¦ï¼ğŸ¥³
                </p>
            </div>
        `;
        showDialog(content);
    }

    // æ”¾çƒŸèŠ±
    function launchFireworks() {
        for (let i = 0; i < 10; i++) {
            setTimeout(() => createFirework(), i * 300);
        }
    }

    function createFirework() {
        const colors = ['#FF6B9D', '#C66FBC', '#7C4DFF', '#536DFE', '#66B3F9', '#FFD700'];
        const x = Math.random() * window.innerWidth;
        const y = Math.random() * window.innerHeight * 0.5;
        
        const firework = document.createElement('div');
        firework.className = 'firework';
        firework.style.left = x + 'px';
        firework.style.top = y + 'px';
        document.body.appendChild(firework);
        
        // åˆ›å»ºçˆ†ç‚¸ç²’å­
        for (let i = 0; i < 20; i++) {
            const particle = document.createElement('div');
            particle.className = 'firework-particle';
            particle.style.background = colors[Math.floor(Math.random() * colors.length)];
            
            const angle = (Math.PI * 2 * i) / 20;
            const velocity = 50 + Math.random() * 50;
            const vx = Math.cos(angle) * velocity;
            const vy = Math.sin(angle) * velocity;
            
            particle.style.transform = `translate(${vx}px, ${vy}px)`;
            firework.appendChild(particle);
        }
        
        setTimeout(() => firework.remove(), 1000);
    }

    // åˆ›å»ºå½©å¸¦
    function createConfetti() {
        const colors = ['#FF6B9D', '#C66FBC', '#7C4DFF', '#FFD700', '#66B3F9'];
        for (let i = 0; i < 50; i++) {
            setTimeout(() => {
                const confetti = document.createElement('div');
                confetti.style.position = 'fixed';
                confetti.style.width = '10px';
                confetti.style.height = '10px';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.left = Math.random() * 100 + '%';
                confetti.style.top = '-10px';
                confetti.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
                confetti.style.zIndex = '1000';
                confetti.style.pointerEvents = 'none';
                document.body.appendChild(confetti);
                
                confetti.animate([
                    { transform: 'translateY(0) rotate(0deg)', opacity: 1 },
                    { transform: `translateY(${window.innerHeight}px) rotate(${Math.random() * 720}deg)`, opacity: 0 }
                ], {
                    duration: 3000 + Math.random() * 2000,
                    easing: 'cubic-bezier(0.25, 0.46, 0.45, 0.94)'
                }).onfinish = () => confetti.remove();
            }, i * 50);
        }
    }

        // æ˜¾ç¤ºç§˜å¯†æ¶ˆæ¯
function showSecretMessage() {
    const content = `
        <h2 style="color: #FFD700;">ğŸ ä¸“å±äºæˆ‘ç»™æ —å­çš„ç§˜å¯†</h2> 
        <p style="margin: 20px 0; line-height: 1.8;">
            å…¶å®æˆ‘å·å·å‡†å¤‡äº†è¿™ä¸ªç¥ç¦é¡µé¢å¾ˆä¹…äº†å‘¢ï½<br>
            å¤§æ¦‚åœ¨å…«æœˆåˆé‚£æ—¶å€™å°±åœ¨å‡†å¤‡äº†å§å•Šå“ˆå“ˆ<br><br>
            è™½ç„¶è¯´ä¸­é€”æˆ‘å°±æœ‰äº›æ²¡å¿ä½å’Œæ —å­æè¿‡äº†å˜¿å˜¿<br>
            åœ¨æ­¤...æ¯ä¸€ä¸ªåŠ¨ç”»ã€æ¯ä¸€å¥ç¥ç¦<br>
            éƒ½æ˜¯æƒ³å‘Šè¯‰ä½ ï¼š<br><br>
            <strong style="font-size: 1.3em; color: #FFD700;"> 
                ä½ å¯¹æˆ‘æ¥è¯´ç»å¯¹æ˜¯ä¸€ä¸ªå¾ˆç‰¹åˆ«çš„å­˜åœ¨ï¼
            </strong><br><br>
            æˆ–è®¸ä¸€äº›é•¿çº¦å®šç¡®å®æ˜¯æ— æ³•å®ç°<br>
                ä½†æˆ‘ä¸€å®šä¼šåŠªåŠ›æœç€å®ç°çš„è·¯ä¸Šèµ°ä¸‹å»çš„<br>
                æˆ‘è¢«ä½ æ”¹å˜äº†å¾ˆå¤š<br>
                æˆ–è®¸æœ‰å¤„äº‹æ–¹å¼ï¼Œå¯¹ä¸–ç•Œçš„è®¤çŸ¥åº¦ç­‰ç­‰å§<br>
                ä½ è™½ç„¶è¯´è¿‡è‡ªå·±å¾ˆéš¾å› åˆ«äººæ”¹å˜<br>
                ä½†æ˜¯ä¹Ÿä¸å¦¨ç¢æˆ‘ç»™ä½ å¸¦æ¥å¿«ä¹å‘€å˜¿å˜¿<br>
            æˆ‘å¸Œæœ›æœªæ¥çš„æ¯ä¸€å¹´<br>
            éƒ½èƒ½ä¸ºä½ é€ä¸Šç”Ÿæ—¥ç¥ç¦ï¼<br><br>            
            PSï¼šæ„Ÿè°¢æ··å…ƒè€å¸ˆåœ¨2020å¹´æä¾›çš„éŸ³é¢‘å“ˆå“ˆå“ˆ<br>æˆ–è®¸æ —å­æƒ³åˆ°äº†å“¦ï¼Œæ­¤éŸ³ä¹å°±æ˜¯é‚£ä½å–œæ¬¢åœ¨coserèƒŒåç”¨å”¢å‘å¹å¯¹åº”è§’è‰²éŸ³ä¹çš„ç‰ˆæœ¬ï¼ï¼ˆå¯èƒ½å› ä¸ºæˆ‘åˆ·åˆ°çš„è§†é¢‘éƒ½æ˜¯è¿™ç±»çš„å§å“ˆå“ˆï¼‰
            <br>å³ä½¿èŠ±äº†æˆ‘è¿‘åŠä¸ªå¤šæœˆçš„æ—¶é—´ï¼Œè¯¥ç½‘é¡µè¿˜æ˜¯æœ‰å¾ˆå¤šä¸è¶³ï¼Œä¸è¿‡...å­¦ä¹ å°±æ˜¯è¦å¾ªåºæ¸è¿›å˜›ï¼Œä»¥åä¸€å®šä¼šè¶Šæ¥è¶Šå®Œç¾çš„ï¼
            <br><br>ä½ è®°å¾—è¦ä¸€ç›´ä¿æŒé‚£ä»½å¯çˆ±çš„"æŠ½è±¡"å‘¢ï¼ï¼ˆå°å£°ï¼‰<br><br> 
            <div class="secret-tip-box">
                <strong>æœ‰éšè—å°å½©è›‹å“¦ï¼š</strong><br>
                â€¢ ç”µè„‘ä¸Šè¿™æ ·æŒ‰é”®ç›˜çœ‹çœ‹ï¼šâ†‘â†‘â†“â†“â†â†’â†â†’BA<br>
                â€¢ éŸ³ä¹æ’­æ”¾å™¨æœ‰å°æƒŠå–œï¼Œå¤šç‚¹å‡ æ¬¡è¯•è¯•çœ‹ï¼Ÿ<br>
                â€¢ <strong>åœ¨ç¬¬1ã€2ã€4åœºæ™¯ä¸­ï¼Œç‚¹å‡»å¡ç‰‡ä¸Šçš„ğŸŒ°æˆ–è€…æ•°å­—ï¼Œä¼šæœ‰ä¸“å±ç¥ç¦å“¦ï¼</strong><br>
                â€¢ <strong>ç¬¬5åœºæ™¯çš„ç”Ÿæ—¥ç¥ç¦å¢™ä¸Šï¼Œæ¯ä¸ªç¥ç¦å¡ç‰‡éƒ½èƒ½è¢«ç‚¹äº®ï¼Œå¿«å»è¯•è¯•ï¼</strong><br>
                â€¢ <strong>åœ¨ç¬¬6åœºæ™¯çš„æœ€åç•™è¨€é‡Œï¼Œç‚¹ç‚¹å¡ç‰‡çš„ç©ºç™½èƒŒæ™¯ï¼Œä¼šæœ‰å°ç©ºåŸçš„æ‚„æ‚„è¯ï¼</strong><br>
                â€¢ æ¯ä¸ªåœºæ™¯éƒ½å¯ä»¥åˆ°å¤„ç‚¹ç‚¹çœ‹<br>
                â€¢ è¯•è¯•æŒ‰ä½å±å¹•æ»‘åŠ¨ï¼Œä¼šæœ‰ç¥ç§˜emojiè·Ÿéš~
            </div>
        </p>
    `;
    showDialog(content);
}

    // å¯¹è¯æ¡†æ§åˆ¶
    function showDialog(content) {
        const dialogContent = document.getElementById('dialogContent');
        const dialogOverlay = document.getElementById('dialogOverlay');
        const dialogBox = document.getElementById('dialogBox');
        
        dialogContent.innerHTML = content;
        dialogOverlay.style.display = 'block';
        dialogBox.style.display = 'block';
        
        // ç¡®ä¿å¯¹è¯æ¡†æ­£ç¡®å®šä½
        setTimeout(() => {
            dialogBox.scrollTop = 0; // é‡ç½®æ»šåŠ¨ä½ç½®åˆ°é¡¶éƒ¨
        }, 100);
        
        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
    }

    function closeDialog() {
        document.getElementById('dialogOverlay').style.display = 'none';
        document.getElementById('dialogBox').style.display = 'none';
        
        // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = '';
    }

        function addTouchOptimization() {
        const dialogBox = document.getElementById('dialogBox');
        const photoViewerContent = document.getElementById('photoViewerContent');
        
        // é˜²æ­¢å¯¹è¯æ¡†å†…å®¹æ»šåŠ¨æ—¶è§¦å‘èƒŒæ™¯æ»šåŠ¨
        dialogBox.addEventListener('touchstart', function(e) {
            e.stopPropagation();
        }, { passive: true }); // ä½¿ç”¨ passive:true æå‡æ»šåŠ¨æ€§èƒ½
        
        dialogBox.addEventListener('touchmove', function(e) {
            e.stopPropagation();
        }, { passive: true });
        
        // ç‚¹å‡»å¯¹è¯æ¡†å†…å®¹åŒºåŸŸä¸å…³é—­å¯¹è¯æ¡†ï¼ˆéæŒ‰é’®åŒºåŸŸï¼‰
        dialogBox.addEventListener('click', function(e) {
            if (e.target.tagName !== 'BUTTON') { // å¦‚æœä¸æ˜¯æŒ‰é’®ï¼Œåˆ™é˜»æ­¢äº‹ä»¶ä¼ æ’­
                e.stopPropagation();
            }
        });

        // é˜²æ­¢å›¾ç‰‡æŸ¥çœ‹å™¨å†…å®¹æ»šåŠ¨æ—¶è§¦å‘èƒŒæ™¯æ»šåŠ¨æˆ–å…³é—­
        if (photoViewerContent) {
            photoViewerContent.addEventListener('touchstart', function(e) {
                e.stopPropagation();
            }, { passive: true });
            photoViewerContent.addEventListener('touchmove', function(e) {
                e.stopPropagation();
            }, { passive: true });
            photoViewerContent.addEventListener('click', function(e) {
                e.stopPropagation(); // ç‚¹å‡»å›¾ç‰‡æŸ¥çœ‹å™¨å†…å®¹ä¸å…³é—­
            });
        }
    }

    // é‡æ–°å¼€å§‹
    function restart() {
        currentScene = 1;
        updateProgress();
        document.querySelectorAll('.scene').forEach(scene => {
            scene.classList.remove('active');
        });
        document.getElementById('scene1').classList.add('active');
        // éšè—è®¸æ„¿æˆåŠŸåçš„ç»§ç»­æŒ‰é’®
        document.getElementById('continueBtn').style.display = 'none';
    }
    
    // === åœºæ™¯ä¸“å±å½©è›‹è§¦å‘å‡½æ•° ===

    // åœºæ™¯1ï¼šæ —å­å›¾æ ‡ç¥ç¦
    function triggerChestnutBlessing(event) {
        event.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ ï¼Œé˜²æ­¢è§¦å‘å…¶ä»–ç‚¹å‡»æ•ˆæœ
        createEnhancedFloatingText('æ„¿æ —å­ğŸŒ°æ°¸è¿œå¯çˆ±ï¼Œå…ƒæ°”æ»¡æ»¡ï¼Œå­¦ä¸šé¡ºé‚ï¼Œå‰ç¨‹ä¼¼é”¦ï¼', event.clientX, event.clientY);
    }

    // åœºæ™¯2ï¼šå¤©æ•°è®¡æ•°ç¥ç¦
    function triggerDaysCounterBlessing(event) {
        event.stopPropagation();
        createEnhancedFloatingText('581å¤©çš„ç§¯ç´¯ï¼Œæ„¿æ —å­å­¦åŒ»ä¹‹è·¯æ­¥æ­¥ä¸ºè¥ï¼ŒåŠŸå¾·åœ†æ»¡ï¼', event.clientX, event.clientY);
    }

    // åœºæ™¯4ï¼šè®¸æ„¿æ˜Ÿç¥ç¦
    function triggerWishStarBlessing(event) {
        event.stopPropagation();
        createEnhancedFloatingText('æ„¿æ —å­æ‰€æ±‚çš†å¦‚æ„¿ï¼Œæ˜Ÿå…‰ä¸ºä½ æŒ‡å¼•æ–¹å‘ï¼', event.clientX, event.clientY);
    }

    // åœºæ™¯5ï¼šç¥ç¦å¡ç‰‡ç‚¹å‡»æ•ˆæœä¸ç¥ç¦
    function triggerWishCardBlessing(event) {
        event.stopPropagation();
        createEnhancedFloatingText('âœ¨è¿™ä»½ç¥ç¦å·²ç­¾æ”¶ï¼Œæ —å­çš„æœªæ¥å……æ»¡å…‰å½©ï¼', event.clientX, event.clientY);
        // ä¸€ä¸ªä¸´æ—¶çš„è§†è§‰åé¦ˆåˆ°å¡ç‰‡æœ¬èº«
        event.currentTarget.style.transition = 'none'; // ç¦ç”¨è¿‡æ¸¡æ•ˆæœï¼Œå®ç°å³æ—¶åé¦ˆ
        event.currentTarget.style.filter = 'brightness(1.5) saturate(1.5)'; // æäº®å¡ç‰‡
        setTimeout(() => {
            event.currentTarget.style.transition = 'all 0.3s ease'; // é‡æ–°å¯ç”¨è¿‡æ¸¡æ•ˆæœ
            event.currentTarget.style.filter = ''; // æ¢å¤åŸå§‹äº®åº¦
        }, 300);
    }

    // åœºæ™¯6ï¼šæœ€åç•™è¨€å¡ç‰‡èƒŒæ™¯ç¥ç¦
    function triggerFinalCardBlessing(event) {
        // ç¡®ä¿ç‚¹å‡»ç›®æ ‡æ˜¯ç»ç’ƒå¡ç‰‡æœ¬èº«ï¼Œè€Œä¸æ˜¯é‡Œé¢çš„æŒ‰é’®æˆ–æ–‡æœ¬ï¼ˆé¿å…å†²çªï¼‰
        const target = event.target;
        if (target.classList.contains('glass-card') || 
            (target.parentElement && target.parentElement.classList.contains('glass-card') && !target.closest('.btn'))) {
            
            event.stopPropagation();
            createEnhancedFloatingText('å°ç©ºåŸä¼šä¸€ç›´é™ªä¼´æ —å­çš„ï¼Œæ„¿ä½ æ¯å¤©éƒ½ç¬‘å®¹ç»½æ”¾ï¼', event.clientX, event.clientY);
        }
    }

    // æ ¹æ®åœºæ™¯å·æ·»åŠ å¯¹åº”çš„ç‚¹å‡»ç›‘å¬å™¨
    function addSceneSpecificClickListeners(sceneNumber) {
        // å…ˆç§»é™¤æ‰€æœ‰æ—§çš„ç›‘å¬å™¨ï¼Œé˜²æ­¢é‡å¤ç»‘å®š
        removeSceneSpecificClickListeners(); 

        if (sceneNumber === 1) {
            const chestnutIcon = document.querySelector('#scene1 .chestnut-icon');
            if (chestnutIcon) chestnutIcon.addEventListener('click', triggerChestnutBlessing);
        } else if (sceneNumber === 2) {
            const daysCounter = document.getElementById('daysCounter');
            if (daysCounter) daysCounter.addEventListener('click', triggerDaysCounterBlessing);
        } else if (sceneNumber === 4) {
            const wishStar = document.querySelector('#scene4 .chestnut-icon');
            if (wishStar) wishStar.addEventListener('click', triggerWishStarBlessing);
        } else if (sceneNumber === 5) {
            const wishCards = document.querySelectorAll('.wish-card');
            wishCards.forEach(card => card.addEventListener('click', triggerWishCardBlessing));
        } else if (sceneNumber === 6) {
            const finalCard = document.querySelector('#scene6 .glass-card');
            if (finalCard) finalCard.addEventListener('click', triggerFinalCardBlessing);
        }
    }

    // ç§»é™¤æ‰€æœ‰åœºæ™¯ç‰¹å®šçš„ç‚¹å‡»ç›‘å¬å™¨
    function removeSceneSpecificClickListeners() {
        // åœºæ™¯1
        const chestnutIcon1 = document.querySelector('#scene1 .chestnut-icon');
        if (chestnutIcon1) chestnutIcon1.removeEventListener('click', triggerChestnutBlessing);

        // åœºæ™¯2
        const daysCounter = document.getElementById('daysCounter');
        if (daysCounter) daysCounter.removeEventListener('click', triggerDaysCounterBlessing);

        // åœºæ™¯4
        const wishStar4 = document.querySelector('#scene4 .chestnut-icon');
        if (wishStar4) wishStar4.removeEventListener('click', triggerWishStarBlessing);

        // åœºæ™¯5
        const wishCards = document.querySelectorAll('.wish-card');
        wishCards.forEach(card => card.removeEventListener('click', triggerWishCardBlessing));
        
        // åœºæ™¯6
        const finalCard = document.querySelector('#scene6 .glass-card');
        if (finalCard) finalCard.removeEventListener('click', triggerFinalCardBlessing);
    }


    // éŸ³ä¹æ’­æ”¾
function toggleMusic() {
    const player = document.getElementById('musicPlayer');
    const audio = document.getElementById('backgroundMusic');

    // æ£€æŸ¥éŸ³é¢‘æ˜¯å¦å·²å‡†å¤‡å¥½ï¼Œé˜²æ­¢ç”¨æˆ·åœ¨éŸ³é¢‘åŠ è½½å®Œæˆå‰ç‚¹å‡»
    if (!audioInitialized) {
        createEnhancedFloatingText('âŒ éŸ³ä¹æ­£åœ¨åŠ è½½ï¼Œè¯·ç¨å€™...', window.innerWidth / 2, 200);
        return;
    }
    
    // === éŸ³ä¹æ’­æ”¾å™¨å½©è›‹è®¡æ•° ===
    musicToggleCount++;
    if (musicToggleCount === 5) {
        // è§¦å‘éŸ³ä¹æ’­æ”¾å™¨å½©è›‹
        createEnhancedFloatingText('ğŸ’– æ­å–œå‘ç°éŸ³ä¹å½©è›‹ï¼æ„¿ä½ çš„ç”Ÿæ´»å……æ»¡ç¾å¦™æ—‹å¾‹ï¼', window.innerWidth / 2, 100);
        createMusicFireflies(player); // å¬å”¤éŸ³ç¬¦è¤ç«è™«
        // å¯é€‰ï¼šæ’­æ”¾ç‰¹æ®ŠéŸ³æ•ˆ
        const specialSound = new Audio(SOUND_BASE_PATH + 'toprincess.ogg'); // å‡è®¾ä½ æœ‰ä¸€ä¸ªç‰¹æ®ŠéŸ³æ•ˆ
        specialSound.volume = 0.5;
        specialSound.play().catch(e => console.warn("Special sound play error:", e));
        musicToggleCount = 0; // é‡ç½®è®¡æ•°å™¨ï¼Œå¯å†æ¬¡è§¦å‘æˆ–è®¾ç½®ä¸º-1ç¦ç”¨
    }

    if (musicPlaying) {
        // --- æš‚åœéŸ³ä¹ ---
        audio.pause();
        musicPlaying = false;
        player.classList.remove('playing');
        player.innerHTML = '<span style="font-size: 1.5em;">ğŸ”‡</span>';
        createEnhancedFloatingText('ğŸ”‡ éŸ³ä¹å·²æš‚åœ', window.innerWidth / 2, 200);
    } else {
        // --- æ’­æ”¾éŸ³ä¹ ---
        audio.play().then(() => {
            musicPlaying = true;
            player.classList.add('playing');
            player.innerHTML = '<span style="font-size: 1.5em;">ğŸµ</span>';
            createEnhancedFloatingText('ğŸµ éŸ³ä¹å·²å¼€å§‹æ’­æ”¾', window.innerWidth / 2, 200);
            createMusicNotes(player);
        }).catch(error => {
            // å¦‚æœæ’­æ”¾å¤±è´¥ï¼ˆä¾‹å¦‚åœ¨æŸäº›ä¸¥æ ¼çš„æµè§ˆå™¨ç­–ç•¥ä¸‹ï¼‰
            console.error('éŸ³ä¹æ’­æ”¾å¤±è´¥:', error);
            createEnhancedFloatingText('âŒ æ’­æ”¾å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢æˆ–æ£€æŸ¥æµè§ˆå™¨è®¾ç½®', window.innerWidth / 2, 200);
        });
    }
}

    // é”®ç›˜å½©è›‹
    function addKeyboardEasterEgg() {
        let sequence = [];
        const code = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
        
        document.addEventListener('keydown', (e) => {
            sequence.push(e.key);
            sequence = sequence.slice(-10);
            
            if (sequence.join(',') === code.join(',')) {
                activateEasterEgg();
            }
        });
    }

    function activateEasterEgg() {
    if (easterEggActivated) return; // é¿å…é‡å¤æ¿€æ´»

    document.body.style.animation = 'rainbow 2s linear infinite';
    createEnhancedFloatingText('ğŸ® æ­å–œå‘ç°å½©è›‹ï¼ä½ çœŸçš„å¾ˆç»†å¿ƒå‘¢ï¼Œæ —å­ï¼', window.innerWidth / 2, 100);
    easterEggActivated = true; // æ ‡è®°å½©è›‹å·²æ¿€æ´»

    // å½©è™¹åŠ¨ç”»
    if (!document.querySelector('#rainbowStyle')) {
        const style = document.createElement('style');
        style.id = 'rainbowStyle';
        style.textContent = `
            @keyframes rainbow {
                0% { filter: hue-rotate(0deg); }
                100% { filter: hue-rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    }

    if (cursorChestnut) {
        originalCursorChestnutEmoji = cursorChestnut.textContent; // ä¿å­˜åŸå§‹æ —å­
        cursorChestnut.textContent = 'ğŸ©º'; // æ›¿æ¢ä¸ºå¬è¯Šå™¨emoji
        createEnhancedFloatingText('ğŸ‘©â€âš•ï¸ æ„¿ä½ å­¦ä¸šæœ‰æˆï¼Œæˆä¸ºä¸€åä¼˜ç§€çš„åŒ»ç”Ÿï¼', window.innerWidth / 2, 250);
        // ä¹Ÿå¯ä»¥è®©å°¾éšçš„å¿ƒå½¢å˜æˆç‰¹æ®Šemoji
        hearts.splice(0, hearts.length, ...specialEmojis); // æ›¿æ¢heartsæ•°ç»„å†…å®¹
    }

    // æŒç»­5ç§’åæ¢å¤
    setTimeout(() => {
        document.body.style.animation = '';
        easterEggActivated = false; // å…è®¸å†æ¬¡è§¦å‘
        // æ¢å¤åŸå§‹æ —å­å›¾æ ‡
        if (cursorChestnut) {
            cursorChestnut.textContent = originalCursorChestnutEmoji;
        }
        // æ¢å¤åŸå§‹å¿ƒå½¢emoji
        hearts.splice(0, hearts.length, 'â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’•');
    }, 8000); // å»¶é•¿æŒç»­æ—¶é—´åˆ°8ç§’
}

// å½“é¡µé¢æ‰€æœ‰èµ„æºåŠ è½½å®Œæˆåæ‰§è¡Œ
window.addEventListener('load', () => {
    // é¦–å…ˆåˆ›å»ºé¼ æ ‡è·Ÿéšçš„æ —å­å…ƒç´ ï¼Œç¡®ä¿å®ƒåœ¨å…¶ä»–äº‹ä»¶ç›‘å¬å‰å°±å­˜åœ¨
    cursorChestnut = createEmojiElement(chestnutEmoji, 0, 0, true);
    currentChestnutX = 0; 
    currentChestnutY = 0;
    document.body.style.cursor = 'none';

    createParticles();
    updateProgress();
    addKeyboardEasterEgg();
    addTouchOptimization();

    // è·å–åŠ è½½ç•Œé¢çš„DOMå…ƒç´ 
    const loadingOverlay = document.getElementById('loadingOverlay');

    // å¼€å§‹é¢„åŠ è½½æ‰€æœ‰æ ¸å¿ƒèµ„æºï¼Œå®Œæˆåæ‰§è¡Œå›è°ƒå‡½æ•°
    preloadAssets(() => {
        // èµ„æºåŠ è½½å®Œæˆåï¼Œä¸ºåŠ è½½ç•Œé¢æ·»åŠ  'hidden' ç±»ä½¿å…¶æ·¡å‡º
        if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
            // åœ¨åŠ è½½åŠ¨ç”»ç»“æŸåå†ç§»é™¤DOMå…ƒç´ ï¼Œé˜²æ­¢é—ªçƒ
            loadingOverlay.addEventListener('transitionend', () => {
                loadingOverlay.remove();
            }, { once: true });
        }
        
        // åˆå§‹åŒ–éŸ³é¢‘
        initializeAudio();
        
        // å»¶è¿Ÿæ˜¾ç¤ºæ“ä½œæç¤º
        setTimeout(() => {
            if (currentScene === 1) {
                createEnhancedFloatingText('ğŸ’¡ å°æç¤ºï¼šé¡µé¢éšè—äº†è®¸å¤šå½©è›‹ï¼Œå¯ä»¥åˆ°å¤„ç‚¹ç‚¹çœ‹å“¦ï¼', window.innerWidth / 2, 100);
            }
        }, 1200); // ç¨å¾®å¢åŠ å»¶è¿Ÿï¼Œç­‰å¾…åŠ è½½ç•Œé¢å®Œå…¨æ¶ˆå¤±

        addGlobalSceneClickListeners();
        addSceneSpecificClickListeners(currentScene);
    });
});

        // éŸ³é¢‘åˆå§‹åŒ–
    function initializeAudio() {
        const audio = document.getElementById('backgroundMusic');
        audio.volume = 0.3; // è®¾ç½®ä¸€ä¸ªåˆé€‚çš„é»˜è®¤éŸ³é‡
        
        // ç›‘å¬éŸ³é¢‘æ˜¯å¦å¯ä»¥æ’­æ”¾
        audio.addEventListener('canplay', () => {
            console.log('éŸ³é¢‘å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥æ’­æ”¾ã€‚');
            audioInitialized = true; // è®¾ç½®æ ‡å¿—ä½
        });
        
        audio.addEventListener('error', (e) => {
            console.error('éŸ³é¢‘åŠ è½½é”™è¯¯:', e);
            // åœ¨é¡µé¢ä¸Šç»™ç”¨æˆ·ä¸€ä¸ªæ¸…æ™°çš„æç¤º
            createEnhancedFloatingText('å¾ˆæŠ±æ­‰ï¼ŒèƒŒæ™¯éŸ³ä¹åŠ è½½å¤±è´¥äº†ï¼', window.innerWidth / 2, 100);
        });
        
        // æ‰‹åŠ¨è§¦å‘åŠ è½½
        audio.load();
    }

    // === éŸ³ä¹æ’­æ”¾å™¨ç‰¹æ®ŠéŸ³ç¬¦è¤ç«è™«æ•ˆæœ ===
    function createMusicFireflies(player) {
        const colors = ['#FFD700', '#FF69B4', '#00CED1', '#7C4DFF', '#FF6B9D'];
        for (let i = 0; i < 15; i++) {
            setTimeout(() => {
                const firefly = document.createElement('div');
                firefly.textContent = 'âœ¨'; // ä½¿ç”¨æ˜Ÿæ˜Ÿæ›¿ä»£éŸ³ç¬¦ï¼Œæ›´åƒè¤ç«è™«
                firefly.style.position = 'fixed';
                firefly.style.left = (player.offsetLeft + player.offsetWidth / 2 + (Math.random() - 0.5) * 80) + 'px';
                firefly.style.top = (player.offsetTop + player.offsetHeight / 2 + (Math.random() - 0.5) * 80) + 'px';
                firefly.style.fontSize = `${1 + Math.random()}em`;
                firefly.style.color = colors[Math.floor(Math.random() * colors.length)];
                firefly.style.zIndex = '1001';
                firefly.style.pointerEvents = 'none';
                firefly.style.opacity = '0'; // åˆå§‹é€æ˜
                document.body.appendChild(firefly);
                
                // å¤æ‚åŠ¨ç”»ï¼Œæ¨¡æ‹Ÿè¤ç«è™«é£èˆ
                const startX = parseFloat(firefly.style.left);
                const startY = parseFloat(firefly.style.top);
                const endX = startX + (Math.random() - 0.5) * 200;
                const endY = startY - 150 - Math.random() * 100;

                firefly.animate([
                    { opacity: 0, transform: `translate(0px, 0px) scale(0.5)` },
                    { opacity: 1, transform: `translate(${endX - startX}px, ${endY - startY}px) scale(1.2)` },
                    { opacity: 0, transform: `translate(${endX - startX + (Math.random() - 0.5) * 50}px, ${endY - startY - 50}px) scale(0.8)` }
                ], {
                    duration: 4000 + Math.random() * 1000,
                    easing: 'ease-in-out',
                    iterations: 1
                }).onfinish = () => firefly.remove();
            }, i * 150);
        }
    }


    // éŸ³ç¬¦åŠ¨ç”»å‡½æ•°
    function createMusicNotes(player) {
        const notes = ['ğŸµ', 'ğŸ¶', 'â™ª', 'â™«'];
        for (let i = 0; i < 5; i++) {
            setTimeout(() => {
                const note = document.createElement('div');
                note.textContent = notes[Math.floor(Math.random() * notes.length)];
                note.style.position = 'fixed';
                note.style.left = (player.offsetLeft + Math.random() * 60) + 'px';
                note.style.top = (player.offsetTop + Math.random() * 60) + 'px';
                note.style.fontSize = '1.5em';
                note.style.color = '#FFD700';
                note.style.zIndex = '1001';
                note.style.pointerEvents = 'none';
                document.body.appendChild(note);
                
                note.animate([
                    { transform: 'translateY(0) scale(1)', opacity: 1 },
                    { transform: 'translateY(-100px) scale(0.5)', opacity: 0 }
                ], {
                    duration: 2000,
                    easing: 'ease-out'
                }).onfinish = () => note.remove();
            }, i * 300);
        }
    }

    // === åœºæ™¯é€šç”¨ç‚¹å‡»å½©è›‹ç›‘å¬å™¨ ===
    function addGlobalSceneClickListeners() {
        document.querySelectorAll('.scene').forEach(scene => {
            scene.addEventListener('click', (e) => {
                // åªæœ‰å½“ç‚¹å‡»ç›®æ ‡ä¸æ˜¯æŒ‰é’®æˆ–é“¾æ¥ï¼Œä¸”ä¸æ˜¯ç‰¹å®šçš„å½©è›‹å…ƒç´ æ—¶æ‰è§¦å‘é€šç”¨å½©è›‹
                if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.closest('.game-item') || e.target.closest('.chestnut-icon') || e.target.closest('.music-player')) {
                    return;
                }
                const randomMessages = [
                    'ğŸŒŸ æ„¿ä½ æ¯å¤©éƒ½æœ‰å°ç¡®å¹¸ï¼',
                    'âœ¨ å¥½è¿å¸¸ä¼´ï¼Œå¿ƒæƒ³äº‹æˆï¼',
                    'ğŸ’– æ —å­æœ€æ£’ï¼Œæœªæ¥å¯æœŸï¼',
                    'ğŸ˜Š æ„¿ä½ ç¬‘å®¹å¸¸åœ¨ï¼Œå¿«ä¹æ— è¾¹ï¼',
                    'ğŸŒˆ å……æ»¡å¸Œæœ›ï¼Œå‹‡æ•¢å‰è¡Œï¼'
                ];
                const message = randomMessages[Math.floor(Math.random() * randomMessages.length)];
                createEnhancedFloatingText(message, e.clientX, e.clientY - 30);
                createFireworkSparkle(e.clientX, e.clientY); // å°é—ªçƒæ•ˆæœ
            });
        });
    }

    // === åœºæ™¯ç‰¹å®šç‚¹å‡»å½©è›‹ç›‘å¬å™¨ ===
    function addSceneSpecificClickListeners(sceneNumber) {
        // å½©è›‹1: åœºæ™¯3çš„ğŸŒ°å›¾æ ‡ç‚¹å‡»å½©è›‹
        if (sceneNumber === 3) {
            const chestnutIcon = document.querySelector('#scene3 .chestnut-icon');
            if (chestnutIcon && !chestnutIcon.dataset.listenerAdded) {
                chestnutIcon.style.cursor = 'pointer'; // æç¤ºå¯ç‚¹å‡»
                chestnutIcon.addEventListener('click', (e) => {
                    e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°åœºæ™¯é€šç”¨ç‚¹å‡»
                    createEnhancedFloatingText('ğŸŒ° æ —å­æœ¬æ —ï¼Œç‹¬ä¸€æ— äºŒï¼ä½ æ˜¯æœ€å¯çˆ±çš„ï¼', e.clientX, e.clientY - 30);
                    for (let i = 0; i < 10; i++) {
                        setTimeout(() => createFloatingChestnut(e.clientX, e.clientY), i * 50);
                    }
                });
                chestnutIcon.dataset.listenerAdded = 'true'; // æ ‡è®°å·²æ·»åŠ ç›‘å¬å™¨
            }
        }
    }

    // === åˆ›å»ºå°é—ªçƒæ•ˆæœï¼ˆç”¨äºé€šç”¨åœºæ™¯ç‚¹å‡»ï¼‰===
    function createFireworkSparkle(x, y) {
        const colors = ['#FFD700', '#FFA500', '#FF6B9D', '#C66FBC'];
        for (let i = 0; i < 5; i++) {
            const sparkle = document.createElement('div');
            sparkle.style.position = 'fixed';
            sparkle.style.left = x + (Math.random() - 0.5) * 20 + 'px';
            sparkle.style.top = y + (Math.random() - 0.5) * 20 + 'px';
            sparkle.style.width = '5px';
            sparkle.style.height = '5px';
            sparkle.style.borderRadius = '50%';
            sparkle.style.background = colors[Math.floor(Math.random() * colors.length)];
            sparkle.style.zIndex = '2000';
            sparkle.style.pointerEvents = 'none';
            document.body.appendChild(sparkle);

            sparkle.animate([
                { transform: 'scale(0)', opacity: 1 },
                { transform: `scale(1.5) translate(${(Math.random() - 0.5) * 30}px, ${(Math.random() - 0.5) * 30}px)`, opacity: 0 }
            ], {
                duration: 500 + Math.random() * 300,
                easing: 'ease-out'
            }).onfinish = () => sparkle.remove();
        }
    }

    // === æ —å­å›¾æ ‡ç‚¹å‡»åæ¼‚æµ®çš„å°æ —å­ ===
    function createFloatingChestnut(x, y) {
        const chestnut = document.createElement('div');
        chestnut.textContent = 'ğŸŒ°';
        chestnut.style.position = 'fixed';
        chestnut.style.left = x + 'px';
        chestnut.style.top = y + 'px';
        chestnut.style.fontSize = `${2 + Math.random()}em`;
        chestnut.style.zIndex = '2000';
        chestnut.style.pointerEvents = 'none';
        chestnut.style.transform = 'translate(-50%, -50%)'; // ä¸­å¿ƒå¯¹é½
        document.body.appendChild(chestnut);

        const endX = x + (Math.random() - 0.5) * 150;
        const endY = y - 100 - Math.random() * 100;

        chestnut.animate([
            { transform: 'translate(-50%, -50%) scale(0.8) rotate(0deg)', opacity: 1 },
            { transform: `translate(${endX - x - 50}px, ${endY - y - 50}px) scale(1.2) rotate(${Math.random() * 360}deg)`, opacity: 1 },
            { transform: `translate(${endX - x}px, ${endY - y - 150}px) scale(0.5) rotate(${Math.random() * 360}deg)`, opacity: 0 }
        ], {
            duration: 2500 + Math.random() * 1000,
            easing: 'ease-out'
        }).onfinish = () => chestnut.remove();
    }

    // éŸ³ç¬¦åŠ¨ç”»å‡½æ•°
function createMusicNotes(player) {
    const notes = ['ğŸµ', 'ğŸ¶', 'â™ª', 'â™«'];
    for (let i = 0; i < 5; i++) {
        setTimeout(() => {
            const note = document.createElement('div');
            note.textContent = notes[Math.floor(Math.random() * notes.length)];
            note.style.position = 'fixed';
            note.style.left = (player.getBoundingClientRect().left + Math.random() * 60) + 'px';
            note.style.top = (player.getBoundingClientRect().top + Math.random() * 60) + 'px';
            note.style.fontSize = '1.5em';
            note.style.color = '#FFD700';
            note.style.zIndex = '1001';
            note.style.pointerEvents = 'none';
            document.body.appendChild(note);
            
            note.animate([
                { transform: 'translateY(0) translateX(0) scale(1)', opacity: 1 },
                // å‘ä¸Šæ¼‚æµ®æ›´è¿œï¼Œå¹¶æœ‰éšæœºçš„æ°´å¹³åç§»
                { transform: `translateY(${-100 - Math.random() * 50}px) translateX(${(Math.random() - 0.5) * 80}px) scale(0.5)`, opacity: 0 }
            ], {
                duration: 2000 + Math.random() * 500,
                easing: 'ease-out'
            }).onfinish = () => note.remove();
        }, i * 300);
    }
}
    
    /* ==================================== */
    /* Emoji ä¼´éšæ•ˆæœé€»è¾‘ */
    /* ==================================== */

    let cursorChestnut = null;
    let touchChestnut = null;
    let hearts = ['â¤ï¸', 'ğŸ§¡', 'ğŸ’›', 'ğŸ’š', 'ğŸ’™', 'ğŸ’œ', 'ğŸ’–', 'ğŸ’˜', 'ğŸ’•']; 
    const chestnutEmoji = 'ğŸŒ°';
    let lastEmojiTime = 0;
    const emojiInterval = 80;

    let targetMouseX = 0;
    let targetMouseY = 0;
    let targetTouchX = 0;
    let targetTouchY = 0;

    let currentChestnutX = 0;
    let currentChestnutY = 0;
    let currentTouchChestnutX = 0;
    let currentTouchChestnutY = 0;

    const animationDecay = 0.2;
    let animationFrameId = null;

        function createEmojiElement(emoji, x, y, isChestnut = false) {
        const el = document.createElement('div');
        el.textContent = emoji;
        el.style.position = 'fixed';
        el.style.left = `${x}px`;
        el.style.top = `${y}px`;
        el.style.pointerEvents = 'none';
        el.style.zIndex = '99999';
        el.style.transform = 'translate(-50%, -50%)';
        document.body.appendChild(el);

        if (isChestnut) {
            el.className = 'cursor-chestnut';
            el.style.fontSize = '2.2em';
            if (!isTouchDevice) { // å¦‚æœä¸æ˜¯è§¦å±è®¾å¤‡ï¼Œåˆ™åˆå§‹å¯è§
                el.style.opacity = '1'; 
            } else { // è§¦å±è®¾å¤‡åˆå§‹éšè—
                el.style.opacity = '0';
            }
            return el;
        } else {
            el.className = 'trail-emoji';
            el.style.fontSize = `${1.2 + Math.random() * 0.6}em`;
            
            const offsetX = (Math.random() - 0.5) * 60;
            const offsetY = (Math.random() - 0.5) * 60;
            const rotation = (Math.random() - 0.5) * 90;
            el.style.setProperty('--dx', `${offsetX}px`);
            el.style.setProperty('--dy', `${offsetY}px`);
            el.style.setProperty('--rotate', `${rotation}deg`);
            
            el.addEventListener('animationend', () => el.remove());
            return el;
        }
    }

    function generateTrailEmoji(x, y) {
        const currentTime = Date.now();
        if (currentTime - lastEmojiTime > emojiInterval) {
            const offsetX = (Math.random() - 0.5) * 20;
            const offsetY = (Math.random() - 0.5) * 20;
            createEmojiElement(hearts[Math.floor(Math.random() * hearts.length)], x + offsetX, y + offsetY);
            lastEmojiTime = currentTime;
        }
    }

    function animateChestnut() {
        let activeChestnuts = 0;

        if (cursorChestnut && parseFloat(cursorChestnut.style.opacity) > 0) {
            const deltaMouseX = targetMouseX - currentChestnutX;
            const deltaMouseY = targetMouseY - currentChestnutY;
            currentChestnutX += deltaMouseX * animationDecay;
            currentChestnutY += deltaMouseY * animationDecay;
            cursorChestnut.style.left = `${currentChestnutX}px`;
            cursorChestnut.style.top = `${currentChestnutY}px`;
            activeChestnuts++;
        }

        if (touchChestnut && parseFloat(touchChestnut.style.opacity) > 0) {
            const deltaTouchX = targetTouchX - currentTouchChestnutX;
            const deltaTouchY = targetTouchY - currentTouchChestnutY;
            currentTouchChestnutX += deltaTouchX * animationDecay;
            currentTouchChestnutY += deltaTouchY * animationDecay;
            touchChestnut.style.left = `${currentTouchChestnutX}px`;
            touchChestnut.style.top = `${currentTouchChestnutY}px`;
            activeChestnuts++;
        }

        if (activeChestnuts > 0) {
            animationFrameId = requestAnimationFrame(animateChestnut);
        } else {
            stopAnimationLoop();
        }
    }

    function startAnimationLoop() {
        if (animationFrameId === null) {
            animationFrameId = requestAnimationFrame(animateChestnut);
        }
    }

    function stopAnimationLoop() {
        if (animationFrameId !== null) {
            cancelAnimationFrame(animationFrameId);
            animationFrameId = null;
        }
    }

        // === ã€ä¿®å¤/ä¼˜åŒ–ã€‘é¼ æ ‡è·Ÿéšæ —å­æ˜¾ç¤ºé€»è¾‘ ===
    // é¼ æ ‡æ —å­åˆå§‹åŒ–åœ¨ window.load ä¸­æ‰§è¡Œï¼Œä»¥ç¡®ä¿DOMå·²å‡†å¤‡å¥½

    document.body.style.cursor = 'none'; // éšè—é»˜è®¤é¼ æ ‡

    document.addEventListener('mousemove', (e) => {
        targetMouseX = e.clientX;
        targetMouseY = e.clientY;
        // åªæœ‰å½“é¼ æ ‡æ —å­å¯è§æ—¶æ‰ç”Ÿæˆå°¾éšemoji
        if (cursorChestnut && parseFloat(cursorChestnut.style.opacity) > 0) {
            generateTrailEmoji(e.clientX, e.clientY);
        }
        startAnimationLoop();
    });

    document.addEventListener('mouseleave', () => {
        // å½“é¼ æ ‡ç¦»å¼€bodyæ—¶ï¼Œéšè—æ —å­
        if (cursorChestnut) {
           cursorChestnut.style.opacity = '0';
        }
    });

    document.addEventListener('mouseenter', (e) => {
        // å½“é¼ æ ‡é‡æ–°è¿›å…¥bodyæ—¶ï¼Œæ˜¾ç¤ºæ —å­å¹¶æ›´æ–°ä½ç½®
        if (cursorChestnut) {
           cursorChestnut.style.opacity = '1';
           currentChestnutX = e.clientX; // ç«‹å³å°†æ —å­ä½ç½®è®¾ç½®åˆ°é¼ æ ‡ä½ç½®
           currentChestnutY = e.clientY;
           cursorChestnut.style.left = `${currentChestnutX}px`;
           cursorChestnut.style.top = `${currentChestnutY}px`;
        }
        startAnimationLoop();
    });

    const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0;
    if (isTouchDevice) {
        // ç§»åŠ¨ç«¯éšè—é»˜è®¤é¼ æ ‡
        document.body.style.cursor = 'auto'; // ç§»åŠ¨ç«¯é€šå¸¸ä¸éœ€è¦éšè—å…‰æ ‡

        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                
                if (!touchChestnut) { // æ‡’åŠ è½½ï¼Œé¦–æ¬¡è§¦æ‘¸æ—¶åˆ›å»º
                    touchChestnut = createEmojiElement(chestnutEmoji, targetTouchX, targetTouchY, true);
                    // ç¡®ä¿ç§»åŠ¨ç«¯touchChestnutåˆå§‹å¯è§
                    touchChestnut.style.opacity = '1';
                }
                
                touchChestnut.style.opacity = '1'; // ç¡®ä¿å¯è§
                currentTouchChestnutX = targetTouchX; // ç«‹å³è®¾ç½®ä½ç½®
                currentTouchChestnutY = targetTouchY;
                touchChestnut.style.left = `${currentTouchChestnutX}px`;
                touchChestnut.style.top = `${currentTouchChestnutY}px`;

                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0 && touchChestnut && parseFloat(touchChestnut.style.opacity) > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            // å¦‚æœæ‰€æœ‰è§¦æ‘¸éƒ½å·²ç»“æŸï¼Œåˆ™éšè—æ —å­
            if (touchChestnut && e.touches.length === 0) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });

        document.addEventListener('touchcancel', () => {
            if (touchChestnut) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });
    } else {
        // æ¡Œé¢ç«¯ä¸“å±ï¼Œç¡®ä¿cursorChestnutä¸€å¼€å§‹å°±æ˜¯å¯è§çš„
        if (cursorChestnut) {
            cursorChestnut.style.opacity = '1';
        }
    }
    if (isTouchDevice) {
        document.addEventListener('touchstart', (e) => {
            if (e.touches.length > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                
                if (!touchChestnut) {
                    touchChestnut = createEmojiElement(chestnutEmoji, targetTouchX, targetTouchY, true);
                }
                
                touchChestnut.style.opacity = '1';
                currentTouchChestnutX = targetTouchX;
                currentTouchChestnutY = targetTouchY;
                touchChestnut.style.left = `${currentTouchChestnutX}px`;
                touchChestnut.style.top = `${currentTouchChestnutY}px`;

                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchmove', (e) => {
            if (e.touches.length > 0 && touchChestnut && parseFloat(touchChestnut.style.opacity) > 0) {
                const touch = e.touches[0];
                targetTouchX = touch.clientX;
                targetTouchY = touch.clientY;
                generateTrailEmoji(targetTouchX, targetTouchY);
                startAnimationLoop();
            }
        }, { passive: true });

        document.addEventListener('touchend', (e) => {
            if (touchChestnut && e.touches.length === 0) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });

        document.addEventListener('touchcancel', () => {
            if (touchChestnut) {
                touchChestnut.style.opacity = '0';
            }
        }, { passive: true });
    }

    function enableAutoPlay() {
        const audio = document.getElementById('backgroundMusic');
        const player = document.getElementById('musicPlayer');
        // åªæœ‰å½“éŸ³ä¹å°šæœªæ’­æ”¾ã€å·²æš‚åœä¸”éŸ³é¢‘å·²å‡†å¤‡å¥½æ—¶æ‰å°è¯•æ’­æ”¾
        if (!musicPlaying && audio.paused && audioInitialized) {
            audio.play().then(() => {
                musicPlaying = true;
                player.classList.add('playing');
                player.innerHTML = '<span style="font-size: 1.5em;">ğŸµ</span>';
                createEnhancedFloatingText('ğŸµ éŸ³ä¹å·²æ’­æ”¾', window.innerWidth / 2, 150);
                createMusicNotes(player);
            }).catch(error => {
                console.log('éŸ³ä¹è‡ªåŠ¨æ’­æ”¾å¤±è´¥:', error);
            });
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        document.addEventListener('click', enableAutoPlay, { once: true });
    });

    // ç‚¹å‡»æ¶Ÿæ¼ªæ•ˆæœ
    document.addEventListener('click', function(e) {
        if (e.target.tagName === 'BUTTON') return;
        // æ’é™¤æ¸¸æˆæ¨¡å—å†…çš„ç‚¹å‡»ï¼Œé˜²æ­¢å¹²æ‰°
        if (e.target.closest('#gameModule') || e.target.closest('#singleCharacterPopup')) return;
        
        const ripple = document.createElement('div');
        ripple.style.position = 'fixed';
        ripple.style.left = e.clientX + 'px';
        ripple.style.top = e.clientY + 'px';
        ripple.style.width = '10px';
        ripple.style.height = '10px';
        ripple.style.background = 'radial-gradient(circle, rgba(255, 255, 255, 0.8), transparent)';
        ripple.style.borderRadius = '50%';
        ripple.style.pointerEvents = 'none';
        ripple.style.zIndex = '10000';
        document.body.appendChild(ripple);
        
        ripple.animate([
            { transform: 'scale(0)', opacity: 1 },
            { transform: 'scale(10)', opacity: 0 }
        ], {
            duration: 600,
            easing: 'ease-out'
        }).onfinish = () => ripple.remove();
    });

    /* ==================================== */
    /* æ–‡å­—å†’é™©æ¸¸æˆæ¨¡å—é€»è¾‘ */
    /* ==================================== */

    // å®šä¹‰äººç‰©å›¾ç‰‡å’ŒèƒŒæ™¯å›¾ç‰‡çš„åŸºç¡€è·¯å¾„
    const IMAGE_BASE_PATH = 'https://vacuopolis.netlify.app/image/';
    const SOUND_BASE_PATH = 'https://vacuopolis.netlify.app/audio/';

        // å¯¹è¯æ•°æ®
    const textAdventureData = [
        {
            id: 'intro_action',
            type: 'action',
            speaker: '',
            text: 'ï¼ˆåœ¨ä½ å¿ƒä¸­é»˜å¿µæ„¿æœ›çš„ç¬é—´...èº«è¾¹çš„ç©ºæ°”çªç„¶å¾®æ¼¾ï¼Œç§¦æ¢§å¦‚åŒé¬¼é­…...æˆ–è€…è¯´ï¼Œæ›´åƒåªè­¦è§‰çš„ç‹ç‹¸ï¼Œç¬é—´è´´è¿‘è‡³ä¸ä½ å‘¼å¸ç›¸é—»çš„è·ç¦»ã€‚ä»–é‚£åŒéé‡‘çœ¼ç³ç…§å°„å‡ºå¾®å…‰ï¼Œå¥½ä¼¼åˆšé€šè¿‡ç¥ç§˜çš„æ–¹å¼ç°èº«ä¸æ­¤ï¼‰', 
            charImg: 'qinwu_yelloweyes.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue0'
        },
        {
            id: 'dialogue0',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'å“¦ï¼Ÿæ„Ÿåº”åˆ°ä¸ªæœ‰è¶£çš„å¿ƒæ„¿ä¿¡å·ï½ï¼ˆå¿½ç„¶å‹ä½å£°éŸ³ï¼Œå¸¦ç€ç‹¡é» çš„ç¬‘æ„ï¼‰åˆ«ç´§å¼ å•Šï¼Œä½ çš„å°é¹¿éƒ½æ’åˆ°æˆ‘å¿ƒå£äº†...(ç¨ä½œåœé¡¿ï¼Œæ„Ÿæ…¨çŠ¶)', 
            charImg: 'qinwu_laugh1.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue1'
        },
        {
            id: 'dialogue1',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'å”‰ï¼Œå¤©ç”ŸåŠ³ç¢Œå‘½å’¯ï¼Œæ—¢ç„¶ç‰©ç†ç¾å­¦å¤©æ‰æ„Ÿåº”åˆ°äº†â€”â€”', 
            charImg: 'qinwu_laugh2.png', // å·²ç¡®è®¤è¯¥å›¾ç‰‡å­˜åœ¨å¹¶è¡¥å……åˆ°manifest
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action1'
        },
        {
            id: 'action1',
            type: 'action',
            speaker: '',
            text: 'ï¼ˆé‡‘çº¢è‰²çš„å…‰ç‚¹å¦‚è°ƒçš®å°è™«ï¼Œå¿½ç„¶ä»ä»–æŒ‡å°–è¹¦å‡ºï¼Œæ¬¢å¿«åœ°åœ¨ä½ çš„è¡£è¥Ÿä¸Šç»•äº†ä¸ªæµå…‰åœˆï¼Œéšå³é’»å…¥çº½æ‰£é—´ï¼‰',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue2'
        },
        {
            id: 'dialogue2',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'ä¸€æ„¿ï¼šç»Šä½ çš„ç§ç§ä¸é¡ºå¿ƒï¼Œç»Ÿç»ŸåŒ–æˆç°å®åˆ†æé¢˜ï¼ï¼ˆé£ŸæŒ‡ç‚¹ç‚¹ç©ºæ°”ï¼‰ä¿è¯æ¯”è¯æ˜ä¸¤ç‰©ç­‰é«˜ç®€å•ï¼ï¼ˆå¿½ç„¶ä¿ƒç‹­çœ¨çœ¼ï¼‰é™„åŠ ç‰¹æ•ˆæ˜¯è§£å®Œé¢˜è‡ªåŠ¨æ¶ˆå¤±~', 
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action2'
        },
        {
            id: 'action2',
            type: 'action',
            speaker: '',
            text: '(ä»¿ä½›ä¸ç»æ„åœ°æŠ½èµ°ä½ é¬“è¾¹ä¸€ç¼•å‘ä¸ï¼ŒæŒ‡å°–é£å¿«åœ°æ‰“äº†ä¸ªç²¾å·§çš„ç»“ï¼‰',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue3'
        },
        {
            id: 'dialogue3',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'äºŒæ„¿ï¼šä¸ºä½ æ’‘æŠŠä¼ï¼ï¼ˆè¯­æ°”è«åå˜å¾—è®¤çœŸï¼‰ä¸æ˜¯æŒ‡æ·‹é›¨æ·‹é›ªæ™’å¤ªå†·æ™’å¤ªé˜³é‚£ç§...ï¼ˆå£°éŸ³å¿½å°ï¼‰', 
            charImg: 'qinwu_laugh2.png', // å·²ç¡®è®¤è¯¥å›¾ç‰‡å­˜åœ¨å¹¶è¡¥å……åˆ°manifest
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue3.5'
        },
        {
            id: 'dialogue3.5',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'æ˜¯è¯´...å—¯...ä¸‡ä¸€æœ‰çœ‹ä¸æƒ¯çš„å®¶ä¼™æƒ¹ä½ ä¸çˆ½éº»çƒ¦...çœ‹æˆ‘ç”¨å…¬å¼æäººï¼ï¼ˆè¯­æ°”è½¬å¿«ï¼‰å½“ç„¶ä¼˜å…ˆåº”ç”¨ç‰©ç†åŠé€€æ³•ï¼', 
            charImg: 'qinwu_embarrass.png', 
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action3'
        },
        {
            id: 'action3',
            type: 'action',
            speaker: '',
            text: 'ï¼ˆæ»ç€å‘ä¸ç¼ æˆçš„å°ç»“ï¼ŒåŠ¨ä½œè½»å¿«åœ°å°†å…¶æŒ‰å‘ä½ çš„æŒå¿ƒï¼‰',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue4a'
        },
        {
            id: 'dialogue4a',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'æœ€åè¿™æ„¿å˜›...ï¼ˆæ•…ä½œé«˜æ·±çŠ¶ï¼‰æš‚å­˜è¿™é¢—â€˜ç§¦å¼ç‰¹ä¾›é€šè®¯ç â€™é‡Œå•¦ï¼',
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue4b'
        },
        {
            id: 'dialogue4b', 
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'è¦æ˜¯ã€è¦æ˜¯æƒ³è®¨è®ºç‰©ç†é¢˜...æˆ–è€…...å’³...â€˜å°ä¸»ä½†å¯æç¢æ­¤ç ï¼Œè‡ªæœ‰å¥´å©¢ç«­è¯šä¸ºæ‚¨æœåŠ¡...â€™',
            charImg: 'qinwu_embarrass.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'systemPrompt1'
        },
        {
            id: 'systemPrompt1',
            type: 'action',
            speaker: '',
            text: 'ã€ç³»ç»Ÿæç¤ºã€‘è·å¾—è¢«åŠ¨æŠ€èƒ½<ç§¦æ¢§ã®æ•‘æ´>ï¼šé‡é™©æ—¶å¼ºåˆ¶é€šçŸ¥ç§¦æ¢§ï¼ˆæ¸©é¦¨æç¤ºï¼šæˆ–è®¸å¬å”¤æœ‰æ¦‚ç‡ä¼šå‡ºç°ç©¿ç€è‰è“å›¾æ¡ˆç¡è¡£ç‰ˆï½ï¼‰', 
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'choices1'
        },
        {
            id: 'choices1',
            type: 'choices',
            text: 'ï¼é€‰é¡¹æµ®ç°ï¼œ',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            options: [
                { text: 'ã€ä¼¸æ‰‹æ¢å‘ä»–æŒ‡å°–ã€‘â€œé€šè®¯ç ï¼Ÿç»“æ„èƒ½æè¿°ä¸€ä¸‹å—ç§¦è€å¸ˆï¼Ÿâ€', next: 'branchA', img: 'choicebox1.png' }, 
                { text: 'ã€è½»æ™ƒæŒå¿ƒçš„ç»“ã€‘â€œè¿™å‰©ä¸‹çš„ä¸€æ„¿...çœŸçš„ä¸æ˜¯å…è´£å£°æ˜ï¼Ÿâ€', next: 'branchB', img: 'choicebox2.png' }, 
                { text: 'ã€ç›¯ç€ä»–å¾®çº¢çš„è€³æœµã€‘â€œç§¦è€å¸ˆï¼Œå®«æ–—å‰§æŒºä¸Šå¤´å‘€ï¼Ÿâ€', next: 'branchC', img: 'choicebox3.png' }  
            ]
        },
        {
            id: 'branchA',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'è¯¶ï¼Ÿå…¶å®æ ¸å¿ƒæ˜¯...(çœ¼ç›é™¡ç„¶äº®èµ·ï¼Œå‡‘è¿‘è®²è§£ï¼ŒæŒ‡å°–äº®èµ·å¾®å…‰å‹¾å‹’ç»“æ„å›¾ï¼‰è¿ç”¨äº†æŸ”*æ›²ç‡çº¦æŸå’Œ...ä¸å¯¹ï¼Œè¿™ä¹ˆè®²å¯èƒ½æœ‰äº›å¬ä¸æ‡‚...ï¼ˆæ€ç´¢ingï¼‰', 
            charImg: 'qinwu_laugh1.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'mergePoint'
        },
        {
            id: 'branchB',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'å˜¿ï¼æ€€ç–‘ä¸“ä¸šç´ å…»ï¼Ÿï¼ˆå¿½ç„¶æŠ“ä½ä½ æ‰‹è…•ï¼‰ä½ çœ‹ç­¾ç« éƒ½ç›–è¿™å„¿äº†ï¼ç«¥åŸæ— æ¬ºï¼ï¼ˆæ¾å¼€æ‰‹ï¼Œä½¯æ€’ï¼‰ä¸è¿‡çœŸè¦æ”¶åˆ©æ¯...ï¼ˆçœ¼ç¥é£˜å‘è¿œå¤„ç«é”…æ‹›ç‰Œï¼‰å¯å¦è€ƒè™‘è¿½åŠ ä¸€ä»½çˆ†è¾£ç¾é£Ÿï¼Ÿ', 
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'mergePoint'
        },
        {
            id: 'branchC',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'è¿™è¿™è¿™...è¡¥å……ç²¾ç¥é£Ÿç²®ç½¢äº†ï¼é¿å…ç‰©ç†å¤§è„‘åƒµåŒ–ï¼.....å’³ï¼Œæ¯”èµ·è¿™ä¸ªï¼Œè¦ä¸è®¨è®ºè®¨è®ºç¬¬ä¸‰æ„¿çš„äº‹ï¼Ÿâ€ (æœ€åå°å£°è½¬ç§»è¯é¢˜)',
            charImg: 'qinwu_embarrass.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'mergePoint'
        },
        {
            id: 'mergePoint',
            type: 'action',
            speaker: '',
            text: 'ï¼ˆçªç„¶é—´ï¼Œé‚£äº›é‡‘è‰²çš„å…‰ç‚¹å¦‚åŒå½’å·¢èœ‚ç¾¤ï¼Œé£é€Ÿå€’æ¶Œå›ä»–çš„è¢–å£ï¼Œå¸¦èµ·ä¸€é˜µè½»é£ï¼Œè£¹ç€æ·¡æ·¡çš„...é›ªæ¾é¦™å‘³çš„æ°”æ¯è¡å¼€ï¼‰', 
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue5'
        },
        {
            id: 'dialogue5',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: 'é‚£ä¸ª...è¦ä¸è¦è€ƒè™‘æŠŠä¸‰æ„¿åˆ†æœŸä»˜ï¼Ÿï¼ˆæŒ äº†æŒ è„¸é¢Šï¼‰æˆ‘æ˜¯è¯´...æ¯”å¦‚...æŠ½å‡ ç›˜å½“æ•™å­¦ç«èµ›å¥–å“æ¥å…‘ç°ï¼Ÿåˆæˆ–è€…æ˜¯å…¶ä»–ä»€ä¹ˆçš„ï¼Ÿ', 
            charImg: 'qinwu_laugh1.png', 
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue6'
        },
        {
            id: 'dialogue6',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: '(çœ‹ä½ æ„£ç¥ï¼Œå¿½ç„¶ä¼¸æ‰‹è½»æˆ³äº†ä¸€ä¸‹ä½ é¢å¤´)â€œå¥½å•¦ï¼ï¼ˆä»–åƒæ˜¯ç«™ä¸ä½ä¼¼çš„è½»å¿«è·³å¼€ä¸¤æ­¥ï¼Œä»¿ä½›ä¸ºç¦»å¼€é¢„çƒ­ï¼‰å†ä¹±æŒ‰è®¸æ„¿æŒ‰é’®...(ç©ºä¸­å¿½é—ªå¾®èŠ’)å°å¿ƒæˆ‘æ¥è¿™å¤šçœ‹ä½ å‡ çœ¼å“¦ï¼â€ï¼ˆè¿™è¯ä¸€å‡ºå£°éŸ³åŒæ—¶å°äº†ä¸‹å»ï¼Œé¢‡æœ‰äº›æ¬²ç›–å¼¥å½°åœ°å³å°†æ¶ˆå¤±ä¸ºå…‰ç—•ï¼‰', 
            charImg: 'qinwu_laugh3.png',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'action_end'
        },
        {
            id: 'action_end',
            type: 'action',
            speaker: '',
            text: 'ï¼ˆé£˜æ•£çš„å…‰æ²«å¾®å¾®éœ‡åŠ¨ï¼Œä»¿ä½›è£¹æŒŸç€ä¸€å¥éšé£æ¶ˆé€çš„ä½è¯­...ï¼‰',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'dialogue_final'
        },
        {
            id: 'dialogue_final',
            type: 'dialogue',
            speaker: 'ç§¦æ¢§',
            text: '....ç¥ˆæ„¿å¦‚æœæ˜¯è¯•å·æ±‚åŠ©çš„è¯...æŒ‘ç‚¹éš¾çš„ä¹Ÿå¥½..è¿™æ ·å°±å¯ä»¥å¤šèŠ±æ—¶é—´é™ªåœ¨ä½ èº«è¾¹äº†..',
            charImg: '',
            bgLandscape: 'bg_landscape_scene1.png',
            bgPortrait: 'bg_portrait_scene1.png',
            music: 'qinwubgm.mp3',
            next: 'end'
        },
        {
            id: 'end',
            type: 'end',
            music: 'qinwubgm.mp3',
            text: 'æ„¿æœ›ç­¾æ”¶å®Œæ¯•ï¼Œæ—¶ç©ºå›å½’å¯»å¸¸ã€‚'
        }
    ];

    let currentDialogueIndex = 0;
    let isDialogueInProgress = false; // é˜²æ­¢å¿«é€Ÿç‚¹å‡»
    let isGameActive = false; // æ¸¸æˆæ˜¯å¦å¤„äºæ¿€æ´»çŠ¶æ€

    // å­˜å‚¨å¯¹è¯IDåˆ°ç´¢å¼•çš„æ˜ å°„ï¼Œæ–¹ä¾¿é€šè¿‡IDè·³è½¬
    const dialogueMap = new Map();
    textAdventureData.forEach((item, index) => {
        if (item.id) {
            dialogueMap.set(item.id, index);
        }
    });

    // è·å–DOMå…ƒç´ 
    const gameModule = document.getElementById('gameModule');
    const gameBGM = document.getElementById('gameBGM');
    const gameBackground = document.getElementById('gameBackground');
    const gameCharacter = document.getElementById('gameCharacter');
    const gameDialogueBox = document.getElementById('gameDialogueBox');
    const speakerNameElem = document.getElementById('speakerName');
    const dialogueTextElem = document.getElementById('dialogueText');
    const choiceContainer = document.getElementById('choiceContainer');
    const gameMenuButton = document.getElementById('gameMenu');

    // ç›‘å¬å±å¹•æ–¹å‘å˜åŒ–
    window.addEventListener('orientationchange', updateGameBackgroundOrientation);
    window.addEventListener('resize', updateGameBackgroundOrientation); // çª—å£å¤§å°æ”¹å˜ä¹Ÿå¯èƒ½å½±å“åˆ¤æ–­

    function updateGameBackgroundOrientation() {
        // åœ¨æ¸¸æˆæœªæ¿€æ´»æ—¶æˆ–è€…å¯¹è¯æ•°æ®ä¸å­˜åœ¨æ—¶ï¼Œä¸æ›´æ–°èƒŒæ™¯
        if (!isGameActive || currentDialogueIndex >= textAdventureData.length) {
            return;
        }
        
        const currentSceneData = textAdventureData[currentDialogueIndex];
        if (!currentSceneData) {
            return;
        }

        const isPortrait = window.innerHeight > window.innerWidth;

        // ç§»é™¤æ‰€æœ‰èƒŒæ™¯æ–¹å‘ç±»
        gameBackground.classList.remove('landscape', 'portrait');

        // æ ¹æ®å½“å‰æ–¹å‘è®¾ç½®èƒŒæ™¯ç±»å’Œå›¾ç‰‡
        if (isPortrait) {
            gameBackground.classList.add('portrait');
            if (currentSceneData.bgPortrait) {
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgPortrait}')`;
            } else if (currentSceneData.bgLandscape) {
                // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„ç«–å±èƒŒæ™¯ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨æ¨ªå±èƒŒæ™¯
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgLandscape}')`;
            } else {
                // å¦‚æœéƒ½æ²¡æœ‰ï¼Œè®¾ç½®ä¸€ä¸ªé»˜è®¤èƒŒæ™¯æˆ–è€…æ¸…é™¤
                gameBackground.style.backgroundImage = 'none';
            }
        } else { // æ¨ªå±
            gameBackground.classList.add('landscape');
            if (currentSceneData.bgLandscape) {
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgLandscape}')`;
            } else if (currentSceneData.bgPortrait) {
                // å¦‚æœæ²¡æœ‰ä¸“é—¨çš„æ¨ªå±èƒŒæ™¯ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ç«–å±èƒŒæ™¯
                gameBackground.style.backgroundImage = `url('${IMAGE_BASE_PATH}${currentSceneData.bgPortrait}')`;
            } else {
                gameBackground.style.backgroundImage = 'none';
            }
        }
    }

    // æ ¸å¿ƒå‡½æ•° - æ¨è¿›å¯¹è¯
    function advanceDialogue() {
        if (!isGameActive || isDialogueInProgress) return; // æ¸¸æˆæœªæ¿€æ´»æˆ–å¯¹è¯æ­£åœ¨è¿›è¡Œä¸­ï¼Œé˜»æ­¢æ¨è¿›

        const currentSceneData = textAdventureData[currentDialogueIndex];

        if (!currentSceneData) {
            console.warn('Dialogue data not found for index:', currentDialogueIndex);
            endTextAdventure();
            return;
        }

        if (currentSceneData.type === 'choices') {
            // å¦‚æœå½“å‰æ˜¯é€‰é¡¹ï¼Œåˆ™ç‚¹å‡»å±å¹•ä¸æ¨è¿›ï¼Œå¿…é¡»é€‰æ‹©é€‰é¡¹
            return;
        } else if (currentSceneData.type === 'end') {
            endTextAdventure();
            return;
        }

        currentDialogueIndex++;
        displayCurrentScene();
    }

    // æ˜¾ç¤ºå½“å‰åœºæ™¯
    function displayCurrentScene() {
        isDialogueInProgress = true; // è®¾ç½®æ ‡å¿—ï¼Œé˜²æ­¢åœ¨æ–‡æœ¬æ˜¾ç¤ºè¿‡ç¨‹ä¸­å¤šæ¬¡ç‚¹å‡»

        const data = textAdventureData[currentDialogueIndex];
        if (!data) {
            endTextAdventure();
            return;
        }

        // åˆ‡æ¢èƒŒæ™¯éŸ³ä¹ (å¦‚æœåœºæ™¯æœ‰æŒ‡å®šéŸ³ä¹)
        if (data.music) {
            const newMusicSrc = SOUND_BASE_PATH + data.music;
            if (gameBGM.src !== newMusicSrc) { // é¿å…é‡å¤è®¾ç½®å’ŒåŠ è½½
                gameBGM.src = newMusicSrc;
                gameBGM.play().catch(e => console.error("Game BGM play error:", e));
            } else if (gameBGM.paused) { // å¦‚æœéŸ³ä¹ç›¸åŒä½†å·²æš‚åœï¼Œåˆ™ç»§ç»­æ’­æ”¾
                gameBGM.play().catch(e => console.error("Game BGM resume error:", e));
            }
        } else {
            // å¦‚æœå½“å‰åœºæ™¯æ²¡æœ‰æŒ‡å®šéŸ³ä¹ï¼Œå¹¶ä¸”éŸ³ä¹æ­£åœ¨æ’­æ”¾ï¼Œåˆ™æš‚åœ
            if (!gameBGM.paused) {
                gameBGM.pause();
            }
        }

        // æ›´æ–°èƒŒæ™¯å›¾ç‰‡
        updateGameBackgroundOrientation(); // æ ¹æ®å½“å‰åœºæ™¯çš„æ•°æ®å’Œå±å¹•æ–¹å‘æ›´æ–°èƒŒæ™¯

        // éšè—äººç‰©å’Œé€‰æ‹©ï¼Œæ˜¾ç¤ºå¯¹è¯æ¡†
        gameCharacter.style.opacity = '0'; // å…ˆéšè—
        choiceContainer.innerHTML = ''; // æ¸…ç©ºé€‰é¡¹
        choiceContainer.style.display = 'none';
        gameDialogueBox.style.display = 'flex'; // é‡æ–°æ˜¾ç¤ºå¯¹è¯æ¡†

        // æ˜¾ç¤ºäººç‰©å›¾ç‰‡
        if (data.charImg) { // æ³¨æ„ï¼šç°åœ¨ charImg ä¸ºç©ºå­—ç¬¦ä¸²æ—¶ä¼šæ­£ç¡®è¿›å…¥ else
            gameCharacter.src = IMAGE_BASE_PATH + data.charImg;
            gameCharacter.style.opacity = '1'; // é€æ¸æ˜¾ç¤º
        } else {
            gameCharacter.src = ''; // æ¸…ç©ºsrcï¼Œé˜²æ­¢æ˜¾ç¤ºæ—§å›¾
            gameCharacter.style.opacity = '0'; // ç¡®ä¿éšè—
        }

        // æ›´æ–°è¯´è¯è€…åå­—å’Œå¯¹è¯æ–‡æœ¬
        speakerNameElem.textContent = data.speaker || ''; // å¦‚æœspeakerä¸ºç©ºï¼Œåˆ™ä¸æ˜¾ç¤º
        dialogueTextElem.textContent = ''; // å…ˆæ¸…ç©ºæ–‡æœ¬ï¼Œå‡†å¤‡æ‰“å­—æ•ˆæœ

        // å®ç°æ‰“å­—æ•ˆæœ
        let textIndex = 0;
        const typingSpeed = 50; // æ¯å­—ç¬¦50æ¯«ç§’

        const typeText = () => {
            if (textIndex < data.text.length) {
                dialogueTextElem.textContent += data.text.charAt(textIndex);
                textIndex++;
                setTimeout(typeText, typingSpeed);
            } else {
                isDialogueInProgress = false; // æ‰“å­—å®Œæˆï¼Œå…è®¸æ¨è¿›
                // å¦‚æœæ˜¯é€‰é¡¹ç±»å‹ï¼Œæ˜¾ç¤ºé€‰é¡¹
                if (data.type === 'choices') {
                    displayChoices(data.options);
                }
            }
        };
        typeText();
    }

    // æ˜¾ç¤ºé€‰é¡¹
    function displayChoices(options) {
        gameDialogueBox.style.display = 'none'; // éšè—å¯¹è¯æ¡†
        gameCharacter.style.opacity = '0'; // é€‰é¡¹æ—¶äººç‰©ä¹Ÿéšè—
        choiceContainer.style.display = 'flex'; // æ˜¾ç¤ºé€‰é¡¹å®¹å™¨
        choiceContainer.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

        options.forEach((option, index) => {
            const choiceBtn = document.createElement('div');
            choiceBtn.className = 'choice-button';
            choiceBtn.textContent = option.text;
            choiceBtn.style.backgroundImage = `url('${IMAGE_BASE_PATH}${option.img}')`; // é€‰é¡¹èƒŒæ™¯å›¾
            choiceBtn.onclick = (e) => {
                e.stopPropagation(); // é˜»æ­¢ç‚¹å‡»äº‹ä»¶å†’æ³¡åˆ° gameModule
                handleChoice(option.next);
            };
            choiceContainer.appendChild(choiceBtn);
        });

        isDialogueInProgress = false; // é€‰é¡¹æ˜¾ç¤ºå®Œæ¯•ï¼Œå¯ä»¥è¿›è¡Œé€‰æ‹©äº†
    }

    // å¤„ç†é€‰é¡¹é€‰æ‹©
    function handleChoice(nextId) {
        const nextIndex = dialogueMap.get(nextId);
        if (nextIndex !== undefined) {
            currentDialogueIndex = nextIndex;
            displayCurrentScene();
        } else {
            console.error('Invalid nextId for choice:', nextId);
            endTextAdventure(); // é”™è¯¯å¤„ç†ï¼Œç»“æŸæ¸¸æˆ
        }
    }

    // å¯åŠ¨æ–‡å­—å†’é™©æ¸¸æˆ
    function startTextAdventure() {
        // æš‚åœä¸»é¡µèƒŒæ™¯éŸ³ä¹
        document.getElementById('backgroundMusic').pause();
        musicPlaying = false; // æ›´æ–°ä¸»é¡µéŸ³ä¹çŠ¶æ€
        document.getElementById('musicPlayer').classList.remove('playing');
        document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">ğŸ”‡</span>';


        gameModule.style.display = 'block'; // æ˜¾ç¤ºæ¸¸æˆæ¨¡å—
        gameModule.style.opacity = '0'; // ä»é€æ˜å¼€å§‹
        setTimeout(() => {
            gameModule.style.opacity = '1'; // æ·¡å…¥
        }, 50); // å°å»¶è¿Ÿç¡®ä¿displayç”Ÿæ•ˆåå¼€å§‹åŠ¨ç”»

        isGameActive = true;
        currentDialogueIndex = dialogueMap.get('intro_action'); // ä»è®¾å®šçš„ç¬¬ä¸€é¡¹å¼€å§‹
        displayCurrentScene(); // æ˜¾ç¤ºç¬¬ä¸€åœºæ™¯

        // ç»‘å®šç‚¹å‡»äº‹ä»¶ï¼Œç”¨äºæ¨è¿›å¯¹è¯
        gameModule.onclick = advanceDialogue;

        // èœå•æŒ‰é’®äº‹ä»¶ (ç¤ºä¾‹ï¼šé€€å‡ºæ¸¸æˆ)
        gameMenuButton.onclick = (e) => {
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°æ¸¸æˆæ¨¡å—ï¼Œé¿å…è§¦å‘ advanceDialogue
            if (confirm('ç¡®å®šè¦é€€å‡ºæ¸¸æˆå—ï¼Ÿ')) {
                endTextAdventure();
            }
        };

        // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
        document.body.style.overflow = 'hidden';
    }

    // ç»“æŸæ–‡å­—å†’é™©æ¸¸æˆ
    function endTextAdventure() {
        isGameActive = false;
        gameModule.style.opacity = '0'; // æ·¡å‡ºåŠ¨ç”»
        setTimeout(() => {
            gameModule.style.display = 'none';
            // æ¢å¤ä¸»é¡µèƒŒæ™¯éŸ³ä¹ (å¦‚æœä¹‹å‰åœ¨æ’­æ”¾)
            if (document.getElementById('backgroundMusic').paused) { // é¿å…é‡å¤æ’­æ”¾
                 document.getElementById('backgroundMusic').play().then(() => {
                    musicPlaying = true;
                    document.getElementById('musicPlayer').classList.add('playing');
                    document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">ğŸµ</span>';
                }).catch(e => console.warn("Main BGM resume error:", e));
            }
            document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
        }, 500); // ç­‰å¾…æ·¡å‡ºåŠ¨ç”»å®Œæˆ
        gameBGM.pause(); // æš‚åœæ¸¸æˆéŸ³ä¹
        gameBGM.currentTime = 0; // é‡ç½®æ¸¸æˆéŸ³ä¹æ’­æ”¾è¿›åº¦

        gameModule.onclick = null; // è§£ç»‘äº‹ä»¶
        gameMenuButton.onclick = null; // è§£ç»‘èœå•äº‹ä»¶
    }

    /* ==================================== */
    /* å•äººç‰©å¯¹è¯æ¨¡å—é€»è¾‘ */
    /* ==================================== */
    const singleCharacterPopup = document.getElementById('singleCharacterPopup');
    const popupCharImage = document.getElementById('popupCharImage');
    const popupCharText = document.getElementById('popupCharText');
    const popupCharVoice = document.getElementById('popupCharVoice');

    function showSingleCharacterPopup() {
    // æš‚åœä¸»é¡µèƒŒæ™¯éŸ³ä¹
    document.getElementById('backgroundMusic').pause();
    musicPlaying = false;
    document.getElementById('musicPlayer').classList.remove('playing');
    document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">ğŸ”‡</span>';

    // è·å–DOMå…ƒç´ 
    const gifContainer = document.getElementById('ljhGifContainer');
    const gif = document.getElementById('ljhGif');
    const charImage = document.getElementById('popupCharImage');
    
    // é‡ç½®çŠ¶æ€
    gifContainer.classList.add('visible');
    charImage.classList.add('hidden');
    
    // è®¾ç½®æ–‡æœ¬å’Œè¯­éŸ³
    const charText = 'â€œç¥å…¨ä¸–ç•Œæœ€æœ€å¯çˆ±çš„ä½ ï¼Œç”Ÿæ—¥å¿«ä¹!~ å§å§çš„æ„¿æœ›å•Šâ€¦â€¦æ—©å°±è¢«æˆ‘çš„ç”»ç¬”å·å·è—è¿›æ˜Ÿç©ºé‡Œäº†å•¦ï¼æ„¿ä½ çš„æ¯ä¸ªæœŸå¾…éƒ½åƒæœªå¹²çš„æ²¹ç”»ï¼Œè¢«æ—¶å…‰é•€ä¸Šæ›´ç»šçƒ‚çš„é‡‰å½©â€”â€”è€Œæˆ‘ï¼Œæ°¸è¿œä¼šæ˜¯æ‰˜ä½ä½ æ‰€æœ‰æ˜Ÿè¾°çš„é‚£ç‰‡å¤œå¹•ã€‚è¿™æ ·è´ªå¿ƒçš„å®ˆæŠ¤ï¼Œå§å§å¯ä¸å‡†æ‹’ç»å‘¢ï½â€';
    document.getElementById('popupCharText').textContent = charText;
    
    const charVoice = document.getElementById('popupCharVoice');
    charVoice.src = 'https://vacuopolis.netlify.app/audio/å°é™†çš„ç”Ÿæ—¥ç¥ç¦.mp3';

    // æ˜¾ç¤ºå¼¹çª—
    singleCharacterPopup.style.display = 'flex';
    singleCharacterPopup.style.opacity = '0';
    setTimeout(() => {
        singleCharacterPopup.style.opacity = '1';
    }, 50);

    // GIFæ’­æ”¾å®Œæˆååˆ‡æ¢åˆ°é™æ€å›¾ç‰‡
    setTimeout(() => {
        gifContainer.classList.remove('visible');
        charImage.classList.remove('hidden');
        
        // æ’­æ”¾è¯­éŸ³
        charVoice.play().catch(e => console.error("Popup voice play error:", e));
    }, 4000); 

    // é˜»æ­¢èƒŒæ™¯æ»šåŠ¨
    document.body.style.overflow = 'hidden';
}

    function closeSingleCharacterPopup() {
    // é‡ç½®GIFå’Œå›¾ç‰‡çŠ¶æ€
    document.getElementById('ljhGifContainer').classList.remove('visible');
    document.getElementById('popupCharImage').classList.add('hidden');
    
    // å…¶ä½™å…³é—­é€»è¾‘
    singleCharacterPopup.style.opacity = '0';
    setTimeout(() => {
        singleCharacterPopup.style.display = 'none';
    }, 500);

    document.getElementById('popupCharVoice').pause();
    document.getElementById('popupCharVoice').currentTime = 0;

    // æ¢å¤ä¸»é¡µèƒŒæ™¯éŸ³ä¹
    if (document.getElementById('backgroundMusic').paused) {
        document.getElementById('backgroundMusic').play().then(() => {
            musicPlaying = true;
            document.getElementById('musicPlayer').classList.add('playing');
            document.getElementById('musicPlayer').innerHTML = '<span style="font-size: 1.5em;">ğŸµ</span>';
        }).catch(e => console.warn("ä¸»BGMæ¢å¤é”™è¯¯:", e));
    }
    
    document.body.style.overflow = '';
}
    
    /* å›¾ç‰‡æŸ¥çœ‹å™¨æ¨¡å—é€»è¾‘ */
/* ==================================== */
const photoViewerOverlay = document.getElementById('photoViewerOverlay');
const photoViewerImg = document.getElementById('photoViewerImg');
const photoViewerContent = document.getElementById('photoViewerContent');

let scale = 1,
    panning = false,
    pointX = 0,
    pointY = 0,
    start = { x: 0, y: 0 };

function setTransform() {
    // æ”¾å¤§åé™åˆ¶å›¾ç‰‡æ‹–åŠ¨èŒƒå›´ï¼Œé˜²æ­¢æ‹–å‡ºè§†å£å¤ªè¿œ
    if (scale > 1) {
        const imgRect = photoViewerImg.getBoundingClientRect();
        const contentRect = photoViewerContent.getBoundingClientRect();
        const max_x = Math.abs(imgRect.width - contentRect.width) / 2;
        const max_y = Math.abs(imgRect.height - contentRect.height) / 2;
        pointX = Math.max(-max_x, Math.min(max_x, pointX));
        pointY = Math.max(-max_y, Math.min(max_y, pointY));
    } else {
        // ç¼©å°æ—¶ä¸å…è®¸æ‹–åŠ¨ï¼Œä½ç½®å½’é›¶
        pointX = 0;
        pointY = 0;
    }
    photoViewerImg.style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`;
}

function openPhotoViewer(imageUrl) {
    photoViewerImg.src = imageUrl;
    photoViewerOverlay.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // ç¦æ­¢èƒŒæ™¯æ»šåŠ¨

    resetPhotoViewer();

    // å»¶è¿Ÿæ·»åŠ äº‹ä»¶ç›‘å¬å™¨ï¼Œç¡®ä¿å…ƒç´ å·²æ¸²æŸ“
    setTimeout(() => {
        photoViewerContent.addEventListener('mousedown', onPointerDown);
        photoViewerContent.addEventListener('mouseup', onPointerUp);
        photoViewerContent.addEventListener('mouseleave', onPointerUp);
        photoViewerContent.addEventListener('mousemove', onPointerMove);
        photoViewerContent.addEventListener('wheel', onWheel);
        photoViewerContent.addEventListener('dblclick', onDoubleClick);
    }, 0);
}

function closePhotoViewer(event) {
    // å¦‚æœç‚¹å‡»äº†å…³é—­æŒ‰é’®(æˆ–å…¶ä»–å­å…ƒç´ )ï¼Œé˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°çˆ¶å…ƒç´ overlay
    if (event) {
        event.stopPropagation();
    }
    
    photoViewerOverlay.style.display = 'none';
    document.body.style.overflow = ''; // æ¢å¤èƒŒæ™¯æ»šåŠ¨
    photoViewerImg.src = ''; // æ¸…ç©ºå›¾ç‰‡ï¼Œé‡Šæ”¾å†…å­˜

    // ç§»é™¤äº‹ä»¶ç›‘å¬å™¨
    photoViewerContent.removeEventListener('mousedown', onPointerDown);
    photoViewerContent.removeEventListener('mouseup', onPointerUp);
    photoViewerContent.removeEventListener('mouseleave', onPointerUp);
    photoViewerContent.removeEventListener('mousemove', onPointerMove);
    photoViewerContent.removeEventListener('wheel', onWheel);
    photoViewerContent.removeEventListener('dblclick', onDoubleClick);
}

function resetPhotoViewer() {
    scale = 1;
    panning = false;
    pointX = 0;
    pointY = 0;
    start = { x: 0, y: 0 };
    photoViewerImg.style.transition = 'transform 0.2s ease-out'; // æ¢å¤å¹³æ»‘è¿‡æ¸¡
    setTransform();
}

function onPointerDown(e) {
    e.preventDefault();
    if (scale <= 1) return; // åªæœ‰æ”¾å¤§æ—¶æ‰èƒ½æ‹–åŠ¨
    start.x = e.clientX - pointX;
    start.y = e.clientY - pointY;
    panning = true;
    photoViewerImg.classList.add('panning');
    photoViewerImg.style.transition = 'none'; // æ‹–åŠ¨æ—¶ç§»é™¤è¿‡æ¸¡æ•ˆæœä»¥è·å¾—æ›´æµç•…çš„ä½“éªŒ
}

function onPointerUp(e) {
    panning = false;
    photoViewerImg.classList.remove('panning');
    photoViewerImg.style.transition = 'transform 0.2s ease-out';
}

function onPointerMove(e) {
    e.preventDefault();
    if (!panning) return;
    pointX = e.clientX - start.x;
    pointY = e.clientY - start.y;
    setTransform();
}

function onWheel(e) {
    e.preventDefault();
    const rect = photoViewerContent.getBoundingClientRect();
    const xs = (e.clientX - rect.left - pointX) / scale;
    const ys = (e.clientY - rect.top - pointY) / scale;
    const delta = -e.deltaY;

    const zoomFactor = 1.2;
    if (delta > 0) {
        scale *= zoomFactor;
    } else {
        scale /= zoomFactor;
    }
    
    // é™åˆ¶æœ€å°ç¼©æ”¾ä¸º1å€ï¼ˆåŸå§‹å¤§å°ï¼‰ï¼Œæœ€å¤§ä¸º10å€
    scale = Math.max(1, Math.min(scale, 10));

    pointX = e.clientX - rect.left - xs * scale;
    pointY = e.clientY - rect.top - ys * scale;
    setTransform();
}

function onDoubleClick(e) {
    e.preventDefault();
    if (scale > 1) {
        // å¦‚æœå·²æ”¾å¤§ï¼Œåˆ™æ¢å¤
        resetPhotoViewer();
    } else {
        // å¦‚æœæ˜¯åŸå¤§å°ï¼Œåˆ™æ”¾å¤§åˆ°2.5å€
        const rect = photoViewerContent.getBoundingClientRect();
        scale = 2.5;
        // æ”¾å¤§åˆ°é¼ æ ‡åŒå‡»çš„ä½ç½®
        pointX = -(e.clientX - rect.left - rect.width / 2) * (scale - 1);
        pointY = -(e.clientY - rect.top - rect.height / 2) * (scale - 1);
        setTransform();
    }
}

    </script>
</body>
</html>