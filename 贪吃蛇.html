<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ç»ˆæè´ªåƒè›‡</title>
    <style>
        * {
    margin: 0;
padding: 0;
box-sizing: border-box;
}
body {
background: linear-gradient(135deg, #1a1a2e, #16213e);
color: white;
font-family: 'Arial', sans-serif;
display: flex;
flex-direction: column;
align-items: center;
justify-content: center;
height: 100vh;
overflow: hidden;
touch-action: manipulation;
}
#game-container {
position: relative;
width: 90vmin;
height: 90vmin;
max-width: 600px;
max-height: 600px;
box-shadow: 0 0 20px rgba(0, 255, 150, 0.2);
border-radius: 8px;
overflow: visible;
perspective: 1000px;
margin-bottom: 20px;
}

#game-canvas {
background: #0f0f23;
width: 100%;
height: 100%;
display: block;
transition: transform 0.3s ease;
}

/* æ¸¸æˆUIå…ƒç´  */
#score-container {
position: absolute;
top: 10px;
left: 10px;
font-size: 18px;
background: rgba(0, 0, 0, 0.6);
padding: 8px 12px;
border-radius: 20px;
display: flex;
gap: 20px;
z-index: 10;
}

#high-score {
color: #ffd700;
}
#status-display {
position: absolute;
top: 10px;
right: 10px;
background: rgba(0, 0, 0, 0.6);
padding: 8px 12px;
border-radius: 20px;
font-size: 16px;
z-index: 10;
display: flex;
flex-direction: column;
gap: 5px;
align-items: flex-end;
}
#food-info {
position: absolute;
top: calc(100% + 10px);
left: 10px;
background: rgba(0, 0, 0, 0.6);
padding: 8px 12px;
border-radius: 20px;
font-size: 16px;
opacity: 0;
transition: opacity 0.3s;
z-index: 10;
}
#food-info.show {
opacity: 1;
}
#power-up-indicator {
position: absolute;
top: calc(100% + 10px);
right: 10px;
background: rgba(0, 0, 0, 0.6);
padding: 8px 12px;
border-radius: 20px;
font-size: 16px;
opacity: 0;
transition: opacity 0.3s;
z-index: 10;
}
#power-up-indicator.show {
opacity: 1;
}
/* æ§åˆ¶æŒ‰é’® */
#controls {
display: grid;
grid-template-columns: repeat(3, 1fr);
grid-template-rows: repeat(3, 1fr);
gap: 10px;
width: 200px;
height: 200px;
max-width: 60vmin;
max-height: 60vmin;
}
.control-btn {
background: rgba(255, 255, 255, 0.15);
border: 2px solid rgba(255, 255, 255, 0.3);
border-radius: 50%;
display: flex;
justify-content: center;
align-items: center;
font-size: 24px;
color: white;
cursor: pointer;
user-select: none;
touch-action: manipulation;
transition: transform 0.1s, background 0.2s;
}
.control-btn:active {
background: rgba(0, 255, 150, 0.3);
transform: scale(1.1);
}
#up-btn {
grid-column: 2;
grid-row: 1;
}
#left-btn {
grid-column: 1;
grid-row: 2;
}
#right-btn {
grid-column: 3;
grid-row: 2;
}
#down-btn {
grid-column: 2;
grid-row: 3;
}
/* èœå•å’Œå¯¹è¯æ¡† */
.overlay {
position: absolute;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.85);
display: flex;
flex-direction: column;
justify-content: center;
align-items: center;
z-index: 20;
text-align: center;
padding: 20px;
}
.dialog {
background: rgba(20, 30, 50, 0.95);
border-radius: 10px;
padding: 20px;
width: 80%;
max-width: 400px;
box-shadow: 0 0 20px rgba(0, 255, 150, 0.2);
border: 1px solid rgba(0, 255, 150, 0.3);
}
.dialog h2 {
margin-bottom: 15px;
color: #00ff96;
}
.btn {
background: linear-gradient(135deg, #00b894, #00cec9);
color: white;
border: none;
padding: 10px 20px;
margin: 8px;
border-radius: 5px;
font-size: 16px;
cursor: pointer;
transition: transform 0.1s, filter 0.2s;
}
.btn:hover {
filter: brightness(1.1);
}
.btn:active {
transform: scale(0.97);
}
.btn.secondary {
background: linear-gradient(135deg, #636e72, #b2bec3);
}
.btn.pause {
position: absolute;
top: 10px;
right: 10px;
background: rgba(0, 0, 0, 0.6);
color: white;
padding: 8px;
font-size: 14px;
z-index: 10;
}
/* è®¾ç½®é¢æ¿ */
.settings-group {
margin: 15px 0;
text-align: left;
}
.settings-group h3 {
margin-bottom: 10px;
color: #00ff96;
}
.slider-container {
display: flex;
align-items: center;
margin: 10px 0;
}
.slider-container label {
flex: 1;
}
.slider-container input {
flex: 2;
}
.checkbox-container {
display: flex;
align-items: center;
margin: 10px 0;
}
.checkbox-container label {
flex: 1;
margin-left: 10px;
}
/* åŠ¨ç”»æ•ˆæœ */
.score-popup {
position: absolute;
font-size: 20px;
font-weight: bold;
pointer-events: none;
z-index: 15;
text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
animation: score-popup 0.8s ease-out forwards;
}

@keyframes score-popup {
0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
50% { transform: translate(-50%, -20px) scale(1.2); opacity: 1; }
100% { transform: translate(-50%, -40px) scale(1); opacity: 0; }
}

.combo-popup {
position: absolute;
font-size: 24px;
font-weight: bold;
pointer-events: none;
z-index: 15;
text-shadow: 0 0 5px rgba(0, 0, 0, 0.7);
animation: combo-popup 1s ease-out forwards;
}
@keyframes combo-popup {
0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
20% { transform: translate(-50%, -30px) scale(1.5); opacity: 1; }
80% { transform: translate(-50%, -60px) scale(1.2); opacity: 0.8; }
100% { transform: translate(-50%,
-80px) scale(1); opacity: 0; }
}

/* æ¸¸æˆå¼€å§‹å‰çš„3Dæ•ˆæœ */
.rotate-effect {
animation: rotate-canvas 15s infinite linear;
transform-style: preserve-3d;
}

@keyframes rotate-canvas {
0% { transform: rotateX(5deg) rotateY(0); }
50% { transform: rotateX(5deg) rotateY(5deg); }
100% { transform: rotateX(5deg) rotateY(0); }
}
/* å¤šäººæ¸¸æˆUIæ ·å¼ */
.input-group {
margin: 15px 0;
display: flex;
flex-direction: column;
}

.input-group label {
margin-bottom: 5px;
}

.input-group input {
padding: 10px;
border-radius: 5px;
border: 1px solid #444;
background: rgba(0, 0, 0, 0.2);
color: white;
}
.player-list {
margin: 15px 0;
text-align: left;
max-height: 200px;
overflow-y: auto;
}

.player-list ul {
list-style: none;
padding: 0;
}

.player-list li {
padding: 5px 10px;
margin: 5px 0;
background: rgba(0, 0, 0, 0.2);
border-radius: 5px;
display: flex;
justify-content: space-between;
align-items: center;
}
.player-list .current-player {
font-weight: bold;
border-left: 3px solid #00ff96;
padding-left: 8px;
}
.host-indicator {
color: #ffcc00;
margin-left: 5px;
}
.player-list .host {
font-weight: bold;
color: #00ff96;
}
/* ç©å®¶åˆ†æ•°æ ·å¼ - ä¿®æ”¹åçš„ä»£ç  */
.player-scores {
position: fixed;
top: 0;
left: 0;
right: 0;
background: rgba(0, 0, 0, 0.7);
padding: 10px;
max-height: 30vh;
overflow-y: auto;
z-index: 100;
display: flex;
flex-wrap: wrap;
justify-content: center;
transform: translateY(-100%);
transition: transform 0.3s ease;
}

.player-scores.show {
transform: translateY(0);
}

.player-score {
margin: 3px 5px;
padding: 3px 8px;
border-radius: 10px;
background: rgba(0, 0, 0, 0.5);
white-space: nowrap;
}

.player-scores .current-player {
font-weight: bold;
border-left: 3px solid #00ff96;
padding-left: 5px;
}

/* èŠå¤©åŠŸèƒ½ - ä¿®æ”¹åçš„ä»£ç  */
#multiplayer-chat {
position: fixed;
bottom: 0;
left: 0;
right: 0;
width: 100%;
height: 30vh;
max-height: 30vh;
background: rgba(0, 0, 0, 0.85);
border-radius: 10px 10px 0 0;
z-index: 100;
display: flex;
flex-direction: column;
transform: translateY(100%);
transition: transform 0.3s ease;
pointer-events: auto;
}

#multiplayer-chat.show {
transform: translateY(0);
}

.chat-handle {
position: absolute;
top: -25px;
left: 50%;
transform: translateX(-50%);
width: 50px;
height: 5px;
background: rgba(255, 255, 255, 0.5);
border-radius: 5px;
cursor: pointer;
}

.chat-messages {
flex: 1;
height: calc(100% - 50px);
overflow-y: auto;
padding: 10px;
font-size: 14px;
pointer-events: none;
}

.chat-input {
display: flex;
pointer-events: auto;
padding: 10px;
border-top: 1px solid rgba(255, 255, 255, 0.2);
}

.chat-input input {
flex: 1;
padding: 8px;
border-radius: 3px;
border: none;
background: rgba(255, 255, 255, 0.1);
color: white;
}

.chat-input button {
    margin-left: 5px;
    padding: 8px;
    background: linear-gradient(135deg, #00b894, #00cec9);
    color: white;
    border: none;
    border-radius: 5px;
    font-size: 18px;
    cursor: pointer;
}

/* å¤æ´»å€’è®¡æ—¶æ¶ˆæ¯æ ·å¼ */
.respawn-message {
  animation: pulse 1.5s infinite;
  pointer-events: none;
  text-align: center;
  z-index: 999;
}

/* æ­»äº¡æ—¶çš„è§†è§‰æ•ˆæœ */
.death-flash {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(255, 0, 0, 0.3);
  animation: death-flash 0.5s ease-out;
  pointer-events: none;
  z-index: 50;
}

@keyframes death-flash {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* å¤æ´»æ—¶çš„è§†è§‰æ•ˆæœ */
.respawn-flash {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 255, 0, 0.3);
  animation: respawn-flash 0.8s ease-out;
  pointer-events: none;
  z-index: 50;
}

@keyframes respawn-flash {
  0% { opacity: 1; }
  100% { opacity: 0; }
}

/* çŠ¶æ€å›¾æ ‡æ ·å¼ */
.status-icon {
  display: inline-block;
  margin-right: 5px;
  font-size: 1.2em;
  vertical-align: middle;
}

/* å¤æ´»ä¸­çŠ¶æ€ç‰¹æ•ˆ */
.respawning {
  animation: respawning-pulse 1s infinite alternate;
}

@keyframes respawning-pulse {
  0% { opacity: 0.6; }
  100% { opacity: 1; }
}

@keyframes pulse {
  0% { transform: translate(-50%, -50%) scale(1); }
  50% { transform: translate(-50%, -50%) scale(1.1); }
  100% { transform: translate(-50%, -50%) scale(1); }
}

/* ç”Ÿå‘½å€¼æ˜¾ç¤ºæ ·å¼ */
.player-score .lives-count {
  margin-left: 5px;
  color: #ff4081;
}


/* æ¸¸æˆå¤§å…æ ·å¼ */
.game-info {
background: rgba(0, 0, 0, 0.3);
padding: 10px;
border-radius: 5px;
margin-bottom: 15px;
text-align: center;
}

#lobby-game-id {
font-weight: bold;
color: #00ff96;
font-size: 24px;
letter-spacing: 2px;
}

.share-tip {
font-size: 14px;
opacity: 0.8;
margin-top: 5px;
}

.player-list-container {
background: rgba(0, 0, 0, 0.2);
padding: 10px;
border-radius: 5px;
margin-bottom: 15px;
max-height: 200px;
overflow-y: auto;
}

/* æ¸¸æˆè®¾ç½®é¢æ¿æ ·å¼ */
.game-settings {
background: rgba(0, 0, 0, 0.2);
padding: 10px;
border-radius: 5px;
margin-bottom: 15px;
max-height: 200px;
overflow-y: auto;
}

.settings-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 10px;
cursor: pointer;
}

.settings-header h3 {
margin: 0;
color: #00ff96;
}

.toggle-icon {
font-size: 18px;
transition: transform 0.3s ease;
}
.toggle-icon.open {
transform: rotate(180deg);
}

.settings-content {
overflow: hidden;
max-height: 0;
transition: max-height 0.5s ease-out, opacity 0.3s ease-in;
opacity: 0;
}

.settings-content.open {
max-height: 500px;
opacity: 1;
}

.setting-item {
margin: 8px 0;
display: flex;
justify-content: space-between;
align-items: center;
}

.setting-item label {
flex: 1;
margin-right: 10px;
}

.setting-item input {
width: 60px;
padding: 5px;
background: rgba(0, 0, 0, 0.3);
border: 1px solid #444;
border-radius: 3px;
color: white;
}

.setting-item input[type="range"] {
width: 100px;
}

.setting-item select {
padding: 5px;
background: rgba(0, 0, 0, 0.3);
border: 1px solid #444;
border-radius: 3px;
color: white;
}

.host-only {
display: none;
}

.host-only.show {
display: block;
}

/* ç§»åŠ¨è®¾å¤‡å“åº”å¼å¸ƒå±€ */
@media (max-width: 768px) {
#game-container {
width: 95vmin;
height: 95vmin;
margin-bottom: 10px;
}
#controls {
    width: 180px;
    height: 180px;
    margin-top: 10px;
}

/* é£Ÿç‰©ä¿¡æ¯å’Œèƒ½åŠ›æç¤ºè°ƒæ•´ */
#food-info, #power-up-indicator {
    font-size: 12px;
    padding: 5px 8px;
}


/* é‡ç”ŸæŒ‰é’®è°ƒæ•´ */
#respawn-btn {
    bottom: auto;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 999;
    padding: 10px 20px;
    font-size: 16px;
}

/* ç§»åŠ¨è®¾å¤‡ä¸Šæš‚åœæŒ‰é’®è°ƒæ•´ */
.btn.pause {
    padding: 5px;
    font-size: 12px;
}

/* ç§»åŠ¨è®¾å¤‡ä¸Šçš„å¯¹è¯æ¡†è°ƒæ•´ */
.dialog {
    width: 90%;
    padding: 15px;
}

.dialog h2 {
    font-size: 18px;
}

.btn {
    padding: 8px 15px;
    font-size: 14px;
    margin: 5px;
}

/* å¤šäººæ¸¸æˆUIåœ¨ç§»åŠ¨ç«¯çš„è°ƒæ•´ */
.toggle-scores-btn, .toggle-chat-btn {
    font-size: 24px;
    padding: 8px 12px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* ç©å®¶åˆ†æ•°åœ¨ç§»åŠ¨ç«¯çš„æ ·å¼ */
.player-score {
    font-size: 12px;
    padding: 2px 6px;
    margin: 2px 3px;
}

/* æ·»åŠ åˆ°ç°æœ‰CSS */
#joystick-container {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    width: 150px;
    height: 150px;
    z-index: 15;
}

#joystick-base {
    position: relative;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.4);
    border-radius: 50%;
}

#joystick-stick {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 50px;
    height: 50px;
    background: rgba(0, 255, 150, 0.6);
    border-radius: 50%;
    cursor: pointer;
    user-select: none;
    touch-action: none;
}

.joystick-left {
    left: 20px;
    transform: translateX(0);
}

.joystick-right {
    left: auto;
    right: 20px;
    transform: translateX(0);
}

.key-binding-container {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.key-binding {
    display: flex;
    align-items: center;
    gap: 8px;
}

.key-binding label {
    width: 60px;
}

.key-binding input {
    flex: 1;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    border: 1px solid #444;
    border-radius: 4px;
    padding: 5px;
    cursor: pointer;
}

.key-binding .reset-key {
    padding: 3px 8px;
    background: rgba(100, 100, 100, 0.4);
    border: 1px solid #555;
    border-radius: 3px;
    color: white;
    cursor: pointer;
}

.radio-container {
    display: flex;
    gap: 15px;
    margin-bottom: 10px;
}

.radio-container input[type="radio"] {
    margin-right: 5px;
}

.select-container {
    display: flex;
    align-items: center;
    margin: 10px 0;
}

.select-container label {
    flex: 1;
}

.select-container select {
    flex: 2;
    padding: 5px;
    background: rgba(0, 0, 0, 0.3);
    color: white;
    border: 1px solid #444;
    border-radius: 4px;
}

/* æ·»åŠ å¤šäººæ¸¸æˆæ§åˆ¶æŒ‰é’®æ ·å¼ */
#multiplayer-controls {
    position: fixed;
    bottom: 20px;
    right: 20px;
    display: flex;
    flex-direction: row;
    gap: 10px;
    z-index: 101;
    display: none;  /* é»˜è®¤éšè— */
}

.toggle-scores-btn, .toggle-chat-btn {
    font-size: 24px;
    padding: 8px 12px;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0, 0, 0, 0.6);
    color: white;
    border: 2px solid rgba(255, 255, 255, 0.3);
    cursor: pointer;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    transition: all 0.2s ease;
}

.toggle-scores-btn:hover, .toggle-chat-btn:hover {
    background: rgba(0, 255, 150, 0.3);
    transform: scale(1.1);
}

/* é€šçŸ¥æ ·å¼ */
#notification-container {
    pointer-events: none; /* ç¡®ä¿ä¸æ‹¦æˆªæŒ‰é’®ç‚¹å‡» */
}

.system-notification {
    background: rgba(0, 0, 0, 0.7);
    color: white;
    padding: 8px 15px;
    border-radius: 20px;
    margin: 5px;
    max-width: 80%;
    text-align: center;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
    pointer-events: none;
}

/* å¤šäººæ¸¸æˆæš‚åœèœå•ç‰¹æ®Šæ ·å¼ */
.pause-menu-multiplayer h2 {
    color: #4CAF50;
}

.pause-menu-multiplayer .btn {
    background: linear-gradient(135deg, #4CAF50, #45a049);
}

.setting-description {
    font-size: 12px;
    color: rgba(255, 255, 255, 0.7);
    margin-top: 5px;
    margin-bottom: 10px;
    padding-left: 10px;
    border-left: 2px solid rgba(0, 255, 150, 0.5);
}

.mode-info-btn {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    font-size: 14px;
    font-weight: bold;
    margin-left: 8px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #00b894, #00cec9);
    border: none;
    cursor: pointer;
    color: white;
    padding: 0;
    box-shadow: 0 0 5px rgba(0, 255, 150, 0.5);
    z-index: 5;
}

.mode-info-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 0 8px rgba(0, 255, 150, 0.8);
}


/* æ¨¡å¼è¯´æ˜å¯¹è¯æ¡†æ ·å¼ */
.mode-info-dialog {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(20, 30, 50, 0.95);
    padding: 20px;
    border-radius: 10px;
    z-index: 30;
    max-width: 400px;
    box-shadow: 0 0 20px rgba(0, 255, 150, 0.2);
    border: 1px solid rgba(0, 255, 150, 0.3);
}

.mode-info-dialog h3 {
    color: #00ff96;
    margin-top: 0;
    margin-bottom: 15px;
}

.mode-info-dialog p {
    margin-bottom: 15px;
}

.mode-info-dialog .close-btn {
    background: linear-gradient(135deg, #00b894, #00cec9);
    color: white;
    border: none;
    padding: 8px 15px;
    border-radius: 5px;
    cursor: pointer;
    margin-top: 10px;
}

.mode-info-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.7);
    z-index: 25;
}

/* åœ¨ç°æœ‰CSSéƒ¨åˆ†æ·»åŠ ä¼ é€é—¨æ ·å¼ */
.portal {
  position: absolute;
  width: 30px;
  height: 30px;
  border-radius: 50%;
  animation: portal-pulse 2s infinite alternate;
  box-shadow: 0 0 20px currentColor;
}

.portal-blue {
  background: radial-gradient(#2196F3, #0D47A1);
  color: #2196F3;
}

.portal-pink {
  background: radial-gradient(#E91E63, #880E4F);
  color: #E91E63;
}

@keyframes portal-pulse {
  0% { transform: scale(0.9); opacity: 0.8; }
  100% { transform: scale(1.1); opacity: 1; }
}

.teleport-effect {
  position: absolute;
  width: 100%;
  height: 100%;
  background: rgba(255, 255, 255, 0.3);
  z-index: 100;
  pointer-events: none;
  opacity: 0;
  transition: opacity 0.3s;
}

.teleport-effect.active {
  opacity: 1;
  animation: teleport-flash 0.5s;
}

@keyframes teleport-flash {
  0% { opacity: 0; }
  50% { opacity: 1; }
  100% { opacity: 0; }
}

/* æ·»åŠ ä»¥ä¸‹CSSæ ·å¼ */
.game-settings .setting-item {
    transition: opacity 0.3s ease, max-height 0.5s ease;
}

.game-settings .settings-content:not(.open) + .setting-item,
.game-settings .settings-content:not(.open) ~ .setting-item {
    max-height: 0;
    opacity: 0;
    overflow: hidden;
    margin: 0;
    padding: 0;
}

.game-settings .settings-content.open + .setting-item,
.game-settings .settings-content.open ~ .setting-item {
    max-height: 50px;
    opacity: 1;
    margin: 8px 0;
}

    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <!-- æ¸¸æˆå®¹å™¨ -->
    <div id="game-container">
        <canvas id="game-canvas" class="rotate-effect"></canvas>
        <div id="score-container">
            <div>åˆ†æ•°: <span id="score">0</span></div>
            <div>æœ€é«˜åˆ†: <span id="high-score">0</span></div>
        </div>
        <div id="status-display">
            <div id="speed-display">é€Ÿåº¦: æ­£å¸¸</div>
            <div id="mode-display">æ¨¡å¼: æ™®é€š</div>
        </div>
        <div id="food-info"></div>
        <div id="power-up-indicator"></div>
        <button id="pause-btn" class="btn pause">æš‚åœ</button>
    </div>

    <!-- æ§åˆ¶æŒ‰é’® -->
    <div id="controls">
        <div class="control-btn" id="up-btn">â†‘</div>
        <div class="control-btn" id="left-btn">â†</div>
        <div class="control-btn" id="right-btn">â†’</div>
        <div class="control-btn" id="down-btn">â†“</div>
    </div>

    <!-- ä¸»èœå• -->
<div id="main-menu" class="overlay">
    <div class="dialog">
        <h2>ç»ˆæè´ªåƒè›‡</h2>
        <p>é€‰æ‹©ä¸€ä¸ªæ¸¸æˆæ¨¡å¼å¼€å§‹æ¸¸æˆ</p>
        <button id="rules-btn" class="btn" style="position: absolute; top: 20px; right: 20px; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; display: flex; justify-content: center; align-items: center; background: linear-gradient(135deg, #00b894, #00cec9);">?</button>
        <button id="classic-btn" class="btn">ç»å…¸æ¨¡å¼</button>
        <button id="challenge-btn" class="btn">å¤ºå† æ¨¡å¼</button>
        <button id="multiplayer-btn" class="btn">å¤šäººæ¸¸æˆ</button>
        <button id="settings-btn" class="btn secondary">è®¾ç½®</button>
    </div>
</div>


    <!-- æ¸¸æˆç»“æŸèœå• -->
    <div id="game-over" class="overlay" style="display: none;">
        <div class="dialog">
            <h2 id="game-over-title">æ¸¸æˆç»“æŸ</h2>
            <p id="final-score">æœ€ç»ˆåˆ†æ•°: 0</p>
            <p id="final-length">è›‡çš„é•¿åº¦: 0</p>
            <p id="game-over-message"></p>
            <button id="restart-btn" class="btn">å†æ¥ä¸€å±€</button>
            <button id="menu-btn" class="btn secondary">è¿”å›èœå•</button>
        </div>
    </div>

    <!-- æš‚åœèœå• -->
    <div id="pause-menu" class="overlay" style="display: none;">
        <div class="dialog">
            <h2>æ¸¸æˆæš‚åœ</h2>
            <button id="resume-btn" class="btn">ç»§ç»­æ¸¸æˆ</button>
            <button id="pause-menu-btn" class="btn secondary">è¿”å›èœå•</button>
        </div>
    </div>
    
<!-- è™šæ‹Ÿæ‘‡æ†æ§åˆ¶ -->
<div id="joystick-container" style="display: none;">
    <div id="joystick-base">
        <div id="joystick-stick"></div>
    </div>
</div>

    <!-- è®¾ç½®èœå• -->
<div id="settings-menu" class="overlay" style="display: none;">
    <div class="dialog">
        <h2>æ¸¸æˆè®¾ç½®</h2>
        
        <div class="settings-group">
            <h3>æ¸¸æˆé€Ÿåº¦</h3>
            <div class="slider-container">
                <label for="speed-slider">é€Ÿåº¦:</label>
                <input type="range" id="speed-slider" min="5" max="20" value="10">
                <span id="speed-value">10</span>
            </div>
        </div>
        
        <div class="settings-group">
            <h3>æ¸¸æˆé€‰é¡¹</h3>
            <div class="checkbox-container">
                <input type="checkbox" id="sound-checkbox" checked>
                <label for="sound-checkbox">éŸ³æ•ˆ</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="particles-checkbox" checked>
                <label for="particles-checkbox">ç²’å­æ•ˆæœ</label>
            </div>
            <div class="checkbox-container">
                <input type="checkbox" id="grid-checkbox" checked>
                <label for="grid-checkbox">æ˜¾ç¤ºç½‘æ ¼</label>
            </div>
        </div>
        
        <!-- æ–°å¢: æ§åˆ¶è®¾ç½®ç»„ -->
        <div class="settings-group" id="mobile-controls-group">
            <h3>ç§»åŠ¨è®¾å¤‡æ§åˆ¶</h3>
            <div class="radio-container">
    <input type="radio" id="control-buttons" name="control-type" value="buttons">
    <label for="control-buttons">æ–¹å‘æŒ‰é’®</label>
    <input type="radio" id="control-joystick" name="control-type" value="joystick" checked>
    <label for="control-joystick">è™šæ‹Ÿæ‘‡æ†</label>
</div>
            </div>
            <div class="slider-container">
                <label for="control-size-slider">å¤§å°:</label>
                <input type="range" id="control-size-slider" min="50" max="150" value="100">
                <span id="control-size-value">100%</span>
            </div>
            <div class="select-container">
                <label for="control-position">ä½ç½®:</label>
                <select id="control-position">
                    <option value="center">å±…ä¸­</option>
                    <option value="left">é å·¦</option>
                    <option value="right">é å³</option>
                </select>
            </div>
        </div>
        
        <!-- æ–°å¢: é”®ç›˜æ§åˆ¶è®¾ç½®ç»„ -->
        <div class="settings-group" id="keyboard-controls-group">
            <h3>é”®ç›˜æ§åˆ¶</h3>
            <div class="key-binding-container">
                <div class="key-binding">
                    <label for="key-up">å‘ä¸Š:</label>
                    <input type="text" id="key-up" readonly value="â†‘, W" data-direction="up">
                    <button class="reset-key" data-direction="up">é‡ç½®</button>
                </div>
                <div class="key-binding">
                    <label for="key-down">å‘ä¸‹:</label>
                    <input type="text" id="key-down" readonly value="â†“, S" data-direction="down">
                    <button class="reset-key" data-direction="down">é‡ç½®</button>
                </div>
                <div class="key-binding">
                    <label for="key-left">å‘å·¦:</label>
                    <input type="text" id="key-left" readonly value="â†, A" data-direction="left">
                    <button class="reset-key" data-direction="left">é‡ç½®</button>
                </div>
                <div class="key-binding">
                    <label for="key-right">å‘å³:</label>
                    <input type="text" id="key-right" readonly value="â†’, D" data-direction="right">
                    <button class="reset-key" data-direction="right">é‡ç½®</button>
                </div>
                <div class="key-binding">
                    <label for="key-pause">æš‚åœ:</label>
                    <input type="text" id="key-pause" readonly value="Space, P" data-direction="pause">
                    <button class="reset-key" data-direction="pause">é‡ç½®</button>
                </div>
            </div>
        </div>
        
        <button id="save-settings-btn" class="btn">ä¿å­˜è®¾ç½®</button>
        <button id="settings-menu-btn" class="btn secondary">è¿”å›èœå•</button>
    </div>
</div>

<!-- åœ¨bodyä¸­æ·»åŠ æ¸¸æˆè§„åˆ™å¯¹è¯æ¡† -->
<div id="rules-menu" class="overlay" style="display: none;">
    <div class="dialog" style="max-width: 600px; max-height: 80vh; overflow-y: auto;">
        <h2>æ¸¸æˆè§„åˆ™ä¸è¯´æ˜</h2>
        
        <div class="setting-item">
    <label for="game-mode-setting">å¤šäººæ¸¸æˆæ¨¡å¼:</label>
    <select id="game-mode-setting">
        <option value="classic" selected>ç»å…¸æ¨¡å¼</option>
        <option value="challenge">å¤ºå† æ¨¡å¼</option>
    </select>
    <button id="mode-info-btn" class="btn mode-info-btn">?</button>
</div>

        
        <div class="settings-group">
            <h3>é£Ÿç‰©ç±»å‹</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0;">
                    <td style="padding: 8px;"><div style="width: 20px; height: 20px; border-radius: 50%; background-color: #ff3333; display: inline-block;"></div></td>
                    <td style="padding: 8px;"><strong>çº¢è‰²é£Ÿç‰©</strong></td>
                    <td style="padding: 8px;">å¢åŠ é€Ÿåº¦ (+15åˆ†)</td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0;">
                    <td style="padding: 8px;"><div style="width: 20px; height: 20px; border-radius: 50%; background-color: #ffcc00; display: inline-block;"></div></td>
                    <td style="padding: 8px;"><strong>é»„è‰²é£Ÿç‰©</strong></td>
                    <td style="padding: 8px;">ç¿»å€å¾—åˆ†5ç§’ (+10åˆ†)</td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0;">
                    <td style="padding: 8px;"><div style="width: 20px; height: 20px; border-radius: 50%; background-color: #33cc33; display: inline-block;"></div></td>
                    <td style="padding: 8px;"><strong>ç»¿è‰²é£Ÿç‰©</strong></td>
                    <td style="padding: 8px;">é™ä½é€Ÿåº¦ (+10åˆ†)</td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0;">
                    <td style="padding: 8px;"><div style="width: 20px; height: 20px; border-radius: 50%; background-color: #3399ff; display: inline-block;"></div></td>
                    <td style="padding: 8px;"><strong>è“è‰²é£Ÿç‰©</strong></td>
                    <td style="padding: 8px;">ç©¿å¢™èƒ½åŠ›5ç§’ (+30åˆ†)</td>
                </tr>
                <tr style="border-bottom: 1px solid rgba(255,255,255,0.2); padding: 8px 0;">
                    <td style="padding: 8px;"><div style="width: 20px; height: 20px; border-radius: 50%; background-color: #9933ff; display: inline-block;"></div></td>
                    <td style="padding: 8px;"><strong>ç´«è‰²é£Ÿç‰©</strong></td>
                    <td style="padding: 8px;">æ— æ•Œèƒ½åŠ›5ç§’ (+40åˆ†)</td>
                </tr>
            </table>
        </div>
        
        <div class="settings-group">
            <h3>éšœç¢ç‰©ä¸ç‰¹æ®Šå…ƒç´ </h3>
            <div style="display: flex; align-items: center; margin: 10px 0;">
                <div style="width: 30px; height: 30px; background-color: #ad1457; margin-right: 10px; display: flex; justify-content: center; align-items: center;">
                    <div style="width: 20px; height: 20px; background-color: #ffeb3b; clip-path: polygon(50% 0%, 0% 100%, 100% 100%);"></div>
                </div>
                <span><strong>éšœç¢ç‰©ï¼š</strong>è§¦ç¢°å°†å¯¼è‡´æ¸¸æˆç»“æŸï¼ˆæ— æ•ŒçŠ¶æ€é™¤å¤–ï¼‰</span>
            </div>
            
            <div style="display: flex; align-items: center; margin: 10px 0;">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #00E5FF; margin-right: 10px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;">ğŸšª</div>
                <span><strong>ç©¿å¢™èƒ½åŠ›ï¼š</strong>è“è‰²ç¯ç»•æ•ˆæœï¼Œå…è®¸è›‡ç©¿è¿‡æ¸¸æˆè¾¹ç•Œ</span>
            </div>
            
            <div style="display: flex; align-items: center; margin: 10px 0;">
                <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #E040FB; margin-right: 10px; display: flex; justify-content: center; align-items: center; color: white; font-weight: bold;">ğŸ›¡ï¸</div>
                <span><strong>æ— æ•Œèƒ½åŠ›ï¼š</strong>ç´«è‰²ç¯ç»•æ•ˆæœï¼Œå¯ä»¥ç©¿è¿‡éšœç¢ç‰©å’Œè‡ªèº«</span>
                
            </div>
<div style="display: flex; align-items: center; margin: 10px 0;">
    <div style="width: 30px; height: 30px; border-radius: 50%; background: radial-gradient(#2196F3, #0D47A1); margin-right: 10px; box-shadow: 0 0 10px #2196F3;"></div>
    <span><strong>ä¼ é€é—¨(ä»…å¤šäººæ¨¡å¼)ï¼š</strong>éšæœºå‡ºç°çš„é—¨æˆ·ï¼Œè¿›å…¥åä¼šä¼ é€åˆ°å¦ä¸€ä¸ªé—¨æˆ·ä½ç½®</span>
</div>

            <div class="settings-group">
    <h3>å¤šäººæ¸¸æˆæ§åˆ¶</h3>
    <div style="display: flex; align-items: center; margin: 10px 0;">
        <div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background: rgba(0, 0, 0, 0.6); color: white; display: flex; justify-content: center; align-items: center; font-size: 24px;">ğŸ†</div>
        <span><strong>åˆ†æ•°æŒ‰é’®ï¼š</strong>ç‚¹å‡»æ˜¾ç¤ºæˆ–éšè—æ‰€æœ‰ç©å®¶çš„åˆ†æ•°é¢æ¿/è¡€é‡ï¼ŒæŸ¥çœ‹æ¯”èµ›å®æ—¶æ’å/æƒ…å†µã€‚</span>
    </div>
    
    <div style="display: flex; align-items: center; margin: 10px 0;">
        <div style="width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; background: rgba(0, 0, 0, 0.6); color: white; display: flex; justify-content: center; align-items: center; font-size: 24px;">ğŸ’¬</div>
        <span><strong>èŠå¤©æŒ‰é’®ï¼š</strong>ç‚¹å‡»æ‰“å¼€èŠå¤©ç•Œé¢ï¼Œä¸å…¶ä»–ç©å®¶å®æ—¶äº¤æµæˆ–æŸ¥çœ‹æ¸¸æˆé€šçŸ¥ã€‚</span>
    </div>
</div>

        </div>
        
        <div class="settings-group">
            <h3>æ“ä½œæ–¹å¼</h3>
            <p><strong>é”®ç›˜ï¼š</strong> æ–¹å‘é”®æˆ–WASDæ§åˆ¶æ–¹å‘ï¼Œç©ºæ ¼é”®æˆ–Pé”®æš‚åœæ¸¸æˆ</p>
            <p><strong>è§¦æ‘¸å±ï¼š</strong> ä½¿ç”¨å±å¹•åº•éƒ¨çš„æ–¹å‘æŒ‰é’®æˆ–è™šæ‹Ÿæ‘‡æ†æ§åˆ¶</p>
            <p><strong>è¿å‡»å¥–åŠ±ï¼š</strong> è¿ç»­åƒåˆ°é£Ÿç‰©ä¼šè·å¾—åˆ†æ•°åŠ æˆ</p>
        </div>
        
        <button id="rules-back-btn" class="btn">è¿”å›</button>
    </div>
</div>


<!-- å¤šäººæ¸¸æˆèœå•å’ŒUI -->
<div id="multiplayer-menu" class="overlay" style="display: none;">
    <div class="dialog">
        <h2>å¤šäººæ¸¸æˆ</h2>
        <div class="input-group">
            <label for="player-name">æ‚¨çš„åå­—:</label>
            <input type="text" id="player-name" maxlength="15" placeholder="è¾“å…¥åå­—...">
        </div>
        <div class="button-group">
            <button id="create-game-btn" class="btn">åˆ›å»ºæ¸¸æˆ</button>
            <button id="join-game-btn" class="btn">åŠ å…¥æ¸¸æˆ</button>
        </div>
        <button id="multiplayer-back-btn" class="btn secondary">è¿”å›</button>
    </div>
</div>

<div id="join-game-menu" class="overlay" style="display: none;">
    <div class="dialog">
        <h2>åŠ å…¥æ¸¸æˆ</h2>
        <div class="input-group">
            <label for="game-id">æ¸¸æˆID:</label>
            <input type="text" id="game-id" maxlength="4" placeholder="è¾“å…¥æˆ¿é—´ID...">
        </div>
        <button id="join-btn" class="btn">åŠ å…¥</button>
        <button id="join-back-btn" class="btn secondary">è¿”å›</button>
    </div>
</div>

<div id="game-lobby" class="overlay" style="display: none;">
    <div class="dialog">
        <h2>æ¸¸æˆå¤§å…</h2>
        <div class="game-info">
            <p>æ¸¸æˆID: <span id="lobby-game-id">XXXXXX</span></p>
            <p class="share-tip">åˆ†äº«æ­¤IDç»™å¥½å‹åŠ å…¥æ¸¸æˆ</p>
        </div>
        
        <div class="game-settings host-only">
    <div class="settings-header">
        <h3>æ¸¸æˆè®¾ç½®</h3>
        <span class="toggle-icon">â–¼</span>
    </div>
    <div class="settings-content">
        <div class="setting-item">
            <label for="game-mode-setting">æ¸¸æˆæ¨¡å¼:</label>
            <div style="display: flex; align-items: center;">
                <select id="game-mode-setting">
                    <option value="classic" selected>ç»å…¸æ¨¡å¼</option>
                    <option value="challenge">å¤ºå† æ¨¡å¼</option>
                </select>
                <button id="mode-info-btn" class="mode-info-btn">?</button>
            </div>
        </div>
        
        <div class="setting-item">
            <label for="grid-size-setting">ç½‘æ ¼å¤§å°:</label>
            <input type="range" id="grid-size-setting" min="20" max="50" value="30">
            <span id="grid-size-value">30</span>
        </div>
        
        <div class="setting-item">
            <label for="game-speed-setting">æ¸¸æˆé€Ÿåº¦:</label>
            <select id="game-speed-setting">
                <option value="slow">æ…¢é€Ÿ</option>
                <option value="normal" selected>æ­£å¸¸</option>
                <option value="fast">å¿«é€Ÿ</option>
                <option value="extreme">æé€Ÿ</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label for="food-count-setting">é£Ÿç‰©æ•°é‡:</label>
            <input type="range" id="food-count-setting" min="1" max="10" value="5">
            <span id="food-count-value">5</span>
        </div>
        
        <div class="setting-item">
            <label for="obstacle-density-setting">éšœç¢ç‰©å¯†åº¦:</label>
            <select id="obstacle-density-setting">
                <option value="none">æ— </option>
                <option value="low">ä½</option>
                <option value="medium" selected>ä¸­</option>
                <option value="high">é«˜</option>
            </select>
        </div>
        
        <div class="setting-item">
            <label for="power-ups-setting">èƒ½åŠ›é“å…·:</label>
            <select id="power-ups-setting">
                <option value="normal" selected>æ­£å¸¸</option>
                <option value="frequent">é¢‘ç¹</option>
                <option value="rare">ç¨€æœ‰</option>
                <option value="none">æ— </option>
            </select>
        </div>
    </div>
</div>

        
        <div class="player-list-container">
            <h3>ç©å®¶åˆ—è¡¨:</h3>
            <ul id="player-list"></ul>
        </div>
        <button id="start-game-btn" class="btn">å¼€å§‹æ¸¸æˆ</button>
        <button id="leave-game-btn" class="btn secondary">ç¦»å¼€æ¸¸æˆ</button>
    </div>
</div>



<div id="multiplayer-status" style="display: none;">
    <div class="player-scores"></div>
</div>

<div id="multiplayer-chat" style="display: none;">
    <div class="chat-messages"></div>
    <div class="chat-input">
        <input type="text" id="chat-input" placeholder="è¾“å…¥æ¶ˆæ¯...">
        <button id="send-chat-btn">å‘é€</button>
    </div>
</div>

    <script>

    
        // ============== æ¸¸æˆåˆå§‹åŒ–ä¸æ ¸å¿ƒå˜é‡ ==============
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        // æ‰©å±•æ¸¸æˆè®¾ç½®å¯¹è±¡
const settings = {
    gridSize: 30,               // ç½‘æ ¼å¤§å°
    baseSpeed: 150,             // åŸºç¡€é€Ÿåº¦(æ¯«ç§’)
    challengeTarget: 1000,      // æŒ‘æˆ˜æ¨¡å¼ç›®æ ‡åˆ†æ•°
    soundEnabled: true,         // éŸ³æ•ˆå¼€å…³
    particlesEnabled: true,     // ç²’å­æ•ˆæœå¼€å…³
    gridEnabled: true,          // ç½‘æ ¼æ˜¾ç¤ºå¼€å…³
    speedMultiplier: 1.0,       // é€Ÿåº¦å€ç‡
    
    // æ§åˆ¶è®¾ç½®
    controlType: 'joystick',     // ç§»åŠ¨è®¾å¤‡æ§åˆ¶ç±»å‹: 'buttons' æˆ– 'joystick'
    controlSize: 1.0,           // æ§åˆ¶æŒ‰é’®å¤§å°å€ç‡
    controlPosition: 'center',  // æ§åˆ¶æŒ‰é’®ä½ç½®: 'center', 'left', 'right'
    keyBindings: {              // è‡ªå®šä¹‰é”®ç›˜ç»‘å®š
        up: ['ArrowUp', 'w', 'W'],
        down: ['ArrowDown', 's', 'S'],
        left: ['ArrowLeft', 'a', 'A'],
        right: ['ArrowRight', 'd', 'D'],
        pause: [' ', 'p', 'P']
    }
};

        
        // æ¸¸æˆçŠ¶æ€
        let gameState = {
            snake: [],                  // è›‡çš„èº«ä½“æ®µ
            snakeInterpolated: [],      // ç”¨äºå¹³æ»‘åŠ¨ç”»çš„æ’å€¼ä½ç½®
            food: null,                 // å½“å‰é£Ÿç‰©
            obstacles: [],              // éšœç¢ç‰©
            direction: 'right',         // å½“å‰æ–¹å‘
            nextDirection: 'right',     // ä¸‹ä¸€æ¬¡æ›´æ–°æ—¶çš„æ–¹å‘
            score: 0,                   // åˆ†æ•°
            highScore: 0,               // æœ€é«˜åˆ†
            combo: 0,                   // è¿å‡»æ•°
            speed: settings.baseSpeed,  // å½“å‰é€Ÿåº¦
            gameMode: '',               // æ¸¸æˆæ¨¡å¼
            isPlaying: false,           // æ¸¸æˆæ˜¯å¦è¿›è¡Œä¸­
            isPaused: false,            // æ¸¸æˆæ˜¯å¦æš‚åœ
            isGameOver: false,          // æ¸¸æˆæ˜¯å¦ç»“æŸ
            powerUpActive: false,       // èƒ½åŠ›æ˜¯å¦æ¿€æ´»
            powerUpType: null,          // æ¿€æ´»çš„èƒ½åŠ›ç±»å‹
            powerUpTimeLeft: 0,         // èƒ½åŠ›å‰©ä½™æ—¶é—´
            lastFrameTime: 0,           // ä¸Šä¸€å¸§æ—¶é—´
            accumulatedTime: 0,         // ç´¯ç§¯æ—¶é—´
            animationFrame: null,       // å½“å‰åŠ¨ç”»å¸§
            particles: [],              // ç²’å­æ•ˆæœ
            trail: [],                   // ç§»åŠ¨è½¨è¿¹
            scoreMultiplierActive: false,  // åˆ†æ•°ç¿»å€æ˜¯å¦æ¿€æ´»
            scoreMultiplierTimeLeft: 0    // åˆ†æ•°ç¿»å€å‰©ä½™æ—¶é—´
        };
        
        // ============== å¤šäººæ¸¸æˆä»£ç  ==============
let socket;
let isMultiplayerGame = false;
let multiplayerGameId = null;
let isHost = false;
let playerName = '';
let playerId = '';
let connectedPlayers = [];
let multiplayerGameState = null;

// åˆå§‹åŒ–Socket.io
function initializeMultiplayer() {
    try {
        socket = io();
        
        // è¿æ¥äº‹ä»¶
        socket.on('connect', () => {
            console.log('å·²è¿æ¥åˆ°æœåŠ¡å™¨');
            playerId = socket.id;
        });
        
        // è¿æ¥é”™è¯¯å¤„ç†
        socket.on('connect_error', (error) => {
            console.error('è¿æ¥æœåŠ¡å™¨å¤±è´¥:', error);
            alert('æ— æ³•è¿æ¥åˆ°æ¸¸æˆæœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            // ç¡®ä¿è¿”å›æŒ‰é’®ä»ç„¶å¯ç”¨
            ensureBackButtonWorks();
        });
        
        // é”™è¯¯å¤„ç†
        socket.on('error', (message) => {
            alert('é”™è¯¯: ' + message);
            // ç¡®ä¿è¿”å›æŒ‰é’®ä»ç„¶å¯ç”¨
            ensureBackButtonWorks();
        });
        
        // æ¸¸æˆåˆ›å»ºæˆåŠŸ
        socket.on('gameCreated', (gameId) => {
            multiplayerGameId = gameId;
            isHost = true;
            document.getElementById('multiplayer-menu').style.display = 'none';
            document.getElementById('lobby-game-id').textContent = gameId;
            document.getElementById('game-lobby').style.display = 'flex';
            // ç¡®ä¿è®¾ç½®é¢æ¿å¯è§æ€§æ­£ç¡®
            updateSettingsVisibility();
            setTimeout(setupLobbyEvents, 300); // ä½¿ç”¨å»¶æ—¶ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        });
        
        // åŠ å…¥æ¸¸æˆæˆåŠŸ
        socket.on('gameJoined', (gameId) => {
            multiplayerGameId = gameId;
            isHost = false;
            document.getElementById('join-game-menu').style.display = 'none';
            document.getElementById('lobby-game-id').textContent = gameId;
            document.getElementById('game-lobby').style.display = 'flex';
            // ç¡®ä¿è®¾ç½®é¢æ¿å¯è§æ€§æ­£ç¡®
            updateSettingsVisibility();
            setTimeout(setupLobbyEvents, 300); // ä½¿ç”¨å»¶æ—¶ç¡®ä¿DOMå®Œå…¨æ¸²æŸ“
        });
        
        // ç©å®¶åŠ å…¥/æ›´æ–°
        socket.on('playerJoined', (players) => {
            connectedPlayers = players;
            updatePlayerList();
            updateSettingsVisibility();
        });
        
        // ç©å®¶ç¦»å¼€
        socket.on('playerLeft', (data) => {
            connectedPlayers = data.players;
            updatePlayerList();
            addChatMessage(`${data.playerName} ç¦»å¼€äº†æ¸¸æˆ`, 'system');
        });
        
        // æ¸¸æˆå¼€å§‹
        socket.on('gameStarted', (gameData) => {
            document.getElementById('game-lobby').style.display = 'none';
            startMultiplayerGame(gameData);
        });
        
        // æ¸¸æˆçŠ¶æ€æ›´æ–°
        socket.on('gameStateUpdate', (gameState) => {
            updateMultiplayerGameState(gameState);
        });
        
        // é£Ÿç‰©è¢«åƒæ‰
        socket.on('foodEaten', (data) => {
            // æ˜¾ç¤ºé£Ÿç‰©è¢«åƒæç¤º
            if (data.playerId === playerId) {
                createScorePopup(data.position.x, data.position.y, data.points);
            }
            addChatMessage(`${data.playerName} åƒåˆ°äº†é£Ÿç‰© (+${data.points})`, 'system');
        });
        
        // æ–°é£Ÿç‰©ç”Ÿæˆ
        socket.on('foodSpawned', (food) => {
            // å¯ä»¥æ·»åŠ æç¤ºåŠ¨ç”»
        });
        
        // æ–°éšœç¢ç‰©ç”Ÿæˆ
        socket.on('obstacleSpawned', (obstacle) => {
            // å¯ä»¥æ·»åŠ æç¤ºåŠ¨ç”»
        });
        
        // èƒ½åŠ›é“å…·æ¿€æ´»
        socket.on('powerUpActivated', (data) => {
            const powerUpName = data.powerUpType === 'phase' ? 'ç©¿å¢™' : 'æ— æ•Œ';
            addChatMessage(`${data.playerName} æ¿€æ´»äº†${powerUpName}èƒ½åŠ›!`, 'system');
        });
        
        // ç©å®¶æ­»äº¡
        // playerDied äº‹ä»¶ç›‘å¬
// åœ¨å®¢æˆ·ç«¯ä¿®æ”¹playerDiedäº‹ä»¶å¤„ç†ï¼Œè®©å¤ºå† æ¨¡å¼ç©å®¶èƒ½é‡ç”Ÿ
socket.on('playerDied', (data) => {
    let message = `${data.playerName} æ­»äº¡äº†`;
    console.log('æ”¶åˆ°playerDiedäº‹ä»¶:', data);
    
    // æ·»åŠ æ­»äº¡åŸå› 
    if (data.reason === 'player' && data.killerName) {
        message += ` (è¢« ${data.killerName} å‡»è´¥)`;
    } else if (data.reason === 'boundary') {
        message += ' (æ’å¢™)';
    } else if (data.reason === 'obstacle') {
        message += ' (æ’åˆ°éšœç¢ç‰©)';
    } else if (data.reason === 'self') {
        message += ' (æ’åˆ°è‡ªå·±)';
    }
    
    // å¦‚æœæ˜¯å½“å‰ç©å®¶ï¼Œå¤„ç†ç•Œé¢
    if (data.playerId === playerId) {
        // ç»å…¸æ¨¡å¼ä¸‹ï¼Œæ ¹æ®å‰©ä½™ç”Ÿå‘½å¤„ç†
        if (data.gameMode === 'classic') {
            if (data.livesLeft > 0) {
                // è¿˜æœ‰ç”Ÿå‘½ï¼Œæ˜¾ç¤ºå¤æ´»å€’è®¡æ—¶
                showRespawnOption();
            } else {
                // æ²¡æœ‰ç”Ÿå‘½äº†ï¼Œæ˜¾ç¤ºæœ€ç»ˆæ­»äº¡æ¶ˆæ¯
                const gameOverMessage = document.createElement('div');
                gameOverMessage.id = 'death-message';
                gameOverMessage.textContent = 'ä½ å·²ç”¨å°½æ‰€æœ‰ç”Ÿå‘½!';
                gameOverMessage.style.position = 'absolute';
                gameOverMessage.style.top = '40%';
                gameOverMessage.style.left = '50%';
                gameOverMessage.style.transform = 'translate(-50%, -50%)';
                gameOverMessage.style.color = '#FF5252';
                gameOverMessage.style.fontSize = '28px';
                gameOverMessage.style.fontWeight = 'bold';
                gameOverMessage.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
                gameOverMessage.style.zIndex = '999';
                gameOverMessage.style.textAlign = 'center';
                gameOverMessage.style.padding = '15px 30px';
                gameOverMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
                gameOverMessage.style.borderRadius = '10px';
                document.getElementById('game-container').appendChild(gameOverMessage);
            }
        } 
        // å¤ºå† æ¨¡å¼ï¼Œæ˜¾ç¤ºæ‰‹åŠ¨é‡ç”ŸæŒ‰é’®
        else if (data.gameMode === 'challenge') {
            const deathMessage = document.createElement('div');
            deathMessage.id = 'death-message';
            deathMessage.textContent = 'ä½ å·²æ­»äº¡! ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®é‡ç”Ÿ';
            deathMessage.style.position = 'absolute';
            deathMessage.style.top = '40%';
            deathMessage.style.left = '50%';
            deathMessage.style.transform = 'translate(-50%, -50%)';
            deathMessage.style.color = '#FF5252';
            deathMessage.style.fontSize = '28px';
            deathMessage.style.fontWeight = 'bold';
            deathMessage.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
            deathMessage.style.zIndex = '999';
            deathMessage.style.textAlign = 'center';
            deathMessage.style.padding = '15px 30px';
            deathMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            deathMessage.style.borderRadius = '10px';
            document.getElementById('game-container').appendChild(deathMessage);
            
            // åˆ›å»ºé‡ç”ŸæŒ‰é’®
            const container = document.getElementById('game-container');
            const respawnBtn = document.createElement('button');
            respawnBtn.id = 'respawn-btn';
            respawnBtn.className = 'btn';
            respawnBtn.textContent = 'ç‚¹å‡»é‡ç”Ÿ';
            
            // è°ƒæ•´æŒ‰é’®æ ·å¼ä»¥é€‚åº”è®¾å¤‡
            if (window.innerWidth <= 768) {
                // ç§»åŠ¨è®¾å¤‡æ ·å¼ - å±…ä¸­æ˜¾ç¤º
                respawnBtn.style.position = 'absolute';
                respawnBtn.style.top = '60%';
                respawnBtn.style.left = '50%';
                respawnBtn.style.transform = 'translate(-50%, -50%)';
            } else {
                // æ¡Œé¢æ ·å¼ - åœ¨ç”»å¸ƒä¸‹æ–¹
                respawnBtn.style.position = 'absolute';
                respawnBtn.style.top = 'calc(40% + 80px)';
                respawnBtn.style.left = '50%';
                respawnBtn.style.transform = 'translateX(-50%)';
            }
            
            respawnBtn.style.zIndex = '999';
            respawnBtn.style.fontSize = window.innerWidth <= 768 ? '16px' : '24px';
            respawnBtn.style.padding = window.innerWidth <= 768 ? '10px 20px' : '15px 30px';
            respawnBtn.style.backgroundColor = '#4CAF50';
            respawnBtn.style.boxShadow = '0 0 20px rgba(0, 255, 0, 0.8)';
            respawnBtn.style.animation = 'pulse 1.5s infinite';
            
            respawnBtn.addEventListener('click', () => {
                console.log('é‡ç”ŸæŒ‰é’®è¢«ç‚¹å‡»ï¼Œå‘é€respawnäº‹ä»¶');
                socket.emit('respawn');
                hideRespawnOption();
            });
            
            container.appendChild(respawnBtn);
        }
        // å…¶ä»–æ¨¡å¼
        else {
            // éç»å…¸æ¨¡å¼ï¼Œæ˜¾ç¤ºæ™®é€šçš„æ­»äº¡ä¿¡æ¯
            const deathMessage = document.createElement('div');
            deathMessage.id = 'death-message';
            deathMessage.textContent = 'ä½ å·²æ­»äº¡!';
            deathMessage.style.position = 'absolute';
            deathMessage.style.top = '40%';
            deathMessage.style.left = '50%';
            deathMessage.style.transform = 'translate(-50%, -50%)';
            deathMessage.style.color = '#FF5252';
            deathMessage.style.fontSize = '28px';
            deathMessage.style.fontWeight = 'bold';
            deathMessage.style.textShadow = '0 0 10px rgba(255, 0, 0, 0.5)';
            deathMessage.style.zIndex = '999';
            deathMessage.style.textAlign = 'center';
            deathMessage.style.padding = '15px 30px';
            deathMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.7)';
            deathMessage.style.borderRadius = '10px';
            document.getElementById('game-container').appendChild(deathMessage);
            
            // å¦‚æœå…è®¸é‡ç”Ÿï¼Œæ˜¾ç¤ºé‡ç”ŸæŒ‰é’®
            if (multiplayerGameState && multiplayerGameState.allowRespawn) {
                const respawnBtn = document.createElement('button');
                respawnBtn.id = 'respawn-btn';
                respawnBtn.className = 'btn';
                respawnBtn.textContent = 'é‡ç”Ÿ';
                
                respawnBtn.style.position = 'absolute';
                respawnBtn.style.top = 'calc(40% + 80px)';
                respawnBtn.style.left = '50%';
                respawnBtn.style.transform = 'translateX(-50%)';
                respawnBtn.style.zIndex = '999';
                
                respawnBtn.addEventListener('click', () => {
                    console.log('é‡ç”ŸæŒ‰é’®è¢«ç‚¹å‡»ï¼Œå‘é€respawnäº‹ä»¶');
                    socket.emit('respawn');
                    hideRespawnOption();
                });
                
                container.appendChild(respawnBtn);
            }
        }
    }
    
    addChatMessage(message, 'system');
    updateScoreBoard(); // æ›´æ–°åˆ†æ•°æ¿æ˜¾ç¤º
});


        
        // playerRespawned äº‹ä»¶ç›‘å¬
socket.on('playerRespawned', (data) => {
    console.log('æ”¶åˆ°playerRespawnedäº‹ä»¶:', data);
    
    // å¦‚æœæ˜¯å½“å‰ç©å®¶å¤æ´»
    if (data.playerId === playerId) {
        // éšè—å¤æ´»å€’è®¡æ—¶UI
        hideRespawnOption();
        
        // æä¾›æ›´æ˜æ˜¾çš„è§†è§‰åé¦ˆ
        const container = document.getElementById('game-container');
        const respawnEffect = document.createElement('div');
        respawnEffect.style.position = 'absolute';
        respawnEffect.style.top = '0';
        respawnEffect.style.left = '0';
        respawnEffect.style.width = '100%';
        respawnEffect.style.height = '100%';
        respawnEffect.style.backgroundColor = 'rgba(0, 255, 0, 0.2)';
        respawnEffect.style.zIndex = '50';
        respawnEffect.style.pointerEvents = 'none';
        container.appendChild(respawnEffect);
        
        // æ·¡å‡ºæ•ˆæœ
        setTimeout(() => {
            let opacity = 0.2;
            const fadeInterval = setInterval(() => {
                opacity -= 0.01;
                respawnEffect.style.backgroundColor = `rgba(0, 255, 0, ${opacity})`;
                if (opacity <= 0) {
                    clearInterval(fadeInterval);
                    respawnEffect.remove();
                }
            }, 20);
        }, 500);
    }
    
    // æ„å»ºå¤æ´»æ¶ˆæ¯ï¼Œæ·»åŠ ç”Ÿå‘½å€¼ä¿¡æ¯
    let message = `${data.playerName} å·²å¤æ´»`;
    
    // å¦‚æœæ˜¯ç»å…¸æ¨¡å¼ä¸”æœ‰ç”Ÿå‘½å€¼ä¿¡æ¯ï¼Œæ˜¾ç¤ºå‰©ä½™ç”Ÿå‘½
    if (data.gameMode === 'classic' && typeof data.livesLeft === 'number') {
        message += ` [å‰©ä½™ç”Ÿå‘½: ${data.livesLeft}]`;
    }
    
    // æ·»åŠ ç³»ç»Ÿæ¶ˆæ¯
    addChatMessage(message, 'system');
    
    // æ›´æ–°åˆ†æ•°æ¿æ˜¾ç¤º
    updateScoreBoard();
});

        
        // æ¸¸æˆç»“æŸ
        socket.on('gameEnd', (data) => {
            endMultiplayerGame(data);
        });
        
        // è®¾ç½®æ›´æ–°
        socket.on('settingsUpdated', (settings) => {
            // æ›´æ–°æ¸¸æˆè®¾ç½®UI
            addChatMessage('æ¸¸æˆè®¾ç½®å·²æ›´æ–°', 'system');
        });
        
        // èŠå¤©æ¶ˆæ¯
        socket.on('newMessage', (data) => {
            addChatMessage(`${data.playerName}: ${data.message}`, 'chat', data.playerId);
        });
        
        // ç½‘æ ¼å¤§å°å˜æ›´
        socket.on('gridSizeChanged', (newGridSize) => {
            console.log('ç½‘æ ¼å¤§å°å·²æ›´æ”¹ä¸º:', newGridSize);
            settings.gridSize = newGridSize;
            
            // ç«‹å³é‡æ–°è°ƒæ•´ç”»å¸ƒå¤§å°ä»¥é€‚åº”æ–°çš„ç½‘æ ¼
            resizeCanvas();
            
            // æ¸…é™¤ç°æœ‰æ¸¸æˆå…ƒç´ ï¼Œé¿å…ä½ç½®é”™ä¹±
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // å¦‚æœæ­£åœ¨å¤šäººæ¸¸æˆä¸­ï¼Œå¼ºåˆ¶é‡æ–°æ¸²æŸ“
            if (isMultiplayerGame && gameState.isPlaying) {
                requestAnimationFrame(multiplayerGameLoop);
            }
            
            addChatMessage(`æ¸¸æˆç½‘æ ¼å¤§å°å·²æ›´æ”¹ä¸º ${newGridSize}x${newGridSize}`, 'system');
        });
        
        socket.on('gameCreated', (gameId) => {
            // ç¡®ä¿å…ˆæ¸…ç†ä¹‹å‰çš„æ¸¸æˆçŠ¶æ€
            if (isMultiplayerGame) {
                resetMultiplayerGameState();
            }
            
            multiplayerGameId = gameId;
            isHost = true;
            document.getElementById('multiplayer-menu').style.display = 'none';
            document.getElementById('lobby-game-id').textContent = gameId;
            document.getElementById('game-lobby').style.display = 'flex';
            updateSettingsVisibility();
            setTimeout(setupLobbyEvents, 100);
        });
        
        // åœ¨Socket.ioäº‹ä»¶ç›‘å¬éƒ¨åˆ†æ·»åŠ ä¼ é€é—¨ç›¸å…³äº‹ä»¶
socket.on('portalsSpawned', (data) => {
    console.log('ä¼ é€é—¨å·²ç”Ÿæˆ:', data);
    if (!multiplayerGameState) return;
    
    multiplayerGameState.portals = data.portals;
    multiplayerGameState.portalExpireTime = data.expireTime;
    
    // æ˜¾ç¤ºä¼ é€é—¨ç”Ÿæˆæç¤º
    addChatMessage('ä¼ é€é—¨å·²å‡ºç°ï¼å¯ä»¥åœ¨ä¸¤å¤„ä½ç½®ä¹‹é—´å¿«é€Ÿç§»åŠ¨', 'system');
});

socket.on('portalsExpired', () => {
    console.log('ä¼ é€é—¨å·²æ¶ˆå¤±');
    if (!multiplayerGameState) return;
    
    multiplayerGameState.portals = [];
    
    // æ˜¾ç¤ºä¼ é€é—¨æ¶ˆå¤±æç¤º
    addChatMessage('ä¼ é€é—¨å·²æ¶ˆå¤±', 'system');
});

socket.on('playerTeleported', (data) => {
    console.log('ç©å®¶ä¼ é€:', data);
    
    // æ’­æ”¾ä¼ é€éŸ³æ•ˆ
    if (settings.soundEnabled) {
        sounds.teleport.currentTime = 0;
        sounds.teleport.play();
    }
    
    // åˆ›å»ºä¼ é€ç‰¹æ•ˆ
    const teleportEffect = document.createElement('div');
    teleportEffect.className = 'teleport-effect';
    document.getElementById('game-container').appendChild(teleportEffect);
    
    // è§¦å‘åŠ¨ç”»
    setTimeout(() => {
        teleportEffect.classList.add('active');
    }, 10);
    
    // ç§»é™¤ç‰¹æ•ˆ
    setTimeout(() => {
        teleportEffect.remove();
    }, 600);
    
    // æ˜¾ç¤ºä¼ é€æç¤º
    if (data.playerId === playerId) {
        addChatMessage('ä½ é€šè¿‡ä¼ é€é—¨ç§»åŠ¨äº†ï¼', 'system');
    } else {
        addChatMessage(`${data.playerName} é€šè¿‡ä¼ é€é—¨ç§»åŠ¨ï¼`, 'system');
    }
});

        
        socket.on('gameJoined', (gameId) => {
            // ç¡®ä¿å…ˆæ¸…ç†ä¹‹å‰çš„æ¸¸æˆçŠ¶æ€
            if (isMultiplayerGame) {
                resetMultiplayerGameState();
            }
            
            multiplayerGameId = gameId;
            isHost = false;
            document.getElementById('join-game-menu').style.display = 'none';
            document.getElementById('lobby-game-id').textContent = gameId;
            document.getElementById('game-lobby').style.display = 'flex';
            updateSettingsVisibility();
            setTimeout(setupLobbyEvents, 100);
        });
    } catch (error) {
        console.error('åˆå§‹åŒ–Socket.ioå¤±è´¥:', error);
        alert('æ— æ³•åˆå§‹åŒ–å¤šäººæ¸¸æˆåŠŸèƒ½ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
        // ç¡®ä¿è¿”å›æŒ‰é’®ä»ç„¶å¯ç”¨
        ensureBackButtonWorks();
    }
    
    // æ— è®ºæ˜¯å¦è¿æ¥æˆåŠŸï¼Œéƒ½ç¡®ä¿è¿”å›æŒ‰é’®æ­£å¸¸å·¥ä½œ
    ensureBackButtonWorks();
}



// æ¸¸æˆè®°å½•å¯¹è±¡
const gameRecords = {
    firstLaunch: true,         // æ˜¯å¦é¦–æ¬¡å¯åŠ¨
    launchCount: 0,            // å¯åŠ¨æ¬¡æ•°
    totalPlayTime: 0,          // æ€»æ¸¸æˆæ—¶é—´(ç§’)
    playerName: '',            // å¤šäººæ¸¸æˆç©å®¶åç§°
    highScores: {              // å„æ¨¡å¼æœ€é«˜åˆ†
        classic: 0,
        challenge: 0
    },
    lastPlayedMode: '',        // ä¸Šæ¬¡ç©çš„æ¨¡å¼
    lastPlayedDate: null,      // ä¸Šæ¬¡æ¸¸æˆæ—¥æœŸ
    multiplayerGamesPlayed: 0, // å¤šäººæ¸¸æˆæ¬¡æ•°
    singleplayerGamesPlayed: 0 // å•äººæ¸¸æˆæ¬¡æ•°
};

// åˆå§‹åŒ–æ¸¸æˆè®°å½•
function initGameRecords() {
    const savedRecords = localStorage.getItem('snakeGameRecords');
    if (savedRecords) {
        // å·²æœ‰è®°å½•ï¼ŒåŠ è½½å®ƒ
        const parsed = JSON.parse(savedRecords);
        Object.assign(gameRecords, parsed);
        gameRecords.firstLaunch = false;
    } else {
        // ç¬¬ä¸€æ¬¡å¯åŠ¨æ¸¸æˆï¼Œæ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
        showWelcomeMessage();
    }
    
    // æ›´æ–°å¯åŠ¨æ¬¡æ•°
    gameRecords.launchCount++;
    gameRecords.lastPlayedDate = new Date().toISOString();
    
    // ä¿å­˜æ›´æ–°åçš„è®°å½•
    saveGameRecords();
    
    console.log('æ¸¸æˆè®°å½•å·²åˆå§‹åŒ–:', gameRecords);
}

// ä¿å­˜æ¸¸æˆè®°å½•
function saveGameRecords() {
    localStorage.setItem('snakeGameRecords', JSON.stringify(gameRecords));
}

// æ˜¾ç¤ºæ¬¢è¿ä¿¡æ¯
function showWelcomeMessage() {
    const welcomeOverlay = document.createElement('div');
    welcomeOverlay.className = 'overlay';
    welcomeOverlay.style.zIndex = '30';
    
    const welcomeDialog = document.createElement('div');
    welcomeDialog.className = 'dialog';
    welcomeDialog.innerHTML = `
        <h2>æ¬¢è¿æ¥åˆ°ç»ˆæè´ªåƒè›‡ï¼</h2>
        <p>è¿™æ˜¯æ‚¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ¸¸æˆã€‚ä»¥ä¸‹æ˜¯ä¸€äº›æ¸¸æˆç‰¹ç‚¹ï¼š</p>
        <ul style="text-align: left; margin: 15px 0; padding-left: 20px;">
            <li>å¤šç§æ¸¸æˆæ¨¡å¼ï¼šç»å…¸æ¨¡å¼å’Œå¤ºå† æ¨¡å¼</li>
            <li>äº”ç§ç‰¹æ®Šé£Ÿç‰©ï¼Œå„å…·ä¸åŒèƒ½åŠ›</li>
            <li>å¤šäººæ¸¸æˆæ¨¡å¼ï¼Œä¸æœ‹å‹ä¸€èµ·ç«æŠ€</li>
            <li>å¯è‡ªå®šä¹‰æ§åˆ¶æ–¹å¼å’Œæ¸¸æˆå‚æ•°</li>
        </ul>
        <p>æ‚¨çš„æ¸¸æˆè¿›åº¦å’Œè®¾ç½®å°†è‡ªåŠ¨ä¿å­˜ã€‚</p>
        <button id="welcome-btn" class="btn">å¼€å§‹æ¸¸æˆ</button>
    `;
    
    welcomeOverlay.appendChild(welcomeDialog);
    document.body.appendChild(welcomeOverlay);
    
    document.getElementById('welcome-btn').addEventListener('click', () => {
        welcomeOverlay.remove();
    });
}

// æ›´æ–°æ¸¸æˆè®°å½•
function updateGameRecord(type, data) {
    switch(type) {
        case 'score':
            // æ›´æ–°æœ€é«˜åˆ†
            if (data.score > gameRecords.highScores[data.mode]) {
                gameRecords.highScores[data.mode] = data.score;
            }
            break;
        case 'mode':
            // æ›´æ–°ä¸Šæ¬¡æ¸¸æˆæ¨¡å¼
            gameRecords.lastPlayedMode = data.mode;
            break;
        case 'multiplayer':
            // æ›´æ–°å¤šäººæ¸¸æˆæ•°æ®
            gameRecords.multiplayerGamesPlayed++;
            if (data.playerName) {
                gameRecords.playerName = data.playerName;
            }
            break;
        case 'singleplayer':
            // æ›´æ–°å•äººæ¸¸æˆæ•°æ®
            gameRecords.singleplayerGamesPlayed++;
            break;
        case 'playtime':
            // æ›´æ–°æ¸¸æˆæ—¶é—´
            gameRecords.totalPlayTime += data.time;
            break;
    }
    
    // ä¿å­˜æ›´æ–°åçš„è®°å½•
    saveGameRecords();
}


// ç¡®ä¿è¿”å›æŒ‰é’®æ­£å¸¸å·¥ä½œçš„è¾…åŠ©å‡½æ•°
function ensureBackButtonWorks() {
    const multiplayerBackBtn = document.getElementById('multiplayer-back-btn');
    if (multiplayerBackBtn) {
        // ç§»é™¤æ‰€æœ‰ç°æœ‰äº‹ä»¶ç›‘å¬å™¨å¹¶é‡æ–°ç»‘å®š
        const newBackBtn = multiplayerBackBtn.cloneNode(true);
        if (multiplayerBackBtn.parentNode) {
            multiplayerBackBtn.parentNode.replaceChild(newBackBtn, multiplayerBackBtn);
        }
        
        // æ·»åŠ è¿”å›ä¸»èœå•çš„äº‹ä»¶
        newBackBtn.addEventListener('click', () => {
            console.log('ç‚¹å‡»è¿”å›æŒ‰é’®');
            document.getElementById('multiplayer-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
            
            // å¦‚æœè¿æ¥å¤±è´¥ï¼Œå°è¯•æ¸…ç†socketçŠ¶æ€
            if (socket && socket.disconnected) {
                try {
                    socket.removeAllListeners();
                    socket.disconnect();
                } catch (e) {
                    console.error('æ¸…ç†Socketå¤±è´¥:', e);
                }
            }
        });
        
        // æ·»åŠ è§¦æ‘¸äº‹ä»¶ï¼Œç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šä¹Ÿèƒ½å·¥ä½œ
        newBackBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            console.log('è§¦æ‘¸ç‚¹å‡»å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®');
            document.getElementById('multiplayer-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
        
        console.log('å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®äº‹ä»¶å·²é‡æ–°ç»‘å®š');
    } else {
        console.error('æ‰¾ä¸åˆ°å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®');
    }
}


function startMultiplayerGame(gameData) {
    console.log('å¼€å§‹å¤šäººæ¸¸æˆï¼Œæ¸¸æˆæ•°æ®:', gameData);
    
    // é‡ç½®ä¹‹å‰çš„æ¸¸æˆçŠ¶æ€
    resetMultiplayerGameState();
    
    // è®¾ç½®æ¸¸æˆä¸ºå¤šäººæ¨¡å¼
    isMultiplayerGame = true;
    
    // åº”ç”¨æœåŠ¡å™¨å‘é€çš„æ¸¸æˆè®¾ç½®
    if (gameData.gameSettings) {
        settings.gridSize = gameData.gameSettings.gridSize || settings.gridSize;
        console.log('åº”ç”¨ç½‘æ ¼å¤§å°è®¾ç½®:', settings.gridSize);
        
        // å¦‚æœé€Ÿåº¦è®¾ç½®è¢«æ”¹å˜
        if (gameData.gameSettings.gameSpeed) {
            settings.baseSpeed = gameData.gameSettings.gameSpeed;
        }
    }
    
    // é‡æ–°è°ƒæ•´ç”»å¸ƒå¤§å°ä»¥é€‚åº”æ–°çš„ç½‘æ ¼
    resizeCanvas();
    
    // éšè—å•äººæ¸¸æˆUI
    document.getElementById('score-container').style.display = 'none'; // éšè—åˆ†æ•°æ˜¾ç¤º
    document.getElementById('status-display').style.display = 'none'; // éšè—çŠ¶æ€æ˜¾ç¤º

    const deathMessage = document.getElementById('death-message');
    if (deathMessage && deathMessage.parentNode) {
        deathMessage.remove();
    }

    // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å¤æ´»æŒ‰é’®å’Œå€’è®¡æ—¶
    hideRespawnOption();

    // åˆå§‹åŒ–å¤šäººæ¸¸æˆUIå…ƒç´ 
    const multiplayerStatus = document.getElementById('multiplayer-status');
    const chatBox = document.getElementById('multiplayer-chat');
    const gameContainer = document.getElementById('game-container');
    const scoreBoard = document.querySelector('.player-scores');
    
    // è®¾ç½®UIæ˜¾ç¤º
    multiplayerStatus.style.display = 'block';
    chatBox.style.display = 'flex'; // ä½¿ç”¨flexå¸ƒå±€æ›´å¥½æ§åˆ¶å†…éƒ¨å…ƒç´ 
    
    // ç¡®ä¿åˆ†æ•°æ¿é»˜è®¤æ˜¾ç¤º - è¿™æ˜¯å…³é”®ä¿®æ”¹
    scoreBoard.classList.add('show');
    
    // åˆ›å»ºå¤šäººæ¸¸æˆæ§åˆ¶æŒ‰é’®å®¹å™¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    let multiplayerControls = document.getElementById('multiplayer-controls');
    if (!multiplayerControls) {
        multiplayerControls = document.createElement('div');
        multiplayerControls.id = 'multiplayer-controls';
        multiplayerControls.style.position = 'fixed';
        multiplayerControls.style.bottom = '20px';
        multiplayerControls.style.right = '20px';
        multiplayerControls.style.display = 'flex';
        multiplayerControls.style.flexDirection = 'row';
        multiplayerControls.style.gap = '10px';
        multiplayerControls.style.zIndex = '101';
        document.body.appendChild(multiplayerControls);
    } else {
        // æ¸…ç©ºå·²æœ‰çš„æŒ‰é’®
        multiplayerControls.innerHTML = '';
    }
    
    // æ·»åŠ åˆ†æ•°åˆ‡æ¢æŒ‰é’®
    const toggleScoresBtn = document.createElement('button');
    toggleScoresBtn.className = 'toggle-scores-btn';
    toggleScoresBtn.textContent = 'ğŸ†';
    toggleScoresBtn.style.fontSize = '24px';
    toggleScoresBtn.style.padding = '8px 12px';
    toggleScoresBtn.style.borderRadius = '50%';
    toggleScoresBtn.style.width = '40px';
    toggleScoresBtn.style.height = '40px';
    toggleScoresBtn.style.display = 'flex';
    toggleScoresBtn.style.alignItems = 'center';
    toggleScoresBtn.style.justifyContent = 'center';
    toggleScoresBtn.style.background = 'rgba(0, 0, 0, 0.6)';
    toggleScoresBtn.style.color = 'white';
    toggleScoresBtn.style.border = '2px solid rgba(255, 255, 255, 0.3)';
    toggleScoresBtn.style.cursor = 'pointer';
    toggleScoresBtn.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
    toggleScoresBtn.style.transition = 'all 0.2s ease';
    
    toggleScoresBtn.addEventListener('click', () => {
        document.querySelector('.player-scores').classList.toggle('show');
    });
    
    // æ·»åŠ èŠå¤©åˆ‡æ¢æŒ‰é’®
    const toggleChatBtn = document.createElement('button');
    toggleChatBtn.className = 'toggle-chat-btn';
    toggleChatBtn.textContent = 'ğŸ’¬';
    toggleChatBtn.style.fontSize = '24px';
    toggleChatBtn.style.padding = '8px 12px';
    toggleChatBtn.style.borderRadius = '50%';
    toggleChatBtn.style.width = '40px';
    toggleChatBtn.style.height = '40px';
    toggleChatBtn.style.display = 'flex';
    toggleChatBtn.style.alignItems = 'center';
    toggleChatBtn.style.justifyContent = 'center';
    toggleChatBtn.style.background = 'rgba(0, 0, 0, 0.6)';
    toggleChatBtn.style.color = 'white';
    toggleChatBtn.style.border = '2px solid rgba(255, 255, 255, 0.3)';
    toggleChatBtn.style.cursor = 'pointer';
    toggleChatBtn.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
    toggleChatBtn.style.transition = 'all 0.2s ease';
    
    toggleChatBtn.addEventListener('click', () => {
        document.getElementById('multiplayer-chat').classList.toggle('show');
    });
    
    // å°†æŒ‰é’®æ·»åŠ åˆ°å®¹å™¨
    multiplayerControls.appendChild(toggleScoresBtn);
    multiplayerControls.appendChild(toggleChatBtn);
    
    // æ˜¾ç¤ºæ§åˆ¶æŒ‰é’®
    multiplayerControls.style.display = 'flex';
    
    // æ·»åŠ èŠå¤©æ‹–åŠ¨æ‰‹æŸ„
    if (!chatBox.querySelector('.chat-handle')) {
        const chatHandle = document.createElement('div');
        chatHandle.className = 'chat-handle';
        chatBox.prepend(chatHandle);
    }
    
    // é…ç½®è§¦æ‘¸äº‹ä»¶å¤„ç†èŠå¤©é¢æ¿æ»‘åŠ¨
    setupChatSwipeInteraction();
    
    // è®¾ç½®æ¸¸æˆæ¨¡å¼å’Œé€‰é¡¹
    gameState.gameMode = gameData.gameMode || 'classic';
    
    // åˆ›å»ºæ¸¸æˆæ¨¡å¼æ˜¾ç¤º
    const modeDisplay = document.createElement('div');
    modeDisplay.id = 'multiplayer-mode-display';
    modeDisplay.style.position = 'absolute';
    modeDisplay.style.top = '10px';
    modeDisplay.style.left = '50%';
    modeDisplay.style.transform = 'translateX(-50%)';
    modeDisplay.style.background = 'rgba(0, 0, 0, 0.6)';
    modeDisplay.style.padding = '8px 12px';
    modeDisplay.style.borderRadius = '20px';
    modeDisplay.style.fontSize = '16px';
    modeDisplay.style.zIndex = '10';
    
    // æ ¹æ®æ¸¸æˆæ¨¡å¼è®¾ç½®ä¸åŒçš„æ˜¾ç¤ºæ–‡æœ¬
    if (gameData.gameMode === 'classic') {
        modeDisplay.textContent = `æ¨¡å¼: ç»å…¸ (ä¸‰æ¡å‘½)`;
    } else if (gameData.gameMode === 'challenge') {
        modeDisplay.textContent = `æ¨¡å¼: å¤ºå†  (ç›®æ ‡500åˆ†)`;
        console.log('è®¾ç½®ä¸ºå¤ºå† æ¨¡å¼æ˜¾ç¤º');
    } else {
        modeDisplay.textContent = `æ¨¡å¼: ${getModeText(gameData.gameMode)}`;
    }

    gameContainer.appendChild(modeDisplay);
    
    // è®°å½•æ¸¸æˆé€‰é¡¹
    const allowRespawn = gameData.allowRespawn !== undefined ? gameData.allowRespawn : true;
    console.log('æ¸¸æˆæ˜¯å¦å…è®¸é‡ç”Ÿ:', allowRespawn);
    
    // é‡ç½®æœ¬åœ°æ¸¸æˆçŠ¶æ€
    gameState.isPlaying = true;
    gameState.isPaused = false;
    gameState.isGameOver = false;
    gameState.score = 0;
    
    // æ˜¾ç¤ºç©å®¶åˆ†æ•°æ¿
    updateScoreBoard();
    
    // éšè—æ‰€æœ‰èœå•
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('game-lobby').style.display = 'none';
    document.getElementById('game-over').style.display = 'none';
    
    // ç§»é™¤3Dæ•ˆæœ
    canvas.classList.remove('rotate-effect');
    
    // ç¡®ä¿é£Ÿç‰©ä¿¡æ¯å’Œèƒ½åŠ›æç¤ºä¸ä¼šé®æŒ¡æ¸¸æˆåŒºåŸŸ
    const foodInfo = document.getElementById('food-info');
    const powerUpIndicator = document.getElementById('power-up-indicator');
    
    if (foodInfo) {
        foodInfo.style.top = 'calc(100% + 10px)';
        foodInfo.style.bottom = 'auto';
    }
    
    if (powerUpIndicator) {
        powerUpIndicator.style.top = 'calc(100% + 10px)';
        powerUpIndicator.style.bottom = 'auto';
        powerUpIndicator.style.right = '10px';
    }
    
    // æ·»åŠ æ¸¸æˆåŒºåŸŸè¾¹ç•Œçº¿ï¼Œå¸®åŠ©ç©å®¶è¯†åˆ«æ¸¸æˆè¾¹ç•Œ
    const borderStyle = document.createElement('style');
    borderStyle.textContent = `
        #game-canvas {
            border: 2px solid rgba(0, 255, 150, 0.5);
            box-sizing: border-box;
        }
    `;
    document.head.appendChild(borderStyle);
    
    // å¼€å§‹æ¸¸æˆå¾ªç¯(åªè´Ÿè´£æ¸²æŸ“ï¼Œé€»è¾‘ç”±æœåŠ¡å™¨å¤„ç†)
    if (gameState.animationFrame) {
        cancelAnimationFrame(gameState.animationFrame);
    }
    gameState.lastFrameTime = 0;
    gameState.animationFrame = requestAnimationFrame(multiplayerGameLoop);
    
    console.log('å¤šäººæ¸¸æˆUIå·²è°ƒæ•´ï¼Œé˜²æ­¢é®æŒ¡æ¸¸æˆåŒºåŸŸ');
}



function setupChatSwipeInteraction() {
    const chatBox = document.getElementById('multiplayer-chat');
    const chatHandle = chatBox.querySelector('.chat-handle');
    
    if (!chatHandle) return;
    
    let startY = 0;
    let currentY = 0;
    
    // å¤„ç†è§¦æ‘¸å¼€å§‹
    chatHandle.addEventListener('touchstart', function(e) {
        startY = e.touches[0].clientY;
        chatBox.style.transition = 'none';
    });
    
    // å¤„ç†è§¦æ‘¸ç§»åŠ¨
    chatHandle.addEventListener('touchmove', function(e) {
        currentY = e.touches[0].clientY;
        const deltaY = currentY - startY;
        
        // ä¸‹æ‹‰æ—¶æ˜¾ç¤ºï¼Œä¸Šæ¨æ—¶éšè—
        if (deltaY < 0) {
            // å‘ä¸Šæ»‘åŠ¨ï¼Œæ˜¾ç¤ºèŠå¤©
            chatBox.classList.add('show');
        } else if (deltaY > 50) {
            // å‘ä¸‹æ»‘åŠ¨è¶…è¿‡é˜ˆå€¼ï¼Œéšè—èŠå¤©
            chatBox.classList.remove('show');
        }
    });
    
    // å¤„ç†è§¦æ‘¸ç»“æŸ
    chatHandle.addEventListener('touchend', function() {
        chatBox.style.transition = 'transform 0.3s ease';
    });
}


// å¤šäººæ¸¸æˆå¾ªç¯
function multiplayerGameLoop(timestamp) {
    // å¦‚æœæ¸¸æˆçŠ¶æ€å·²ç»ä¸æ˜¯å¤šäººæ¸¸æˆï¼Œåœæ­¢å¾ªç¯
    if (!isMultiplayerGame || !gameState.isPlaying) {
        console.log('å¤šäººæ¸¸æˆå·²åœæ­¢ï¼Œç»“æŸæ¸²æŸ“å¾ªç¯');
        return;
    }
    
    if (!gameState.lastFrameTime) gameState.lastFrameTime = timestamp;
    
    const deltaTime = timestamp - gameState.lastFrameTime;
    
    if (!gameState.isPaused) {
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
        if (settings.gridEnabled) {
            drawGrid();
        }
        
        // éªŒè¯å¤šäººæ¸¸æˆçŠ¶æ€æ˜¯å¦å­˜åœ¨
        if (!multiplayerGameState) {
            console.log('è­¦å‘Š: å¤šäººæ¸¸æˆçŠ¶æ€ç¼ºå¤±');
            requestAnimationFrame(multiplayerGameLoop);
            return;
        }
        
        // æ£€æŸ¥cellSizeæ˜¯å¦æœ‰æ•ˆ
        if (!cellSize || cellSize <= 0) {
            console.error('è­¦å‘Š: multiplayerGameLoopä¸­cellSizeæ— æ•ˆ:', cellSize);
            resizeCanvas();
        }
        
        // ç»˜åˆ¶ä»æœåŠ¡å™¨æ¥æ”¶çš„æ¸¸æˆçŠ¶æ€
        drawMultiplayerGame();
    }
    
    gameState.lastFrameTime = timestamp;
    
    // å¦‚æœæ¸¸æˆä»åœ¨è¿›è¡Œä¸­ï¼Œç»§ç»­åŠ¨ç”»å¾ªç¯
    if (isMultiplayerGame && gameState.isPlaying) {
        gameState.animationFrame = requestAnimationFrame(multiplayerGameLoop);
    }
}



// æ›´æ–°å¤šäººæ¸¸æˆçŠ¶æ€
// ç¡®ä¿updateMultiplayerGameStateå‡½æ•°æ­£ç¡®ä¿å­˜ä¼ é€é—¨æ•°æ®
function updateMultiplayerGameState(newState) {
    // æ›´æ–°æœ¬åœ°æ¸¸æˆçŠ¶æ€
    multiplayerGameState = newState;
    
    // ç¡®ä¿æ¸¸æˆæ¨¡å¼ä¹Ÿæ›´æ–°
    if (newState && newState.gameMode) {
        gameState.gameMode = newState.gameMode;
        
        // æ›´æ–°æ¨¡å¼æ˜¾ç¤º
        const modeDisplay = document.getElementById('multiplayer-mode-display');
        if (modeDisplay) {
            if (newState.gameMode === 'classic') {
                modeDisplay.textContent = `æ¨¡å¼: ç»å…¸ (ä¸‰æ¡å‘½)`;
            } else if (newState.gameMode === 'challenge') {
                modeDisplay.textContent = `æ¨¡å¼: å¤ºå†  (ç›®æ ‡500åˆ†)`;
            } else {
                modeDisplay.textContent = `æ¨¡å¼: ${getModeText(newState.gameMode)}`;
            }
        }
    }
    
    // ç¡®ä¿ç½‘æ ¼å¤§å°æ­£ç¡®
    if (newState && newState.gridSize && newState.gridSize !== settings.gridSize) {
        console.log('ä»æœåŠ¡å™¨æ›´æ–°ç½‘æ ¼å¤§å°:', newState.gridSize);
        settings.gridSize = newState.gridSize;
        resizeCanvas();
    }
    
    // ä¿å­˜ä¼ é€é—¨ä¿¡æ¯
    if (newState && newState.portals) {
        multiplayerGameState.portals = newState.portals;
        multiplayerGameState.portalExpireTime = newState.portalExpireTime;
    }
    
    // æ£€æŸ¥cellSizeæ˜¯å¦æœ‰æ•ˆ
    if (!cellSize || cellSize <= 0) {
        console.error('è­¦å‘Š: updateMultiplayerGameStateåcellSizeæ— æ•ˆ:', cellSize);
        resizeCanvas();
    }
    
    // æ›´æ–°ç©å®¶åˆ†æ•°
    updateScoreBoard();
    
    // æ·»åŠ è°ƒè¯•æ—¥å¿—
    if (newState) {
        console.log('æ”¶åˆ°å¤šäººæ¸¸æˆçŠ¶æ€æ›´æ–°:', 
                  'ç½‘æ ¼å¤§å°:', newState.gridSize,
                  'éšœç¢ç‰©:', (newState.obstacles || []).length,
                  'é£Ÿç‰©:', (newState.foods || []).length, 
                  'ç©å®¶:', (newState.players || []).length,
                  'æ¸¸æˆæ¨¡å¼:', newState.gameMode,
                  'ä¼ é€é—¨:', (newState.portals || []).length);
    } else {
        console.warn('æ”¶åˆ°ç©ºçš„æ¸¸æˆçŠ¶æ€æ›´æ–°');
    }
}




// ç»˜åˆ¶å¤šäººæ¸¸æˆ
// ä¿®æ”¹drawMultiplayerGameå‡½æ•°æ·»åŠ ä¼ é€é—¨ç»˜åˆ¶ - å®Œæ•´å‡½æ•°
function drawMultiplayerGame() {
    if (!multiplayerGameState) {
        console.log('æ— å¤šäººæ¸¸æˆçŠ¶æ€å¯ç»˜åˆ¶');
        return;
    }
    
    // æ£€æŸ¥cellSizeæ˜¯å¦å·²æ­£ç¡®åˆå§‹åŒ–
    if (!cellSize || cellSize <= 0) {
        console.error('é”™è¯¯: cellSizeæœªæ­£ç¡®åˆå§‹åŒ–:', cellSize);
        // å°è¯•é‡æ–°è®¡ç®—
        resizeCanvas();
        return;
    }
    
    console.log('ç»˜åˆ¶å¤šäººæ¸¸æˆçŠ¶æ€ï¼Œä½¿ç”¨cellSize:', cellSize,
                'éšœç¢ç‰©:', (multiplayerGameState.obstacles || []).length,
                'é£Ÿç‰©:', (multiplayerGameState.foods || []).length, 
                'ç©å®¶:', (multiplayerGameState.players || []).length);
    
    // ç¡®ä¿ç½‘æ ¼å°ºå¯¸ä¸æœåŠ¡å™¨åŒ¹é…
    if (multiplayerGameState.gridSize && multiplayerGameState.gridSize !== settings.gridSize) {
        settings.gridSize = multiplayerGameState.gridSize;
        console.log('æ›´æ–°ç½‘æ ¼å°ºå¯¸ä¸º:', settings.gridSize);
        resizeCanvas();
    }
    
    // ç»˜åˆ¶éšœç¢ç‰©
    if (multiplayerGameState.obstacles && Array.isArray(multiplayerGameState.obstacles)) {
        multiplayerGameState.obstacles.forEach(obstacle => {
            if (obstacle && typeof obstacle.x === 'number' && typeof obstacle.y === 'number') {
                drawMultiplayerObstacle(obstacle);
            } else {
                console.warn('è·³è¿‡æ— æ•ˆçš„éšœç¢ç‰©:', obstacle);
            }
        });
    }
    
    // ç»˜åˆ¶ä¼ é€é—¨ - æ–°å¢ä¼ é€é—¨ç»˜åˆ¶
    if (multiplayerGameState.portals && Array.isArray(multiplayerGameState.portals)) {
        drawPortals();
    }
    
    // ç»˜åˆ¶é£Ÿç‰©
    if (multiplayerGameState.foods && Array.isArray(multiplayerGameState.foods)) {
        multiplayerGameState.foods.forEach(food => {
            if (food && typeof food.x === 'number' && typeof food.y === 'number') {
                drawMultiplayerFood(food);
            } else {
                console.warn('è·³è¿‡æ— æ•ˆçš„é£Ÿç‰©:', food);
            }
        });
    } else if (multiplayerGameState.food && Array.isArray(multiplayerGameState.food)) {
        // å°è¯•æ›¿ä»£å­—æ®µå
        multiplayerGameState.food.forEach(food => {
            if (food && typeof food.x === 'number' && typeof food.y === 'number') {
                drawMultiplayerFood(food);
            } else {
                console.warn('è·³è¿‡æ— æ•ˆçš„é£Ÿç‰©:', food);
            }
        });
    }
    
    // ç»˜åˆ¶æ‰€æœ‰ç©å®¶çš„è›‡
    if (multiplayerGameState.players && Array.isArray(multiplayerGameState.players)) {
        multiplayerGameState.players.forEach(player => {
            if (!player.isAlive) return;
            if (player.snake && player.snake.segments && player.snake.segments.length > 0) {
                drawMultiplayerSnake(player);
            } else {
                console.warn('è·³è¿‡æ— æ•ˆçš„ç©å®¶è›‡:', player.id);
            }
        });
    }
}


// ç»˜åˆ¶å¤šäººæ¸¸æˆä¸­çš„éšœç¢ç‰©
function drawMultiplayerObstacle(obstacle) {
    if (!obstacle || typeof obstacle.x !== 'number' || typeof obstacle.y !== 'number') {
        console.log('æ— æ•ˆçš„éšœç¢ç‰©æ•°æ®:', obstacle);
        return;
    }
    
    // æ£€æŸ¥cellSizeæ˜¯å¦æœ‰æ•ˆ
    if (!cellSize || cellSize <= 0) {
        console.error('cellSizeæ— æ•ˆ:', cellSize);
        return;
    }
    
    const padding = cellSize * 0.1;
    const x = obstacle.x * cellSize + padding;
    const y = obstacle.y * cellSize + padding;
    const size = cellSize - padding * 2;
    
    // æ·»åŠ å‘å…‰æ•ˆæœ
    ctx.shadowColor = '#ff0066';
    ctx.shadowBlur = 10;
    
    // ç»˜åˆ¶éšœç¢ç‰©ä¸»ä½“
    ctx.fillStyle = '#ad1457';
    ctx.fillRect(x, y, size, size);
    
    // ç»˜åˆ¶éšœç¢ç‰©å›¾æ¡ˆ (è­¦å‘Šæ ‡å¿—)
    ctx.fillStyle = '#ffeb3b';
    ctx.beginPath();
    
    // ä¸‰è§’å½¢è­¦å‘Šæ ‡å¿—
    ctx.moveTo(x + size/2, y + size/4);
    ctx.lineTo(x + size/4, y + size*3/4);
    ctx.lineTo(x + size*3/4, y + size*3/4);
    ctx.closePath();
    ctx.fill();
    
    // å†…éƒ¨æ„Ÿå¹å·
    ctx.fillStyle = '#ad1457';
    ctx.fillRect(x + size/2 - size/10, y + size/2 - size/10, size/5, size/5);
    ctx.fillRect(x + size/2 - size/10, y + size*2/3 - size/10, size/5, size/5);
    
    // é‡ç½®é˜´å½±
    ctx.shadowBlur = 0;
}

// ç»˜åˆ¶å¤šäººæ¸¸æˆä¸­çš„é£Ÿç‰©
function drawMultiplayerFood(food) {
    if (!food || typeof food.x !== 'number' || typeof food.y !== 'number') {
        console.log('æ— æ•ˆçš„é£Ÿç‰©æ•°æ®:', food);
        return;
    }
    
    // æ£€æŸ¥cellSizeæ˜¯å¦æœ‰æ•ˆ
    if (!cellSize || cellSize <= 0) {
        console.error('cellSizeæ— æ•ˆ:', cellSize);
        return;
    }
    
    const foodTypes = {
        'red': { color: '#ff3333', borderColor: '#cc0000' },
        'yellow': { color: '#ffcc00', borderColor: '#cc9900' },
        'green': { color: '#33cc33', borderColor: '#009900' },
        'blue': { color: '#3399ff', borderColor: '#0066cc' },
        'purple': { color: '#9933ff', borderColor: '#6600cc' }
    };
    
    const foodInfo = foodTypes[food.type] || foodTypes.red;
    
    // è®¡ç®—è„‰åŠ¨æ•ˆæœ
    const pulsePhase = (Date.now() / 200) % (Math.PI * 2);
    const scale = 1 + Math.sin(pulsePhase) * 0.1;
    const centerX = (food.x + 0.5) * cellSize;
    const centerY = (food.y + 0.5) * cellSize;
    const radius = cellSize * 0.4 * scale;
    
    // ç»˜åˆ¶é£Ÿç‰©
    ctx.save();
    
    // é—ªå…‰æ•ˆæœ
    ctx.shadowColor = foodInfo.color;
    ctx.shadowBlur = 10;
    
    // ä¸»ä½“
    ctx.fillStyle = foodInfo.color;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fill();
    
    // è¾¹æ¡†
    ctx.strokeStyle = foodInfo.borderColor;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.stroke();
    
    // å†…éƒ¨è£…é¥°
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.beginPath();
    ctx.arc(centerX - radius * 0.3, centerY - radius * 0.3, radius * 0.2, 0, Math.PI * 2);
    ctx.fill();
    
    ctx.restore();
}


// ç»˜åˆ¶å¤šäººæ¸¸æˆä¸­çš„è›‡
function drawMultiplayerSnake(player) {
    if (!player.snake || !player.snake.segments || !Array.isArray(player.snake.segments)) {
        console.log('æ— æ•ˆçš„è›‡æ•°æ®:', player);
        return;
    }
    
    // æ£€æŸ¥cellSizeæ˜¯å¦æœ‰æ•ˆ
    if (!cellSize || cellSize <= 0) {
        console.error('cellSizeæ— æ•ˆ:', cellSize);
        return;
    }
    
    const isCurrentPlayer = player.id === playerId;
    
    // ç»˜åˆ¶è›‡èº«ä½“
    player.snake.segments.forEach((segment, index) => {
        if (!segment || typeof segment.x !== 'number' || typeof segment.y !== 'number') {
            return; // è·³è¿‡æ— æ•ˆçš„æ®µ
        }
        
        const isHead = index === 0;
        
        // è®¡ç®—é¢œè‰²
        let color;
        if (isHead) {
            color = player.powerUpActive ? 
                (player.powerUpType === 'phase' ? '#00E5FF' : '#E040FB') : 
                player.color || '#00E676';
        } else {
            // èº«ä½“é¢œè‰²æ¸å˜
            const baseHue = hexToHsl(player.color || '#00E676')[0];
            const hue = player.powerUpActive ? 
                (player.powerUpType === 'phase' ? 180 : 280) : 
                baseHue - (index / player.snake.segments.length * 40);
            const saturation = 80 - (index / player.snake.segments.length * 30);
            const lightness = 60 - (index / player.snake.segments.length * 20);
            color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }
        
        // ç»˜åˆ¶èº«ä½“æ®µ
        const x = segment.x * cellSize;
        const y = segment.y * cellSize;
        const radius = isHead ? cellSize * 0.45 : cellSize * 0.35;
        
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(
            x + cellSize / 2,
            y + cellSize / 2,
            radius,
            0,
            Math.PI * 2
        );
        ctx.fill();
        
        // å¦‚æœæ˜¯å¤´éƒ¨ï¼Œæ·»åŠ çœ¼ç›
        if (isHead) {
            drawMultiplayerSnakeEyes(segment, player.snake.direction || 'right');
        }
    });
    
    // ä¸ºå½“å‰ç©å®¶æ·»åŠ åç§°æ ‡ç­¾
    if (player.snake.segments.length > 0 && player.name) {
        const head = player.snake.segments[0];
        ctx.fillStyle = 'white';
        ctx.font = 'bold 12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(
            player.name,
            (head.x + 0.5) * cellSize,
            head.y * cellSize - 5
        );
    }
}

// ç»˜åˆ¶å¤šäººæ¸¸æˆä¸­çš„è›‡çœ¼ç›
function drawMultiplayerSnakeEyes(head, direction) {
    const eyeSize = cellSize * 0.15;
    const eyeDistance = cellSize * 0.18;
    
    // æ ¹æ®æ–¹å‘è°ƒæ•´çœ¼ç›ä½ç½®
    let leftEyePos, rightEyePos;
    const centerX = (head.x + 0.5) * cellSize;
    const centerY = (head.y + 0.5) * cellSize;
    
    switch (direction) {
        case 'up':
            leftEyePos = {x: centerX - eyeDistance, y: centerY - eyeDistance};
            rightEyePos = {x: centerX + eyeDistance, y: centerY - eyeDistance};
            break;
        case 'down':
            leftEyePos = {x: centerX - eyeDistance, y: centerY + eyeDistance};
            rightEyePos = {x: centerX + eyeDistance, y: centerY + eyeDistance};
            break;
        case 'left':
            leftEyePos = {x: centerX - eyeDistance, y: centerY - eyeDistance};
            rightEyePos = {x: centerX - eyeDistance, y: centerY + eyeDistance};
            break;
        case 'right':
            leftEyePos = {x: centerX + eyeDistance, y: centerY - eyeDistance};
            rightEyePos = {x: centerX + eyeDistance, y: centerY + eyeDistance};
            break;
        default:
            leftEyePos = {x: centerX - eyeDistance, y: centerY - eyeDistance};
            rightEyePos = {x: centerX + eyeDistance, y: centerY - eyeDistance};
    }
    
    // ç»˜åˆ¶çœ¼ç›
    ctx.fillStyle = 'white';
    ctx.beginPath();
    ctx.arc(leftEyePos.x, leftEyePos.y, eyeSize, 0, Math.PI * 2);
    ctx.arc(rightEyePos.x, rightEyePos.y, eyeSize, 0, Math.PI * 2);
    ctx.fill();
    
    // ç»˜åˆ¶ç³å­”
    const pupilOffset = eyeSize * 0.4;
    const pupilSize = eyeSize * 0.6;
    
    // è®¡ç®—ç³å­”ä½ç½®åç§»(æ ¹æ®æ–¹å‘)
    let pupilOffsetX = 0, pupilOffsetY = 0;
    switch (direction) {
        case 'up': pupilOffsetY = -pupilOffset; break;
        case 'down': pupilOffsetY = pupilOffset; break;
        case 'left': pupilOffsetX = -pupilOffset; break;
        case 'right': pupilOffsetX = pupilOffset; break;
    }
    
    ctx.fillStyle = 'black';
    ctx.beginPath();
    ctx.arc(
        leftEyePos.x + pupilOffsetX, 
        leftEyePos.y + pupilOffsetY, 
        pupilSize, 
        0, 
        Math.PI * 2
    );
    ctx.arc(
        rightEyePos.x + pupilOffsetX, 
        rightEyePos.y + pupilOffsetY, 
        pupilSize, 
        0, 
        Math.PI * 2
    );
    ctx.fill();
}



// æ›´æ–°ç©å®¶åˆ—è¡¨
function updatePlayerList() {
    const playerList = document.getElementById('player-list');
    playerList.innerHTML = '';
    
    connectedPlayers.forEach(player => {
        const li = document.createElement('li');
        
        // æ ‡è®°å½“å‰ç©å®¶
        if (player.id === playerId) {
            li.classList.add('current-player');
        }
        
        // åˆ›å»ºç©å®¶åç§°å…ƒç´ 
        const nameSpan = document.createElement('span');
        nameSpan.textContent = player.name;
        li.appendChild(nameSpan);
        
        // æ·»åŠ ä¸»æœºæ ‡è®°
        if (player.isHost) {
            const hostIcon = document.createElement('span');
            hostIcon.className = 'host-indicator';
            hostIcon.textContent = ' ğŸ‘‘ æˆ¿ä¸»';
            li.appendChild(hostIcon);
        }
        
        playerList.appendChild(li);
        
        // åªæœ‰æˆ¿ä¸»å¯ä»¥çœ‹åˆ°å¼€å§‹æ¸¸æˆæŒ‰é’®
        document.getElementById('start-game-btn').style.display = 
            (playerId === connectedPlayers.find(p => p.isHost)?.id) ? 'block' : 'none';
    });
    
    // æ£€æŸ¥å¹¶æ›´æ–°å½“å‰ç©å®¶æ˜¯å¦æ˜¯æˆ¿ä¸»
    isHost = connectedPlayers.some(p => p.id === playerId && p.isHost);
    
    // æ›´æ–°è®¾ç½®é¢æ¿å¯è§æ€§
    updateSettingsVisibility();
}


// æ›´æ–°åˆ†æ•°æ¿
function updateScoreBoard() {
    if (!multiplayerGameState || !multiplayerGameState.players) return;
    
    const scoreBoard = document.querySelector('.player-scores');
    scoreBoard.innerHTML = '';
    
    // ç¡®ä¿åˆ†æ•°æ¿æœ‰æ­£ç¡®çš„ç±»
    if (!scoreBoard.classList.contains('show')) {
        // åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šé»˜è®¤éšè—åˆ†æ•°æ¿
        scoreBoard.classList.remove('show');
    }
    
    // è·å–å½“å‰æ¸¸æˆæ¨¡å¼
    const gameMode = multiplayerGameState.gameMode || 'classic';
    
    // æŒ‰åˆ†æ•°æ’åº
    const sortedPlayers = [...multiplayerGameState.players].sort((a, b) => b.score - a.score);
    
    sortedPlayers.forEach(player => {
        const scoreDiv = document.createElement('div');
        scoreDiv.className = 'player-score';
        
        // ä¸ºå½“å‰ç©å®¶æ·»åŠ æ ‡è®°
        if (player.id === playerId) {
            scoreDiv.classList.add('current-player');
        }
        
        // æ·»åŠ ç”Ÿå­˜çŠ¶æ€æŒ‡ç¤º
        let statusMark = player.isAlive ? 'ğŸŸ¢' : 'ğŸ”´';
        if (player.isRespawning) {
            statusMark = 'ğŸŸ¡'; // é»„è‰²è¡¨ç¤ºå¤æ´»ä¸­
        }
        
        // æ·»åŠ ç”Ÿå‘½å€¼æ˜¾ç¤ºï¼ˆä»…åœ¨ç»å…¸æ¨¡å¼ä¸‹ï¼‰
        let livesMark = '';
        if (gameMode === 'classic' && player.snake && typeof player.snake.lives === 'number') {
            livesMark = ` â¤ï¸Ã—${player.snake.lives}`;
        }
        
        // æ·»åŠ èƒ½åŠ›é“å…·æŒ‡ç¤º
        let powerUpMark = '';
        if (player.powerUpActive) {
            powerUpMark = player.powerUpType === 'phase' ? ' ğŸšª' : ' ğŸ›¡ï¸';
        }
        
        // æ·»åŠ åˆ†æ•°ç¿»å€æŒ‡ç¤º
        let multiplierMark = '';
        if (player.scoreMultiplierActive) {
            multiplierMark = ' ğŸ’°Ã—2';
            scoreDiv.style.color = '#ffcc00'; // ä½¿ç”¨é»„è‰²çªå‡ºæ˜¾ç¤ºæœ‰ç¿»å€æ•ˆæœçš„ç©å®¶
        }
        
        scoreDiv.innerHTML = `${statusMark} ${player.name}: ${player.score}${livesMark}${powerUpMark}${multiplierMark}`;
        
        // è®¾ç½®é¢œè‰²æŒ‡ç¤º
        scoreDiv.style.borderLeft = `3px solid ${player.color || '#00E676'}`;
        
        scoreBoard.appendChild(scoreDiv);
    });
}


// æ·»åŠ èŠå¤©æ¶ˆæ¯
function addChatMessage(message, type, senderId = null) {
    const chatMessages = document.querySelector('.chat-messages');
    const messageDiv = document.createElement('div');
    
    if (type === 'system') {
    // åˆ›å»ºé¡¶éƒ¨é€šçŸ¥
    const notification = document.createElement('div');
    notification.className = 'system-notification';
    notification.textContent = message;
    
    // å°†é€šçŸ¥æ·»åŠ åˆ°ä¸“é—¨çš„é€šçŸ¥å®¹å™¨ä¸­
    let notificationContainer = document.getElementById('notification-container');
    if (!notificationContainer) {
        // å¦‚æœå®¹å™¨ä¸å­˜åœ¨ï¼Œåˆ›å»ºä¸€ä¸ª
        notificationContainer = document.createElement('div');
        notificationContainer.id = 'notification-container';
        notificationContainer.style.position = 'fixed';
        notificationContainer.style.top = '10px';
        notificationContainer.style.left = '0';
        notificationContainer.style.right = '0';
        notificationContainer.style.display = 'flex';
        notificationContainer.style.flexDirection = 'column';
        notificationContainer.style.alignItems = 'center';
        notificationContainer.style.zIndex = '50';
        notificationContainer.style.pointerEvents = 'none'; // ç¡®ä¿ä¸ä¼šé˜»æ­¢ç‚¹å‡»
        document.body.appendChild(notificationContainer);
    }
    
    // è®¾ç½®é€šçŸ¥æ ·å¼
    notification.style.background = 'rgba(0, 0, 0, 0.7)';
    notification.style.color = 'white';
    notification.style.padding = '8px 15px';
    notification.style.borderRadius = '20px';
    notification.style.margin = '5px';
    notification.style.maxWidth = '80%';
    notification.style.textAlign = 'center';
    notification.style.boxShadow = '0 0 10px rgba(0, 0, 0, 0.3)';
    notification.style.transform = 'translateY(-20px)';
    notification.style.opacity = '0';
    notification.style.transition = 'transform 0.3s, opacity 0.3s';
    
    // æ·»åŠ é€šçŸ¥
    notificationContainer.appendChild(notification);
    
    // è§¦å‘åŠ¨ç”»æ•ˆæœ
    setTimeout(() => {
        notification.style.transform = 'translateY(0)';
        notification.style.opacity = '1';
    }, 10);
    
    // åŠ¨ç”»ç»“æŸåè‡ªåŠ¨ç§»é™¤é€šçŸ¥
    setTimeout(() => {
        notification.style.transform = 'translateY(-20px)';
        notification.style.opacity = '0';
        setTimeout(() => {
            notification.remove();
        }, 300);
    }, 2500);
    
    // åŒæ—¶åœ¨èŠå¤©åŒºåŸŸæ·»åŠ æ¶ˆæ¯
    messageDiv.className = 'game-message system-message';
    messageDiv.textContent = message;
} else {
        messageDiv.className = 'game-message chat-message';
        
        // å¦‚æœæ˜¯å½“å‰ç©å®¶çš„æ¶ˆæ¯ï¼Œæ·»åŠ æ ·å¼
        if (senderId === playerId) {
            messageDiv.classList.add('my-message');
        }
        
        messageDiv.innerHTML = message;
    }
    
    chatMessages.appendChild(messageDiv);
    chatMessages.scrollTop = chatMessages.scrollHeight;
}


// æ˜¾ç¤ºå¤æ´»å€’è®¡æ—¶
function showRespawnOption() {
    // åˆ›å»ºå¤æ´»æç¤ºè€Œä¸æ˜¯æŒ‰é’®
    const container = document.getElementById('game-container');
    
    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨å¤æ´»æç¤º
    if (document.getElementById('respawn-message')) return;
    
    const respawnMessage = document.createElement('div');
    respawnMessage.id = 'respawn-message';
    respawnMessage.className = 'respawn-message';
    respawnMessage.textContent = 'å¤æ´»å€’è®¡æ—¶: 3...';
    
    // è®¾ç½®æ ·å¼
    respawnMessage.style.position = 'absolute';
    respawnMessage.style.top = '50%';
    respawnMessage.style.left = '50%';
    respawnMessage.style.transform = 'translate(-50%, -50%)';
    respawnMessage.style.padding = '15px 30px';
    respawnMessage.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
    respawnMessage.style.color = '#4CAF50';
    respawnMessage.style.borderRadius = '10px';
    respawnMessage.style.fontSize = '24px';
    respawnMessage.style.fontWeight = 'bold';
    respawnMessage.style.zIndex = '999';
    respawnMessage.style.boxShadow = '0 0 20px rgba(0, 255, 0, 0.5)';
    respawnMessage.style.animation = 'pulse 1.5s infinite';
    respawnMessage.style.pointerEvents = 'none'; // ç¡®ä¿ä¸ä¼šå¹²æ‰°ç‚¹å‡»äº‹ä»¶
    
    container.appendChild(respawnMessage);
    
    // åˆ›å»ºå€’è®¡æ—¶åŠ¨ç”»
    let countdown = 3;
    const countdownInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) {
            respawnMessage.textContent = `å¤æ´»å€’è®¡æ—¶: ${countdown}...`;
        } else {
            respawnMessage.textContent = 'æ­£åœ¨å¤æ´»...';
            clearInterval(countdownInterval);
            
            // 3ç§’åè‡ªåŠ¨ç§»é™¤æ¶ˆæ¯
            setTimeout(() => {
                hideRespawnOption();
            }, 500);
        }
    }, 1000);
    
    // å°†å€’è®¡æ—¶é—´éš”IDå­˜å‚¨åˆ°å…ƒç´ ä¸Šï¼Œä»¥ä¾¿åç»­æ¸…é™¤
    respawnMessage.dataset.intervalId = countdownInterval;
}



// éšè—å¤æ´»å€’è®¡æ—¶
function hideRespawnOption() {
    const respawnMessage = document.getElementById('respawn-message');
    if (respawnMessage) {
        // æ¸…é™¤å¯èƒ½çš„å€’è®¡æ—¶è®¡æ—¶å™¨
        if (respawnMessage.dataset.intervalId) {
            clearInterval(parseInt(respawnMessage.dataset.intervalId));
        }
        
        // æ·»åŠ æ·¡å‡ºåŠ¨ç”»
        respawnMessage.style.opacity = '0';
        respawnMessage.style.transition = 'opacity 0.3s ease';
        
        // åŠ¨ç”»ç»“æŸåç§»é™¤å…ƒç´ 
        setTimeout(() => {
            if (respawnMessage.parentNode) {
                respawnMessage.remove();
            }
        }, 300);
    }
    
    // ç§»é™¤æ­»äº¡æ¶ˆæ¯æç¤º
    const deathMessage = document.getElementById('death-message');
    if (deathMessage) {
        deathMessage.style.opacity = '0';
        deathMessage.style.transition = 'opacity 0.3s ease';
        
        setTimeout(() => {
            if (deathMessage.parentNode) {
                deathMessage.remove();
            }
        }, 300);
    }
}



// è®¾ç½®æ¸¸æˆå¤§å…ç•Œé¢äº‹ä»¶
function setupLobbyEvents() {
    console.log('è®¾ç½®æ¸¸æˆå¤§å…ç•Œé¢äº‹ä»¶');
    
    // ç½‘æ ¼å¤§å°è®¾ç½®å®æ—¶æ›´æ–°
    const gridSizeSetting = document.getElementById('grid-size-setting');
    const gridSizeValue = document.getElementById('grid-size-value');
    if (gridSizeSetting && gridSizeValue) {
        // å…‹éš†å¹¶æ›¿æ¢å…ƒç´ ä»¥æ¸…é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
        const newGridSizeSetting = gridSizeSetting.cloneNode(true);
        gridSizeSetting.parentNode.replaceChild(newGridSizeSetting, gridSizeSetting);
        
        newGridSizeSetting.addEventListener('input', () => {
            gridSizeValue.textContent = newGridSizeSetting.value;
        });
    }

    // é£Ÿç‰©æ•°é‡è®¾ç½®å®æ—¶æ›´æ–°
    const foodCountSetting = document.getElementById('food-count-setting');
    const foodCountValue = document.getElementById('food-count-value');
    if (foodCountSetting && foodCountValue) {
        // å…‹éš†å¹¶æ›¿æ¢å…ƒç´ ä»¥æ¸…é™¤ç°æœ‰äº‹ä»¶ç›‘å¬å™¨
        const newFoodCountSetting = foodCountSetting.cloneNode(true);
        foodCountSetting.parentNode.replaceChild(newFoodCountSetting, foodCountSetting);
        
        newFoodCountSetting.addEventListener('input', () => {
            foodCountValue.textContent = newFoodCountSetting.value;
        });
    }

    // æ¸¸æˆé€Ÿåº¦è®¾ç½®
    const gameSpeedSetting = document.getElementById('game-speed-setting');
    if (gameSpeedSetting) {
        const newGameSpeedSetting = gameSpeedSetting.cloneNode(true);
        gameSpeedSetting.parentNode.replaceChild(newGameSpeedSetting, gameSpeedSetting);
    }

    // éšœç¢ç‰©å¯†åº¦è®¾ç½®
    const obstacleDensitySetting = document.getElementById('obstacle-density-setting');
    if (obstacleDensitySetting) {
        const newObstacleDensitySetting = obstacleDensitySetting.cloneNode(true);
        obstacleDensitySetting.parentNode.replaceChild(newObstacleDensitySetting, obstacleDensitySetting);
    }

    // èƒ½åŠ›é“å…·è®¾ç½®
    const powerUpsSetting = document.getElementById('power-ups-setting');
    if (powerUpsSetting) {
        const newPowerUpsSetting = powerUpsSetting.cloneNode(true);
        powerUpsSetting.parentNode.replaceChild(newPowerUpsSetting, powerUpsSetting);
    }

    // æ¸¸æˆæ¨¡å¼è®¾ç½®
    const gameModeSelect = document.getElementById('game-mode-setting');
    if (gameModeSelect) {
        const newGameModeSelect = gameModeSelect.cloneNode(true);
        gameModeSelect.parentNode.replaceChild(newGameModeSelect, gameModeSelect);
    }
    
    // ç»Ÿä¸€çš„æ–¹å¼å¤„ç†æ‰€æœ‰æ¨¡å¼ä¿¡æ¯æŒ‰é’®
    setupModeInfoButtons();
    
    // è®¾ç½®å¤§å…å†…è®¾ç½®é¢æ¿åˆ‡æ¢äº‹ä»¶
    setupLobbySettingsToggle();

    console.log('æ¸¸æˆå¤§å…ç•Œé¢äº‹ä»¶è®¾ç½®å®Œæˆ');
}


// æ–°å¢å‡½æ•°ï¼Œç»Ÿä¸€å¤„ç†æ‰€æœ‰æ¨¡å¼ä¿¡æ¯æŒ‰é’®
function setupModeInfoButtons() {
    // ç§»é™¤æ‰€æœ‰ç°æœ‰çš„æ¨¡å¼ä¿¡æ¯æŒ‰é’®äº‹ä»¶ç›‘å¬å™¨
    const allModeInfoBtns = document.querySelectorAll('.mode-info-btn');
    
    allModeInfoBtns.forEach(btn => {
        // å…‹éš†æŒ‰é’®ä»¥ç§»é™¤æ‰€æœ‰äº‹ä»¶ç›‘å¬å™¨
        const newBtn = btn.cloneNode(true);
        if (btn.parentNode) {
            btn.parentNode.replaceChild(newBtn, btn);
        }
        
        // ä¸ºæ–°æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        newBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡
            
            // è·å–å½“å‰é€‰æ‹©çš„æ¸¸æˆæ¨¡å¼
            let selectedMode = 'classic';
            const settingSelect = this.closest('.setting-item')?.querySelector('select');
            if (settingSelect) {
                selectedMode = settingSelect.value;
            } else {
                // å°è¯•ä»å…¶ä»–åœ°æ–¹è·å–æ¨¡å¼
                const lobbyModeSelect = document.querySelector('#game-lobby #game-mode-setting');
                if (lobbyModeSelect) {
                    selectedMode = lobbyModeSelect.value;
                }
            }
            
            console.log('æ¨¡å¼ä¿¡æ¯æŒ‰é’®è¢«ç‚¹å‡»ï¼Œæ˜¾ç¤ºæ¨¡å¼:', selectedMode);
            showModeInfoDialog(selectedMode);
        });
    });
    
    console.log('æ‰€æœ‰æ¨¡å¼ä¿¡æ¯æŒ‰é’®äº‹ä»¶å·²é‡æ–°ç»‘å®š');
}


// æ˜¾ç¤ºæ¨¡å¼ä¿¡æ¯å¯¹è¯æ¡†å‡½æ•°
// ä¿®æ”¹ showModeInfoDialog å‡½æ•°ï¼Œå¢åŠ æ£€æŸ¥é¿å…é‡å¤æ˜¾ç¤º
function showModeInfoDialog(mode) {
    // æ£€æŸ¥æ˜¯å¦å·²ç»å­˜åœ¨å¯¹è¯æ¡†ï¼Œå¦‚æœå­˜åœ¨åˆ™å…ˆç§»é™¤
    const existingOverlay = document.querySelector('.mode-info-overlay');
    const existingDialog = document.querySelector('.mode-info-dialog');
    if (existingOverlay) existingOverlay.remove();
    if (existingDialog) existingDialog.remove();
    
    // åˆ›å»ºè¦†ç›–å±‚
    const overlay = document.createElement('div');
    overlay.className = 'mode-info-overlay';
    document.body.appendChild(overlay);
    
    // åˆ›å»ºå¯¹è¯æ¡†
    const dialog = document.createElement('div');
    dialog.className = 'mode-info-dialog';
    
    let title, description;
    
    if (mode === 'classic') {
        title = 'ç»å…¸æ¨¡å¼';
        description = 'æ¯ä½ç©å®¶æœ‰3æ¡ç”Ÿå‘½ï¼Œæ’å¢™æˆ–ç¢°æ’å3ç§’è‡ªåŠ¨å¤æ´»ï¼Œæœ€åå­˜æ´»çš„ç©å®¶è·èƒœã€‚';
    } else if (mode === 'challenge') {
        title = 'å¤ºå† æ¨¡å¼';
        description = 'æ›´é«˜éš¾åº¦ï¼Œæ›´å¤šéšœç¢ç‰©ï¼Œç©å®¶éœ€è¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°ï¼ˆ500åˆ†ï¼‰æ‰èƒ½è·èƒœã€‚';
    }
    
    dialog.innerHTML = `
        <h3>${title}</h3>
        <p>${description}</p>
        <button class="close-btn">å…³é—­</button>
    `;
    
    document.body.appendChild(dialog);
    
    // æ·»åŠ å…³é—­åŠŸèƒ½
    const closeBtn = dialog.querySelector('.close-btn');
    const closeDialog = () => {
        overlay.remove();
        dialog.remove();
    };
    
    closeBtn.addEventListener('click', closeDialog);
    overlay.addEventListener('click', closeDialog);
}


// åˆ‡æ¢è®¾ç½®é¢æ¿æ˜¾ç¤º/éšè—çŠ¶æ€çš„å‡½æ•°
function toggleSettings() {
    console.log('åˆ‡æ¢è®¾ç½®é¢æ¿æ˜¾ç¤ºçŠ¶æ€');
    const settingsContent = document.querySelector('.game-settings .settings-content');
    const toggleIcon = document.querySelector('.game-settings .toggle-icon');
    
    if (settingsContent && toggleIcon) {
        settingsContent.classList.toggle('open');
        toggleIcon.classList.toggle('open');
        console.log('è®¾ç½®é¢æ¿çŠ¶æ€:', settingsContent.classList.contains('open') ? 'å·²å±•å¼€' : 'å·²æŠ˜å ');
    }
}


// ä¿®æ”¹ endMultiplayerGame å‡½æ•°
function endMultiplayerGame(data) {
    // æ ‡è®°ä¸ºæ¸¸æˆç»“æŸä½†ä¿æŒå¤šäººæ¸¸æˆæ¨¡å¼æ ‡è¯†
    gameState.isPlaying = false;
    gameState.isGameOver = true;
    
    // æ¢å¤å•äººæ¸¸æˆUI
document.getElementById('score-container').style.display = 'flex';
document.getElementById('status-display').style.display = 'flex'; // æ¢å¤çŠ¶æ€æ˜¾ç¤º

    
    // æ˜¾ç¤ºæ¸¸æˆç»“æŸèœå•
    document.getElementById('game-over-title').textContent = 'æ¸¸æˆç»“æŸ';
    if (data && data.winner) {
        const finalScore = document.getElementById('final-score');
        const finalLength = document.getElementById('final-length');
        const gameOverMessage = document.getElementById('game-over-message');
        
        finalScore.textContent = `è·èƒœè€…: ${data.winner.name}`;
        finalLength.textContent = `å¾—åˆ†: ${data.winner.score}`;
        
        if (data.winner.id === playerId) {
            gameOverMessage.textContent = 'æ­å–œä½ è·å¾—èƒœåˆ©ï¼';
        } else {
            gameOverMessage.textContent = 'å†æ¥å†å‰ï¼';
        }
    }

    // ç¡®ä¿æ¸¸æˆç»“æŸèœå•ä¸­æœ‰è¿”å›å¤§å…æŒ‰é’®ï¼Œä½†ä¸é‡å¤æ·»åŠ 
    const gameOverDialog = document.querySelector('#game-over .dialog');
    let backToLobbyBtn = document.getElementById('back-to-lobby-btn');
    
    if (!backToLobbyBtn) {
        backToLobbyBtn = document.createElement('button');
        backToLobbyBtn.id = 'back-to-lobby-btn';
        backToLobbyBtn.textContent = 'è¿”å›æ¸¸æˆå¤§å…';
        backToLobbyBtn.className = 'btn';
        backToLobbyBtn.style.backgroundColor = '#4CAF50';
        backToLobbyBtn.onclick = function() {
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('game-lobby').style.display = 'flex';
        };
        
        // åœ¨èœå•æŒ‰é’®å‰æ’å…¥
        const menuBtn = document.getElementById('menu-btn');
        if (menuBtn && menuBtn.parentNode === gameOverDialog) {
            gameOverDialog.insertBefore(backToLobbyBtn, menuBtn);
        } else {
            gameOverDialog.appendChild(backToLobbyBtn);
        }
    }

    document.getElementById('game-over').style.display = 'flex';
    
    // åœæ­¢æ¸¸æˆå¾ªç¯
    if (gameState.animationFrame) {
        cancelAnimationFrame(gameState.animationFrame);
    }
    
    // é‡è¦ï¼šä¸æ¸…é™¤å¤šäººæ¸¸æˆçŠ¶æ€æ ‡å¿—ï¼Œåªéšè—UIå…ƒç´ 
    document.getElementById('multiplayer-status').style.display = 'none';
    document.getElementById('multiplayer-chat').style.display = 'none';
    
    // æ¢å¤3Dæ—‹è½¬æ•ˆæœ
    canvas.classList.add('rotate-effect');
}


function resetMultiplayerGameState() {
    console.log('é‡ç½®å¤šäººæ¸¸æˆçŠ¶æ€');
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€æ ‡å¿—ï¼Œä½†ä¿æŒå¤šäººæ¸¸æˆè¿æ¥
    multiplayerGameState = null;
    
    // é‡ç½®æœ¬åœ°æ¸¸æˆçŠ¶æ€
    gameState.isPlaying = false;
    gameState.isPaused = false;
    gameState.isGameOver = false;
    gameState.score = 0;
    gameState.snake = [];
    gameState.snakeInterpolated = [];
    gameState.obstacles = [];
    gameState.trail = [];
    gameState.particles = [];
    gameState.food = null;
    gameState.direction = 'right';
    gameState.nextDirection = 'right';
    gameState.combo = 0;
    gameState.powerUpActive = false;
    gameState.powerUpType = null;
    particleSystem.clear();
    
    // åœæ­¢ä»»ä½•ç°æœ‰åŠ¨ç”»
    if (gameState.animationFrame) {
        cancelAnimationFrame(gameState.animationFrame);
        gameState.animationFrame = null;
    }
    
    // æ¸…é™¤ä»»ä½•èƒ½åŠ›é“å…·è®¡æ—¶å™¨
    if (powerUpTimeout) {
        clearTimeout(powerUpTimeout);
        powerUpTimeout = null;
    }
    
    // æ¸…é™¤ä»»ä½•é£Ÿç‰©ä¿¡æ¯è®¡æ—¶å™¨
    if (foodInfoTimeout) {
        clearTimeout(foodInfoTimeout);
        foodInfoTimeout = null;
    }
    
    // æ¸…é™¤æ‰€æœ‰æ¸¸æˆå…ƒç´ çš„æ˜¾ç¤º
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // æ¸…é™¤æ‰€æœ‰å¼¹å‡ºæ•ˆæœ
    const popups = document.querySelectorAll('.score-popup, .combo-popup');
    popups.forEach(popup => popup.remove());
    
    // æ¸…é™¤æ­»äº¡æ¶ˆæ¯
    const deathMessage = document.getElementById('death-message');
    if (deathMessage && deathMessage.parentNode) {
        deathMessage.remove();
    }
    
    // ç§»é™¤æ‰€æœ‰å¯èƒ½å­˜åœ¨çš„å¤æ´»æŒ‰é’®å’Œå€’è®¡æ—¶
    hideRespawnOption();
    
    console.log('å¤šäººæ¸¸æˆçŠ¶æ€å·²é‡ç½®');
}


// é‡ç½®æ§åˆ¶æŒ‰é’®çŠ¶æ€çš„å‡½æ•°
function resetControls() {
    // ç¡®ä¿æ§åˆ¶æŒ‰é’®åœ¨å•äººæ¸¸æˆä¸­æ­£å¸¸æ˜¾ç¤º
    const controls = document.getElementById('controls');
    if (settings.controlType === 'buttons') {
        controls.style.display = 'grid';
    } else if (settings.controlType === 'joystick') {
        document.getElementById('joystick-container').style.display = 'block';
        controls.style.display = 'none';
    }
}

// ä¿®å¤æš‚åœæŒ‰é’®åŠŸèƒ½
function setupPauseButton() {
    const pauseBtn = document.getElementById('pause-btn');
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶å¤„ç†å™¨
    const newPauseBtn = pauseBtn.cloneNode(true);
    pauseBtn.parentNode.replaceChild(newPauseBtn, pauseBtn);
    
    newPauseBtn.addEventListener('click', function() {
        console.log('æš‚åœæŒ‰é’®è¢«ç‚¹å‡», å¤šäººæ¸¸æˆæ¨¡å¼:', isMultiplayerGame);
        if (!isMultiplayerGame) {
            // å•äººæ¸¸æˆä½¿ç”¨æš‚åœé€»è¾‘
            togglePause();
        } else {
            // å¤šäººæ¸¸æˆä¸­æ˜¾ç¤ºä¸€ä¸ªç‰¹æ®Šçš„ä¿¡æ¯èœå•
            const pauseMenu = document.getElementById('pause-menu');
            const pauseTitle = pauseMenu.querySelector('h2');
            const resumeBtn = document.getElementById('resume-btn');
            const pauseMenuBtn = document.getElementById('pause-menu-btn');
            
            // ä¿®æ”¹æš‚åœèœå•å†…å®¹
            pauseTitle.textContent = 'æ¸¸æˆä¿¡æ¯';
            resumeBtn.textContent = 'ç»§ç»­æ¸¸æˆ';
            pauseMenuBtn.textContent = 'è¿”å›ä¸»èœå•';
            
            // æ˜¾ç¤ºèœå•
            pauseMenu.style.display = 'flex';
            
            // åŒæ—¶æ‰“å¼€èŠå¤©çª—å£æ–¹ä¾¿äº¤æµ
            document.getElementById('multiplayer-chat').classList.add('show');
            
            // è®¾ç½®æ¸¸æˆæš‚åœçŠ¶æ€(ä»…æœ¬åœ°è§†è§‰æš‚åœ)
            gameState.isPaused = true;
        }
    });
}

// ä¿®æ”¹æš‚åœèœå•ä¸­çš„è¿”å›èœå•æŒ‰é’®äº‹ä»¶å¤„ç†
function setupPauseMenuButton() {
    const pauseMenuBtn = document.getElementById('pause-menu-btn');
    
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶å¤„ç†å™¨
    const newPauseMenuBtn = pauseMenuBtn.cloneNode(true);
    pauseMenuBtn.parentNode.replaceChild(newPauseMenuBtn, pauseMenuBtn);
    
    newPauseMenuBtn.addEventListener('click', function() {
        // åœæ­¢æ¸¸æˆå¾ªç¯
        if (gameState.animationFrame) {
            cancelAnimationFrame(gameState.animationFrame);
            gameState.animationFrame = null;
        }
        
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        gameState.isPlaying = false;
        gameState.isPaused = false;
        
        // éšè—æš‚åœèœå•
        document.getElementById('pause-menu').style.display = 'none';
        
        // æ ¹æ®æ¸¸æˆæ¨¡å¼é‡ç½®
        if (isMultiplayerGame) {
            // å½»åº•æ¸…ç†å¤šäººæ¸¸æˆçŠ¶æ€
            resetMultiplayerGame();
        } else {
            // æ˜¾ç¤ºä¸»èœå•
            document.getElementById('main-menu').style.display = 'flex';
            
            // æ¢å¤3Dæ—‹è½¬æ•ˆæœ
            canvas.classList.add('rotate-effect');
        }
    });
}



// è¾…åŠ©å‡½æ•°: å°†åå…­è¿›åˆ¶é¢œè‰²è½¬æ¢ä¸ºHSL
function hexToHsl(hex) {
// ç§»é™¤å‰å¯¼#
hex = hex.replace(/^#/, '');
// è§£æåå…­è¿›åˆ¶
let r, g, b;
if (hex.length === 3) {
    r = parseInt(hex.charAt(0) + hex.charAt(0), 16) / 255;
    g = parseInt(hex.charAt(1) + hex.charAt(1), 16) / 255;
    b = parseInt(hex.charAt(2) + hex.charAt(2), 16) / 255;
} else {
    r = parseInt(hex.substring(0, 2), 16) / 255;
    g = parseInt(hex.substring(2, 4), 16) / 255;
    b = parseInt(hex.substring(4, 6), 16) / 255;
}

// è®¡ç®—HSL
const max = Math.max(r, g, b);
const min = Math.min(r, g, b);
let h, s, l = (max + min) / 2;

if (max === min) {
    h = s = 0; // ç°è‰²
} else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    
    switch (max) {
        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
        case g: h = (b - r) / d + 2; break;
        case b: h = (r - g) / d + 4; break;
    }
    
    h /= 6;
}

return [h * 360, s * 100, l * 100];
}


// è®¾ç½®å¤šäººæ¸¸æˆäº‹ä»¶ç›‘å¬å™¨
function setupMultiplayerEvents() {
    console.log('è®¾ç½®å¤šäººæ¸¸æˆäº‹ä»¶ç›‘å¬å™¨');
    
    // æ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§ç›‘å¬å™¨
    const elements = [
        'multiplayer-back-btn', 'create-game-btn', 'join-game-btn',
        'join-btn', 'join-back-btn', 'start-game-btn', 'leave-game-btn',
        'send-chat-btn', 'chat-input', 'menu-btn'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            const newElement = element.cloneNode(true);
            element.parentNode.replaceChild(newElement, element);
        }
    });
    
    // è¿”å›ä¸»èœå• - ç‰¹åˆ«åŠ å¼ºå¤„ç†ï¼Œç¡®ä¿å¤šç§æƒ…å†µä¸‹éƒ½èƒ½å·¥ä½œ
    const multiplayerBackBtn = document.getElementById('multiplayer-back-btn');
    if (multiplayerBackBtn) {
        multiplayerBackBtn.addEventListener('click', function() {
            console.log('ç‚¹å‡»å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®');
            document.getElementById('multiplayer-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
            
            // å¦‚æœæœ‰è¿æ¥é”™è¯¯ï¼Œå°è¯•é‡ç½®socket
            if (socket && socket.disconnected) {
                console.log('æ£€æµ‹åˆ°æ–­å¼€è¿æ¥çŠ¶æ€ï¼Œå°è¯•æ¸…ç†Socket');
                try {
                    socket.removeAllListeners();
                    socket.disconnect();
                } catch (e) {
                    console.error('æ¸…ç†Socketå¤±è´¥:', e);
                }
            }
        });
        
        // é¢å¤–æ·»åŠ è§¦æ‘¸äº‹ä»¶ï¼Œç¡®ä¿åœ¨ç§»åŠ¨è®¾å¤‡ä¸Šä¹Ÿèƒ½å·¥ä½œ
        multiplayerBackBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            console.log('è§¦æ‘¸ç‚¹å‡»å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®');
            document.getElementById('multiplayer-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
    } else {
        console.error('æ‰¾ä¸åˆ°å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®');
    }

    // åˆ›å»ºæ¸¸æˆ
const createGameBtn = document.getElementById('create-game-btn');
if (createGameBtn) {
    createGameBtn.addEventListener('click', () => {
        playerName = document.getElementById('player-name').value.trim();
        if (!playerName) {
            alert('è¯·è¾“å…¥æ‚¨çš„åå­—');
            return;
        }
        
        // æ›´æ–°æ¸¸æˆè®°å½•
        updateGameRecord('multiplayer', { playerName: playerName });
        
        if (socket && socket.connected) {
            socket.emit('createGame', {
                playerName: playerName,
                playerColor: getRandomPlayerColor()
            });
        } else {
            alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
            ensureBackButtonWorks(); // ç¡®ä¿è¿”å›æŒ‰é’®å¯ç”¨
        }
    });
}

    // æ˜¾ç¤ºåŠ å…¥æ¸¸æˆç•Œé¢
    const joinGameBtn = document.getElementById('join-game-btn');
    if (joinGameBtn) {
        joinGameBtn.addEventListener('click', () => {
            playerName = document.getElementById('player-name').value.trim();
            if (!playerName) {
                alert('è¯·è¾“å…¥æ‚¨çš„åå­—');
                return;
            }
            
            if (socket && socket.connected) {
                document.getElementById('multiplayer-menu').style.display = 'none';
                document.getElementById('join-game-menu').style.display = 'flex';
            } else {
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                ensureBackButtonWorks(); // ç¡®ä¿è¿”å›æŒ‰é’®å¯ç”¨
            }
        });
    }

    // åŠ å…¥æ¸¸æˆ
    const joinBtn = document.getElementById('join-btn');
    if (joinBtn) {
        joinBtn.addEventListener('click', () => {
            const gameId = document.getElementById('game-id').value.trim();
            if (!gameId) {
                alert('è¯·è¾“å…¥æˆ¿é—´ID');
                return;
            }
            
            if (socket && socket.connected) {
                socket.emit('joinGame', {
                    gameId: gameId,
                    playerName: playerName,
                    playerColor: getRandomPlayerColor()
                });
            } else {
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                // ç¡®ä¿èƒ½å¤Ÿè¿”å›åˆ°ä¸Šä¸€ä¸ªèœå•
                document.getElementById('join-game-menu').style.display = 'none';
                document.getElementById('multiplayer-menu').style.display = 'flex';
            }
        });
    }

    // è¿”å›å¤šäººèœå•ï¼ˆä»åŠ å…¥æ¸¸æˆç•Œé¢ï¼‰
    const joinBackBtn = document.getElementById('join-back-btn');
    if (joinBackBtn) {
        joinBackBtn.addEventListener('click', () => {
            document.getElementById('join-game-menu').style.display = 'none';
            document.getElementById('multiplayer-menu').style.display = 'flex';
        });
        
        // æ·»åŠ è§¦æ‘¸äº‹ä»¶
        joinBackBtn.addEventListener('touchend', function(e) {
            e.preventDefault();
            document.getElementById('join-game-menu').style.display = 'none';
            document.getElementById('multiplayer-menu').style.display = 'flex';
        });
    }

    // å¼€å§‹æ¸¸æˆ
const startGameBtn = document.getElementById('start-game-btn');
if (startGameBtn) {
    startGameBtn.addEventListener('click', () => {
        if (connectedPlayers.length < 1) {
            alert('è‡³å°‘éœ€è¦1åç©å®¶æ‰èƒ½å¼€å§‹æ¸¸æˆ');
            return;
        }
        
        // ä»è®¾ç½®UIå…ƒç´ ä¸­è·å–è®¾ç½®å€¼
        const gameSettings = {
            gridSize: parseInt(document.getElementById('grid-size-setting').value),
            gameSpeed: document.getElementById('game-speed-setting').value,
            foodCount: parseInt(document.getElementById('food-count-setting').value),
            obstacleDensity: document.getElementById('obstacle-density-setting').value,
            powerUps: document.getElementById('power-ups-setting').value
        };
        
        const gameOptions = {
            gameMode: document.getElementById('game-mode-setting').value, // è·å–æ¸¸æˆæ¨¡å¼
            allowLateJoin: false,
            allowRespawn: true,
            gameSettings: gameSettings
        };
        
        console.log('å‘é€startGameäº‹ä»¶ï¼Œé€‰é¡¹:', gameOptions);
        socket.emit('startGame', gameOptions);
    });
}


    // ç¦»å¼€æ¸¸æˆ
    const leaveGameBtn = document.getElementById('leave-game-btn');
    if (leaveGameBtn) {
        leaveGameBtn.addEventListener('click', () => {
            // é€šçŸ¥æœåŠ¡å™¨
            if (socket && socket.connected) {
                socket.emit('leaveGame');
            }
            
            // å½»åº•æ¸…ç†æ¸¸æˆçŠ¶æ€
            isMultiplayerGame = false;
            multiplayerGameId = null;
            
            // åœæ­¢ä»»ä½•æ¸¸æˆå¾ªç¯
            if (gameState.animationFrame) {
                cancelAnimationFrame(gameState.animationFrame);
                gameState.animationFrame = null;
            }
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            resetMultiplayerGame();
            
            // æ˜¾ç¤ºä¸»èœå•
            document.getElementById('game-lobby').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
    }

    // å‘é€èŠå¤©æ¶ˆæ¯
    const sendChatBtn = document.getElementById('send-chat-btn');
    if (sendChatBtn) {
        sendChatBtn.addEventListener('click', sendChatMessage);
    }
    
    const chatInput = document.getElementById('chat-input');
    if (chatInput) {
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });
    }

    // æ¸¸æˆç»“æŸåè¿”å›å¤§å…
    const menuBtn = document.getElementById('menu-btn');
    if (menuBtn) {
        menuBtn.addEventListener('click', function() {
            if (isMultiplayerGame) {
                console.log('åœ¨å¤šäººæ¸¸æˆä¸­ç‚¹å‡»äº†èœå•æŒ‰é’®ï¼Œè¿”å›å¤§å…è€Œéä¸»èœå•');
                document.getElementById('game-over').style.display = 'none';
                document.getElementById('game-lobby').style.display = 'flex';
                return;
            }
            
            // å•äººæ¸¸æˆè¿”å›ä¸»èœå•
            document.getElementById('game-over').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
    }

    // æ¸¸æˆå¤§å…è®¾ç½®
    // ç½‘æ ¼å¤§å°è®¾ç½®
    const gridSizeSetting = document.getElementById('grid-size-setting');
    const gridSizeValue = document.getElementById('grid-size-value');
    if (gridSizeSetting && gridSizeValue) {
        gridSizeSetting.addEventListener('input', () => {
            gridSizeValue.textContent = gridSizeSetting.value;
        });
    }

    // é£Ÿç‰©æ•°é‡è®¾ç½®
    const foodCountSetting = document.getElementById('food-count-setting');
    const foodCountValue = document.getElementById('food-count-value');
    if (foodCountSetting && foodCountValue) {
        foodCountSetting.addEventListener('input', () => {
            foodCountValue.textContent = foodCountSetting.value;
        });
    }
    
    // æ¸¸æˆæ¨¡å¼è®¾ç½®
    const gameModeSettingSelect = document.getElementById('game-mode-setting');
    if (gameModeSettingSelect) {
        gameModeSettingSelect.addEventListener('change', function() {
            const modeDescription = document.getElementById('game-mode-description');
            if (modeDescription) {
                switch(this.value) {
                    case 'classic':
                        modeDescription.textContent = 'ç»å…¸æ¨¡å¼ï¼šåŸºç¡€æ¸¸æˆä½“éªŒï¼Œå¹³è¡¡çš„éš¾åº¦å’Œä¹è¶£ã€‚';
                        break;
                    case 'challenge':
                        modeDescription.textContent = 'å¤ºå† æ¨¡å¼ï¼šæ›´é«˜éš¾åº¦ï¼Œæ›´å¤šéšœç¢ç‰©ï¼Œéœ€è¦è¾¾åˆ°ç›®æ ‡åˆ†æ•°ï¼ˆ500åˆ†ï¼‰æ‰èƒ½è·èƒœã€‚';
                        break;
                }
            }
        });
    }
    
    // è®¾ç½®å¤§å…å†…è®¾ç½®é¢æ¿åˆ‡æ¢äº‹ä»¶
    setupLobbySettingsToggle();
    
    console.log('å¤šäººæ¸¸æˆäº‹ä»¶ç›‘å¬å™¨è®¾ç½®å®Œæˆ');
}


// æ·»åŠ æ–°çš„è¾…åŠ©å‡½æ•°ï¼Œä¸“é—¨è®¾ç½®æ¸¸æˆå¤§å…ä¸­çš„è®¾ç½®é¢æ¿åˆ‡æ¢åŠŸèƒ½
function setupLobbySettingsToggle() {
    console.log('è®¾ç½®æ¸¸æˆå¤§å…è®¾ç½®é¢æ¿åˆ‡æ¢åŠŸèƒ½');
    const settingsHeader = document.querySelector('.game-settings .settings-header');
    const settingsContent = document.querySelector('.game-settings .settings-content');
    const toggleIcon = document.querySelector('.game-settings .toggle-icon');
    
    if (settingsHeader && settingsContent && toggleIcon) {
        // ç§»é™¤ä¹‹å‰å¯èƒ½å­˜åœ¨çš„äº‹ä»¶ç›‘å¬å™¨
        const newSettingsHeader = settingsHeader.cloneNode(true);
        settingsHeader.parentNode.replaceChild(newSettingsHeader, settingsHeader);
        
        // æ·»åŠ ç‚¹å‡»äº‹ä»¶å¤„ç†å™¨
        newSettingsHeader.addEventListener('click', function() {
            console.log('ç‚¹å‡»äº†è®¾ç½®é¢æ¿æ ‡é¢˜');
            
            // åˆ‡æ¢å†…å®¹åŒºåŸŸçš„æ˜¾ç¤ºçŠ¶æ€
            settingsContent.classList.toggle('open');
            toggleIcon.classList.toggle('open');
            
            // æ‰‹åŠ¨æ£€æŸ¥å¹¶æ§åˆ¶æ‰€æœ‰è®¾ç½®é¡¹çš„æ˜¾ç¤ºçŠ¶æ€
            const isOpen = settingsContent.classList.contains('open');
            const allSettingItems = document.querySelectorAll('.game-settings .setting-item');
            
            allSettingItems.forEach(item => {
                // å¦‚æœè®¾ç½®é¡¹ä¸åœ¨settings-contentå†…ï¼Œéœ€è¦å•ç‹¬å¤„ç†
                if (!settingsContent.contains(item)) {
                    // è®¾ç½®æ˜¾ç¤ºçŠ¶æ€
                    item.style.display = isOpen ? 'flex' : 'none';
                }
            });
            
            console.log('è®¾ç½®é¢æ¿çŠ¶æ€:', isOpen ? 'å·²å±•å¼€' : 'å·²æŠ˜å ');
        });
        
        // åˆå§‹åŒ–è®¾ç½®é¡¹çŠ¶æ€
        const isInitiallyOpen = settingsContent.classList.contains('open');
        document.querySelectorAll('.game-settings .setting-item').forEach(item => {
            if (!settingsContent.contains(item)) {
                item.style.display = isInitiallyOpen ? 'flex' : 'none';
            }
        });
        
        console.log('è®¾ç½®é¢æ¿åˆ‡æ¢åŠŸèƒ½å·²è®¾ç½®');
    } else {
        console.error('è®¾ç½®é¢æ¿å…ƒç´ ä¸å­˜åœ¨ï¼Œæ— æ³•ç»‘å®šäº‹ä»¶');
    }
}



// æ›´æ–°è®¾ç½®é¢æ¿å¯è§æ€§
function updateSettingsVisibility() {
    console.log('æ›´æ–°è®¾ç½®é¢æ¿å¯è§æ€§ï¼Œå½“å‰ç”¨æˆ·æ˜¯å¦ä¸ºæˆ¿ä¸»:', isHost);
    const gameSettingsPanel = document.querySelector('.game-settings.host-only');
    
    if (gameSettingsPanel) {
        if (isHost) {
            gameSettingsPanel.style.display = 'block';
            console.log('æˆ¿ä¸»ï¼šæ˜¾ç¤ºè®¾ç½®é¢æ¿');
        } else {
            gameSettingsPanel.style.display = 'none';
            console.log('éæˆ¿ä¸»ï¼šéšè—è®¾ç½®é¢æ¿');
        }
    } else {
        console.error('æœªæ‰¾åˆ°æ¸¸æˆè®¾ç½®é¢æ¿å…ƒç´ ');
    }
}



// å®Œå…¨é€€å‡ºå¤šäººæ¸¸æˆï¼ˆåªåœ¨è¿”å›ä¸»èœå•æ—¶è°ƒç”¨ï¼‰
function resetMultiplayerGame() {
    console.log('å½»åº•é‡ç½®å¤šäººæ¸¸æˆ');
    
    // åœ¨é€€å‡ºå‰å…ˆé€šçŸ¥æœåŠ¡å™¨
    if (socket && socket.connected && multiplayerGameId) {
        socket.emit('leaveGame');
    }
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€æ ‡å¿—
    isMultiplayerGame = false;
    multiplayerGameId = null;
    
    // å½»åº•æ¸…ç©ºæ¸¸æˆçŠ¶æ€
    multiplayerGameState = null;
    
    // åœæ­¢åŠ¨ç”»å¸§
    if (gameState.animationFrame) {
        cancelAnimationFrame(gameState.animationFrame);
        gameState.animationFrame = null;
    }
    
    // æ¸…ç©ºç”»å¸ƒä»¥é¿å…æ®‹ç•™
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // éšè—æ‰€æœ‰å¤šäººæ¸¸æˆUI
    document.getElementById('multiplayer-status').style.display = 'none';
    document.getElementById('multiplayer-chat').style.display = 'none';
    document.getElementById('game-lobby').style.display = 'none';
    if (document.getElementById('multiplayer-controls')) {
        document.getElementById('multiplayer-controls').style.display = 'none';
    }
    
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„é‡ç”ŸæŒ‰é’®
    hideRespawnOption();
    
    // é‡ç½®æ§åˆ¶æŒ‰é’®çŠ¶æ€
    resetControls();
    
    // æ˜¾ç¤ºä¸»èœå•
    document.getElementById('main-menu').style.display = 'flex';
    
    console.log('å¤šäººæ¸¸æˆçŠ¶æ€å·²å®Œå…¨é‡ç½®');
}


// å‘é€èŠå¤©æ¶ˆæ¯
function sendChatMessage() {
    const input = document.getElementById('chat-input');
    const message = input.value.trim();
    if (message) {
        socket.emit('sendMessage', message);
        input.value = '';
    }
    
    // æ— è®ºæ¶ˆæ¯æ˜¯å¦ä¸ºç©ºï¼Œéƒ½å…³é—­èŠå¤©ç•Œé¢
    document.getElementById('multiplayer-chat').classList.remove('show');
}


// ç”Ÿæˆéšæœºç©å®¶é¢œè‰²
function getRandomPlayerColor() {
const colors = [
'#FF5252', '#FF4081', '#E040FB', '#7C4DFF',
'#536DFE', '#448AFF', '#40C4FF', '#18FFFF',
'#64FFDA', '#69F0AE', '#B2FF59', '#EEFF41',
'#FFFF00', '#FFD740', '#FFAB40', '#FF6E40'
];
return colors[Math.floor(Math.random() * colors.length)];
}

// ä¿®æ”¹æ–¹å‘æ§åˆ¶ä»¥æ”¯æŒå¤šäººæ¸¸æˆ
function changeDirectionMultiplayer(newDirection) {
if (!isMultiplayerGame) {
// å•äººæ¸¸æˆä½¿ç”¨åŸæœ‰é€»è¾‘
changeDirection(newDirection);
return;
}
// å¤šäººæ¸¸æˆå‘é€æ–¹å‘å˜æ›´åˆ°æœåŠ¡å™¨
socket.emit('changeDirection', newDirection);
}

// æš‚åœæŒ‰é’®ä¿®æ”¹
const pauseBtn = document.getElementById('pause-btn');
const originalPauseBtnHandler = pauseBtn.onclick;
pauseBtn.onclick = function() {
if (!isMultiplayerGame) {
// å•äººæ¸¸æˆä½¿ç”¨åŸæœ‰æš‚åœé€»è¾‘
togglePause();
} else {
// å¤šäººæ¸¸æˆä¸­å¯ä»¥æ‰“å¼€èŠå¤©
const chatInput = document.getElementById('chat-input');
if (chatInput) {
chatInput.focus();
}
}
};

// ä¿®æ”¹æ¸¸æˆç»“æŸå¤„ç†ä»¥æ”¯æŒå¤šäººæ¸¸æˆ
const originalEndGame = endGame;
endGame = function(reason) {
if (isMultiplayerGame) {
// å¤šäººæ¸¸æˆä¸­ï¼Œæ­»äº¡ç”±æœåŠ¡å™¨å¤„ç†
return;
}
// å•äººæ¸¸æˆä½¿ç”¨åŸæœ‰é€»è¾‘
originalEndGame(reason);
};

// ä¿®æ”¹é‡æ–°å¼€å§‹æŒ‰é’®
const restartBtn = document.getElementById('restart-btn');
const originalRestartBtnHandler = restartBtn.onclick;
restartBtn.onclick = function() {
    // æ£€æŸ¥æ˜¯å¦åœ¨å¤šäººæ¸¸æˆæ¨¡å¼
    if (isMultiplayerGame) {
        console.log('åœ¨å¤šäººæ¸¸æˆä¸­ç‚¹å‡»äº†é‡æ–°å¼€å§‹æŒ‰é’®ï¼Œè¿”å›å¤§å…');
        document.getElementById('game-over').style.display = 'none';
        
        // é‡ç½®æ¸¸æˆçŠ¶æ€
        resetMultiplayerGameState();
        
        // æ˜¾ç¤ºå¤§å…
        document.getElementById('game-lobby').style.display = 'flex';
        
        // å¦‚æœæ˜¯æˆ¿ä¸»ï¼Œç¡®ä¿å¼€å§‹æ¸¸æˆæŒ‰é’®å¯è§
        if (isHost) {
            document.getElementById('start-game-btn').style.display = 'block';
        }
        
        return;
    }

    
    // å•äººæ¸¸æˆä½¿ç”¨åŸå§‹å¤„ç†å‡½æ•°
    if (originalRestartBtnHandler) {
        originalRestartBtnHandler();
    }
};

        
        
        
        // å•å…ƒæ ¼å¤§å°(æ ¹æ®ç”»å¸ƒå¤§å°å’Œç½‘æ ¼å¤§å°è®¡ç®—)
        let cellSize = 0;
        
        // é£Ÿç‰©ç±»å‹åŠæ•ˆæœ
        const foodTypes = {
            red: {
                color: '#ff3333',
                borderColor: '#cc0000',
                name: 'åŠ é€Ÿé£Ÿç‰©',
                effect: 'å¢åŠ é€Ÿåº¦',
                points: 15,
                action: () => {
                    gameState.speed = Math.max(50, gameState.speed - 20);
                    updateSpeedDisplay();
                }
            },
     yellow: {
    color: '#ffcc00',
    borderColor: '#cc9900',
    name: 'ç¿»å€é£Ÿç‰©',
    effect: '5ç§’å†…åˆ†æ•°ç¿»å€',
    points: 10, // åŸºç¡€åˆ†æ•°é™ä½ï¼Œå› ä¸ºæœ‰ç¿»å€æ•ˆæœ
    action: () => {
        // æ¿€æ´»åˆ†æ•°ç¿»å€
        activateScoreMultiplier(5000); // 5ç§’é’Ÿ
    }
},

            green: {
                color: '#33cc33',
                borderColor: '#009900',
                name: 'å‡é€Ÿé£Ÿç‰©',
                effect: 'é™ä½é€Ÿåº¦',
                points: 10,
                action: () => {
                    gameState.speed = Math.min(300, gameState.speed + 30);
                    updateSpeedDisplay();
                }
            },
            blue: {
                color: '#3399ff',
                borderColor: '#0066cc',
                name: 'ç©¿å¢™é£Ÿç‰©',
                effect: 'å¯ç©¿å¢™5ç§’',
                points: 30,
                action: () => {
                    activatePowerUp('phase', 5000);
                }
            },
            purple: {
                color: '#9933ff',
                borderColor: '#6600cc',
                name: 'æ— æ•Œé£Ÿç‰©',
                effect: 'æš‚æ—¶æ— æ•Œ',
                points: 40,
                action: () => {
                    activatePowerUp('invincible', 5000);
                }
            }
        };
        
        // éŸ³æ•ˆ
const sounds = {
    eat: new Audio("data:audio/wav;base64,UklGRiQFAABXQVZFZm10IBAAAAABAAEARKwAAESsAAABAAgAZGF0YQAFAACAf3x8fYB8gH2Be4F8goCEf4Z6inuQgZWElnuadJpzmXWghKaGrHevea6LrZazn7BrqYGotqI9oueWxJNRlluYe5hylw+Y05y4n+yhxaXNqSCvGLV/uEvAucNFxufEO8DHva24aa/4qg+nq6LunHOXjJPhjy+NJ4oQiLOG94WpheWGW4gxilmMdI5ZkD+S7JPgleOX25mEm/Wch58qoYiiB6RcpSmmrqbUpmqm/aLDngCb85ZSk/yP+ozzidyICYm8iv+MVJB+lCWZDZ4Io2unRaq8rHGvz6+CrlisoafEpBCexJp1mNCUsJTJl9+cT6ENpN+mnKLXmkiW+I8Mi6KJvIZuh+uLiIzqitSIj4dRhpWD8IOhhq+IMYl7icyJ3ImeiSeQHZcfnX+ij6bmp02m5KP2oqCf6JlJlSiSTo8Vi1uIbIYKiF+JZYh9iaCLuYxIkMyVbJw2oh2o5apvqUGoxKaWpDOhYJ5jmuSVuZIZkR+SlZXemHWZapm9lxCVDJN7kXOPFI3oifmGmodQh2SGF4Zvid+NRJG3k0OUj5LhkbKROpLlk/eUrZY/mIGaSprZmBKW7ZQPkteQh4/cjmaOd49Lj4GQoJJFlQGWYZkCmxuc+JzXnDmc7ps6mqiY2JcclhiU3pImk7OTBpQzlOqUQZWGlSaVNJXElQqXAphXl5uWf5aplx+WG5X+lBeU+ZPmkyOVp5a0mM+Zp5rCmRqZaZnWmCiYjpf2mPeZ0JiKl+iWb5bglA=="),
    gameOver: new Audio("data:audio/wav;base64,UklGRigEAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQEAACBhYqFbF1fdHJpfHNrY1ttdGlYRDQ0KCxGXWVgU0hRS0xGUFRLR1RmcXFwa2VVRzoxOEdHUI+l1fT//+TDo4VoSCsPM0VRiLTK3v7pxbamlHddVD4pCC9nbXN0cVhAQEVfc3+Ni6Wvqp+ZkYF1VlJQVWl0b4uepqGZk42HhH+AdnNwaGBWUlBMSVFgbX2SqL3O3N/Z0srEt7CuqqWhmJeYlIh1blRMMCQhLz9SY3aGk6Kqs77EyMjGxMLBuK+rpJ2UjYV9dGlaSj0zKiYmLTQ8S1lneoCKkpmeoqWnqauvrKijnpmWkoyFfnhtYlhNQjgvJyMgHRwdICUqMDc+RUtRV1xgZGdpbG1tbW1saWdkYV5aVVFMR0M9ODMuKiYjIB4dHB0dHyIlKi0yNjpAQkdLTlJVWFpcXl9fYGBfX15dW1lXVFJPTElGQ0A9OjczLyspJyQiIB8eHR0dHh8gIiQlJyksLjE0Njk7PkBDRUdJSkxNTk9PT09OTk1MS0lIRkVDQT89Ozo4NjQyMC8tKyopKCcmJSUkJCQjJCQkJSYnKCkrLC4vMTM1Nzk7PD4/QUJDREVGR0hISUlJSUhIR0dGRURDQkFAPj07Ojk3NjU0MzIxMC8uLSwrKyoqKSkpKSkpKSkqKisrLC0uLzAxMjM0NTY3ODk6Ozw9PT4/P0BAQEFBQUFBQUFBQUBAPz8+Pj08Ozs6OTg3NzY1NDMzMjEwMC8vLi4tLS0sLCwsLCwsLC0tLS4uLi8wMDEyMjM0NDU2Njc4ODk5Ojo7Ozw8PT09Pj4+Pj4+Pj4+Pj49PT08PDs7Ojk5ODc3NjY1NTQzMzIyMTEwMDAvLy8vLi4uLi4uLi4uLi4uLi8vLzAwMDAxMTIyMzM0NDQ1NTY2Njc3Nzg4ODk5OTo6Ojo6Ojo6Ojo6OTk5ODg4NzY2NjU1NDQ0MzMyMjIxMTEwMDAwLy8vLy8vLy8vLy8vLy8vLy8vMDAwMDAxMTEyMjIzMzM0NDQ1NTU1NjY2Njc3Nzc3ODg4ODg4ODg4ODc3Nzc3NjY2NTU1NDQ0MzMzMjIyMTExMTAwMDAwMDAwMDAwMDAwMDAwMDAwMDAxMTExMTEyMjIyMzMzMzQ0NDQ0NTU1NTU1NjY2NjY2NjY2NjY2NjY2NTU1NTU1NDQ0NDMzMzMyMjIyMTExMTExMTExMTExMTExMTExMTExMTExMTExMTEyMjIyMjIzMzMzMzMzNDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDQ0NDMzMzMzMzIyMjIyMjExMTExMTExMTExMTEx"),
    win: new Audio("data:audio/wav;base64,UklGRrQIAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYwIAACAgICAgICAgICAgICAgICAgICAgICBAoIFgweCCIIKgQyBDYAOgA9/EH8Pfg5+DX0MfAt7CnsJegmAEZAbyCTwNRVDJE8bWAxhAWr6cfd433bXf82JxJfAnr+rwbjKydLc3/Dm9e//9hb8Ggof/yILJQQnzSbJJoQnSigKKbgpbSoiK+grqi1mMCEzQDfHO4pAmEXESmFP1FMIWPBb1V+uYqtloGh/a0VuB3DOcol1IXh+egB9IX9pgXyDeoWyh/SJQ4zEk3+cyadErUK3ZMIyz1reR+vu/W0QeyFlMq03xDtZP3hDnEa5SNdJ4kngSMtH80ZqRvhG00dWR8JFEkIFPtU5+jWiMo0vxSxTKssnICWzIpolOCioK0EuoTDYMrw0bjbqN1s5yTpfPAA+sT95QWhDY0VTR0dJP0skTQVP4lDIUrlUmVZ1WEtaJFzgXZNfQWHmYndkAGaVZxRpjGoCbGxtwm4nb4NvwW/sb/5vA3ARcEhwnHDycFVxsnIfcot0+nZyeep7i35mgV6ES4c1iieNI5AhkxqWGJkXnBafFqIWpRamFqYWpRajFqEVnxWcFJgUlNeSKIMWb0BZNzo2Qi8bKSck6h9oG+sW3RJMD/YL9QgRBkADngDp/XX7/fho9gHz+fBA7q7rOukx50blVeOV4e/fXN7P3FTbANq62IPXWNYv1R7UIdMx0k/RdtKm1H7YvNyv4LLkfOj+6/nu3/Gb9EL37vmy/GD/HgLBBEgH0QlUDNIOixFSFBIX0RmRHE0f8iGTJCsn2yk8LAkz9D2nSJ5REFYQXR9j9Wi4bVRxx3Qyd4p55XsOfR9+a4OpiruPwpPLl4Kbs56yoaOkiKdKqvmsda8dsrO0Q7fMuUK8773nv53B7cTxy1vQyNFF01rbu+WU8If7Xgb/D7MYQyBwJgssOTDxMk41yzapOF06KDwLPtU/lEFVQxFF4UZrSABKjEsZTZ9OE1BpUbRSBFRQVZZW2VcZWVNac1uQXKtdw17XYOZiIGWbYvpeNVeRTlxFlzt+MZgnTB7XFM0Kbf9o85nn1d7M0azIHsByuBGyQ614pyGnrKfCqKupsaqvq4SsUK0drtSuka+HsIKxerKCs4W0h7WRtpi3pbistbixdKo8ouKZW5EeiW2A3XXxbaRlMl0WVeVM/kR9PeY1niagHcsPUQF18l7jj9TVxSO5KK2Eor+YrZE7jPqJ/4Q8gA=="),
    teleport: new Audio("data:audio/wav;base64,UklGRqQIAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YYAIAACBhYqFbF1fdHJpfHNrY1ttdGlYRFRMTlFJVENKPEU3Pzk7MkE8Nk5OQ1ZeS2Ntb2dje3mJhJGRmaWltKitrMjJ5fL7/+/q4dTGrYuMg2lwaGBPUFNJRk44MD03MixGR0dVWGJsc32Mi6Wvq6OYl4t/d3twaGh3gH1rdWJZT05ENDoqLiQeJRwhGx4aHCg1O0dFUVZlfYyXqLfL3uzv9vH+/f/+/vv++/bu6d7OtaKSg4d4X0xGOTAcExIPDAYKAgsSGx4qKjhCSFRdaHV5kKakssDb2+f2//jl6efb39zMyLazqqGVj4iCeXRuaGFdU01KPz04MzEsLy0sLy8xNzo6Pzo+Oj07ODo5NjY1MzMzMDIwMC4uLi0tLCsrKyoqKSgoJyYlJCMiISAfHh0cGhkYFhQSEA4MCggHBQQDAgEAAAEBAQMEBQcICgsNDhASExQWFxgaGxwdHh8gISIjJCQlJiYnKCgpKisrLC0tLi8vMDEyMzQ1NTY3ODk6Ojs8PT0+Pz9AQUFCQ0RFRkdISUpLS0xNTk9QUVFSU1RVVlZXWFlaW1tcXV1eX19gYWFiY2NkZWVmZ2doaGlqamtrbGxtbm5vcHBxcXJyc3N0dHV1dnZ3d3h4eXl6ent7fHx9fX5+f3+AgICBgYGCgoKDg4OEhISFhYWGhoaHh4eIiIiJiYmKioqLi4uMjIyNjY2Ojo6Pj4+QkJCRkZGSkpKTk5OUlJSVlZWWlpaXl5eYmJiZmZmampqbm5ucnJydnZ2enp6fn5+goKChoaGioqKjo6OkpKSlpaWmpqanp6eoqKipqamqqqqrq6usrKytra2urq6vr6+wsLCxsbGysrKzs7O0tLS1tbW2tra3t7e4uLi5ubm6urq7u7u8vLy9vb2+vr6/v7/AwMDBwcHCwsLDw8PExMTFxcXGxsbHx8fIyMjJycnKysrLy8vMzMzNzc3Ozs7Pz8/Q0NDR0dHS0tLT09PU1NTV1dXW1tbX19fY2NjZ2dna2trb29vc3Nzd3d3e3t7f39/g4ODh4eHi4uLj4+Pk5OTl5eXm5ubn5+fo6Ojp6enq6urr6+vs7Ozt7e3u7u7v7+/w8PDx8fHy8vLz8/P09PT19fX29vb39/f4+Pj5+fn6+vr7+/v8/Pz9/f3+/v7///8=") // ä¼ é€é—¨éŸ³æ•ˆ
};

    // æ—¶é—´ç›¸å…³
let powerUpTimeout = null;    // èƒ½åŠ›é“å…·è®¡æ—¶å™¨
let foodInfoTimeout = null;   // é£Ÿç‰©ä¿¡æ¯è®¡æ—¶å™¨
let scoreMultiplierTimeout = null; // åˆ†æ•°ç¿»å€è®¡æ—¶å™¨

    // ============== æ¸¸æˆåˆå§‹åŒ–å‡½æ•° ==============
    function initGame() {
    // æ ¹æ®æ¸¸æˆå®¹å™¨è°ƒæ•´ç”»å¸ƒå¤§å°
    resizeCanvas();
    
    // åˆå§‹åŒ–è›‡çš„ä½ç½®
    gameState.snake = [];
    for (let i = 6; i >= 0; i--) {
        gameState.snake.push({x: i, y: Math.floor(settings.gridSize / 2)});
    }
    
    // åˆå§‹åŒ–æ’å€¼ä½ç½®(ç”¨äºå¹³æ»‘åŠ¨ç”»)
    resetSnakeInterpolation();
    
    // é‡ç½®æ¸¸æˆçŠ¶æ€
    gameState.obstacles = [];
    gameState.trail = [];
    gameState.particles = [];
    gameState.direction = 'right';
    gameState.nextDirection = 'right';
    gameState.speed = settings.baseSpeed / settings.speedMultiplier;
    gameState.score = 0;
    gameState.combo = 0;
    gameState.isGameOver = false;
    gameState.powerUpActive = false;
    gameState.powerUpType = null;
    gameState.scoreMultiplierActive = false;
    gameState.scoreMultiplierTimeLeft = 0;
    
    // æ¸…é™¤è®¡æ—¶å™¨
    if (powerUpTimeout) {
        clearTimeout(powerUpTimeout);
        powerUpTimeout = null;
    }
    
    if (scoreMultiplierTimeout) {
        clearTimeout(scoreMultiplierTimeout);
        scoreMultiplierTimeout = null;
    }
    
    // ç”Ÿæˆç¬¬ä¸€ä¸ªé£Ÿç‰©
    generateFood();
    
    // æ ¹æ®æ¸¸æˆæ¨¡å¼åˆå§‹åŒ–éšœç¢ç‰©
    if (gameState.gameMode === 'challenge') {
        // æŒ‘æˆ˜æ¨¡å¼ä¸‹åˆå§‹æ·»åŠ 5-8ä¸ªéšœç¢ç‰©
        const obstacleCount = 5 + Math.floor(Math.random() * 4);
        for (let i = 0; i < obstacleCount; i++) {
            addObstacle();
        }
    } else if (gameState.gameMode === 'classic') {
        // ç»å…¸æ¨¡å¼ä¸‹åˆå§‹æ·»åŠ 2-3ä¸ªéšœç¢ç‰©
        const obstacleCount = 2 + Math.floor(Math.random() * 2);
        for (let i = 0; i < obstacleCount; i++) {
            addObstacle();
        }
    }
    // ç¦…æ¨¡å¼ä¸æ·»åŠ éšœç¢ç‰©
    
    // æ›´æ–°æ˜¾ç¤º
    updateScoreDisplay();
    updateSpeedDisplay();
    document.getElementById('mode-display').textContent = 'æ¨¡å¼: ' + getModeText();
    
    // ç§»é™¤3Dæ—‹è½¬æ•ˆæœ
    canvas.classList.remove('rotate-effect');
}

    
    function resetSnakeInterpolation() {
        gameState.snakeInterpolated = gameState.snake.map(segment => ({
            displayX: segment.x,
            displayY: segment.y
        }));
    }
    
    // è°ƒæ•´ç”»å¸ƒå¤§å° - ä¿®å¤ç½‘æ ¼æ¸²æŸ“é—®é¢˜
function resizeCanvas() {
    const container = document.getElementById('game-container');
    // è·å–å®¹å™¨å¤§å°
    const containerSize = Math.min(container.clientWidth, container.clientHeight);
    
    // ç²¾ç¡®è®¡ç®—æ¯ä¸ªå•å…ƒæ ¼å¤§å°ï¼Œç¡®ä¿æ•´æ•°
    cellSize = Math.floor(containerSize / settings.gridSize);
    
    // é‡æ–°è®¡ç®—ç”»å¸ƒå¤§å°ï¼Œç¡®ä¿å®Œå…¨åŒ¹é…ç½‘æ ¼
    const canvasSize = cellSize * settings.gridSize;
    
    // è®¾ç½®ç”»å¸ƒå¤§å°
    canvas.width = canvasSize;
    canvas.height = canvasSize;
    
    // è°ƒæ•´ç”»å¸ƒåœ¨å®¹å™¨ä¸­å±…ä¸­
    canvas.style.marginLeft = `${(containerSize - canvasSize) / 2}px`;
    canvas.style.marginTop = `${(containerSize - canvasSize) / 2}px`;
    
    console.log(`è°ƒæ•´ç”»å¸ƒå¤§å°: å®¹å™¨=${containerSize}px, å•å…ƒæ ¼=${cellSize}px, ç”»å¸ƒ=${canvasSize}px, ç½‘æ ¼=${settings.gridSize}x${settings.gridSize}`);
}

    
    // ============== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==============
    // æ¸¸æˆå¾ªç¯
    function gameLoop(timestamp) {
    if (!gameState.lastFrameTime) gameState.lastFrameTime = timestamp;
    
    const deltaTime = timestamp - gameState.lastFrameTime;
    gameState.accumulatedTime += deltaTime;
    
    if (!gameState.isPaused && gameState.isPlaying) {
        // å¤„ç†é€»è¾‘æ›´æ–°(åŸºäºæ—¶é—´æ­¥é•¿)
        const updateSteps = Math.floor(gameState.accumulatedTime / gameState.speed);
        
        if (updateSteps > 0) {
            // é™åˆ¶å•å¸§æœ€å¤§æ›´æ–°æ¬¡æ•°ï¼Œé˜²æ­¢å¡é¡¿åå¤§é‡æ›´æ–°
            const maxUpdates = Math.min(updateSteps, 3);
            
            for (let i = 0; i < maxUpdates; i++) {
                updateGame();
                gameState.accumulatedTime -= gameState.speed;
            }
            
            // å¦‚æœç´¯ç§¯äº†å¤ªå¤šæ›´æ–°ï¼Œç›´æ¥ä¸¢å¼ƒä»¥è¿½èµ¶å½“å‰æ—¶é—´
            if (updateSteps > maxUpdates) {
                gameState.accumulatedTime = 0;
            }
        }
        
        // æ›´æ–°å¹³æ»‘åŠ¨ç”» - ä½¿ç”¨çº¿æ€§æ’å€¼å› å­
        const alpha = gameState.accumulatedTime / gameState.speed;
        updateAnimations(alpha);
        
        // ç»˜åˆ¶æ¸¸æˆç”»é¢
        draw();
    }
    
    gameState.lastFrameTime = timestamp;
    
    // ä»…åœ¨æ¸¸æˆæ­£åœ¨è¿›è¡Œæ—¶ç»§ç»­åŠ¨ç”»å¾ªç¯
    if (gameState.isPlaying) {
        gameState.animationFrame = requestAnimationFrame(gameLoop);
    }
}

// æ·»åŠ ç»˜åˆ¶ä¼ é€é—¨å‡½æ•°
function drawPortals() {
  if (!multiplayerGameState || !multiplayerGameState.portals) return;
  
  multiplayerGameState.portals.forEach(portal => {
    // ç”»ä¼ é€é—¨ä¸»ä½“
    const x = portal.x * cellSize;
    const y = portal.y * cellSize;
    const centerX = x + cellSize / 2;
    const centerY = y + cellSize / 2;
    const radius = cellSize * 0.4;
    
    // æ·»åŠ å‘å…‰æ•ˆæœ
    ctx.shadowColor = portal.color;
    ctx.shadowBlur = 15;
    
    // åˆ›å»ºæ¸å˜
    const gradient = ctx.createRadialGradient(
      centerX, centerY, radius * 0.2,
      centerX, centerY, radius
    );
    
    if (portal.id === 0) {
      // è“è‰²ä¼ é€é—¨
      gradient.addColorStop(0, '#64B5F6');
      gradient.addColorStop(0.7, '#2196F3');
      gradient.addColorStop(1, '#0D47A1');
    } else {
      // ç²‰è‰²ä¼ é€é—¨
      gradient.addColorStop(0, '#F48FB1');
      gradient.addColorStop(0.7, '#E91E63');
      gradient.addColorStop(1, '#880E4F');
    }
    
    // ç»˜åˆ¶ä¼ é€é—¨åœ†å½¢
    ctx.fillStyle = gradient;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fill();
    
    // ç»˜åˆ¶ä¼ é€é—¨å†…éƒ¨å›¾æ¡ˆ
    ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
    ctx.beginPath();
    
    // åˆ›å»ºæ—‹è½¬æ•ˆæœ - éšæ—¶é—´æ—‹è½¬çš„èºæ—‹
    const rotationAngle = (Date.now() / 500) % (Math.PI * 2);
    
    // ç»˜åˆ¶èºæ—‹å›¾æ¡ˆ
    for (let i = 0; i < 3; i++) {
      const angle = rotationAngle + (i * Math.PI * 2 / 3);
      const spiralX = centerX + Math.cos(angle) * radius * 0.5;
      const spiralY = centerY + Math.sin(angle) * radius * 0.5;
      
      ctx.arc(spiralX, spiralY, radius * 0.15, 0, Math.PI * 2);
    }
    
    ctx.fill();
    
    // é‡ç½®é˜´å½±
    ctx.shadowBlur = 0;
  });
}
    
    // æ¸¸æˆçŠ¶æ€æ›´æ–°
    function updateGame() {
        if (gameState.isGameOver) return;
        
        // æ›´æ–°æ–¹å‘
        gameState.direction = gameState.nextDirection;
        
        // è®¡ç®—æ–°çš„å¤´éƒ¨ä½ç½®
        const head = {...gameState.snake[0]};
        
        switch (gameState.direction) {
            case 'up': head.y--; break;
            case 'down': head.y++; break;
            case 'left': head.x--; break;
            case 'right': head.x++; break;
        }
        
        // ç¢°æ’æ£€æµ‹
        let collisionDetected = false;
        
        // æ£€æŸ¥è¾¹ç•Œç¢°æ’(é™¤éæœ‰ç©¿å¢™èƒ½åŠ›)
        if (!gameState.powerUpActive || gameState.powerUpType !== 'phase') {
            if (head.x < 0 || head.x >= settings.gridSize || head.y < 0 || head.y >= settings.gridSize) {
                collisionDetected = true;
            }
        } else {
            // ç©¿å¢™å¤„ç†
            if (head.x < 0) head.x = settings.gridSize - 1;
            if (head.x >= settings.gridSize) head.x = 0;
            if (head.y < 0) head.y = settings.gridSize - 1;
            if (head.y >= settings.gridSize) head.y = 0;
        }
        
        // æ£€æŸ¥è‡ªèº«ç¢°æ’(é™¤éæœ‰æ— æ•Œèƒ½åŠ›)
        if (!collisionDetected && (!gameState.powerUpActive || gameState.powerUpType !== 'invincible')) {
            for (let i = 0; i < gameState.snake.length; i++) {
                if (gameState.snake[i].x === head.x && gameState.snake[i].y === head.y) {
                    collisionDetected = true;
                    break;
                }
            }
        }
        
        // æ£€æŸ¥éšœç¢ç‰©ç¢°æ’(é™¤éæœ‰æ— æ•Œèƒ½åŠ›)
        if (!collisionDetected && (!gameState.powerUpActive || gameState.powerUpType !== 'invincible')) {
            for (let i = 0; i < gameState.obstacles.length; i++) {
                if (gameState.obstacles[i].x === head.x && gameState.obstacles[i].y === head.y) {
                    collisionDetected = true;
                    break;
                }
            }
        }
        
        // å¦‚æœæ£€æµ‹åˆ°ç¢°æ’
        if (collisionDetected) {
            endGame('collision');
            return;
        }
        
        // ç§»åŠ¨è›‡
        gameState.snake.unshift(head);
        
        // è®°å½•è½¨è¿¹
        if (settings.particlesEnabled) {
            gameState.trail.push({...head, alpha: 1});
            if (gameState.trail.length > 10) gameState.trail.shift();
        }
        
        // æ£€æŸ¥æ˜¯å¦åƒåˆ°é£Ÿç‰©
if (gameState.food && head.x === gameState.food.x && head.y === gameState.food.y) {
    // æ’­æ”¾éŸ³æ•ˆ
    if (settings.soundEnabled) {
        sounds.eat.currentTime = 0;
        sounds.eat.play();
    }
    
    // è®°å½•å½“å‰é£Ÿç‰©ç±»å‹ï¼ˆåœ¨åº”ç”¨actionä¹‹å‰ï¼‰
    const currentFoodType = gameState.food.type;
    
    // åº”ç”¨é£Ÿç‰©æ•ˆæœ
    const foodInfo = foodTypes[currentFoodType];
    foodInfo.action();
    
    // æ›´æ–°åˆ†æ•°
    const comboMultiplier = gameState.combo > 0 ? gameState.combo : 1;
    let points = foodInfo.points * comboMultiplier;
    
    // å¤„ç†åˆ†æ•°ç¿»å€æ•ˆæœ
    // æ³¨æ„ï¼šå½“å‰é£Ÿç‰©å¦‚æœæ˜¯é»„è‰²ï¼Œåˆ™ä¸äº«å—ç¿»å€æ•ˆæœï¼ˆé»„è‰²æ¿€æ´»ç¿»å€ï¼Œä½†ä¸è‡ªå·±äº«å—ï¼‰
    if (gameState.scoreMultiplierActive && currentFoodType !== 'yellow') {
        points *= 2;
        // åˆ›å»ºé¢å¤–çš„åˆ†æ•°ç¿»å€æç¤º
        if (settings.particlesEnabled) {
            const bonusPopup = document.createElement('div');
            bonusPopup.className = 'score-popup';
            bonusPopup.textContent = `åŒå€!`;
            bonusPopup.style.left = `${(gameState.food.x + 0.5) * cellSize}px`;
            bonusPopup.style.top = `${(gameState.food.y + 0.5) * cellSize - 40}px`;
            bonusPopup.style.color = '#ffcc00';
            document.getElementById('game-container').appendChild(bonusPopup);
            
            // åˆ é™¤å…ƒç´ 
            setTimeout(() => {
                bonusPopup.remove();
            }, 800);
        }
    }
    
    gameState.score += points;
    gameState.combo++;
    updateScoreDisplay();
    
    // åˆ›å»ºåˆ†æ•°å¼¹å‡ºæ•ˆæœ
    if (settings.particlesEnabled) {
        createScorePopup(gameState.food.x, gameState.food.y, points);
        
        // è¿å‡»æç¤º
        if (gameState.combo > 1) {
            createComboPopup(gameState.food.x, gameState.food.y);
        }
        
        // åˆ›å»ºç²’å­æ•ˆæœ
        particleSystem.createExplosion(gameState.food.x, gameState.food.y, foodInfo.color, 20);
    }
    
    // åœ¨æŒ‘æˆ˜æ¨¡å¼ä¸­æ£€æŸ¥èƒœåˆ©æ¡ä»¶
    if (gameState.gameMode === 'challenge' && gameState.score >= settings.challengeTarget) {
        endGame('victory');
        return;
    }
    
    // ç”Ÿæˆæ–°é£Ÿç‰©
    generateFood();
    
    // æ ¹æ®æ¸¸æˆæ¨¡å¼æ·»åŠ éšœç¢ç‰©
    if (gameState.gameMode === 'challenge' && Math.random() < 0.5) {
        // æŒ‘æˆ˜æ¨¡å¼æœ‰50%å‡ ç‡æ·»åŠ éšœç¢ç‰©
        addObstacle();
    } else if (gameState.gameMode === 'classic' && Math.random() < 0.2) {
        // ç»å…¸æ¨¡å¼æœ‰20%å‡ ç‡æ·»åŠ éšœç¢ç‰©
        addObstacle();
    }
    // ç¦…æ¨¡å¼ä¸æ·»åŠ éšœç¢ç‰©
} else {
    // å¦‚æœæ²¡æœ‰åƒåˆ°é£Ÿç‰©ï¼Œç§»é™¤è›‡å°¾
    gameState.snake.pop();
    gameState.combo = 0; // é‡ç½®è¿å‡»
}

}
    
    // ============== æ”¹è¿›çš„ç²’å­ç‰¹æ•ˆç³»ç»Ÿ ==============
const particleSystem = {
    particles: [],
    maxParticles: 300, // æœ€å¤§ç²’å­æ•°é‡é™åˆ¶
    
    // åˆ›å»ºé£Ÿç‰©åƒåˆ°æ—¶çš„çˆ†ç‚¸æ•ˆæœ
    createExplosion(x, y, color, count = 15) {
        if (!settings.particlesEnabled) return;
        
        // è§£æé¢œè‰²ä¸ºRGB
        const r = parseInt(color.slice(1, 3), 16);
        const g = parseInt(color.slice(3, 5), 16);
        const b = parseInt(color.slice(5, 7), 16);
        
        // é™åˆ¶æœ€å¤§ç²’å­æ•°é‡
        if (this.particles.length > this.maxParticles - count) {
            // ç§»é™¤æœ€æ—§çš„ç²’å­
            this.particles.splice(0, count);
        }
        
        for (let i = 0; i < count; i++) {
            // éšæœºæ–¹å‘å’Œé€Ÿåº¦
            const angle = Math.random() * Math.PI * 2;
            const speed = 0.1 + Math.random() * 0.2;
            
            this.particles.push({
                x: x + 0.5,
                y: y + 0.5,
                vx: Math.cos(angle) * speed,
                vy: Math.sin(angle) * speed,
                radius: 0.5 + Math.random() * 0.5,
                alpha: 1,
                color: {r, g, b},
                life: 1, // ç”Ÿå‘½å€¼ä»1é€’å‡è‡³0
                decay: 0.02 + Math.random() * 0.02, // éšæœºè¡°å‡é€Ÿç‡
                gravity: 0.001 * (Math.random() + 0.5), // æ·»åŠ ä¸€ç‚¹é‡åŠ›
                spin: (Math.random() - 0.5) * 0.1, // æ—‹è½¬æ•ˆæœ
                type: 'normal'
            });
        }
    },
    
    // åˆ›å»ºè›‡ç§»åŠ¨çš„å°¾è¿¹æ•ˆæœ
    createTrail(x, y, color, direction) {
        if (!settings.particlesEnabled) return;
        if (Math.random() > 0.3) return; // åªæœ‰30%çš„ç§»åŠ¨ä¼šäº§ç”Ÿå°¾è¿¹
        
        // è§£æé¢œè‰²ä¸ºRGB
        const r = parseInt(color.slice(1, 3), 16);
        const g = parseInt(color.slice(3, 5), 16);
        const b = parseInt(color.slice(5, 7), 16);
        
        // æ ¹æ®æ–¹å‘è®¾ç½®å°¾è¿¹äº§ç”Ÿçš„åç§»ä½ç½®
        let offsetX = 0, offsetY = 0;
        
        switch (direction) {
            case 'up': offsetY = 0.8; break;
            case 'down': offsetY = 0.2; break;
            case 'left': offsetX = 0.8; break;
            case 'right': offsetX = 0.2; break;
        }
        
        // é™åˆ¶æœ€å¤§ç²’å­æ•°é‡
        if (this.particles.length > this.maxParticles - 1) {
            this.particles.shift();
        }
        
        this.particles.push({
            x: x + offsetX,
            y: y + offsetY,
            vx: (Math.random() - 0.5) * 0.05,
            vy: (Math.random() - 0.5) * 0.05,
            radius: 0.1 + Math.random() * 0.2,
            alpha: 0.7,
            color: {r, g, b},
            life: 1,
            decay: 0.03 + Math.random() * 0.02,
            gravity: 0,
            type: 'trail'
        });
    },
    
    // åˆ›å»ºèƒ½åŠ›æ¿€æ´»æ—¶çš„ç¯ç»•æ•ˆæœ
    createPowerUpEffect(snake, type) {
        if (!settings.particlesEnabled) return;
        
        // è·å–å¤´éƒ¨ä½ç½®
        const head = snake[0];
        
        // è®¾ç½®é¢œè‰²
        let r, g, b;
        if (type === 'phase') {
            r = 0; g = 229; b = 255; // è“è‰²
        } else {
            r = 224; g = 64; b = 251; // ç´«è‰²
        }
        
        // äº§ç”Ÿç¯ç»•ç²’å­
        for (let i = 0; i < 5; i++) {
            const angle = Math.random() * Math.PI * 2;
            const distance = 0.5 + Math.random() * 0.3;
            
            // é™åˆ¶æœ€å¤§ç²’å­æ•°é‡
            if (this.particles.length > this.maxParticles - 1) {
                this.particles.shift();
            }
            
            this.particles.push({
                x: head.x + 0.5 + Math.cos(angle) * distance,
                y: head.y + 0.5 + Math.sin(angle) * distance,
                vx: Math.cos(angle) * 0.05,
                vy: Math.sin(angle) * 0.05,
                radius: 0.15 + Math.random() * 0.15,
                alpha: 0.9,
                color: {r, g, b},
                life: 1,
                decay: 0.02,
                gravity: -0.001, // è½»å¾®å‘ä¸Šé£˜
                orbitRadius: distance,
                orbitSpeed: 0.1 + Math.random() * 0.1,
                orbitAngle: angle,
                type: 'orbit',
                centerX: head.x + 0.5,
                centerY: head.y + 0.5
            });
        }
    },
    
    // æ›´æ–°æ‰€æœ‰ç²’å­
    update(delta) {
        if (!settings.particlesEnabled) return;
        
        for (let i = this.particles.length - 1; i >= 0; i--) {
            const p = this.particles[i];
            
            // æ›´æ–°ç”Ÿå‘½å€¼
            p.life -= p.decay;
            
            // ç§»é™¤æ­»äº¡ç²’å­
            if (p.life <= 0) {
                this.particles.splice(i, 1);
                continue;
            }
            
            // æ ¹æ®ç²’å­ç±»å‹æ›´æ–°
            if (p.type === 'orbit') {
                // æ›´æ–°è½¨é“ç²’å­
                p.orbitAngle += p.orbitSpeed;
                p.centerX = gameState.snake[0].x + 0.5;
                p.centerY = gameState.snake[0].y + 0.5;
                p.x = p.centerX + Math.cos(p.orbitAngle) * p.orbitRadius;
                p.y = p.centerY + Math.sin(p.orbitAngle) * p.orbitRadius;
            } else {
                // æ›´æ–°æ™®é€šç²’å­
                p.x += p.vx;
                p.y += p.vy;
                p.vy += p.gravity || 0;
                
                // åº”ç”¨è‡ªè½¬æ•ˆæœ
                if (p.spin) {
                    p.vx = p.vx * Math.cos(p.spin) - p.vy * Math.sin(p.spin);
                    p.vy = p.vx * Math.sin(p.spin) + p.vy * Math.cos(p.spin);
                }
            }
            
            // æ›´æ–°é€æ˜åº¦
            p.alpha = p.life > 0.8 ? 1 : p.life * 1.25;
        }
    },
    
    // ç»˜åˆ¶æ‰€æœ‰ç²’å­
    draw(ctx, cellSize) {
        if (!settings.particlesEnabled || this.particles.length === 0) return;
        
        for (const p of this.particles) {
            // è®¾ç½®é¢œè‰²å’Œé€æ˜åº¦
            ctx.fillStyle = `rgba(${p.color.r}, ${p.color.g}, ${p.color.b}, ${p.alpha})`;
            
            // ç»˜åˆ¶ç²’å­
            ctx.beginPath();
            ctx.arc(
                p.x * cellSize,
                p.y * cellSize,
                p.radius * cellSize / 3,
                0,
                Math.PI * 2
            );
            ctx.fill();
        }
    },
    
    // æ¸…é™¤æ‰€æœ‰ç²’å­
    clear() {
        this.particles = [];
    }
};

    
    // æ›´æ–°åŠ¨ç”»çŠ¶æ€
function updateAnimations(progress) {
    // è®¡ç®—æ¯å¸§çš„æ—¶é—´å·®
    const deltaTime = gameState.lastFrameTime ? Date.now() - gameState.lastFrameTime : 16;
    
    // æ›´æ–°è›‡çš„å¹³æ»‘ç§»åŠ¨ - å¢åŠ æ’å€¼ç³»æ•°ä½¿ç§»åŠ¨æ›´ä¸æ»‘
    for (let i = 0; i < gameState.snakeInterpolated.length; i++) {
        if (i < gameState.snake.length) {
            const segment = gameState.snakeInterpolated[i];
            if (segment) {
                // ä¿®æ”¹å¹³æ»‘ç³»æ•°ä»0.3åˆ°0.5ï¼Œä½¿ç§»åŠ¨æ›´æµç•…
                segment.displayX += (gameState.snake[i].x - segment.displayX) * 0.5;
                segment.displayY += (gameState.snake[i].y - segment.displayY) * 0.5;
            }
        }
    }
    
    // ç¡®ä¿æ’å€¼æ•°ç»„å¤§å°ä¸è›‡èº«ä¸€è‡´
    while (gameState.snakeInterpolated.length < gameState.snake.length) {
        const last = gameState.snake[gameState.snakeInterpolated.length];
        gameState.snakeInterpolated.push({
            displayX: last.x,
            displayY: last.y
        });
    }
    
    // æ›´æ–°ç²’å­æ•ˆæœ
    if (settings.particlesEnabled) {
        // æ›´æ–°è½¨è¿¹é€æ˜åº¦
        gameState.trail.forEach(point => {
            if (point.alpha) point.alpha *= 0.95;
        });
        
        // ç§»é™¤é€æ˜åº¦å¤ªä½çš„è½¨è¿¹ç‚¹
        gameState.trail = gameState.trail.filter(point => point.alpha > 0.1);
        
        // æ›´æ–°ç²’å­ä½ç½®å’Œé€æ˜åº¦
        gameState.particles.forEach(particle => {
            particle.x += particle.vx;
            particle.y += particle.vy;
            particle.radius *= 0.96;
            particle.alpha *= 0.96;
        });
        
        // ä¼˜åŒ–ï¼šé™åˆ¶ç²’å­æ•°é‡ï¼Œé˜²æ­¢è¿‡å¤šç²’å­å½±å“æ€§èƒ½
        if (gameState.particles.length > 100) {
            gameState.particles.length = 100;
        }
        
        // ç§»é™¤è¿‡å°æˆ–è¿‡é€æ˜çš„ç²’å­
        gameState.particles = gameState.particles.filter(
            particle => particle.alpha > 0.1 && particle.radius > 0.1
        );
    }
    
    // æ›´æ–°ç²’å­ç³»ç»Ÿ
    particleSystem.update(progress);
    
    // å¦‚æœç©å®¶æœ‰èƒ½åŠ›æ¿€æ´»ï¼Œåˆ›å»ºç¯ç»•æ•ˆæœ
    if (gameState.powerUpActive && settings.particlesEnabled) {
        if (Math.random() > 0.7) { // 30%æ¦‚ç‡ç”Ÿæˆç²’å­ï¼Œå‡å°‘è¿‡å¤šç”Ÿæˆ
            particleSystem.createPowerUpEffect(gameState.snake, gameState.powerUpType);
        }
    }
    
    // ä¸ºè›‡çš„ç§»åŠ¨åˆ›å»ºå°¾è¿¹ï¼ˆåªå¯¹å¤´éƒ¨ï¼‰
    if (gameState.snake.length > 0 && settings.particlesEnabled) {
        const head = gameState.snake[0];
        const color = gameState.powerUpActive ? 
            (gameState.powerUpType === 'phase' ? '#00E5FF' : '#E040FB') : 
            '#00E676';
        particleSystem.createTrail(head.x, head.y, color, gameState.direction);
    }
   
// æ›´æ–°åˆ†æ•°ç¿»å€å‰©ä½™æ—¶é—´
if (gameState.scoreMultiplierActive && gameState.scoreMultiplierTimeLeft > 0) {
    gameState.scoreMultiplierTimeLeft -= deltaTime;
    // æ›´æ–°æ˜¾ç¤ºï¼ˆå¦‚æœåœ¨å•äººæ¸¸æˆä¸­ï¼‰
    if (!isMultiplayerGame) {
        updateScoreMultiplierDisplay();
    }
    
    if (gameState.scoreMultiplierTimeLeft <= 0) {
        gameState.scoreMultiplierActive = false;
        
        // éšè—æŒ‡ç¤ºå™¨
        document.getElementById('power-up-indicator').className = '';
        updateScoreMultiplierDisplay(); // ç§»é™¤æ˜¾ç¤º
    }
}

// æ›´æ–°é£Ÿç‰©åŠ¨ç”»
if (gameState.food) {
    gameState.food.pulsePhase = ((gameState.food.pulsePhase || 0) + 0.05) % (Math.PI * 2);
}
}

// æ£€æµ‹è®¾å¤‡ç±»å‹
function isMobileDevice() {
    return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
           window.innerWidth <= 768;
}

// æ ¹æ®è®¾å¤‡ç±»å‹æ˜¾ç¤ºç›¸åº”çš„æ§åˆ¶è®¾ç½®
function showControlSettings() {
    const isMobile = isMobileDevice();
    document.getElementById('mobile-controls-group').style.display = isMobile ? 'block' : 'none';
    document.getElementById('keyboard-controls-group').style.display = isMobile ? 'none' : 'block';
}

// åˆå§‹åŒ–æ§åˆ¶è®¾ç½®
function initControlSettings() {
    showControlSettings();
    
    // åŠ è½½å­˜å‚¨çš„æ§åˆ¶è®¾ç½®åˆ°UI - ä¿®æ”¹é»˜è®¤é€‰ä¸­çŠ¶æ€
    document.getElementById('control-buttons').checked = settings.controlType === 'buttons';
    document.getElementById('control-joystick').checked = settings.controlType === 'joystick';
    document.getElementById('control-size-slider').value = settings.controlSize * 100;
    document.getElementById('control-size-value').textContent = `${Math.round(settings.controlSize * 100)}%`;
    document.getElementById('control-position').value = settings.controlPosition;
    
    // æ›´æ–°é”®ç›˜ç»‘å®šæ˜¾ç¤º
    updateKeyBindingsDisplay();
    
    // è®¾ç½®é”®ç›˜ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
    setupKeyBindingInputs();
    
    // ç«‹å³åº”ç”¨æ§åˆ¶è®¾ç½®
    applyControlSettings();
    
    console.log('æ§åˆ¶è®¾ç½®å·²åˆå§‹åŒ–ï¼Œç±»å‹:', settings.controlType, 'å¤§å°:', settings.controlSize, 'ä½ç½®:', settings.controlPosition);
}


// æ›´æ–°é”®ç›˜ç»‘å®šæ˜¾ç¤º
function updateKeyBindingsDisplay() {
    for (const direction in settings.keyBindings) {
        const input = document.getElementById(`key-${direction}`);
        if (input) {
            input.value = formatKeyBindings(settings.keyBindings[direction]);
        }
    }
}

// æ ¼å¼åŒ–æŒ‰é”®ç»‘å®šæ˜¾ç¤º
function formatKeyBindings(keys) {
    return keys.map(key => {
        if (key === ' ') return 'Space';
        if (key === 'ArrowUp') return 'â†‘';
        if (key === 'ArrowDown') return 'â†“';
        if (key === 'ArrowLeft') return 'â†';
        if (key === 'ArrowRight') return 'â†’';
        return key;
    }).join(', ');
}

// è®¾ç½®é”®ç›˜ç»‘å®šè¾“å…¥æ¡†äº‹ä»¶
function setupKeyBindingInputs() {
    const keyInputs = document.querySelectorAll('.key-binding input');
    keyInputs.forEach(input => {
        input.addEventListener('click', function() {
            this.value = 'æŒ‰ä¸‹ä»»æ„é”®...';
            this.classList.add('listening');
        });
        
        input.addEventListener('keydown', function(e) {
            e.preventDefault();
            if (this.classList.contains('listening')) {
                const direction = this.dataset.direction;
                const key = e.key;
                
                // æ›´æ–°é”®ç»‘å®š
                settings.keyBindings[direction] = [key];
                this.value = formatKeyBindings([key]);
                this.classList.remove('listening');
            }
        });
    });
    
    // é‡ç½®æŒ‰é’®äº‹ä»¶
    const resetButtons = document.querySelectorAll('.reset-key');
    resetButtons.forEach(button => {
        button.addEventListener('click', function() {
            const direction = this.dataset.direction;
            const defaultBindings = getDefaultKeyBindings()[direction];
            settings.keyBindings[direction] = defaultBindings;
            
            const input = document.getElementById(`key-${direction}`);
            input.value = formatKeyBindings(defaultBindings);
            input.classList.remove('listening');
        });
    });
}

// è·å–é»˜è®¤é”®ç›˜ç»‘å®š
function getDefaultKeyBindings() {
    return {
        up: ['ArrowUp', 'w', 'W'],
        down: ['ArrowDown', 's', 'S'],
        left: ['ArrowLeft', 'a', 'A'],
        right: ['ArrowRight', 'd', 'D'],
        pause: [' ', 'p', 'P']
    };
}

// åº”ç”¨æ§åˆ¶è®¾ç½®
function applyControlSettings() {
    const isMobile = isMobileDevice();
    console.log('åº”ç”¨æ§åˆ¶è®¾ç½®ï¼Œå½“å‰æ§åˆ¶ç±»å‹:', settings.controlType);
    
    // åº”ç”¨ç§»åŠ¨è®¾å¤‡æ§åˆ¶è®¾ç½®
    if (isMobile) {
        // è·å–æ§åˆ¶å…ƒç´ 
        const controlButtons = document.getElementById('controls');
        const joystickContainer = document.getElementById('joystick-container');
        
        if (settings.controlType === 'joystick') {
            // ä½¿ç”¨æ‘‡æ†æ§åˆ¶
            console.log('å¯ç”¨æ‘‡æ†æ§åˆ¶ï¼Œå¤§å°è®¾ç½®ä¸º:', settings.controlSize, 'ä½ç½®è®¾ç½®ä¸º:', settings.controlPosition);
            controlButtons.style.display = 'none';
            joystickContainer.style.display = 'block';
            
            // åº”ç”¨æ‘‡æ†å¤§å°
            const size = 150 * settings.controlSize;
            joystickContainer.style.width = `${size}px`;
            joystickContainer.style.height = `${size}px`;
            
            // ç›´æ¥è®¾ç½®æ‘‡æ†ä½ç½®è€Œä¸æ˜¯ä½¿ç”¨ç±»ï¼Œé¿å…CSSç‰¹å¼‚æ€§é—®é¢˜
            // é¦–å…ˆé‡ç½®æ‰€æœ‰ä½ç½®ç›¸å…³æ ·å¼
            joystickContainer.style.left = '';
            joystickContainer.style.right = '';
            joystickContainer.style.transform = '';
            
            // ç„¶åæ ¹æ®è®¾ç½®åº”ç”¨ç›¸åº”çš„ä½ç½®æ ·å¼
            if (settings.controlPosition === 'left') {
                joystickContainer.style.left = '20px';
                joystickContainer.style.transform = 'translateX(0)';
            } else if (settings.controlPosition === 'right') {
                joystickContainer.style.left = 'auto';
                joystickContainer.style.right = '20px';
                joystickContainer.style.transform = 'translateX(0)';
            } else {
                joystickContainer.style.left = '50%';
                joystickContainer.style.transform = 'translateX(-50%)';
            }
            
            // é‡ç½®æ‘‡æ†ä½ç½®
            const joystickStick = document.getElementById('joystick-stick');
            if (joystickStick) {
                joystickStick.style.left = '50%';
                joystickStick.style.top = '50%';
                joystickStick.style.transform = 'translate(-50%, -50%)';
            }
            
            // è®¾ç½®æ‘‡æ†
            setTimeout(setupJoystick, 100); // å»¶æ—¶ç¡®ä¿DOMå·²æ›´æ–°
        } else {
            // ä½¿ç”¨æŒ‰é’®æ§åˆ¶
            console.log('å¯ç”¨æŒ‰é’®æ§åˆ¶ï¼Œå¤§å°è®¾ç½®ä¸º:', settings.controlSize);
            controlButtons.style.display = 'grid';
            joystickContainer.style.display = 'none';
            
            // åº”ç”¨æŒ‰é’®å¤§å°
            const size = 180 * settings.controlSize;
            controlButtons.style.width = `${size}px`;
            controlButtons.style.height = `${size}px`;
            
            // åº”ç”¨æŒ‰é’®ä½ç½®
            if (settings.controlPosition === 'left') {
                controlButtons.style.marginLeft = '20px';
                controlButtons.style.marginRight = 'auto';
            } else if (settings.controlPosition === 'right') {
                controlButtons.style.marginLeft = 'auto';
                controlButtons.style.marginRight = '20px';
            } else {
                controlButtons.style.marginLeft = 'auto';
                controlButtons.style.marginRight = 'auto';
            }
        }
    } else {
        // æ¡Œé¢è®¾å¤‡åªä½¿ç”¨é”®ç›˜æ§åˆ¶
        document.getElementById('controls').style.display = 'none';
        document.getElementById('joystick-container').style.display = 'none';
    }
}


// è®¾ç½®è™šæ‹Ÿæ‘‡æ† - æ”¹è¿›æµç•…åº¦ç‰ˆæœ¬
function setupJoystick() {
    const joystickBase = document.getElementById('joystick-base');
    const joystickStick = document.getElementById('joystick-stick');
    
    let isDragging = false;
    let currentDirection = null;
    let timer = null;
    
    // è·å–åŸºç¡€ä½ç½®
    const baseRect = joystickBase.getBoundingClientRect();
    const centerX = baseRect.width / 2;
    const centerY = baseRect.height / 2;
    
    // å¤„ç†è§¦æ‘¸/é¼ æ ‡äº‹ä»¶
    const handleStart = (e) => {
        e.preventDefault();
        isDragging = true;
        joystickStick.style.transition = 'none'; // ç§»é™¤è¿‡æ¸¡æ•ˆæœä»¥å®ç°å³æ—¶å“åº”
        handleMove(e);
    };
    
    const handleMove = (e) => {
        if (!isDragging) return;
        
        const point = e.type.includes('touch') ? 
            e.touches[0] : e;
        
        const rect = joystickBase.getBoundingClientRect();
        const x = point.clientX - rect.left;
        const y = point.clientY - rect.top;
        
        // è®¡ç®—ä¸ä¸­å¿ƒçš„è·ç¦»
        const deltaX = x - centerX;
        const deltaY = y - centerY;
        const distance = Math.min(Math.sqrt(deltaX * deltaX + deltaY * deltaY), centerX);
        const angle = Math.atan2(deltaY, deltaX);
        
        // ç§»åŠ¨æ‘‡æ† - å¹³æ»‘è·Ÿéšæ‰‹æŒ‡
        const stickX = centerX + Math.cos(angle) * distance;
        const stickY = centerY + Math.sin(angle) * distance;
        
        joystickStick.style.left = `${stickX}px`;
        joystickStick.style.top = `${stickY}px`;
        
        // é€‚ä¸­çš„æ­»åŒº - 35%
        const deadZone = centerX * 0.35;
        
        // ç¡®å®šæ–¹å‘ï¼Œè¶…è¿‡æ­»åŒºå°±å¯ä»¥è§¦å‘
        let newDirection = null;
        if (distance > deadZone) {
            // æ ¹æ®è§’åº¦ç¡®å®šæ–¹å‘
            if (angle > -Math.PI/4 && angle < Math.PI/4) {
                newDirection = 'right';
                joystickStick.style.backgroundColor = 'rgba(255, 100, 100, 0.7)';
            }
            else if (angle >= Math.PI/4 && angle < 3*Math.PI/4) {
                newDirection = 'down';
                joystickStick.style.backgroundColor = 'rgba(100, 100, 255, 0.7)';
            }
            else if (angle >= 3*Math.PI/4 || angle < -3*Math.PI/4) {
                newDirection = 'left';
                joystickStick.style.backgroundColor = 'rgba(100, 255, 100, 0.7)';
            }
            else {
                newDirection = 'up';
                joystickStick.style.backgroundColor = 'rgba(255, 255, 100, 0.7)';
            }
            
            // åªæœ‰å½“æ–¹å‘çœŸæ­£æ”¹å˜æ—¶æ‰æ›´æ–°
            if (newDirection !== currentDirection) {
                // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å‘é€
                if (timer) {
                    clearInterval(timer);
                    timer = null;
                }
                
                // æ›´æ–°å½“å‰æ–¹å‘
                currentDirection = newDirection;
                
                // ç«‹å³å‘é€æ–°æ–¹å‘
                changeDirectionMultiplayer(currentDirection);
                
                // è®¾ç½®è¾ƒçŸ­é—´éš”çš„å®šæ—¶å‘é€ï¼Œç¡®ä¿å“åº”åŠæ—¶
                timer = setInterval(() => {
                    changeDirectionMultiplayer(currentDirection);
                }, 100);
            }
        } else {
            // åœ¨æ­»åŒºå†…
            joystickStick.style.backgroundColor = 'rgba(0, 255, 150, 0.6)';
        }
    };
    
    const handleEnd = () => {
        isDragging = false;
        currentDirection = null;
        
        // é‡ç½®æ‘‡æ†ä½ç½®ï¼Œæ·»åŠ è¿‡æ¸¡æ•ˆæœ
        joystickStick.style.transition = 'all 0.2s ease';
        joystickStick.style.left = '50%';
        joystickStick.style.top = '50%';
        joystickStick.style.transform = 'translate(-50%, -50%)';
        joystickStick.style.backgroundColor = 'rgba(0, 255, 150, 0.6)';
        
        // æ¸…é™¤å®šæ—¶å™¨
        if (timer) {
            clearInterval(timer);
            timer = null;
        }
    };
    
    // å…ˆæ¸…é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶å¤„ç†å™¨
    joystickBase.removeEventListener('mousedown', handleStart);
    document.removeEventListener('mousemove', handleMove);
    document.removeEventListener('mouseup', handleEnd);
    joystickBase.removeEventListener('touchstart', handleStart);
    document.removeEventListener('touchmove', handleMove);
    document.removeEventListener('touchend', handleEnd);
    document.removeEventListener('touchcancel', handleEnd);
    
    // æ·»åŠ è§¦æ‘¸å’Œé¼ æ ‡äº‹ä»¶
    joystickBase.addEventListener('mousedown', handleStart);
    document.addEventListener('mousemove', handleMove);
    document.addEventListener('mouseup', handleEnd);
    
    joystickBase.addEventListener('touchstart', handleStart, { passive: false });
    document.addEventListener('touchmove', handleMove, { passive: false });
    document.addEventListener('touchend', handleEnd);
    document.addEventListener('touchcancel', handleEnd);
    
    console.log('è™šæ‹Ÿæ‘‡æ†å·²è®¾ç½®å®Œæˆï¼Œæå‡äº†æµç•…åº¦å’Œå“åº”æ€§');
}




// ä¿å­˜è®¾ç½®
function saveSettings() {
    // è·å–æ§åˆ¶è®¾ç½®
    settings.controlType = document.getElementById('control-buttons').checked ? 'buttons' : 'joystick';
    settings.controlSize = parseInt(document.getElementById('control-size-slider').value) / 100;
    settings.controlPosition = document.getElementById('control-position').value;
    
    // å…¶ä»–è®¾ç½®
    settings.soundEnabled = document.getElementById('sound-checkbox').checked;
    settings.particlesEnabled = document.getElementById('particles-checkbox').checked;
    settings.gridEnabled = document.getElementById('grid-checkbox').checked;
    settings.speedMultiplier = parseInt(document.getElementById('speed-slider').value) / 10;
    
    // è¾“å‡ºè®¾ç½®ä»¥ä¾¿è°ƒè¯•
    console.log('ä¿å­˜è®¾ç½®:', {
        controlType: settings.controlType,
        controlSize: settings.controlSize,
        controlPosition: settings.controlPosition
    });
    
    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
    const settingsToSave = {
        soundEnabled: settings.soundEnabled,
        particlesEnabled: settings.particlesEnabled,
        gridEnabled: settings.gridEnabled,
        speedMultiplier: settings.speedMultiplier,
        controlType: settings.controlType,
        controlSize: settings.controlSize,
        controlPosition: settings.controlPosition,
        keyBindings: settings.keyBindings
    };
    
    localStorage.setItem('snakeSettings', JSON.stringify(settingsToSave));
    
    // ç«‹å³åº”ç”¨æ§åˆ¶è®¾ç½®
    applyControlSettings();
}


// ä¿®æ”¹loadSettingså‡½æ•°æ¥åŠ è½½æ§åˆ¶è®¾ç½®
function loadSettings() {
    const savedSettings = localStorage.getItem('snakeSettings');
    if (savedSettings) {
        const parsed = JSON.parse(savedSettings);
        
        // æ›´æ–°è®¾ç½®
        settings.soundEnabled = parsed.soundEnabled !== undefined ? parsed.soundEnabled : true;
        settings.particlesEnabled = parsed.particlesEnabled !== undefined ? parsed.particlesEnabled : true;
        settings.gridEnabled = parsed.gridEnabled !== undefined ? parsed.gridEnabled : true;
        settings.speedMultiplier = parsed.speedMultiplier || 1.0;
        
        // åŠ è½½æ§åˆ¶è®¾ç½®
        settings.controlType = parsed.controlType || 'buttons';  // é»˜è®¤ä¸ºæŒ‰é’®æ§åˆ¶
        settings.controlSize = parsed.controlSize !== undefined ? parsed.controlSize : 1.0;  // é»˜è®¤ä¸º100%
        settings.controlPosition = parsed.controlPosition || 'center';  // é»˜è®¤ä¸ºå±…ä¸­
        
        if (parsed.keyBindings) settings.keyBindings = parsed.keyBindings;
        
        // æ›´æ–°UI
        document.getElementById('sound-checkbox').checked = settings.soundEnabled;
        document.getElementById('particles-checkbox').checked = settings.particlesEnabled;
        document.getElementById('grid-checkbox').checked = settings.gridEnabled;
        document.getElementById('speed-slider').value = settings.speedMultiplier * 10;
        document.getElementById('speed-value').textContent = settings.speedMultiplier * 10;
        
        console.log('å·²åŠ è½½è®¾ç½®ï¼Œæ§åˆ¶ç±»å‹:', settings.controlType, 'å¤§å°:', settings.controlSize, 'ä½ç½®:', settings.controlPosition);
    }
    
    // åŠ è½½é«˜åˆ†
    const highScore = localStorage.getItem('snakeHighScore');
    if (highScore) {
        gameState.highScore = parseInt(highScore);
        document.getElementById('high-score').textContent = gameState.highScore;
    }
    
    // åˆå§‹åŒ–æ§åˆ¶è®¾ç½®å¹¶åº”ç”¨
    initControlSettings();
}

// ä¿®æ”¹é”®ç›˜äº‹ä»¶å¤„ç†
function setupKeyboardControls() {
    document.addEventListener('keydown', (e) => {
        if (!gameState.isPlaying) return;
        
        // æ£€æŸ¥æŒ‰é”®æ˜¯å¦åŒ¹é…ä»»ä½•æ–¹å‘
        for (const direction in settings.keyBindings) {
            if (settings.keyBindings[direction].includes(e.key)) {
                if (direction === 'pause') {
                    if (!isMultiplayerGame) {
                        togglePause();
                    }
                } else {
                    changeDirectionMultiplayer(direction);
                }
                break;
            }
        }
    });
}

// è®¾ç½®æ§åˆ¶äº‹ä»¶ç›‘å¬
function setupControlEvents() {
    // æ§åˆ¶å¤§å°æ»‘å—å®æ—¶æ›´æ–°
    document.getElementById('control-size-slider').addEventListener('input', function() {
        document.getElementById('control-size-value').textContent = `${this.value}%`;
        
        // å®æ—¶æ›´æ–°å¤§å°
        settings.controlSize = parseInt(this.value) / 100;
        applyControlSettings();
    });
    
    // æ§åˆ¶ç±»å‹åˆ‡æ¢äº‹ä»¶
    document.getElementById('control-buttons').addEventListener('change', function() {
        if (this.checked) {
            console.log('æŒ‰é’®æ§åˆ¶è¢«é€‰ä¸­');
            settings.controlType = 'buttons';
            applyControlSettings();
        }
    });
    
    document.getElementById('control-joystick').addEventListener('change', function() {
        if (this.checked) {
            console.log('æ‘‡æ†æ§åˆ¶è¢«é€‰ä¸­');
            settings.controlType = 'joystick';
            applyControlSettings();
        }
    });
    
    // æ§åˆ¶ä½ç½®åˆ‡æ¢äº‹ä»¶
    document.getElementById('control-position').addEventListener('change', function() {
        console.log('ä½ç½®æ”¹å˜ä¸º:', this.value);
        settings.controlPosition = this.value;
        applyControlSettings();
    });
}

    
    // ============== ç»˜åˆ¶å‡½æ•° ==============
    function draw() {
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ç»˜åˆ¶èƒŒæ™¯ç½‘æ ¼
        if (settings.gridEnabled) {
            drawGrid();
        }
        
        // ç»˜åˆ¶è½¨è¿¹å’Œç²’å­
        if (settings.particlesEnabled) {
            particleSystem.draw(ctx, cellSize);
        }
        
        // ç»˜åˆ¶éšœç¢ç‰©
        drawObstacles();
        
        // ç»˜åˆ¶é£Ÿç‰©
        drawFood();
        
        // ç»˜åˆ¶è›‡
        drawSnake();
        
        // ç»˜åˆ¶èƒ½åŠ›ç‰¹æ•ˆ
        if (gameState.powerUpActive) {
            drawPowerUpEffect();
        }
    }
    
    // ç»˜åˆ¶ç½‘æ ¼ - ç¡®ä¿å‡†ç¡®åŒ¹é…ç½‘æ ¼å¤§å°
function drawGrid() {
    ctx.strokeStyle = 'rgba(50, 50, 50, 0.3)';
    ctx.lineWidth = 0.5;
    
    // ç»˜åˆ¶å‚ç›´å’Œæ°´å¹³çº¿
    for (let i = 0; i <= settings.gridSize; i++) {
        // å‚ç›´çº¿
        ctx.beginPath();
        ctx.moveTo(i * cellSize, 0);
        ctx.lineTo(i * cellSize, canvas.height);
        ctx.stroke();
        
        // æ°´å¹³çº¿
        ctx.beginPath();
        ctx.moveTo(0, i * cellSize);
        ctx.lineTo(canvas.width, i * cellSize);
        ctx.stroke();
    }
    
    // ç»˜åˆ¶è¾¹ç•Œä»¥çªå‡ºæ˜¾ç¤ºæ¸¸æˆåŒºåŸŸ
    ctx.strokeStyle = 'rgba(0, 255, 150, 0.3)';
    ctx.lineWidth = 2;
    ctx.strokeRect(0, 0, canvas.width, canvas.height);
}

    
    // ç»˜åˆ¶ç§»åŠ¨è½¨è¿¹
    function drawTrail() {
        gameState.trail.forEach(point => {
            if (!point.alpha) return;
            
            ctx.fillStyle = `rgba(0, 255, 150, ${point.alpha * 0.3})`;
            ctx.fillRect(
                point.x * cellSize,
                point.y * cellSize,
                cellSize,
                cellSize
            );
        });
    }
    
    // ç»˜åˆ¶ç²’å­æ•ˆæœ
    function drawParticles() {
        gameState.particles.forEach(particle => {
            ctx.fillStyle = `rgba(${particle.color.r}, ${particle.color.g}, ${particle.color.b}, ${particle.alpha})`;
            ctx.beginPath();
            ctx.arc(
                particle.x * cellSize,
                particle.y * cellSize,
                particle.radius * cellSize / 3,
                0,
                Math.PI * 2
            );
            ctx.fill();
        });
    }
    
    // ç»˜åˆ¶éšœç¢ç‰©
    function drawObstacles() {
    gameState.obstacles.forEach(obstacle => {
        const padding = cellSize * 0.1;
        const x = obstacle.x * cellSize + padding;
        const y = obstacle.y * cellSize + padding;
        const size = cellSize - padding * 2;
        
        // æ·»åŠ å‘å…‰æ•ˆæœ
        ctx.shadowColor = '#ff0066';
        ctx.shadowBlur = 10;
        
        // ç»˜åˆ¶éšœç¢ç‰©ä¸»ä½“
        ctx.fillStyle = '#ad1457';
        ctx.fillRect(x, y, size, size);
        
        // ç»˜åˆ¶éšœç¢ç‰©å›¾æ¡ˆ (è­¦å‘Šæ ‡å¿—)
        ctx.fillStyle = '#ffeb3b';
        ctx.beginPath();
        
        // ä¸‰è§’å½¢è­¦å‘Šæ ‡å¿—
        ctx.moveTo(x + size/2, y + size/4);
        ctx.lineTo(x + size/4, y + size*3/4);
        ctx.lineTo(x + size*3/4, y + size*3/4);
        ctx.closePath();
        ctx.fill();
        
        // å†…éƒ¨æ„Ÿå¹å·
        ctx.fillStyle = '#ad1457';
        ctx.fillRect(x + size/2 - size/10, y + size/2 - size/10, size/5, size/5);
        ctx.fillRect(x + size/2 - size/10, y + size*2/3 - size/10, size/5, size/5);
        
        // é‡ç½®é˜´å½±
        ctx.shadowBlur = 0;
    });
}

    
    // ç»˜åˆ¶é£Ÿç‰©
    function drawFood() {
        if (!gameState.food) return;
        
        const food = gameState.food;
        const foodInfo = foodTypes[food.type];
        
        // è®¡ç®—è„‰åŠ¨æ•ˆæœ
        const scale = 1 + Math.sin(food.pulsePhase || 0) * 0.1;
        const centerX = (food.x + 0.5) * cellSize;
        const centerY = (food.y + 0.5) * cellSize;
        const radius = cellSize * 0.4 * scale;
        
        // ç»˜åˆ¶é£Ÿç‰©
        ctx.save();
        
        // é—ªå…‰æ•ˆæœ
        ctx.shadowColor = foodInfo.color;
        ctx.shadowBlur = 10;
        
        // ä¸»ä½“
        ctx.fillStyle = foodInfo.color;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.fill();
        
        // è¾¹æ¡†
        ctx.strokeStyle = foodInfo.borderColor;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
        ctx.stroke();
        
        // å†…éƒ¨è£…é¥°
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.beginPath();
        ctx.arc(centerX - radius * 0.3, centerY - radius * 0.3, radius * 0.2, 0, Math.PI * 2);
        ctx.fill();
        
        ctx.restore();
    }
    
// ç»˜åˆ¶è›‡
function drawSnake() {
    // ç¡®ä¿æœ‰è¶³å¤Ÿçš„æ’å€¼èŠ‚ç‚¹
    while (gameState.snakeInterpolated.length < gameState.snake.length) {
        const lastIdx = gameState.snakeInterpolated.length;
        const lastPos = gameState.snake[lastIdx];
        gameState.snakeInterpolated.push({
            displayX: lastPos.x,
            displayY: lastPos.y
        });
    }
    
    // ç»˜åˆ¶è›‡èº«ä½“
    gameState.snakeInterpolated.forEach((segment, index) => {
        if (index >= gameState.snake.length) return;
        
        const isHead = index === 0;
        
        // è®¡ç®—é¢œè‰²
        let color;
        if (isHead) {
            color = gameState.powerUpActive ? 
                (gameState.powerUpType === 'phase' ? '#00E5FF' : '#E040FB') : 
                '#00E676';
        } else {
            // èº«ä½“é¢œè‰²æ¸å˜
            const hue = gameState.powerUpActive ? 
                (gameState.powerUpType === 'phase' ? 180 : 280) : 
                140 - (index / gameState.snake.length * 40);
            const saturation = 80 - (index / gameState.snake.length * 30);
            const lightness = 60 - (index / gameState.snake.length * 20);
            color = `hsl(${hue}, ${saturation}%, ${lightness}%)`;
        }
        
        // ç»˜åˆ¶èº«ä½“æ®µ
        const x = segment.displayX * cellSize;
        const y = segment.displayY * cellSize;
        const size = cellSize * 0.9;
        const radius = isHead ? cellSize * 0.45 : cellSize * 0.35;
        
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.arc(
            x + cellSize / 2,
            y + cellSize / 2,
            radius,
            0,
            Math.PI * 2
        );
        ctx.fill();
        
        // å¦‚æœæ˜¯å¤´éƒ¨ï¼Œæ·»åŠ çœ¼ç›
        if (isHead) {
            drawSnakeEyes(segment);
        }
    });
}
    
    // ç»˜åˆ¶è›‡çš„çœ¼ç›
    function drawSnakeEyes(head) {
        const eyeSize = cellSize * 0.15;
        const eyeDistance = cellSize * 0.18;
        
        // æ ¹æ®æ–¹å‘è°ƒæ•´çœ¼ç›ä½ç½®
        let leftEyePos, rightEyePos;
        const centerX = (head.displayX + 0.5) * cellSize;
        const centerY = (head.displayY + 0.5) * cellSize;
        
        switch (gameState.direction) {
            case 'up':
                leftEyePos = {x: centerX - eyeDistance, y: centerY - eyeDistance};
                rightEyePos = {x: centerX + eyeDistance, y: centerY - eyeDistance};
                break;
            case 'down':
                leftEyePos = {x: centerX - eyeDistance, y: centerY + eyeDistance};
                rightEyePos = {x: centerX + eyeDistance, y: centerY + eyeDistance};
                break;
            case 'left':
                leftEyePos = {x: centerX - eyeDistance, y: centerY - eyeDistance};
                rightEyePos = {x: centerX - eyeDistance, y: centerY + eyeDistance};
                break;
            case 'right':
                leftEyePos = {x: centerX + eyeDistance, y: centerY - eyeDistance};
                rightEyePos = {x: centerX + eyeDistance, y: centerY + eyeDistance};
                break;
        }
        
        // ç»˜åˆ¶çœ¼ç›
        ctx.fillStyle = 'white';
        ctx.beginPath();
        ctx.arc(leftEyePos.x, leftEyePos.y, eyeSize, 0, Math.PI * 2);
        ctx.arc(rightEyePos.x, rightEyePos.y, eyeSize, 0, Math.PI * 2);
        ctx.fill();
        
        // ç»˜åˆ¶ç³å­”
        const pupilOffset = eyeSize * 0.4;
        const pupilSize = eyeSize * 0.6;
        
        // è®¡ç®—ç³å­”ä½ç½®åç§»(æ ¹æ®æ–¹å‘)
        let pupilOffsetX = 0, pupilOffsetY = 0;
        switch (gameState.direction) {
            case 'up': pupilOffsetY = -pupilOffset; break;
            case 'down': pupilOffsetY = pupilOffset; break;
            case 'left': pupilOffsetX = -pupilOffset; break;
            case 'right': pupilOffsetX = pupilOffset; break;
        }
        
        ctx.fillStyle = 'black';
        ctx.beginPath();
        ctx.arc(
            leftEyePos.x + pupilOffsetX, 
            leftEyePos.y + pupilOffsetY, 
            pupilSize, 
            0, 
            Math.PI * 2
        );
        ctx.arc(
            rightEyePos.x + pupilOffsetX, 
            rightEyePos.y + pupilOffsetY, 
            pupilSize, 
            0, 
            Math.PI * 2
        );
        ctx.fill();
    }
    
    // ç»˜åˆ¶èƒ½åŠ›ç‰¹æ•ˆ
    function drawPowerUpEffect() {
        // æ·»åŠ å…¨å±è¦†ç›–æ•ˆæœ
        ctx.fillStyle = gameState.powerUpType === 'phase' ? 
            'rgba(0, 229, 255, 0.1)' : 
            'rgba(224, 64, 251, 0.1)';
        
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // æ·»åŠ è¾¹æ¡†é—ªçƒæ•ˆæœ
        const borderColor = gameState.powerUpType === 'phase' ? 
            'rgba(0, 229, 255, 0.5)' : 
            'rgba(224, 64, 251, 0.5)';
        
        const borderWidth = 4 + Math.sin(Date.now() / 100) * 2;
        
        ctx.strokeStyle = borderColor;
        ctx.lineWidth = borderWidth;
        ctx.strokeRect(
            borderWidth / 2, 
            borderWidth / 2, 
            canvas.width - borderWidth, 
            canvas.height - borderWidth
        );
    }
    
    // ============== æ¸¸æˆé€»è¾‘è¾…åŠ©å‡½æ•° ==============
    // ç”Ÿæˆé£Ÿç‰©
    function generateFood() {
        // å¯ç”¨é£Ÿç‰©ç±»å‹
        const types = Object.keys(foodTypes);
        
        // æ ¹æ®æ¸¸æˆè¿›åº¦å’Œéš¾åº¦è°ƒæ•´é£Ÿç‰©ç±»å‹å‡ºç°æ¦‚ç‡
        let typeIndex;
        const rand = Math.random();
        const snakeLength = gameState.snake.length;
        
        if (snakeLength < 10 || rand < 0.5) {
            // åŸºç¡€é£Ÿç‰©(çº¢/é»„/ç»¿)
            typeIndex = Math.floor(Math.random() * 3);
        } else if (snakeLength < 20 || rand < 0.8) {
            // è“è‰²é£Ÿç‰©(ç©¿å¢™)
            typeIndex = 3;
        } else {
            // ç´«è‰²é£Ÿç‰©(æ— æ•Œ)
            typeIndex = 4;
        }
        
        const type = types[typeIndex];
        
        // æ‰¾åˆ°ä¸€ä¸ªä¸åœ¨è›‡èº«ä½“å’Œéšœç¢ç‰©ä¸Šçš„ä½ç½®
        let x, y, validPosition = false;
        let attempts = 0;
        const maxAttempts = 100;
        
        while (!validPosition && attempts < maxAttempts) {
            x = Math.floor(Math.random() * settings.gridSize);
            y = Math.floor(Math.random() * settings.gridSize);
            validPosition = true;
            attempts++;
            
            // æ£€æŸ¥æ˜¯å¦ä¸è›‡èº«ä½“é‡å 
            for (const segment of gameState.snake) {
                if (segment.x === x && segment.y === y) {
                    validPosition = false;
                    break;
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸éšœç¢ç‰©é‡å 
            if (validPosition) {
                for (const obstacle of gameState.obstacles) {
                    if (obstacle.x === x && obstacle.y === y) {
                        validPosition = false;
                        break;
                    }
                }
            }
        }
        
        // å¦‚æœæ‰¾ä¸åˆ°æœ‰æ•ˆä½ç½®ï¼Œä½¿ç”¨åå¤‡æ–¹æ¡ˆ
        if (!validPosition) {
            // ä»ç½‘æ ¼è¾¹ç¼˜é€‰æ‹©ä¸€ä¸ªä½ç½®
            const edge = Math.floor(Math.random() * 4);
            switch (edge) {
                case 0: // ä¸Šè¾¹ç¼˜
                    x = Math.floor(Math.random() * settings.gridSize);
                    y = 0;
                    break;
                case 1: // å³è¾¹ç¼˜
                    x = settings.gridSize - 1;
                    y = Math.floor(Math.random() * settings.gridSize);
                    break;
                case 2: // ä¸‹è¾¹ç¼˜
                    x = Math.floor(Math.random() * settings.gridSize);
                    y = settings.gridSize - 1;
                    break;
                case 3: // å·¦è¾¹ç¼˜
                    x = 0;
                    y = Math.floor(Math.random() * settings.gridSize);
                    break;
            }
        }
        
        // åˆ›å»ºé£Ÿç‰©
        gameState.food = {
            x,
            y,
            type,
            pulsePhase: 0
        };
        
        // æ˜¾ç¤ºé£Ÿç‰©ä¿¡æ¯
        showFoodInfo(type);
    }
    
    // æ¿€æ´»åˆ†æ•°ç¿»å€æ•ˆæœ
function activateScoreMultiplier(duration) {
    // æ¸…é™¤ä¹‹å‰çš„è®¡æ—¶å™¨
    if (scoreMultiplierTimeout) {
        clearTimeout(scoreMultiplierTimeout);
    }
    
    gameState.scoreMultiplierActive = true;
    gameState.scoreMultiplierTimeLeft = duration;
    
    // æ˜¾ç¤ºæŒ‡ç¤ºå™¨
    const powerUpIndicator = document.getElementById('power-up-indicator');
    powerUpIndicator.textContent = 'åˆ†æ•°ç¿»å€æ¿€æ´»!';
    powerUpIndicator.className = 'show';
    powerUpIndicator.style.color = '#ffcc00';
    
    // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
    updateScoreMultiplierDisplay();
    
    // åˆ›å»ºæ›´æ–°è®¡æ—¶å™¨ï¼Œæ¯ç§’æ›´æ–°ä¸€æ¬¡å€’è®¡æ—¶æ˜¾ç¤º
    const updateInterval = setInterval(() => {
        if (gameState.scoreMultiplierTimeLeft > 0) {
            gameState.scoreMultiplierTimeLeft -= 1000;
            updateScoreMultiplierDisplay();
        } else {
            clearInterval(updateInterval);
        }
    }, 1000);
    
    // è®¾ç½®è®¡æ—¶å™¨ç»“æŸç¿»å€æ•ˆæœ
    scoreMultiplierTimeout = setTimeout(() => {
        gameState.scoreMultiplierActive = false;
        gameState.scoreMultiplierTimeLeft = 0;
        powerUpIndicator.className = '';
        clearInterval(updateInterval);
        updateScoreMultiplierDisplay(); // ç§»é™¤æ˜¾ç¤º
    }, duration);
}


    // æ·»åŠ éšœç¢ç‰©
    function addObstacle() {
    // æ ¹æ®æ¸¸æˆæ¨¡å¼å†³å®šæœ€å¤§éšœç¢ç‰©æ•°é‡
    let maxObstacles = 10; // é»˜è®¤
    if (gameState.gameMode === 'challenge') {
        maxObstacles = 20; // æŒ‘æˆ˜æ¨¡å¼æ›´å¤šéšœç¢ç‰©
    } else if (gameState.gameMode === 'classic') {
        maxObstacles = 15; // ç»å…¸æ¨¡å¼é€‚ä¸­
    }
    
    if (gameState.obstacles.length >= maxObstacles) return; // é™åˆ¶éšœç¢ç‰©æ•°é‡
    
    // æ‰¾ä¸€ä¸ªä¸åœ¨è›‡èº«ä½“å’Œé£Ÿç‰©ä¸Šçš„ä½ç½®
    let x, y, validPosition = false;
    let attempts = 0;
    const maxAttempts = 50;
    
    while (!validPosition && attempts < maxAttempts) {
        x = Math.floor(Math.random() * settings.gridSize);
        y = Math.floor(Math.random() * settings.gridSize);
        validPosition = true;
        attempts++;
        
        // æ£€æŸ¥æ˜¯å¦ä¸è›‡èº«ä½“é‡å 
        for (const segment of gameState.snake) {
            if (segment.x === x && segment.y === y) {
                validPosition = false;
                break;
            }
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸é£Ÿç‰©é‡å 
        if (validPosition && gameState.food && gameState.food.x === x && gameState.food.y === y) {
            validPosition = false;
        }
        
        // æ£€æŸ¥æ˜¯å¦ä¸å…¶ä»–éšœç¢ç‰©é‡å 
        if (validPosition) {
            for (const obstacle of gameState.obstacles) {
                if (obstacle.x === x && obstacle.y === y) {
                    validPosition = false;
                    break;
                }
            }
        }
        
        // ç¡®ä¿æ–°éšœç¢ç‰©ä¸ä¼šå¤ªé è¿‘è›‡å¤´
        if (validPosition) {
            const head = gameState.snake[0];
            const distance = Math.abs(head.x - x) + Math.abs(head.y - y);
            // å¢åŠ å®‰å…¨è·ç¦»ï¼Œé¿å…çªç„¶å‡ºç°åœ¨è›‡å¤´å‰
            if (distance < 6) {
                validPosition = false;
            }
        }
    }
    
    if (validPosition) {
        gameState.obstacles.push({x, y});
    }
}

    
    // æ¿€æ´»èƒ½åŠ›é“å…·
    function activatePowerUp(type, duration) {
        // æ¸…é™¤ä¹‹å‰çš„èƒ½åŠ›è®¡æ—¶å™¨
        if (powerUpTimeout) {
            clearTimeout(powerUpTimeout);
        }
        
        gameState.powerUpActive = true;
        gameState.powerUpType = type;
        
        // æ›´æ–°èƒ½åŠ›é“å…·æŒ‡ç¤ºå™¨
        const powerUpIndicator = document.getElementById('power-up-indicator');
        powerUpIndicator.textContent = type === 'phase' ? 'ç©¿å¢™èƒ½åŠ›æ¿€æ´»!' : 'æ— æ•Œèƒ½åŠ›æ¿€æ´»!';
        powerUpIndicator.className = 'show';
        
        // è®¾ç½®èƒ½åŠ›æŒç»­æ—¶é—´
        powerUpTimeout = setTimeout(() => {
            gameState.powerUpActive = false;
            gameState.powerUpType = null;
            powerUpIndicator.className = '';
            
            // æ£€æŸ¥æ˜¯å¦åœ¨ç©¿å¢™èƒ½åŠ›ç»“æŸæ—¶å¡åœ¨å¢™é‡Œ
            if (type === 'phase') {
                const head = gameState.snake[0];
                if (head.x < 0 || head.x >= settings.gridSize || 
                    head.y < 0 || head.y >= settings.gridSize) {
                    endGame('collision');
                }
            }
        }, duration);
    }
    
    // åˆ›å»ºé£Ÿç‰©ç²’å­æ•ˆæœ
    function createFoodParticles(x, y, color) {
    // è§£æé¢œè‰²ä¸ºRGB
    const r = parseInt(color.slice(1, 3), 16);
    const g = parseInt(color.slice(3, 5), 16);
    const b = parseInt(color.slice(5, 7), 16);
    
    // å‡å°‘ç²’å­æ•°é‡ä»20åˆ°15ï¼Œé˜²æ­¢è¿‡å¤šçš„ç²’å­å½±å“æ€§èƒ½
    const particleCount = 15;
    
    for (let i = 0; i < particleCount; i++) {
        gameState.particles.push({
            x: x + 0.5,
            y: y + 0.5,
            // å¢åŠ ç²’å­é€Ÿåº¦ä½¿æ•ˆæœæ›´æ˜æ˜¾
            vx: (Math.random() - 0.5) * 0.25,
            vy: (Math.random() - 0.5) * 0.25,
            radius: 0.5 + Math.random() * 0.5,
            alpha: 1,
            color: {r, g, b}
        });
    }
}

    
    // åˆ›å»ºåˆ†æ•°å¼¹å‡ºæ•ˆæœ
    function createScorePopup(x, y, points) {
        const popup = document.createElement('div');
        popup.className = 'score-popup';
        popup.textContent = `+${points}`;
        popup.style.left = `${(x + 0.5) * cellSize}px`;
        popup.style.top = `${(y + 0.5) * cellSize}px`;
        popup.style.color = '#FFEB3B';
        document.getElementById('game-container').appendChild(popup);
        
        // åˆ é™¤å…ƒç´ 
        setTimeout(() => {
            popup.remove();
        }, 800);
    }
    
    // åˆ›å»ºè¿å‡»å¼¹å‡ºæ•ˆæœ
    function createComboPopup(x, y) {
        const popup = document.createElement('div');
        popup.className = 'combo-popup';
        popup.textContent = `è¿å‡» x${gameState.combo}!`;
        popup.style.left = `${(x + 0.5) * cellSize}px`;
        popup.style.top = `${(y - 0.5) * cellSize}px`;
        
        // æ ¹æ®è¿å‡»æ•°é‡æ”¹å˜é¢œè‰²
        let color;
        if (gameState.combo > 5) color = '#FF9100';
        else if (gameState.combo > 3) color = '#FFEA00';
        else color = '#76FF03';
        
        popup.style.color = color;
        document.getElementById('game-container').appendChild(popup);
        
        // åˆ é™¤å…ƒç´ 
        setTimeout(() => {
            popup.remove();
        }, 1000);
    }
    
    // æ˜¾ç¤ºé£Ÿç‰©ä¿¡æ¯
    function showFoodInfo(type) {
        const foodInfo = document.getElementById('food-info');
        if (foodInfoTimeout) {
            clearTimeout(foodInfoTimeout);
        }
        
        const info = foodTypes[type];
        foodInfo.textContent = `${info.name}: ${info.effect} (+${info.points}åˆ†)`;
        foodInfo.style.color = info.color;
        foodInfo.className = 'show';
        
        foodInfoTimeout = setTimeout(() => {
            foodInfo.className = '';
        }, 3000);
    }
    
    // æ›´æ–°åˆ†æ•°æ˜¾ç¤º
    function updateScoreDisplay() {
        document.getElementById('score').textContent = gameState.score;
        document.getElementById('high-score').textContent = gameState.highScore;
    }
    // æ›´æ–°åˆ†æ•°å€ç‡æ˜¾ç¤º
function updateScoreMultiplierDisplay() {
    const speedDisplay = document.getElementById('speed-display');
    const statusDisplay = document.getElementById('status-display');
    
    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§æ˜¾ç¤º
    const existingMultiplier = document.getElementById('score-multiplier-display');
    if (existingMultiplier) {
        existingMultiplier.remove();
    }
    
    // å¦‚æœåˆ†æ•°ç¿»å€å¤„äºæ¿€æ´»çŠ¶æ€ï¼Œæ·»åŠ æŒ‡ç¤ºå™¨
    if (gameState.scoreMultiplierActive) {
        const multiplierDisplay = document.createElement('div');
        multiplierDisplay.id = 'score-multiplier-display';
        multiplierDisplay.textContent = `åˆ†æ•°: åŒå€ (${Math.ceil(gameState.scoreMultiplierTimeLeft/1000)}ç§’)`;
        multiplierDisplay.style.color = '#ffcc00';
        multiplierDisplay.style.fontWeight = 'bold';
        statusDisplay.appendChild(multiplierDisplay);
    }
}

    // æ›´æ–°é€Ÿåº¦æ˜¾ç¤º
    function updateSpeedDisplay() {
        let speedText = 'æ­£å¸¸';
        if (gameState.speed < settings.baseSpeed - 20) speedText = 'å¿«é€Ÿ';
        if (gameState.speed < settings.baseSpeed - 50) speedText = 'æå¿«';
        if (gameState.speed > settings.baseSpeed + 20) speedText = 'æ…¢é€Ÿ';
        document.getElementById('speed-display').textContent = `é€Ÿåº¦: ${speedText}`;
    }
    
    // ç»“æŸæ¸¸æˆ
    function endGame(reason) {
        gameState.isPlaying = false;
        gameState.isGameOver = true;
        
        // æ›´æ–°æ¸¸æˆè®°å½•
    updateGameRecord('score', { mode: gameState.gameMode, score: gameState.score });
        
        // æ ¹æ®ç»“æŸåŸå› ä¸åŒï¼Œæ˜¾ç¤ºä¸åŒçš„ä¿¡æ¯
        const gameOverTitle = document.getElementById('game-over-title');
        const finalScore = document.getElementById('final-score');
        const finalLength = document.getElementById('final-length');
        const gameOverMessage = document.getElementById('game-over-message');
        
        if (reason === 'victory') {
            gameOverTitle.textContent = 'æŒ‘æˆ˜æˆåŠŸï¼';
            
            if (settings.soundEnabled) {
                sounds.win.play();
            }
        } else {
            gameOverTitle.textContent = 'æ¸¸æˆç»“æŸ';
            
            if (settings.soundEnabled) {
                sounds.gameOver.play();
            }
        }
        
        finalScore.textContent = `æœ€ç»ˆåˆ†æ•°: ${gameState.score}`;
        finalLength.textContent = `è›‡çš„é•¿åº¦: ${gameState.snake.length}`;
        
        // æ ¹æ®åˆ†æ•°ç»™å‡ºè¯„ä»·
        let message = '';
        if (gameState.score > 300) message = 'å¤ªå‰å®³äº†ï¼ä½ æ˜¯è›‡ç¥ï¼';
        else if (gameState.score > 200) message = 'çœŸæ£’ï¼è›‡æŠ€é«˜è¶…ï¼';
        else if (gameState.score > 100) message = 'ä¸é”™ï¼ç›¸å½“ç†Ÿç»ƒï¼';
        else message = 'å†æ¥å†å‰ï¼Œä½ èƒ½åšå¾—æ›´å¥½ï¼';
        
        gameOverMessage.textContent = message;
        
        // æ›´æ–°é«˜åˆ†è®°å½•
        if (gameState.score > gameState.highScore) {
            gameState.highScore = gameState.score;
            localStorage.setItem('snakeHighScore', gameState.highScore);
            document.getElementById('high-score').textContent = gameState.highScore;
        }
        
        // æ˜¾ç¤ºæ¸¸æˆç»“æŸèœå•
        document.getElementById('game-over').style.display = 'flex';
        
        // æ¸…é™¤èƒ½åŠ›é“å…·è®¡æ—¶å™¨
        if (powerUpTimeout) {
            clearTimeout(powerUpTimeout);
            powerUpTimeout = null;
        }
        
        // åœæ­¢æ¸¸æˆå¾ªç¯
        cancelAnimationFrame(gameState.animationFrame);
        
        // æ¢å¤3Dæ—‹è½¬æ•ˆæœ
        canvas.classList.add('rotate-effect');
    }
    
    // ============== äº‹ä»¶å¤„ç† ==============
    // æ”¹å˜æ–¹å‘
    function changeDirection(newDirection) {
        // é˜²æ­¢åæ–¹å‘ç§»åŠ¨
        if ((gameState.direction === 'up' && newDirection === 'down') ||
            (gameState.direction === 'down' && newDirection === 'up') ||
            (gameState.direction === 'left' && newDirection === 'right') ||
            (gameState.direction === 'right' && newDirection === 'left')) {
            return;
        }
        
        gameState.nextDirection = newDirection;
    }
    
    // å¯åŠ¨æ¸¸æˆ
    function startGame(mode) {
    // è®¾ç½®æ¸¸æˆæ¨¡å¼
    gameState.gameMode = mode;
    
    // æ›´æ–°æ¸¸æˆè®°å½•
    updateGameRecord('mode', { mode: mode });
    updateGameRecord('singleplayer', {});
    
    // ç¡®ä¿ä¸æ˜¯å¤šäººæ¸¸æˆ
    isMultiplayerGame = false;
    
    // éšè—æ‰€æœ‰èœå•
    document.getElementById('main-menu').style.display = 'none';
    document.getElementById('settings-menu').style.display = 'none';
    document.getElementById('game-over').style.display = 'none';
    document.getElementById('pause-menu').style.display = 'none';
    
    // éšè—å¤šäººæ¸¸æˆUI
    document.getElementById('multiplayer-status').style.display = 'none';
    document.getElementById('multiplayer-chat').style.display = 'none';
    document.getElementById('multiplayer-controls').style.display = 'none';
    
    // ç¡®ä¿å•äººæ¸¸æˆæ§åˆ¶å¯è§
    resetControls();
    // ç¡®ä¿çŠ¶æ€æ˜¾ç¤ºå¯è§
document.getElementById('status-display').style.display = 'flex';

    // ç§»é™¤å¯èƒ½å­˜åœ¨çš„é‡ç”ŸæŒ‰é’®
    hideRespawnOption();
    
    // åˆå§‹åŒ–æ¸¸æˆ
    initGame();
    
    // ç¡®ä¿å¤šäººæ¸¸æˆè¿”å›æŒ‰é’®åŠŸèƒ½æ­£å¸¸
    ensureBackButtonWorks();
    
    // æ ‡è®°æ¸¸æˆå¼€å§‹
    gameState.isPlaying = true;
    gameState.isPaused = false;
    gameState.lastFrameTime = 0;
    gameState.accumulatedTime = 0;
    particleSystem.clear();
    
    // å¼€å§‹æ¸¸æˆå¾ªç¯
    if (gameState.animationFrame) {
        cancelAnimationFrame(gameState.animationFrame);
    }
    gameState.animationFrame = requestAnimationFrame(gameLoop);
}

    
    // æš‚åœæ¸¸æˆ
    function togglePause() {
        if (gameState.isGameOver) return;
        
        gameState.isPaused = !gameState.isPaused;
        
        if (gameState.isPaused) {
            document.getElementById('pause-menu').style.display = 'flex';
        } else {
            document.getElementById('pause-menu').style.display = 'none';
            gameState.lastFrameTime = 0; // é‡ç½®å¸§æ—¶é—´ï¼Œé¿å…ä¸€æ¬¡æ€§å¤§æ›´æ–°
        }
    }
    
// è·å–æ¨¡å¼æ–‡æœ¬
function getModeText(mode) {
    switch (mode) {
        case 'classic': return 'ç»å…¸';
        case 'challenge': return 'å¤ºå† ';
        default: return 'ç»å…¸';
    }
}

function getModeText() {
    switch (gameState.gameMode) {
        case 'classic': return 'ç»å…¸';
        case 'challenge': return 'å¤ºå† ';
        default: return 'ç»å…¸';
    }
}

    
    // ============== åˆå§‹åŒ– ==============
    
    
    // ä¿å­˜è®¾ç½®
    function saveSettings() {
        const settingsToSave = {
            soundEnabled: settings.soundEnabled,
            particlesEnabled: settings.particlesEnabled,
            gridEnabled: settings.gridEnabled,
            speedMultiplier: settings.speedMultiplier
        };
        
        localStorage.setItem('snakeSettings', JSON.stringify(settingsToSave));
    }
    
// è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
function setupEventListeners() {
    // è§„åˆ™æŒ‰é’®äº‹ä»¶
    const rulesBtn = document.getElementById('rules-btn');
if (rulesBtn) {
    rulesBtn.addEventListener('click', () => {
        document.getElementById('main-menu').style.display = 'none';
        document.getElementById('rules-menu').style.display = 'flex';
        
        // æ·»åŠ è¿™ä¸€è¡Œæ¥è®¾ç½®æ¨¡å¼ä¿¡æ¯æŒ‰é’®
        setTimeout(setupModeInfoButtons, 100); // ä½¿ç”¨å»¶æ—¶ç¡®ä¿DOMå·²å®Œå…¨åŠ è½½
    });
}


    const rulesBackBtn = document.getElementById('rules-back-btn');
    if (rulesBackBtn) {
        rulesBackBtn.addEventListener('click', () => {
            document.getElementById('rules-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
    }
    
    // æ¸¸æˆæ¨¡å¼æŒ‰é’®
    const classicBtn = document.getElementById('classic-btn');
    if (classicBtn) {
        classicBtn.addEventListener('click', () => startGame('classic'));
    }
    
    const challengeBtn = document.getElementById('challenge-btn');
    if (challengeBtn) {
        challengeBtn.addEventListener('click', () => startGame('challenge'));
    }
    
    // å¤šäººæ¸¸æˆæŒ‰é’® - ç¡®ä¿è¿™æ®µä»£ç æ­£ç¡®æ‰§è¡Œ
    const multiplayerBtn = document.getElementById('multiplayer-btn');
    if (multiplayerBtn) {
        // ç§»é™¤å¯èƒ½å­˜åœ¨çš„æ—§äº‹ä»¶ç›‘å¬å™¨
        const newMultiplayerBtn = multiplayerBtn.cloneNode(true);
        if (multiplayerBtn.parentNode) {
            multiplayerBtn.parentNode.replaceChild(newMultiplayerBtn, multiplayerBtn);
        }
        
        // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
        newMultiplayerBtn.addEventListener('click', () => {
            console.log('ç‚¹å‡»å¤šäººæ¸¸æˆæŒ‰é’®');
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('multiplayer-menu').style.display = 'flex';
        });
        console.log('å¤šäººæ¸¸æˆæŒ‰é’®äº‹ä»¶ç›‘å¬å™¨å·²è®¾ç½®');
    } else {
        console.error('æ‰¾ä¸åˆ°å¤šäººæ¸¸æˆæŒ‰é’®å…ƒç´ ');
    }
    
    // æ¸¸æˆç»“æŸèœå•æŒ‰é’®
    const restartBtn = document.getElementById('restart-btn');
    if (restartBtn) {
        restartBtn.addEventListener('click', () => {
            if (isMultiplayerGame) {
                document.getElementById('game-over').style.display = 'none';
                resetMultiplayerGameState();
                document.getElementById('game-lobby').style.display = 'flex';
                if (isHost) {
                    document.getElementById('start-game-btn').style.display = 'block';
                }
            } else {
                startGame(gameState.gameMode);
            }
        });
    }
    
    const menuBtn = document.getElementById('menu-btn');
    if (menuBtn) {
        menuBtn.addEventListener('click', () => {
            if (isMultiplayerGame) {
                document.getElementById('game-over').style.display = 'none';
                document.getElementById('game-lobby').style.display = 'flex';
            } else {
                document.getElementById('game-over').style.display = 'none';
                document.getElementById('main-menu').style.display = 'flex';
            }
        });
    }
    
    // æš‚åœç›¸å…³æŒ‰é’®
    const pauseBtn = document.getElementById('pause-btn');
    if (pauseBtn) {
        pauseBtn.addEventListener('click', () => {
            if (!isMultiplayerGame) {
                togglePause();
            } else {
                const pauseMenu = document.getElementById('pause-menu');
                const pauseTitle = pauseMenu.querySelector('h2');
                const resumeBtn = document.getElementById('resume-btn');
                const pauseMenuBtn = document.getElementById('pause-menu-btn');
                
                pauseTitle.textContent = 'æ¸¸æˆä¿¡æ¯';
                resumeBtn.textContent = 'ç»§ç»­æ¸¸æˆ';
                pauseMenuBtn.textContent = 'è¿”å›ä¸»èœå•';
                
                pauseMenu.style.display = 'flex';
                document.getElementById('multiplayer-chat').classList.add('show');
                gameState.isPaused = true;
            }
        });
    }
    
    const resumeBtn = document.getElementById('resume-btn');
    if (resumeBtn) {
        resumeBtn.addEventListener('click', () => {
            if (isMultiplayerGame) {
                document.getElementById('pause-menu').style.display = 'none';
                document.getElementById('multiplayer-chat').classList.remove('show');
                gameState.isPaused = false;
            } else {
                togglePause();
            }
        });
    }
    
    const pauseMenuBtn = document.getElementById('pause-menu-btn');
    if (pauseMenuBtn) {
        pauseMenuBtn.addEventListener('click', () => {
            if (gameState.animationFrame) {
                cancelAnimationFrame(gameState.animationFrame);
                gameState.animationFrame = null;
            }
            
            gameState.isPlaying = false;
            gameState.isPaused = false;
            
            document.getElementById('pause-menu').style.display = 'none';
            
            if (isMultiplayerGame) {
                resetMultiplayerGame();
            } else {
                document.getElementById('main-menu').style.display = 'flex';
                canvas.classList.add('rotate-effect');
            }
        });
    }
    
    // è®¾ç½®èœå•æŒ‰é’®
    const settingsBtn = document.getElementById('settings-btn');
    if (settingsBtn) {
        settingsBtn.addEventListener('click', () => {
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('settings-menu').style.display = 'flex';
        });
    }
    
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    if (saveSettingsBtn) {
        saveSettingsBtn.addEventListener('click', () => {
            settings.soundEnabled = document.getElementById('sound-checkbox').checked;
            settings.particlesEnabled = document.getElementById('particles-checkbox').checked;
            settings.gridEnabled = document.getElementById('grid-checkbox').checked;
            settings.speedMultiplier = parseInt(document.getElementById('speed-slider').value) / 10;
            
            saveSettings();
            
            document.getElementById('settings-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
    }
    
    const settingsMenuBtn = document.getElementById('settings-menu-btn');
    if (settingsMenuBtn) {
        settingsMenuBtn.addEventListener('click', () => {
            document.getElementById('settings-menu').style.display = 'none';
            document.getElementById('main-menu').style.display = 'flex';
        });
    }
    
    // é€Ÿåº¦æ»‘å—æ›´æ–°
    const speedSlider = document.getElementById('speed-slider');
    if (speedSlider) {
        speedSlider.addEventListener('input', function() {
            document.getElementById('speed-value').textContent = this.value;
        });
    }
    
    // æ–¹å‘æ§åˆ¶æŒ‰é’®
    const upBtn = document.getElementById('up-btn');
    const downBtn = document.getElementById('down-btn');
    const leftBtn = document.getElementById('left-btn');
    const rightBtn = document.getElementById('right-btn');
    
    if (upBtn) {
        upBtn.addEventListener('touchstart', () => changeDirectionMultiplayer('up'));
        upBtn.addEventListener('click', () => changeDirectionMultiplayer('up'));
    }
    
    if (downBtn) {
        downBtn.addEventListener('touchstart', () => changeDirectionMultiplayer('down'));
        downBtn.addEventListener('click', () => changeDirectionMultiplayer('down'));
    }
    
    if (leftBtn) {
        leftBtn.addEventListener('touchstart', () => changeDirectionMultiplayer('left'));
        leftBtn.addEventListener('click', () => changeDirectionMultiplayer('left'));
    }
    
    if (rightBtn) {
        rightBtn.addEventListener('touchstart', () => changeDirectionMultiplayer('right'));
        rightBtn.addEventListener('click', () => changeDirectionMultiplayer('right'));
    }
    
    // é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', (e) => {
        if (!gameState.isPlaying) return;
        
        switch (e.key) {
            case 'ArrowUp':
            case 'w':
            case 'W':
                changeDirectionMultiplayer('up');
                break;
            case 'ArrowDown':
            case 's':
            case 'S':
                changeDirectionMultiplayer('down');
                break;
            case 'ArrowLeft':
            case 'a':
            case 'A':
                changeDirectionMultiplayer('left');
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                changeDirectionMultiplayer('right');
                break;
            case ' ':
            case 'p':
            case 'P':
                if (!isMultiplayerGame) {
                    togglePause();
                }
                break;
        }
    });
    
    // çª—å£å¤§å°è°ƒæ•´
    window.addEventListener('resize', resizeCanvas);
}

    
    let isInitialized = false;

function initialize() {
    if (isInitialized) {
        console.log('æ¸¸æˆå·²ç»åˆå§‹åŒ–ï¼Œè·³è¿‡é‡å¤åˆå§‹åŒ–');
        return;
    }
    
    isInitialized = true;
    console.log('åˆå§‹åŒ–æ¸¸æˆ...');
    
    // åˆå§‹åŒ–æ¸¸æˆè®°å½•
    initGameRecords();
    
    // è°ƒæ•´ç”»å¸ƒå¤§å°
    resizeCanvas();
    
    // åŠ è½½è®¾ç½®
    loadSettings();
    
    // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
    setupEventListeners();
    
    // è®¾ç½®æ§åˆ¶äº‹ä»¶ç›‘å¬å™¨
    setupControlEvents();
    
    // è®¾ç½®æš‚åœæŒ‰é’®å’Œæš‚åœèœå•
    setupPauseButton();
    setupPauseMenuButton();
    
    // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€
    initGame();
    
    // åˆå§‹åŒ–å¤šäººæ¸¸æˆåŠŸèƒ½
    console.log('åˆå§‹åŒ–å¤šäººæ¸¸æˆ...');
    initializeMultiplayer();
    
    // ç›´æ¥ä¸ºHTMLä¸­å·²å­˜åœ¨çš„å¤šäººæ¸¸æˆæŒ‰é’®æ·»åŠ äº‹ä»¶ç›‘å¬
    const multiplayerBtn = document.getElementById('multiplayer-btn');
    if (multiplayerBtn) {
        multiplayerBtn.addEventListener('click', () => {
            console.log('ç‚¹å‡»å¤šäººæ¸¸æˆæŒ‰é’®');
            document.getElementById('main-menu').style.display = 'none';
            document.getElementById('multiplayer-menu').style.display = 'flex';
            
            // é¢„å¡«ä¸Šæ¬¡ä½¿ç”¨çš„åç§°
            if (gameRecords.playerName) {
                document.getElementById('player-name').value = gameRecords.playerName;
            }
        });
        console.log('å¤šäººæ¸¸æˆæŒ‰é’®äº‹ä»¶å·²è®¾ç½®');
    } else {
        console.error('æ‰¾ä¸åˆ°å¤šäººæ¸¸æˆæŒ‰é’®');
    }
    
    // è®¾ç½®å¤šäººæ¸¸æˆäº‹ä»¶ç›‘å¬
    setupMultiplayerEvents();
    
    // è®¾ç½®æ–¹å‘æ§åˆ¶
    setupDirectionControls();
    
    // ç»˜åˆ¶åˆå§‹ç”»é¢
    draw();
    
    // åº”ç”¨æ§åˆ¶è®¾ç½®
    applyControlSettings();
    
    console.log('æ¸¸æˆåˆå§‹åŒ–å®Œæˆ');
}


// æ·»åŠ æ–¹å‘æ§åˆ¶è®¾ç½®å‡½æ•°
function setupDirectionControls() {
    // è®¾ç½®æ–¹å‘æŒ‰é’®
    const directionButtons = {
        'up': document.getElementById('up-btn'),
        'down': document.getElementById('down-btn'),
        'left': document.getElementById('left-btn'),
        'right': document.getElementById('right-btn')
    };

    // ä¸ºæŒ‰é’®è®¾ç½®äº‹ä»¶ç›‘å¬
    for (const direction in directionButtons) {
        const btn = directionButtons[direction];
        if (btn) {
            // ç§»é™¤åŸæœ‰äº‹ä»¶ç›‘å¬å™¨
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // æ·»åŠ æ–°çš„äº‹ä»¶ç›‘å¬å™¨
            newBtn.addEventListener('touchstart', () => changeDirectionMultiplayer(direction));
            newBtn.addEventListener('click', () => changeDirectionMultiplayer(direction));
        }
    }

    // è®¾ç½®é”®ç›˜æ§åˆ¶
    document.addEventListener('keydown', (e) => {
        if (!gameState.isPlaying) return;
        
        switch (e.key) {
            case 'ArrowUp':
            case 'w':
            case 'W':
                changeDirectionMultiplayer('up');
                break;
            case 'ArrowDown':
            case 's':
            case 'S':
                changeDirectionMultiplayer('down');
                break;
            case 'ArrowLeft':
            case 'a':
            case 'A':
                changeDirectionMultiplayer('left');
                break;
            case 'ArrowRight':
            case 'd':
            case 'D':
                changeDirectionMultiplayer('right');
                break;
            case ' ':
            case 'p':
            case 'P':
                if (!isMultiplayerGame) {
                    togglePause();
                }
                break;
        }
    });
}

    

// ä¿®æ”¹ DOMContentLoaded äº‹ä»¶å¤„ç†å‡½æ•°ï¼Œé¿å…é‡å¤ç»‘å®šäº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOMåŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–æ¸¸æˆ...');
    
    // ç¡®ä¿ç§»é™¤ä»»ä½•ç°æœ‰çš„æ¨¡å¼æè¿°å…ƒç´ 
    const existingDescription = document.getElementById('game-mode-description');
    if (existingDescription) {
        existingDescription.remove();
    }
    
    // æ·»åŠ å¤šäººæ¸¸æˆæ§åˆ¶æŒ‰é’®å®¹å™¨
    if (!document.getElementById('multiplayer-controls')) {
        const multiplayerControls = document.createElement('div');
        multiplayerControls.id = 'multiplayer-controls';
        document.body.appendChild(multiplayerControls);
    }
    
    // æ·»åŠ è™šæ‹Ÿæ‘‡æ†å®¹å™¨å¹¶è®¾ç½®åˆå§‹æ ·å¼
    if (!document.getElementById('joystick-container')) {
        const joystickContainer = document.createElement('div');
        joystickContainer.id = 'joystick-container';
        joystickContainer.style.position = 'absolute';
        joystickContainer.style.bottom = '20px';
        joystickContainer.style.left = '50%';
        joystickContainer.style.transform = 'translateX(-50%)';
        joystickContainer.style.width = '150px';
        joystickContainer.style.height = '150px';
        joystickContainer.style.zIndex = '15';
        joystickContainer.style.display = 'none';
        
        const joystickBase = document.createElement('div');
        joystickBase.id = 'joystick-base';
        
        const joystickStick = document.createElement('div');
        joystickStick.id = 'joystick-stick';
        joystickStick.style.left = '50%';
        joystickStick.style.top = '50%';
        joystickStick.style.transform = 'translate(-50%, -50%)';
        
        joystickBase.appendChild(joystickStick);
        joystickContainer.appendChild(joystickBase);
        document.body.appendChild(joystickContainer);
    }
    
    // åˆå§‹åŒ–æ¸¸æˆ
    initialize();
    
    // ç¡®ä¿æ§åˆ¶è®¾ç½®æœ€åè¢«åº”ç”¨ï¼Œå¹¶å¼ºåˆ¶ä½¿ç”¨æ‘‡æ†æ§åˆ¶
    setTimeout(function() {
        // ç¡®ä¿è®¾ç½®ä¸ºæ‘‡æ†æ§åˆ¶
        settings.controlType = 'joystick';
        
        // æ›´æ–°UIä»¥åŒ¹é…è®¾ç½®
        document.getElementById('control-buttons').checked = false;
        document.getElementById('control-joystick').checked = true;
        
        // åº”ç”¨æ§åˆ¶è®¾ç½®
        applyControlSettings();
        console.log('å·²åº”ç”¨æ‘‡æ†æ§åˆ¶è®¾ç½®');
    }, 500);
});

</script>
</body>
 </html>



