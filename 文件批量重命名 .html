<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æœ¬åœ°æ‰¹é‡é‡å‘½åå·¥å…·</title>
  <style>
    :root {
      --bg: #0b1220;
      --panel: #0f1b31;
      --text: #e8eefc;
      --muted: #a8b3cf;
      --line: #223055;
      --btn: #2a66ff;
      --danger: #ff4d4f;
      --ok: #23c26b;
      --warn: #f5a524;
      --accent: #00d2ff;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: linear-gradient(135deg, #070c16, var(--bg));
      color: var(--text);
      font-family: var(--sans);
      min-height: 100vh;
      line-height: 1.5;
    }
    
    /* Header */
    header {
      padding: 16px 20px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(11,18,32,.9);
      backdrop-filter: blur(12px);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    header h1 {
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(90deg, var(--accent), #3a7bd5);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    header .tips {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    /* Main Layout */
    main {
      padding: 16px;
      max-width: 1400px;
      margin: 0 auto;
    }
    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 16px;
    }

    /* Card Panel */
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.1);
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 32px rgba(0,0,0,.3);
    }
    .card-header {
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .card-header .title {
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .card-header .icon { font-size: 18px; }
    .card-header .badge {
      background: linear-gradient(90deg, var(--accent), #3a7bd5);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    .card-body { 
  padding: 14px; 
  position: relative; 
  overflow: hidden;
}

    /* Drop Zone */
    .drop-zone {
    border: 2px dashed rgba(255,255,255,.25);
    border-radius: 12px;
    padding: 28px 16px;
    text-align: center;
    cursor: pointer;
    transition: all .2s ease;
    background: rgba(0,0,0,.15);
    position: relative;
    display: block; 
    width: 100%; 
    box-sizing: border-box;
    }
    .drop-zone:hover {
    border-color: rgba(255,255,255,.4);
    background: rgba(255,255,255,.03);
    }
    .drop-zone.dragover {
    border-color: var(--accent);
    background: rgba(0,210,255,.08);
    }
    .drop-zone .upload-icon { font-size: 36px; margin-bottom: 8px; }
    .drop-zone .main-text { font-weight: 600; font-size: 13px; }
    .drop-zone .sub-text { font-size: 12px; color: var(--muted); margin-top: 4px; }
    input[type="file"] { display: none; }

    /* Buttons */
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 12px;
    }
    button {
      border: 1px solid rgba(255,255,255,.12);
      background: linear-gradient(180deg, rgba(42,102,255,.85), rgba(42,102,255,.6));
      color: white;
      padding: 8px 14px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      font-size: 12px;
      transition: all .15s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    button:hover:not(:disabled) { transform: translateY(-1px); filter: brightness(1.1); }
    button:disabled { opacity: .45; cursor: not-allowed; }
    button.secondary { background: rgba(255,255,255,.08); }
    button.danger { background: linear-gradient(180deg, rgba(255,77,79,.85), rgba(255,77,79,.6)); }
    button.success { background: linear-gradient(180deg, rgba(35,194,107,.85), rgba(35,194,107,.6)); }

    /* File List */
    .file-list {
      margin-top: 12px;
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 12px;
      overflow: hidden;
      background: rgba(0,0,0,.12);
    }
    .list-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      font-size: 12px;
      color: var(--muted);
    }
    .list-items {
      max-height: 320px;
      overflow-y: auto;
    }
    .list-items::-webkit-scrollbar { width: 6px; }
    .list-items::-webkit-scrollbar-track { background: rgba(255,255,255,.05); }
    .list-items::-webkit-scrollbar-thumb { background: rgba(255,255,255,.2); border-radius: 3px; }

    .file-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.05);
      transition: background .15s;
      cursor: grab;
    }
    .file-item:hover { background: rgba(255,255,255,.04); }
    .file-item:last-child { border-bottom: none; }
    .file-item.dragging { opacity: .5; background: rgba(0,210,255,.1); }

    .file-index {
      background: rgba(0,210,255,.15);
      color: var(--accent);
      padding: 3px 8px;
      border-radius: 8px;
      font-size: 11px;
      font-family: var(--mono);
      min-width: 28px;
      text-align: center;
    }
    .file-icon { font-size: 20px; }
    .file-info { flex: 1; min-width: 0; }
    .file-name {
      font-size: 12px;
      word-break: break-all;
      line-height: 1.4;
    }
    .file-size {
      font-size: 11px;
      color: var(--muted);
      font-family: var(--mono);
    }
    .file-thumb {
      width: 32px;
      height: 32px;
      border-radius: 6px;
      object-fit: cover;
      border: 1px solid rgba(255,255,255,.1);
    }
    .remove-btn {
      background: transparent;
      border: none;
      color: var(--danger);
      padding: 4px 8px;
      font-size: 14px;
      opacity: .6;
    }
    .remove-btn:hover { opacity: 1; background: transparent; }

    /* Text Area & Form */
    textarea {
      width: 100%;
      min-height: 180px;
      resize: vertical;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.2);
      color: var(--text);
      padding: 12px;
      font-size: 12px;
      line-height: 1.6;
      font-family: var(--sans);
      outline: none;
    }
    textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(0,210,255,.15);
    }
    textarea::placeholder { color: rgba(255,255,255,.35); }

    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 12px;
    }
    .field {
      background: rgba(0,0,0,.12);
      border: 1px solid rgba(255,255,255,.08);
      border-radius: 10px;
      padding: 10px;
    }
    .field.full { grid-column: 1 / -1; }
    .field label {
      display: block;
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="text"], input[type="number"], select {
      width: 100%;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.1);
      background: rgba(0,0,0,.2);
      color: var(--text);
      padding: 8px 10px;
      font-size: 12px;
      font-family: var(--mono);
      outline: none;
    }
    input:focus, select:focus {
      border-color: var(--accent);
    }
    select option { background: #1a1a2e; }

    .checkbox-group {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }
    .checkbox-item {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--muted);
      cursor: pointer;
    }
    .checkbox-item input { width: 16px; height: 16px; cursor: pointer; }

    /* Status Box */
    .status-box {
      margin-top: 12px;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.12);
      font-size: 12px;
      color: var(--muted);
      line-height: 1.6;
    }
    .status-box .label { color: var(--accent); font-weight: 500; }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--danger); }

    /* Preview Items */
    .preview-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,.05);
      border-left: 3px solid transparent;
    }
    .preview-item.ok { border-left-color: var(--ok); }
    .preview-item.err { border-left-color: var(--danger); background: rgba(255,77,79,.05); }
    .preview-item:last-child { border-bottom: none; }
    .preview-info { flex: 1; min-width: 0; }
    .new-name {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      word-break: break-all;
    }
    .old-name {
      font-size: 11px;
      color: var(--muted);
      margin-top: 2px;
    }
    .error-msg {
      font-size: 11px;
      color: var(--danger);
      margin-top: 2px;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: linear-gradient(90deg, var(--accent), #3a7bd5);
      color: white;
      padding: 12px 24px;
      border-radius: 24px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 8px 32px rgba(0,0,0,.4);
      transition: transform .3s ease;
      z-index: 1000;
    }
    .toast.show { transform: translateX(-50%) translateY(0); }
    .toast.warn { background: linear-gradient(90deg, #f5a524, #ff6b35); }
    .toast.error { background: linear-gradient(90deg, #ff4d4f, #ff7875); }

    /* Progress Overlay */
    .progress-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,.85);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      opacity: 0;
      visibility: hidden;
      transition: all .3s;
    }
    .progress-overlay.show { opacity: 1; visibility: visible; }
    .progress-bar {
      width: 280px;
      height: 8px;
      background: rgba(255,255,255,.15);
      border-radius: 4px;
      overflow: hidden;
      margin: 16px 0;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent), #3a7bd5);
      width: 0%;
      transition: width .2s;
    }
    .progress-text { font-size: 14px; color: white; }

    /* Hints */
    .hint {
      font-size: 11px;
      color: var(--muted);
      margin-top: 10px;
      line-height: 1.6;
      padding: 10px;
      background: rgba(245,165,36,.08);
      border: 1px solid rgba(245,165,36,.2);
      border-radius: 8px;
    }
    .hint strong { color: var(--warn); }

    /* Responsive */
    @media (max-width: 1100px) {
      .grid { grid-template-columns: 1fr; }
      .list-items { max-height: 240px; }
    }
  </style>
</head>
<body>

<header>
  <h1>ğŸ“ æœ¬åœ°æ‰¹é‡é‡å‘½åå·¥å…·</h1>
  <div class="tips">å¯¼å…¥æ–‡ä»¶ â†’ è¾“å…¥æ–°åå­—ï¼ˆæ¯è¡Œä¸€ä¸ªï¼‰ â†’ å®æ—¶é¢„è§ˆ â†’ ä¸‹è½½ ZIP</div>
</header>

<main>
  <div class="grid">
    <!-- å·¦ä¾§ï¼šæ–‡ä»¶å¯¼å…¥ -->
    <section class="card">
      <div class="card-header">
        <div class="title"><span class="icon">ğŸ“‚</span> åŸå§‹æ–‡ä»¶</div>
        <span class="badge" id="fileCount">0 ä¸ª</span>
      </div>
      <div class="card-body">
        <label class="drop-zone" id="dropZone">
          <div class="upload-icon">ğŸ“¤</div>
          <div class="main-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ æˆ– ç‚¹å‡»é€‰æ‹©</div>
          <div class="sub-text">æ”¯æŒä»»æ„ç±»å‹æ–‡ä»¶ï¼Œå¯å¤šé€‰</div>
          <input type="file" id="fileInput" multiple>
        </label>

        <div class="btn-row">
          <button class="danger" id="btnClear" disabled>ğŸ—‘ï¸ æ¸…ç©º</button>
          <button class="secondary" id="btnSortName" disabled>ğŸ”¤ æŒ‰åç§°æ’åº</button>
          <button class="secondary" id="btnSortTime" disabled>ğŸ• æŒ‰æ·»åŠ é¡ºåº</button>
        </div>

        <div class="file-list">
          <div class="list-header">
            <span>æ–‡ä»¶åˆ—è¡¨ï¼ˆå¯æ‹–æ‹½æ’åºï¼‰</span>
            <span id="totalSize">0 B</span>
          </div>
          <div class="list-items" id="fileList">
            <div style="padding:30px;text-align:center;color:var(--muted)">æš‚æ— æ–‡ä»¶</div>
          </div>
        </div>
      </div>
    </section>

    <!-- ä¸­é—´ï¼šè§„åˆ™è®¾ç½® -->
    <section class="card">
      <div class="card-header">
        <div class="title"><span class="icon">âœï¸</span> é‡å‘½åè§„åˆ™</div>
        <span class="badge" id="lineCount">0 è¡Œ</span>
      </div>
      <div class="card-body">
        <textarea id="namesInput" placeholder="æ¯è¡Œè¾“å…¥ä¸€ä¸ªæ–°åå­—ï¼ˆä¸å«æ‰©å±•åï¼‰&#10;ä¾‹å¦‚ï¼š&#10;è¿™æ˜¯ç¬¬ä¸€ä¸ªå›¾&#10;è¿™æ˜¯ç¬¬äºŒä¸ªå›¾&#10;è¿™æ˜¯ç¬¬ä¸‰ä¸ªå›¾"></textarea>

        <div class="form-grid">
          <div class="field">
            <label>å‘½åæ¨¡å¼</label>
            <select id="renameMode">
              <option value="replace">å®Œå…¨æ›¿æ¢</option>
              <option value="prefix">æ·»åŠ å‰ç¼€</option>
              <option value="suffix">æ·»åŠ åç¼€</option>
            </select>
          </div>
          <div class="field">
            <label>å†²çªå¤„ç†</label>
            <select id="conflictMode">
              <option value="suffix">è‡ªåŠ¨åŠ  (1)(2)â€¦</option>
              <option value="error">é‡åˆ°é‡å¤æŠ¥é”™</option>
            </select>
          </div>
          <div class="field">
            <label>èµ·å§‹åºå·</label>
            <input type="number" id="startIndex" value="1" min="0">
          </div>
          <div class="field">
            <label>åºå·ä½æ•°ï¼ˆè¡¥é›¶ï¼‰</label>
            <input type="number" id="padWidth" value="0" min="0">
          </div>
          <div class="field">
            <label>åˆ†éš”ç¬¦</label>
            <input type="text" id="separator" value="_">
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="secondary" id="btnSwap" style="width:100%" disabled>ğŸ”„ åå‘åŒ¹é…</button>
          </div>
          <div class="field full">
            <label>é€‰é¡¹</label>
            <div class="checkbox-group">
              <label class="checkbox-item"><input type="checkbox" id="keepExt" checked> ä¿ç•™æ‰©å±•å</label>
              <label class="checkbox-item"><input type="checkbox" id="lowerExt" checked> æ‰©å±•åå°å†™</label>
              <label class="checkbox-item"><input type="checkbox" id="trimLines" checked> å»é¦–å°¾ç©ºæ ¼</label>
              <label class="checkbox-item"><input type="checkbox" id="skipEmpty" checked> è·³è¿‡ç©ºè¡Œ</label>
              <label class="checkbox-item"><input type="checkbox" id="autoNumber"> è¿½åŠ åºå·</label>
            </div>
          </div>
        </div>

        <div class="status-box" id="statusBox">
          <div><span class="label">çŠ¶æ€ï¼š</span><span id="statusText">ç­‰å¾…å¯¼å…¥æ–‡ä»¶â€¦</span></div>
          <div><span class="label">åŒ¹é…ï¼š</span><span id="matchInfo">-</span></div>
        </div>

        <div class="hint">
          <strong>ğŸ’¡ æç¤ºï¼š</strong>æ¯è¡Œæ–‡å­—æŒ‰é¡ºåºå¯¹åº”å·¦ä¾§æ–‡ä»¶ã€‚åå­—ä¸å¤Ÿæ—¶ç”¨åŸæ–‡ä»¶åè¡¥é½ï¼Œå¤šä½™çš„è¡Œå°†å¿½ç•¥ã€‚
        </div>
      </div>
    </section>

    <!-- å³ä¾§ï¼šé¢„è§ˆç»“æœ -->
    <section class="card">
      <div class="card-header">
        <div class="title"><span class="icon">ğŸ‘ï¸</span> é¢„è§ˆç»“æœ</div>
        <span class="badge" id="previewCount">0 ä¸ª</span>
      </div>
      <div class="card-body">
        <div class="btn-row">
          <button class="success" id="btnDownloadZip" disabled>ğŸ“¦ ä¸‹è½½ ZIP</button>
          <button class="secondary" id="btnDownloadCSV" disabled>ğŸ“‹ ä¸‹è½½å¯¹ç…§è¡¨</button>
        </div>

        <div class="file-list">
          <div class="list-header">
            <span>é‡å‘½åé¢„è§ˆ</span>
            <span id="previewSize">0 B</span>
          </div>
          <div class="list-items" id="previewList">
            <div style="padding:30px;text-align:center;color:var(--muted)">è¾“å…¥åå­—åè‡ªåŠ¨é¢„è§ˆ</div>
          </div>
        </div>

        <div class="hint">
          ä¸‹è½½çš„ ZIP å†…å«é‡å‘½ååçš„æ–‡ä»¶åŠå¯¹ç…§è¡¨ CSVã€‚
        </div>
      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast"></div>
<div class="progress-overlay" id="progressOverlay">
  <div class="progress-text" id="progressText">æ‰“åŒ…ä¸­â€¦</div>
  <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
  <div class="progress-text" id="progressDetail">0 / 0</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script>
// ===== å·¥å…·å‡½æ•° =====
const formatBytes = (b) => {
  const u = ['B','KB','MB','GB'];
  let i = 0, v = b;
  while (v >= 1024 && i < u.length - 1) { v /= 1024; i++; }
  return (i === 0 ? v : v.toFixed(2)) + ' ' + u[i];
};

const getExt = (name) => {
  const i = name.lastIndexOf('.');
  return i > 0 ? name.slice(i) : '';
};

const stripExt = (name) => {
  const i = name.lastIndexOf('.');
  return i > 0 ? name.slice(0, i) : name;
};

const sanitize = (s) => {
  let x = (s ?? '').toString();
  x = x.replace(/[\u0000-\u001f\u007f]/g, '');
  x = x.replace(/[\\/:*?"<>|]/g, ' ');
  x = x.replace(/\s+/g, ' ').trim().replace(/[. ]+$/g, '');
  return x || 'untitled';
};

const padNum = (n, w) => String(n).padStart(w > 0 ? w : 0, '0');

const csvEscape = (v) => {
  const s = String(v ?? '');
  return /[",\n\r]/.test(s) ? `"${s.replace(/"/g,'""')}"` : s;
};

const getFileIcon = (name) => {
  const ext = name.split('.').pop().toLowerCase();
  const icons = {
    jpg:'ğŸ–¼ï¸', jpeg:'ğŸ–¼ï¸', png:'ğŸ–¼ï¸', gif:'ğŸ–¼ï¸', webp:'ğŸ–¼ï¸', bmp:'ğŸ–¼ï¸', svg:'ğŸ–¼ï¸',
    pdf:'ğŸ“„', doc:'ğŸ“', docx:'ğŸ“', txt:'ğŸ“ƒ', xls:'ğŸ“Š', xlsx:'ğŸ“Š', csv:'ğŸ“Š',
    ppt:'ğŸ“½ï¸', pptx:'ğŸ“½ï¸', zip:'ğŸ—œï¸', rar:'ğŸ—œï¸', '7z':'ğŸ—œï¸',
    mp3:'ğŸµ', wav:'ğŸµ', mp4:'ğŸ¬', avi:'ğŸ¬', mkv:'ğŸ¬',
    js:'ğŸ’»', html:'ğŸ’»', css:'ğŸ’»', py:'ğŸ’»', exe:'âš™ï¸'
  };
  return icons[ext] || 'ğŸ“„';
};

const isImage = (file) => /^image\//.test(file.type) || /\.(png|jpe?g|gif|webp|bmp|svg)$/i.test(file.name);

// ===== çŠ¶æ€ =====
let files = [];
let orderMode = 'picked';
let reverseMatch = false;
let generated = [];
const urlCache = new Map();

// ===== DOM =====
const $ = (id) => document.getElementById(id);
const dropZone = $('dropZone');
const fileInput = $('fileInput');
const fileList = $('fileList');
const previewList = $('previewList');
const namesInput = $('namesInput');

// ===== äº‹ä»¶ï¼šå¯¼å…¥ =====
dropZone.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', (e) => {
  if (e.target.files?.length) addFiles([...e.target.files]);
  fileInput.value = '';
});

['dragover', 'dragenter'].forEach(evt => {
  dropZone.addEventListener(evt, (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
});
['dragleave', 'drop'].forEach(evt => {
  dropZone.addEventListener(evt, () => dropZone.classList.remove('dragover'));
});
dropZone.addEventListener('drop', (e) => {
  e.preventDefault();
  if (e.dataTransfer.files?.length) addFiles([...e.dataTransfer.files]);
});

function addFiles(newFiles) {
  files = files.concat(newFiles);
  applyOrder();
  renderFiles();
  updatePreview();
  showToast(`å·²æ·»åŠ  ${newFiles.length} ä¸ªæ–‡ä»¶`);
}

function applyOrder() {
  if (orderMode === 'name') files.sort((a, b) => a.name.localeCompare(b.name, 'zh-CN'));
}

function getObjectUrl(file) {
  if (!urlCache.has(file)) urlCache.set(file, URL.createObjectURL(file));
  return urlCache.get(file);
}

function clearUrls() {
  urlCache.forEach(url => URL.revokeObjectURL(url));
  urlCache.clear();
}

// ===== æ¸²æŸ“å·¦ä¾§æ–‡ä»¶åˆ—è¡¨ =====
function renderFiles() {
  let total = 0;
  if (files.length === 0) {
    fileList.innerHTML = '<div style="padding:30px;text-align:center;color:var(--muted)">æš‚æ— æ–‡ä»¶</div>';
  } else {
    fileList.innerHTML = files.map((f, i) => {
      total += f.size || 0;
      const thumb = isImage(f) 
        ? `<img class="file-thumb" src="${getObjectUrl(f)}" alt="">` 
        : `<span class="file-icon">${getFileIcon(f.name)}</span>`;
      return `
        <div class="file-item" draggable="true" data-idx="${i}">
          <span class="file-index">${i + 1}</span>
          ${thumb}
          <div class="file-info">
            <div class="file-name">${f.name}</div>
            <div class="file-size">${formatBytes(f.size)}</div>
          </div>
          <button class="remove-btn" onclick="removeFile(${i})">âœ•</button>
        </div>
      `;
    }).join('');
    initDragSort();
  }
  $('fileCount').textContent = `${files.length} ä¸ª`;
  $('totalSize').textContent = formatBytes(total);
  updateButtons();
}

function removeFile(i) {
  files.splice(i, 1);
  renderFiles();
  updatePreview();
}

// ===== æ‹–æ‹½æ’åº =====
let dragIdx = null;
function initDragSort() {
  fileList.querySelectorAll('.file-item').forEach(item => {
    item.addEventListener('dragstart', (e) => {
      dragIdx = +item.dataset.idx;
      item.classList.add('dragging');
    });
    item.addEventListener('dragend', () => {
      item.classList.remove('dragging');
      dragIdx = null;
    });
    item.addEventListener('dragover', (e) => e.preventDefault());
    item.addEventListener('drop', (e) => {
      e.preventDefault();
      const toIdx = +item.dataset.idx;
      if (dragIdx !== null && dragIdx !== toIdx) {
        const [moved] = files.splice(dragIdx, 1);
        files.splice(toIdx, 0, moved);
        renderFiles();
        updatePreview();
      }
    });
  });
}

// ===== è·å–æ–°åå­—è¡Œ =====
function getNameLines() {
  let lines = namesInput.value.replace(/\r\n/g, '\n').replace(/\r/g, '\n').split('\n');
  if ($('trimLines').checked) lines = lines.map(s => s.trim());
  if ($('skipEmpty').checked) lines = lines.filter(s => s.length > 0);
  return lines;
}

// ===== è‡ªåŠ¨é¢„è§ˆ =====
function updatePreview() {
  const lines = getNameLines();
  $('lineCount').textContent = `${lines.length} è¡Œ`;

  if (files.length === 0) {
    $('statusText').textContent = 'ç­‰å¾…å¯¼å…¥æ–‡ä»¶â€¦';
    $('matchInfo').textContent = '-';
    previewList.innerHTML = '<div style="padding:30px;text-align:center;color:var(--muted)">è¾“å…¥åå­—åè‡ªåŠ¨é¢„è§ˆ</div>';
    $('previewCount').textContent = '0 ä¸ª';
    $('previewSize').textContent = '0 B';
    $('btnDownloadZip').disabled = true;
    $('btnDownloadCSV').disabled = true;
    return;
  }

  const mode = $('renameMode').value;
  const start = parseInt($('startIndex').value) || 1;
  const width = parseInt($('padWidth').value) || 0;
  const sep = $('separator').value;
  const keepExt = $('keepExt').checked;
  const lowerExt = $('lowerExt').checked;
  const autoNum = $('autoNumber').checked;
  const conflict = $('conflictMode').value;

  const idxs = [...files.keys()];
  if (reverseMatch) idxs.reverse();

  const result = [];
  const usedNames = new Map();
  let total = 0;

  for (let k = 0; k < idxs.length; k++) {
    const i = idxs[k];
    const file = files[i];
    total += file.size || 0;

    const ext = keepExt ? getExt(file.name) : '';
    const extFinal = lowerExt ? ext.toLowerCase() : ext;
    const origBase = sanitize(stripExt(file.name));

    let base = '';
    const lineText = lines[k] ?? '';
    const hasLine = k < lines.length && lineText.length > 0;

    if (mode === 'replace') {
      base = hasLine ? sanitize(lineText) : origBase;
    } else if (mode === 'prefix') {
      base = hasLine ? sanitize(lineText) + sep + origBase : origBase;
    } else if (mode === 'suffix') {
      base = hasLine ? origBase + sep + sanitize(lineText) : origBase;
    }

    if (autoNum) {
      base += sep + padNum(start + k, width);
    }

    let newName = base + extFinal;

    // å†²çªå¤„ç†
    if (usedNames.has(newName)) {
      if (conflict === 'error') {
        result.push({ file, oldName: file.name, newName, ok: false, err: `é‡å: ${newName}` });
        continue;
      } else {
        let n = usedNames.get(newName) + 1;
        while (usedNames.has(`${base}(${n})${extFinal}`)) n++;
        usedNames.set(newName, n);
        newName = `${base}(${n})${extFinal}`;
      }
    }
    usedNames.set(newName, 1);
    result.push({ file, oldName: file.name, newName, ok: true, err: '' });
  }

  generated = result;
  renderPreview(total);

  const okCount = result.filter(x => x.ok).length;
  const used = Math.min(files.length, lines.length);
  $('matchInfo').textContent = `${used} / ${files.length} è¡Œå·²åŒ¹é…${reverseMatch ? 'ï¼ˆåå‘ï¼‰' : ''}`;
  $('statusText').innerHTML = `æˆåŠŸ <span class="ok">${okCount}</span>ï¼Œå¤±è´¥ <span class="err">${result.length - okCount}</span>`;
  $('btnDownloadZip').disabled = okCount === 0;
  $('btnDownloadCSV').disabled = result.length === 0;
}

function renderPreview(total) {
  if (generated.length === 0) {
    previewList.innerHTML = '<div style="padding:30px;text-align:center;color:var(--muted)">è¾“å…¥åå­—åè‡ªåŠ¨é¢„è§ˆ</div>';
  } else {
    previewList.innerHTML = generated.map((g, i) => `
      <div class="preview-item ${g.ok ? 'ok' : 'err'}">
        <span class="file-index">${i + 1}</span>
        <span class="file-icon">${getFileIcon(g.newName)}</span>
        <div class="preview-info">
          <div class="new-name">${g.newName}</div>
          <div class="old-name">åŸ: ${g.oldName}</div>
          ${g.err ? `<div class="error-msg">${g.err}</div>` : ''}
        </div>
      </div>
    `).join('');
  }
  $('previewCount').textContent = `${generated.length} ä¸ª`;
  $('previewSize').textContent = formatBytes(total);
}

// ===== æŒ‰é’®çŠ¶æ€ =====
function updateButtons() {
  const has = files.length > 0;
  $('btnClear').disabled = !has;
  $('btnSortName').disabled = !has;
  $('btnSortTime').disabled = !has;
  $('btnSwap').disabled = !has;
}

// ===== æ§åˆ¶æŒ‰é’® =====
$('btnClear').addEventListener('click', () => {
  files = [];
  generated = [];
  reverseMatch = false;
  clearUrls();
  renderFiles();
  updatePreview();
  showToast('å·²æ¸…ç©º');
});

$('btnSortName').addEventListener('click', () => {
  orderMode = 'name';
  applyOrder();
  renderFiles();
  updatePreview();
  showToast('å·²æŒ‰åç§°æ’åº');
});

$('btnSortTime').addEventListener('click', () => {
  orderMode = 'picked';
  renderFiles();
  updatePreview();
  showToast('å·²æŒ‰æ·»åŠ é¡ºåº');
});

$('btnSwap').addEventListener('click', () => {
  reverseMatch = !reverseMatch;
  updatePreview();
  showToast(reverseMatch ? 'å·²å¯ç”¨åå‘åŒ¹é…' : 'å·²æ¢å¤æ­£å‘åŒ¹é…');
});

// ===== å®æ—¶é¢„è§ˆäº‹ä»¶ =====
namesInput.addEventListener('input', updatePreview);
['renameMode', 'conflictMode', 'startIndex', 'padWidth', 'separator', 'keepExt', 'lowerExt', 'trimLines', 'skipEmpty', 'autoNumber'].forEach(id => {
  $(id).addEventListener('input', updatePreview);
  $(id).addEventListener('change', updatePreview);
});

// ===== ä¸‹è½½ ZIP =====
$('btnDownloadZip').addEventListener('click', async () => {
  const okItems = generated.filter(x => x.ok);
  if (!okItems.length) return;
  if (typeof JSZip === 'undefined') { showToast('JSZip æœªåŠ è½½', 'error'); return; }

  $('btnDownloadZip').disabled = true;
  showProgress(true);

  try {
    const zip = new JSZip();
    const folder = zip.folder('renamed_files');

    for (let i = 0; i < okItems.length; i++) {
      const item = okItems[i];
      const buf = await item.file.arrayBuffer();
      folder.file(item.newName, buf);
      updateProgress((i + 1) / okItems.length * 100, i + 1, okItems.length);
    }

    // é™„å¸¦å¯¹ç…§è¡¨
    const csv = ['index,oldName,newName,sizeBytes'].concat(
      okItems.map((it, idx) => [idx + 1, csvEscape(it.oldName), csvEscape(it.newName), it.file.size].join(','))
    ).join('\n');
    folder.file('_rename_map.csv', csv);

    const blob = await zip.generateAsync({ type: 'blob' });
    downloadBlob(blob, `batch_renamed_${Date.now()}.zip`);
    showToast(`å·²ä¸‹è½½ ${okItems.length} ä¸ªæ–‡ä»¶`);
  } finally {
    showProgress(false);
    $('btnDownloadZip').disabled = false;
  }
});

// ===== ä¸‹è½½ CSV =====
$('btnDownloadCSV').addEventListener('click', () => {
  if (!generated.length) return;
  const csv = ['index,oldName,newName,status,error'].concat(
    generated.map((it, i) => [i + 1, csvEscape(it.oldName), csvEscape(it.newName), it.ok ? 'OK' : 'ERR', csvEscape(it.err)].join(','))
  ).join('\n');
  downloadBlob(new Blob([csv], { type: 'text/csv' }), `rename_map_${Date.now()}.csv`);
});

function downloadBlob(blob, name) {
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = name;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(url), 2000);
}

// ===== Toast =====
function showToast(msg, type = 'success') {
  const t = $('toast');
  t.textContent = msg;
  t.className = 'toast show' + (type !== 'success' ? ' ' + type : '');
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ===== Progress =====
function showProgress(show) {
  $('progressOverlay').classList.toggle('show', show);
}
function updateProgress(pct, cur, total) {
  $('progressFill').style.width = pct + '%';
  $('progressDetail').textContent = `${cur} / ${total}`;
}

// åˆå§‹åŒ–
updateButtons();
</script>
</body>
</html>